<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude AI Setup Diagnostic</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-box { border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        button { padding: 12px 24px; margin: 10px 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .loading { display: none; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background-color: #f8f9fa; }
        .step.completed { border-left-color: #28a745; background-color: #d4edda; }
        .step.failed { border-left-color: #dc3545; background-color: #f8d7da; }
        .diagnostic-info { font-family: monospace; font-size: 12px; background-color: #f1f3f4; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Claude AI Setup Diagnostic</h1>
        <p>This tool helps you verify your Claude AI serverless function setup and identify any configuration issues.</p>

        <div class="test-box info">
            <h3>üìã Setup Checklist</h3>
            <div class="step" id="step-1">
                <strong>Step 1:</strong> Serverless function deployed at <code>/.netlify/functions/claude-ai</code>
                <span id="step-1-status">‚è≥ Checking...</span>
            </div>
            <div class="step" id="step-2">
                <strong>Step 2:</strong> ANTHROPIC_API_KEY environment variable set
                <span id="step-2-status">‚è≥ Pending...</span>
            </div>
            <div class="step" id="step-3">
                <strong>Step 3:</strong> API key format and authentication
                <span id="step-3-status">‚è≥ Pending...</span>
            </div>
            <div class="step" id="step-4">
                <strong>Step 4:</strong> Claude AI response generation
                <span id="step-4-status">‚è≥ Pending...</span>
            </div>
        </div>

        <div class="test-box">
            <h3>üß™ Run Diagnostics</h3>
            <button onclick="runFullDiagnostic()" id="diagnosticBtn">Start Diagnostic</button>
            <button onclick="testBasicConnection()" id="basicTestBtn">Test Connection Only</button>
            <div class="loading" id="loadingIndicator">
                <p>üîÑ Running diagnostics... Please wait.</p>
            </div>
        </div>

        <div id="resultsContainer"></div>

        <div class="test-box info">
            <h3>üìö Common Issues & Solutions</h3>
            <details>
                <summary><strong>Function not found (404 error)</strong></summary>
                <ul>
                    <li>Create folder: <code>netlify/functions/</code> in your project root</li>
                    <li>Copy the function file to: <code>netlify/functions/claude-ai.js</code></li>
                    <li>Redeploy your site to Netlify</li>
                    <li>Ensure the file is exactly named <code>claude-ai.js</code></li>
                </ul>
            </details>
            <details>
                <summary><strong>API key not configured</strong></summary>
                <ul>
                    <li>Go to Netlify Dashboard ‚Üí Your Site ‚Üí Site Settings ‚Üí Environment Variables</li>
                    <li>Add new variable: Key = <code>ANTHROPIC_API_KEY</code>, Value = your API key</li>
                    <li>Get API key from: <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></li>
                    <li>Redeploy your site after adding the environment variable</li>
                </ul>
            </details>
            <details>
                <summary><strong>Invalid API key format</strong></summary>
                <ul>
                    <li>API key should start with <code>sk-ant-api03-</code></li>
                    <li>Get a new key from Anthropic console if needed</li>
                    <li>Ensure you copied the full key without extra spaces</li>
                </ul>
            </details>
            <details>
                <summary><strong>Authentication failed (401)</strong></summary>
                <ul>
                    <li>Check if API key is correct and active</li>
                    <li>Verify you have sufficient credits in your Anthropic account</li>
                    <li>Try generating a new API key</li>
                </ul>
            </details>
        </div>
    </div>

    <script>
        async function runFullDiagnostic() {
            document.getElementById('diagnosticBtn').disabled = true;
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsContainer').innerHTML = '';

            try {
                // Step 1: Test function existence
                await updateStep('step-1', 'Testing function deployment...');
                
                const testResponse = await fetch('/.netlify/functions/claude-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: 'Hello! This is a test to verify you are working correctly.',
                        maxTokens: 100
                    })
                });

                if (testResponse.status === 404) {
                    await updateStep('step-1', '‚ùå Function not found', 'failed');
                    showResults({
                        success: false,
                        error: 'Serverless function not deployed',
                        diagnostic: 'The function /.netlify/functions/claude-ai was not found.',
                        solution: 'Deploy the claude-ai.js file to netlify/functions/ folder and redeploy your site.'
                    });
                    return;
                } else {
                    await updateStep('step-1', '‚úÖ Function found', 'completed');
                }

                // Parse response
                const result = await testResponse.json();
                console.log('Diagnostic result:', result);

                // Step 2: Check API key configuration
                await updateStep('step-2', 'Checking API key configuration...');
                
                if (result.diagnostic && result.diagnostic.includes('ANTHROPIC_API_KEY')) {
                    await updateStep('step-2', '‚ùå API key not set', 'failed');
                    showResults({
                        success: false,
                        error: 'API key not configured',
                        diagnostic: result.diagnostic,
                        solution: 'Set ANTHROPIC_API_KEY environment variable in Netlify'
                    });
                    return;
                } else {
                    await updateStep('step-2', '‚úÖ API key configured', 'completed');
                }

                // Step 3: Check API key format and auth
                await updateStep('step-3', 'Testing API key authentication...');
                
                if (result.diagnostic && result.diagnostic.includes('Invalid') || result.error?.includes('Invalid')) {
                    await updateStep('step-3', '‚ùå Invalid API key', 'failed');
                    showResults(result);
                    return;
                } else if (result.httpStatus === 401) {
                    await updateStep('step-3', '‚ùå Authentication failed', 'failed');
                    showResults(result);
                    return;
                } else if (result.success) {
                    await updateStep('step-3', '‚úÖ Authentication successful', 'completed');
                }

                // Step 4: Check AI response
                await updateStep('step-4', 'Testing AI response generation...');
                
                if (result.success && result.response) {
                    await updateStep('step-4', '‚úÖ AI responding correctly', 'completed');
                    showResults({
                        success: true,
                        message: 'All systems working correctly!',
                        response: result.response,
                        usage: result.usage
                    });
                } else {
                    await updateStep('step-4', '‚ùå No AI response', 'failed');
                    showResults(result);
                }

            } catch (error) {
                console.error('Diagnostic error:', error);
                await updateStep('step-1', '‚ùå Connection failed', 'failed');
                showResults({
                    success: false,
                    error: 'Network or deployment error',
                    diagnostic: error.message,
                    solution: 'Check if you are accessing the site via HTTPS and the function is properly deployed.'
                });
            } finally {
                document.getElementById('diagnosticBtn').disabled = false;
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function testBasicConnection() {
            document.getElementById('basicTestBtn').disabled = true;
            
            try {
                const response = await fetch('/.netlify/functions/claude-ai', {
                    method: 'OPTIONS'
                });
                
                if (response.status === 200) {
                    alert('‚úÖ Function is deployed and responding to requests');
                } else {
                    alert('‚ùå Function deployment issue - status: ' + response.status);
                }
            } catch (error) {
                alert('‚ùå Cannot reach function: ' + error.message);
            } finally {
                document.getElementById('basicTestBtn').disabled = false;
            }
        }

        async function updateStep(stepId, message, status = '') {
            const step = document.getElementById(stepId);
            const statusSpan = document.getElementById(stepId + '-status');
            
            statusSpan.textContent = message;
            
            if (status === 'completed') {
                step.classList.add('completed');
                step.classList.remove('failed');
            } else if (status === 'failed') {
                step.classList.add('failed');
                step.classList.remove('completed');
            }
            
            // Small delay for visual effect
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        function showResults(result) {
            const container = document.getElementById('resultsContainer');
            
            let className = result.success ? 'success' : 'error';
            let icon = result.success ? '‚úÖ' : '‚ùå';
            
            let html = `
                <div class="test-box ${className}">
                    <h3>${icon} Diagnostic Results</h3>
            `;
            
            if (result.success) {
                html += `
                    <p><strong>üéâ Claude AI is working correctly!</strong></p>
                    <div class="diagnostic-info">
                        <strong>Test Response:</strong><br>
                        ${result.response || 'No response text'}
                    </div>
                `;
                if (result.usage) {
                    html += `
                        <div class="diagnostic-info">
                            <strong>API Usage:</strong><br>
                            ${JSON.stringify(result.usage, null, 2)}
                        </div>
                    `;
                }
            } else {
                html += `
                    <p><strong>Issue Found:</strong> ${result.error}</p>
                `;
                
                if (result.diagnostic) {
                    html += `
                        <div class="diagnostic-info">
                            <strong>Technical Details:</strong><br>
                            ${result.diagnostic}
                        </div>
                    `;
                }
                
                if (result.solution) {
                    html += `
                        <div class="diagnostic-info">
                            <strong>üí° Solution:</strong><br>
                            ${result.solution}
                        </div>
                    `;
                }
                
                if (result.details) {
                    html += `
                        <details>
                            <summary>Raw Error Details</summary>
                            <pre>${result.details}</pre>
                        </details>
                    `;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Auto-run basic check on page load
        window.onload = function() {
            console.log('Claude AI Setup Diagnostic loaded');
        };
    </script>
</body>
</html>
