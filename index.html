<!-- This file now includes proper additional level sequencing and ERP Data Entry role support -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI Item Code Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .attribute-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        .attribute-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .drag-handle {
            cursor: grab;
            width: 2rem;
            text-align: center;
            color: #9ca3af;
            font-size: 1.2rem;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .drag-handle.disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }
        .sortable-ghost {
            opacity: 0.5;
            background-color: #e2e8f0;
        }
        .search-dropdown {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            top: 100%;
            left: 0;
        }
        #search-results-dropdown {
    position: static;
    z-index: 1000;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    max-height: 300px;
    overflow-y: auto;
    width: 100%;
}

#search-results-dropdown .project-option {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
}

#search-results-dropdown .project-option:hover {
    background-color: #f9fafb;
}

#search-results-dropdown .project-option:last-child {
    border-bottom: none;
}
        .project-option {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .project-option:hover {
            background-color: #f9fafb;
        }
        .project-option:last-child {
            border-bottom: none;
        }
        
        /* Enhanced Export Dropdown Styles */
        #export-dropdown-menu {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            max-height: 400px;
            overflow-y: auto;
        }
        
        #export-dropdown-menu .export-option {
            transition: all 0.2s ease;
        }
        
        #export-dropdown-menu button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .export-filter-info {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* Structured AI Message Content */
        .structured-content h2, .structured-content h3, .structured-content h4, .structured-content h5 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            line-height: 1.3;
            color: #1f2937;
        }
        
        .structured-content ul {
            margin: 0.5rem 0;
            padding-left: 0;
            list-style: none;
        }
        
        .structured-content li {
            margin-bottom: 0.25rem;
            color: #374151;
        }
        
        .structured-content .bg-gray-50 {
            margin: 1rem 0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
        }
        
        .structured-content .bg-gray-50 h5 {
            margin: 0 0 0.5rem 0;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .structured-content .flex.justify-between {
            margin: 0.125rem 0;
            padding: 0.25rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .structured-content .flex.justify-between:last-child {
            border-bottom: none;
        }
        
        .ai-message .bg-white {
            max-width: 700px;
            width: 100%;
        }
        
        .structured-content strong {
            color: #111827;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">CSI Code Generator Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="text-red-600 text-sm hidden"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Container -->
    <div id="main-container" class="container bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">CSI Item Code Generator</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-sm text-gray-600"></span>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                    Logout
                </button>
            </div>
        </div>

        <!-- AI Chatbot Integration -->
        <div id="ai-chatbot-container" class="fixed bottom-6 right-6 z-50">
            <!-- Chat Toggle Button -->
            <button id="ai-chat-toggle" class="group bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white rounded-full p-4 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                <svg class="w-6 h-6 transition-transform duration-300 group-hover:rotate-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <!-- Notification badge for new suggestions -->
                <span id="ai-notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">!</span>
            </button>
            
            <!-- Chat Window -->
            <div id="ai-chat-window" class="hidden absolute bottom-16 right-0 w-96 h-[500px] bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
                <div class="flex flex-col h-full">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg">Ask Ziad</h3>
                                <p class="text-blue-100 text-xs">For Any Help Needed</p>
                            </div>
                        </div>
                        <button id="ai-chat-close" class="text-white hover:text-gray-200 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Messages Area -->
                    <div id="ai-messages" class="flex-1 p-4 overflow-y-auto bg-gradient-to-b from-gray-50 to-white space-y-3">
                        <div class="ai-message">
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                        </svg>
                                    </div>
                                    <span class="text-xs text-gray-500 font-medium">AI Assistant</span>
                                </div>
                                <div class="text-sm text-gray-700 leading-relaxed">
                                    <p class="mb-3">üëã Welcome to your **Claude AI-Powered** Code Generation Assistant!</p>
                                    <div class="bg-gradient-to-r from-red-50 to-orange-50 p-3 rounded-lg border border-red-200 mb-3">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="text-lg">üîß</span>
                                            <span class="font-semibold text-red-800">Setup Required</span>
                                        </div>
                                        <p class="text-xs text-red-700">Deploy Claude AI serverless function to enable AI responses</p>
                                    </div>
                                    
                                    <div class="bg-blue-50 p-2 rounded-lg border border-blue-200 mb-3">
                                        <p class="text-xs text-blue-800">
                                            <strong>üß† Real AI Features:</strong> This chatbot uses actual Claude AI (no mock responses) 
                                            for intelligent database analysis, complex query handling, and natural conversations.
                                        </p>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 gap-2 text-xs">
                                        <div class="bg-green-50 p-2 rounded-lg border-l-3 border-green-400">
                                            <strong class="text-green-700">‚úÖ Database Functions:</strong> Search, analytics, and data export work perfectly
                                        </div>
                                        <div class="bg-orange-50 p-2 rounded-lg border-l-3 border-orange-400">
                                            <strong class="text-orange-700">üîß AI Responses:</strong> Require Claude AI serverless function setup
                                        </div>
                                        <div class="bg-purple-50 p-2 rounded-lg border-l-3 border-purple-400">
                                            <strong class="text-purple-700">üéØ Complex Queries:</strong> "Analyze steel pricing trends and recommend suppliers"
                                        </div>
                                        <div class="bg-blue-50 p-2 rounded-lg border-l-3 border-blue-400">
                                            <strong class="text-blue-700">ü§ù Natural AI:</strong> Real Claude AI understands context and nuance
                                        </div>
                                    </div>
                                    <p class="mt-3 text-xs text-gray-600">üîß Use "Test AI" to check Claude AI setup status</p>
                                    <p class="mt-1 text-xs text-gray-500">üìö See setup guide for deployment instructions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div id="ai-quick-actions" class="px-4 py-2 bg-gray-50 border-t">
                        <div class="flex flex-wrap gap-1">
                            <button class="quick-action-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full text-xs transition-colors" data-action="search_pending">
                                üìã My Pending
                            </button>
                            <button class="quick-action-btn bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-full text-xs transition-colors" data-action="quick_search">
                                üîç Quick Search
                            </button>
                            <button class="quick-action-btn bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded-full text-xs transition-colors" data-action="export_data">
                                üì§ Export
                            </button>
                            <button class="quick-action-btn bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-1 rounded-full text-xs transition-colors" data-action="help">
                                ‚ùì Help
                            </button>
                            <button class="quick-action-btn bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs transition-colors" data-action="test_ai">
                                üß™ Test AI
                            </button>
                            <button class="quick-action-btn bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-full text-xs transition-colors" data-action="test_db">
                                üîç Test DB
                            </button>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="p-4 border-t bg-white">
                        <div class="flex space-x-2">
                            <div class="flex-1 relative">
                                <input type="text" id="ai-chat-input" 
                                       placeholder="Ask me anything about code generation..." 
                                       class="w-full border border-gray-300 rounded-xl px-4 py-3 pr-12 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                <button id="ai-voice-input" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                                    </svg>
                                </button>
                            </div>
                            <button id="ai-chat-send" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white px-4 py-3 rounded-xl transition-all duration-200 transform hover:scale-105">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Typing indicator -->
                        <div id="ai-typing-indicator" class="hidden mt-2">
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                                </div>
                                <span>AI is thinking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b">
            <nav class="flex space-x-8">
                <button class="tab-btn py-2 px-1 border-b-2 border-blue-500 text-blue-600" data-tab="generate">
                    Generate Codes
                </button>
                <button class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500" data-tab="user-history">
                    User History
                </button>
                <button class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500" data-tab="search">
                    Search Codes
                </button>
                <button id="admin-tab" class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hidden" data-tab="admin">
                    Admin Panel
                </button>
                <button id="erp-tab-button" class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hidden" data-tab="erp">
                    ERP Integration
                </button>
            </nav>
        </div>

        <!-- Generate Tab -->
        <div id="generate-tab" class="tab-content">
            <!-- Project Selection -->
<div class="mb-6">
    <label class="block text-sm font-medium text-gray-700 mb-2">Select Approved Project</label>
    
    <!-- Cascading Dropdown Selection -->
    <div class="mb-3 space-y-3">
        <!-- Division Selection -->
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">1. Select Division</label>
            <select id="division-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                <option value="">Choose division...</option>
            </select>
        </div>
        
        <!-- Section Selection -->
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">2. Select Section</label>
            <select id="section-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500" disabled>
                <option value="">Choose section...</option>
            </select>
        </div>
        
        <!-- Detailed Section Selection -->
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">3. Select Detailed Section</label>
            <select id="detailed-section-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500" disabled>
                <option value="">Choose detailed section...</option>
            </select>
        </div>
        
        <!-- Item Code Selection -->
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">4. Select Item Code</label>
            <select id="item-code-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500" disabled>
                <option value="">Choose item code...</option>
            </select>
        </div>
        
        <!-- Additional Level Value Selection -->
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">5. Select Additional Level</label>
            <select id="additional-level-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500" disabled>
                <option value="">Choose additional level...</option>
            </select>
        </div>
    </div>
    
    <!-- Advanced Search Section -->
    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
        <h4 class="text-sm font-medium text-gray-700 mb-3">Advanced Project Search</h4>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Project Name</label>
                <input type="text" id="search-project-name" placeholder="Search by project name..." 
                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Creator</label>
                <input type="text" id="search-creator" placeholder="Search by creator..." 
                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">CSI Code (Any Level)</label>
                <input type="text" id="search-csi-code" placeholder="Search by CSI code..." 
                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Attribute Name</label>
                <input type="text" id="search-attribute-name" placeholder="Search by attribute..." 
                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Standard Value</label>
                <input type="text" id="search-standard-value" placeholder="Search by standard value..." 
                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500">
            </div>
            
            <div class="flex items-end">
                <button id="clear-search-btn" class="w-full px-3 py-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600">
                    Clear All
                </button>
            </div>
        </div>
        
        <!-- Search Results -->
        <div id="search-results-dropdown" class="search-dropdown hidden mt-3">
            <!-- Search results will be populated here -->
        </div>
    </div>
</div>

            <!-- Selected Project Display -->
            <div id="selected-project-display" class="mb-6 p-4 bg-blue-50 rounded-lg hidden">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">Selected Project</h3>
                <div id="selected-project-info"></div>
            </div>

            
            <!-- Project Details (Hidden initially) -->
<div id="project-details" class="hidden">
    <!-- Attributes Section -->
    <div class="mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Select Attributes</h2>
            <div class="flex space-x-2">
                <button id="add-standard-value-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-sm">
                    + Add Standard Value
                </button>
                <div id="reorder-lock-indicator" class="text-green-600 text-sm">
     Attribute ordering is always available (order-independent duplicate detection)
</div>
            </div>
        </div>
        
        <div id="attributes-container" class="space-y-2">
            <!-- Attributes will be rendered here -->
        </div>
    </div>

    <!-- Generation Controls -->
    <div class="bg-blue-50 p-6 rounded-lg mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Code Generation</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Unit of Measurement *</label>
                <select id="uom-select" class="mt-1 w-full rounded-md border-gray-300">
                    <option value="">Select UoM...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Country of Origin *</label>
                <select id="country-select" class="mt-1 w-full rounded-md border-gray-300">
                    <option value="">Select country...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Model Number</label>
                <input type="text" id="model-number" placeholder="Optional" 
                       class="mt-1 w-full rounded-md border-gray-300">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Assign Reviewer *</label>
                <select id="reviewer-select" class="mt-1 w-full rounded-md border-gray-300">
                    <option value="">Select reviewer...</option>
                </select>
            </div>
        </div>

        <!-- NEW: Price and Currency Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">
                    Unit Price * <span class="text-red-500">(Required)</span>
                </label>
                <input type="number" 
                       id="unit-price" 
                       step="0.01" 
                       min="0"
                       placeholder="Enter unit price"
                       class="mt-1 w-full rounded-md border-gray-300">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">
                    Currency * <span class="text-red-500">(Required)</span>
                </label>
                <select id="currency-select" class="mt-1 w-full rounded-md border-gray-300">
                    <option value="">Select currency...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">
                    Manufacturer <span class="text-gray-500">(Optional)</span>
                </label>
                <div class="flex gap-2">
                    <select id="manufacturer-select" class="mt-1 flex-1 rounded-md border-gray-300">
                        <option value="">Select manufacturer...</option>
                    </select>
                    <button type="button" 
                            id="add-manufacturer-btn"
                            class="mt-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm">
                        + Add
                    </button>
                </div>
            </div>
        </div>

        <!-- Duplication Check Status -->
        <div id="duplication-status" class="mb-4 p-3 rounded-lg hidden">
            <div id="duplication-message"></div>
        </div>

        <!-- Variation Information Display -->
        <div id="variation-info" class="mb-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg hidden">
            <h4 class="text-lg font-medium text-blue-800 mb-3 flex items-center">
                 <span class="ml-2">Variation Preview</span>
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="bg-white p-3 rounded border">
                    <span class="text-blue-600 font-medium block mb-1">Base Item Code:</span>
                    <span id="base-item-code" class="text-blue-900 font-mono text-lg"></span>
                </div>
                <div class="bg-white p-3 rounded border">
                    <span class="text-blue-600 font-medium block mb-1">This Will Be:</span>
                    <span id="variation-preview-code" class="text-blue-900 font-mono text-lg font-bold"></span>
                </div>
                <div class="bg-white p-3 rounded border">
                    <span class="text-blue-600 font-medium block mb-1">Existing Variations:</span>
                    <span id="existing-variations-count" class="text-blue-900 text-lg"></span>
                </div>
            </div>
            <div class="mt-3 p-2 bg-blue-100 rounded text-blue-800 text-sm">
                <strong>Note:</strong> Same attributes with different UOM/manufacturer/model/country create variations, not new items.
            </div>
        </div>

        <!-- Code Preview -->
        <div class="bg-gray-800 text-white p-4 rounded-lg mb-4">
            <div class="text-sm text-gray-400 mb-1">Preview:</div>
            <pre id="code-preview" class="font-mono">Select attributes to preview code</pre>
        </div>

        <div class="flex space-x-4">
            <button id="generate-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md" disabled>
                Submit for Approval
            </button>
            <button id="block-btn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md">
                Block Combination
            </button>
        </div>
    </div>

    <!-- Enhanced Request History with Card Layout -->
<div class="mt-8">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Request History</h3>
        <div class="flex space-x-2">
            <button id="export-all-excel-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                Export All (Excel)
            </button>
            <button id="export-pdf-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm">
                Export All (PDF)
            </button>
        </div>
    </div>
    
    <!-- Card-based layout for history -->
    <div id="history-cards-container" class="space-y-4">
        <!-- History cards will be rendered here -->
    </div>
    
    <!-- Fallback table for history -->
    <div id="history-table-container" class="hidden overflow-x-auto">
        <table class="min-w-full bg-white border">
           <thead>
                <tr class="bg-gray-100">
                    <th class="py-2 px-4 border text-left text-xs">Item Code</th>
                    <th class="py-2 px-4 border text-left text-xs">Status</th>
                    <th class="py-2 px-4 border text-left text-xs">Source</th>
                    <th class="py-2 px-4 border text-left text-xs">Request ID</th>
                    <th class="py-2 px-4 border text-left text-xs">Created By</th>
                    <th class="py-2 px-4 border text-left text-xs">Approved By</th>
                    <th class="py-2 px-4 border text-left text-xs">Unit Price</th>
                    <th class="py-2 px-4 border text-left text-xs">Manufacturer</th>
                    <th class="py-2 px-4 border text-left text-xs">CSI Code</th>
                    <th class="py-2 px-4 border text-left text-xs">Additional Level</th>
                    <th class="py-2 px-4 border text-left text-xs">UoM</th>
                    <th class="py-2 px-4 border text-left text-xs">Origin</th>
                    <th class="py-2 px-4 border text-left text-xs">Model</th>
                    <th class="py-2 px-4 border text-left text-xs">Description</th>
                    <th class="py-2 px-4 border text-left text-xs">Created</th>
                    <th class="py-2 px-4 border text-left text-xs">Actions</th>
                </tr>
            </thead>
            <tbody id="history-table">
                <!-- History table rows -->
            </tbody>
        </table>
    </div>
    
    <!-- Toggle view button -->
    <div class="mt-4 text-center">
        <button id="toggle-view-btn" class="text-blue-600 hover:text-blue-800 text-sm">
            Switch to Table View
        </button>
    </div>
</div>
        </div>

        <!-- Requests Tab -->
        <!-- Enhanced Requests Tab -->
<div id="requests-tab" class="tab-content hidden">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">My Requests</h2>
        <div class="flex space-x-2">
            <button id="export-requests-excel-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                Export All (Excel)
            </button>
            <button id="export-requests-pdf-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm">
                Export All (PDF)
            </button>
        </div>
    </div>
    
    <!-- Card-based layout for requests -->
    <div id="requests-cards-container" class="space-y-4">
        <!-- Request cards will be rendered here -->
    </div>
    
    <!-- Fallback table for requests -->
    <div id="requests-table-container" class="hidden overflow-x-auto">
        <table class="min-w-full bg-white border">
            <thead>
                <tr class="bg-gray-100">
                    <th class="py-2 px-4 border text-left text-xs">Item Code</th>
                    <th class="py-2 px-4 border text-left text-xs">Status</th>
                    <th class="py-2 px-4 border text-left text-xs">Request ID</th>
                    <th class="py-2 px-4 border text-left text-xs">Created By</th>
                    <th class="py-2 px-4 border text-left text-xs">Unit Price</th>
                    <th class="py-2 px-4 border text-left text-xs">Manufacturer</th>
                    <th class="py-2 px-4 border text-left text-xs">CSI Code</th>
                    <th class="py-2 px-4 border text-left text-xs">Additional Level</th>
                    <th class="py-2 px-4 border text-left text-xs">UoM</th>
                    <th class="py-2 px-4 border text-left text-xs">Origin</th>
                    <th class="py-2 px-4 border text-left text-xs">Model</th>
                    <th class="py-2 px-4 border text-left text-xs">Description</th>
                    <th class="py-2 px-4 border text-left text-xs">Created</th>
                    <th class="py-2 px-4 border text-left text-xs">Actions</th>
                </tr>
            </thead>
            <tbody id="requests-table">
                <!-- Fallback table rows -->
            </tbody>
        </table>
    </div>
    
    <!-- Toggle view button for requests -->
    <div class="mt-4 text-center">
        <button id="toggle-requests-view-btn" class="text-blue-600 hover:text-blue-800 text-sm">
            Switch to Table View
        </button>
    </div>
</div>
</div>
        <!-- End Generate Tab -->
        
        <!-- User History Tab - Enhanced with Sub-tabs -->
        <div id="user-history-tab" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">User History</h2>
                
                <!-- Sub-tabs Navigation -->
                <div class="mb-6 border-b border-gray-200">
                    <nav class="flex space-x-8">
                        <button class="history-subtab-btn py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium" data-subtab="item-codes">
                            Item Code Requests
                        </button>
                        <button class="history-subtab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-subtab="standard-values">
                            Standard Value Requests
                        </button>
                        <button class="history-subtab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-subtab="combination-requests">
                            Combination Requests
                        </button>
                    </nav>
                </div>

                <!-- Sub-tab Contents -->
                <div id="item-codes-subtab" class="history-subtab-content">
                    <div id="user-history-content">
                        <!-- Item code requests content will be loaded here -->
                    </div>
                </div>

                <div id="standard-values-subtab" class="history-subtab-content hidden">
                    <div id="standard-values-content">
                        <!-- Standard value requests content will be loaded here -->
                    </div>
                </div>

                <div id="combination-requests-subtab" class="history-subtab-content hidden">
                    <div id="combination-requests-content">
                        <!-- Combination requests content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="tab-content hidden">
            <!-- Search Controls -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Search Approved Item Codes</h2>
                
                <!-- Advanced Search Form -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description 1</label>
                        <input type="text" id="search-desc1" placeholder="Search description 1..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description 2</label>
                        <input type="text" id="search-desc2" placeholder="Search description 2..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Item Code</label>
                        <input type="text" id="search-item-code" placeholder="Search item code..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                        <input type="text" id="search-project-name-codes" placeholder="Search project name..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CSI Path</label>
                        <input type="text" id="search-csi-path" placeholder="Search CSI path..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Country of Origin</label>
                        <input type="text" id="search-country" placeholder="Search country..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model Number</label>
                        <input type="text" id="search-model" placeholder="Search model..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit of Measurement</label>
                        <input type="text" id="search-uom" placeholder="Search UOM..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Attribute/Standard Value</label>
                        <input type="text" id="search-attributes" placeholder="Search attributes/values..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                    </div>
                <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ERP Status</label>
                        <select id="search-erp-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                            <option value="">All Statuses</option>
                            <option value="integrated">Integrated to ERP</option>
                            <option value="pending">Pending Integration</option>
                        </select>
                    </div>
                </div>
                
                <!-- Search Actions -->
                <div class="flex space-x-3">
                    <button id="perform-search-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                        Search
                    </button>
                    <button id="clear-search-codes-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md">
                        Clear All
                    </button>
                    <button id="toggle-view-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md">
                        Toggle Hierarchy View
                    </button>
                    <button id="toggle-table-view-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-md">
                        Switch to Table View
                    </button>
                    <!-- Enhanced Export Controls -->
                    <div class="relative inline-block">
                        <button id="export-dropdown-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                            </svg>
                            Export Options
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="export-dropdown-menu" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                            <div class="p-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3"> Export Item Codes</h3>
                                
                                <!-- Filter Selection -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status:</label>
                                    <select id="export-filter-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                                        <option value="all">All Approved Item Codes</option>
                                        <option value="erp_integrated">ERP Integrated Codes Only</option>
                                        <option value="erp_pending">Pending ERP Integration</option>
                                    </select>
                                </div>
                                
                                <!-- Export Format Options -->
                                <div class="grid grid-cols-2 gap-2">
                                    <button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Excel (.xlsx)
                                    </button>
                                    <button id="export-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2 2z"></path>
                                        </svg>
                                        PDF
                                    </button>
                                </div>
                                
                                <div class="mt-3 text-xs text-gray-600 bg-gray-50 p-2 rounded">
                                    <p><strong>Note:</strong> PDF exports include automatic text wrapping to ensure all content is clearly visible.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="refresh-search-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-md">
    Refresh Data
</button>
                </div>
            </div>
            
            <!-- View Toggle Info -->
            <div id="view-info" class="mb-4 p-3 bg-blue-50 rounded-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="view-description" class="text-blue-800 text-sm">Showing hierarchical WBS view organized by CSI structure</span>
                </div>
            </div>
            
            <!-- Results Summary -->
            <div id="search-summary" class="mb-4 hidden">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <span id="results-count" class="text-gray-700 font-medium">0 item codes found</span>
                </div>
            </div>
            
            <!-- Search Results Container -->
            <div id="search-results-container">
    <div id="hierarchy-view" class="space-y-4 hidden"></div>
    <div id="list-view" class="space-y-4"></div>
    
    <!-- Table View Container -->
    <div id="table-view-container" class="hidden">
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table id="search-codes-table" class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Item Code</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Project</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Description</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Unit Price</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Manufacturer</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">UOM</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Country</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Model</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Approved By</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Created Date</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">ERP Status</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-red-600 uppercase tracking-wider border-b bg-yellow-50"> Admin: Mark ERP</th>
                    </tr>
                </thead>
                <tbody id="search-codes-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Table rows will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="search-empty" class="hidden text-center py-8 text-gray-500">No search results found</div>
    <div id="search-loading" class="hidden text-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-2 text-gray-600">Loading search results...</p>
    </div>
</div>
</div>
    
    <!-- Loading State -->
    <div id="search-loading" class="hidden text-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-2 text-gray-600">Loading search results...</p>
    </div>
</div>        
        </div>

        <!-- Admin Tab -->
        <div id="admin-tab" class="tab-content hidden">
            <h2 class="text-xl font-semibold mb-4">Admin Panel</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold mb-2">Pending Code Requests</h3>
                    <div id="pending-codes" class="space-y-2">
                        <!-- Pending requests will be rendered here -->
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Pending Standard Values</h3>
                    <div id="pending-values" class="space-y-2">
                        <!-- Pending values will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ERP Integration Tab -->
        <div id="erp-tab" class="tab-content hidden">
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <h2 class="text-xl font-bold text-blue-800 mb-2"> ERP Integration Dashboard</h2>
                <p class="text-blue-700">View and manage ERP integration status for approved item codes</p>
            </div>

            <!-- ERP Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Integrated Items</p>
                            <p id="erp-integrated-count" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="text-green-500"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Pending Integration</p>
                            <p id="erp-pending-count" class="text-2xl font-bold text-orange-600">0</p>
                        </div>
                        <div class="text-orange-500"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Total Approved</p>
                            <p id="erp-total-count" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="text-blue-500"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Integration Rate</p>
                            <p id="erp-rate-percentage" class="text-2xl font-bold text-purple-600">0%</p>
                        </div>
                        <div class="text-purple-500"></div>
                    </div>
                </div>
            </div>

            <!-- ERP Filter Controls -->
            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Status:</label>
                        <select id="erp-status-filter" class="border border-gray-300 rounded px-3 py-2">
                            <option value="">All Items</option>
                            <option value="integrated">Integrated</option>
                            <option value="pending">Pending Integration</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search:</label>
                        <input type="text" id="erp-search-input" placeholder="Search item codes, descriptions..." 
                               class="border border-gray-300 rounded px-3 py-2 w-64">
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="refreshERPData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            Refresh
                        </button>
                        <div class="relative">
                            <button id="erp-export-btn" onclick="toggleERPExportDropdown()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center gap-2">
                                Export
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="erp-export-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-10 border">
                                <div class="py-2">
                                    <button onclick="exportERPData('all')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        Export All Approved Items
                                    </button>
                                    <button onclick="exportERPData('integrated')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        Export ERP Integrated Items
                                    </button>
                                    <button onclick="exportERPData('pending')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                       Export Pending Integration
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ERP Items Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-4 py-3 bg-gray-50 border-b">
                    <h3 class="text-lg font-medium text-gray-900">Approved Item Codes for ERP Integration</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Code</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Group</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description 1</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description 2</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manufacturer</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country of Origin</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approved Date</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERP Status</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="erp-items-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Standard Value Modal -->
    <div id="add-value-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-96">
            <h3 class="text-lg font-semibold mb-4">Request New Standard Value</h3>
            <form id="add-value-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Attribute *</label>
                    <select id="modal-attribute-select" class="mt-1 w-full rounded-md border-gray-300" required>
                        <option value="">Select attribute...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">New Value *</label>
                    <input type="text" id="modal-new-value" class="mt-1 w-full rounded-md border-gray-300" required placeholder="e.g., Steel, Aluminum, 10mm, etc.">
                    <p class="text-xs text-gray-500 mt-1">Enter the value name</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Unit of Measurement</label>
                    <select id="modal-unit-select" class="mt-1 w-full rounded-md border-gray-300">
                        <option value="">Select unit (optional)...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Assign Reviewer *</label>
                    <select id="modal-reviewer-select" class="mt-1 w-full rounded-md border-gray-300" required>
                        <option value="">Select reviewer...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Reason</label>
                    <textarea id="modal-reason" rows="3" class="mt-1 w-full rounded-md border-gray-300" placeholder="Explain why this new standard value is needed..."></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">
                        Submit Request
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase configuration
        // Supabase configuration
const SUPABASE_URL = 'https://mvftaaxgdygeyzcvzqfr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12ZnRhYXhnZHlnZXl6Y3Z6cWZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjI3OTQsImV4cCI6MjA3NDE5ODc5NH0.nj5c_AAEg4U2qlcE1vQDMWt0nfXpmUYR1lrTR6KCIDY';

// Use window property to avoid "already declared" identifier errors
if (window.supabase && !window.supabaseClient) {
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}

// Map the local variable to the global client instance
var supabase = window.supabaseClient;
        // Global state
        let currentUser = null;
        let currentProject = null;
        let attributeSelections = {};
        let attributeOrder = [];
        let includeHeaders = {};
        let uomList = [];
        let countriesList = [];
        let allProjects = [];
        let nextSerial = 1;
let requestsData = [];
let historyData = [];
let isCardView = true;
// MD5 hash function to match database
function md5(string) {
    function md5cycle(x, k) {
        var a = x[0], b = x[1], c = x[2], d = x[3];
        a = ff(a, b, c, d, k[0], 7, -680876936);
        d = ff(d, a, b, c, k[1], 12, -389564586);
        c = ff(c, d, a, b, k[2], 17, 606105819);
        b = ff(b, c, d, a, k[3], 22, -1044525330);
        a = ff(a, b, c, d, k[4], 7, -176418897);
        d = ff(d, a, b, c, k[5], 12, 1200080426);
        c = ff(c, d, a, b, k[6], 17, -1473231341);
        b = ff(b, c, d, a, k[7], 22, -45705983);
        a = ff(a, b, c, d, k[8], 7, 1770035416);
        d = ff(d, a, b, c, k[9], 12, -1958414417);
        c = ff(c, d, a, b, k[10], 17, -42063);
        b = ff(b, c, d, a, k[11], 22, -1990404162);
        a = ff(a, b, c, d, k[12], 7, 1804603682);
        d = ff(d, a, b, c, k[13], 12, -40341101);
        c = ff(c, d, a, b, k[14], 17, -1502002290);
        b = ff(b, c, d, a, k[15], 22, 1236535329);
        a = gg(a, b, c, d, k[1], 5, -165796510);
        d = gg(d, a, b, c, k[6], 9, -1069501632);
        c = gg(c, d, a, b, k[11], 14, 643717713);
        b = gg(b, c, d, a, k[0], 20, -373897302);
        a = gg(a, b, c, d, k[5], 5, -701558691);
        d = gg(d, a, b, c, k[10], 9, 38016083);
        c = gg(c, d, a, b, k[15], 14, -660478335);
        b = gg(b, c, d, a, k[4], 20, -405537848);
        a = gg(a, b, c, d, k[9], 5, 568446438);
        d = gg(d, a, b, c, k[14], 9, -1019803690);
        c = gg(c, d, a, b, k[3], 14, -187363961);
        b = gg(b, c, d, a, k[8], 20, 1163531501);
        a = gg(a, b, c, d, k[13], 5, -1444681467);
        d = gg(d, a, b, c, k[2], 9, -51403784);
        c = gg(c, d, a, b, k[7], 14, 1735328473);
        b = gg(b, c, d, a, k[12], 20, -1926607734);
        a = hh(a, b, c, d, k[5], 4, -378558);
        d = hh(d, a, b, c, k[8], 11, -2022574463);
        c = hh(c, d, a, b, k[11], 16, 1839030562);
        b = hh(b, c, d, a, k[14], 23, -35309556);
        a = hh(a, b, c, d, k[1], 4, -1530992060);
        d = hh(d, a, b, c, k[4], 11, 1272893353);
        c = hh(c, d, a, b, k[7], 16, -155497632);
        b = hh(b, c, d, a, k[10], 23, -1094730640);
        a = hh(a, b, c, d, k[13], 4, 681279174);
        d = hh(d, a, b, c, k[0], 11, -358537222);
        c = hh(c, d, a, b, k[3], 16, -722521979);
        b = hh(b, c, d, a, k[6], 23, 76029189);
        a = hh(a, b, c, d, k[9], 4, -640364487);
        d = hh(d, a, b, c, k[12], 11, -421815835);
        c = hh(c, d, a, b, k[15], 16, 530742520);
        b = hh(b, c, d, a, k[2], 23, -995338651);
        a = ii(a, b, c, d, k[0], 6, -198630844);
        d = ii(d, a, b, c, k[7], 10, 1126891415);
        c = ii(c, d, a, b, k[14], 15, -1416354905);
        b = ii(b, c, d, a, k[5], 21, -57434055);
        a = ii(a, b, c, d, k[12], 6, 1700485571);
        d = ii(d, a, b, c, k[3], 10, -1894986606);
        c = ii(c, d, a, b, k[10], 15, -1051523);
        b = ii(b, c, d, a, k[1], 21, -2054922799);
        a = ii(a, b, c, d, k[8], 6, 1873313359);
        d = ii(d, a, b, c, k[15], 10, -30611744);
        c = ii(c, d, a, b, k[6], 15, -1560198380);
        b = ii(b, c, d, a, k[13], 21, 1309151649);
        a = ii(a, b, c, d, k[4], 6, -145523070);
        d = ii(d, a, b, c, k[11], 10, -1120210379);
        c = ii(c, d, a, b, k[2], 15, 718787259);
        b = ii(b, c, d, a, k[9], 21, -343485551);
        x[0] = add32(a, x[0]);
        x[1] = add32(b, x[1]);
        x[2] = add32(c, x[2]);
        x[3] = add32(d, x[3]);
    }
    function cmn(q, a, b, x, s, t) {
        a = add32(add32(a, q), add32(x, t));
        return add32((a << s) | (a >>> (32 - s)), b);
    }
    function ff(a, b, c, d, x, s, t) {
        return cmn((b & c) | ((~b) & d), a, b, x, s, t);
    }
    function gg(a, b, c, d, x, s, t) {
        return cmn((b & d) | (c & (~d)), a, b, x, s, t);
    }
    function hh(a, b, c, d, x, s, t) {
        return cmn(b ^ c ^ d, a, b, x, s, t);
    }
    function ii(a, b, c, d, x, s, t) {
        return cmn(c ^ (b | (~d)), a, b, x, s, t);
    }
    function md51(s) {
        var n = s.length,
            state = [1732584193, -271733879, -1732584194, 271733878], i;
        for (i = 64; i <= s.length; i += 64) {
            md5cycle(state, md5blk(s.substring(i - 64, i)));
        }
        s = s.substring(i - 64);
        var tail = [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0];
        for (i = 0; i < s.length; i++)
            tail[i>>2] |= s.charCodeAt(i) << ((i%4) << 3);
        tail[i>>2] |= 0x80 << ((i%4) << 3);
        if (i > 55) {
            md5cycle(state, tail);
            for (i = 0; i < 16; i++) tail[i] = 0;
        }
        tail[14] = n*8;
        md5cycle(state, tail);
        return state;
    }
    function md5blk(s) {
        var md5blks = [], i;
        for (i = 0; i < 64; i += 4) {
            md5blks[i>>2] = s.charCodeAt(i)
            + (s.charCodeAt(i+1) << 8)
            + (s.charCodeAt(i+2) << 16)
            + (s.charCodeAt(i+3) << 24);
        }
        return md5blks;
    }
    var hex_chr = '0123456789abcdef'.split('');
    function rhex(n) {
        var s='', j=0;
        for(; j<4; j++)
            s += hex_chr[(n >> (j * 8 + 4)) & 0x0F]
            + hex_chr[(n >> (j * 8)) & 0x0F];
        return s;
    }
    function hex(x) {
        for (var i=0; i<x.length; i++)
            x[i] = rhex(x[i]);
        return x.join('');
    }
    function add32(a, b) {
        return (a + b) & 0xFFFFFFFF;
    }
    return hex(md51(string));
}
// Enhanced function to get next variation number including pending requests
async function getNextVariationNumber(projectId, baseSignature) {
    try {
        console.log('√É¬∞√Ö¬∏√¢‚Ç¨¬ù√Ç¬ç Getting next variation number for base signature:', baseSignature);
        
        // Query ALL variations (approved AND pending) with same base signature
        const { data: existingVariations, error } = await supabase
            .from('item_code_workflow')
            .select('variation_number, item_code, status')
            .eq('project_id', projectId)
            .eq('base_combination_signature', baseSignature)
            .eq('is_variation', true)
            .order('variation_number', { ascending: false });
            
        if (error) {
            console.error('Error fetching variations:', error);
            return 1; // Default to first variation
        }
        
        console.log('Existing variations found:', existingVariations);
        
        if (!existingVariations || existingVariations.length === 0) {
            console.log('No existing variations found, starting with /1');
            return 1;
        }
        
        // Get the highest variation number (including pending ones)
        const maxVariationNumber = Math.max(...existingVariations.map(v => v.variation_number || 0));
        const nextVariation = maxVariationNumber + 1;
        
        console.log(`Highest existing variation: /${maxVariationNumber}, next will be: /${nextVariation}`);
        console.log('Variation breakdown:', existingVariations.map(v => `${v.item_code} (${v.status}) = /${v.variation_number}`));
        
        return nextVariation;
        
    } catch (error) {
        console.error('Error in getNextVariationNumber:', error);
        return 1;
    }
}
// Function to get next serial number by checking existing codes
async function getNextSerialNumber() {
    try {
        console.log('Getting next serial for project:', currentProject.id);
        
        // Simple approach - just get the highest serial from existing records
        let highestSerial = 0;
        
        // Check item_code_workflow table (unified table)
        const { data: workflowCodes } = await supabase
            .from('item_code_workflow')
            .select('serial_number')
            .eq('project_id', currentProject.id)
            .order('serial_number', { ascending: false })
            .limit(1);
            
        if (workflowCodes && workflowCodes.length > 0) {
            highestSerial = Math.max(highestSerial, workflowCodes[0].serial_number || 0);
        }
        
        const nextSerial = highestSerial + 1;
        console.log('Calculated next serial:', nextSerial);
        return nextSerial;
        
    } catch (error) {
        console.error('Error getting serial:', error);
        return 1;
    }
}
// Function to check if combination already exists
// Enhanced duplicate checking with variation support
async function checkCombinationExists(combination, uom, country, modelNumber, unitPrice, currency, manufacturer) {
    if (!currentProject) return { exists: false };
    
    try {
        console.log(' Checking duplicates with VARIATION logic...');
        
        const baseSignature = getBaseCombinationSignature();
        const variationSignature = getVariationFieldsSignature();
        
        console.log(' Base signature (attributes):', baseSignature);
        console.log(' Variation signature (UOM/manufacturer/model/country):', variationSignature);
        
        // Check existing approved codes
        const { data: existingCodes, error: codeError } = await supabase
            .from('item_code_workflow')
            .select(`
                id, item_code, base_combination_signature, variation_fields_signature, 
                is_variation, variation_number, variation_suffix,
                uom, country_of_origin, model_number, manufacturer
            `)
            .eq('project_id', currentProject.id)
            .eq('status', 'admin_approved');
            
        if (codeError) {
            console.error('Error checking existing codes:', codeError);
            return { exists: false, error: codeError.message };
        }
        
        if (existingCodes && existingCodes.length > 0) {
            // Check for exact duplicate (same base + same variation)
            const exactMatch = existingCodes.find(code => {
                // For existing codes without variation fields, fall back to field comparison
                if (code.base_combination_signature) {
                    return code.base_combination_signature === baseSignature && 
                           code.variation_fields_signature === variationSignature;
                } else {
                    // Legacy comparison for existing data
                    return code.uom === uom && 
                           code.country_of_origin === country && 
                           (code.model_number || '') === (modelNumber || '') &&
                           (code.manufacturer || '') === (manufacturer || '');
                }
            });
            
            if (exactMatch) {
                console.log('EXACT DUPLICATE found:', exactMatch);
                return { 
                    exists: true, 
                    type: 'approved code', 
                    code: exactMatch.item_code,
                    isDuplicate: true
                };
            }
            
            // Check if base combination exists (same attributes)
            const baseMatches = existingCodes.filter(code => {
                if (code.base_combination_signature) {
                    return code.base_combination_signature === baseSignature;
                } else {
                    // Legacy: compare by combination signature for old data
                    return code.item_code && baseSignature; // Basic fallback
                }
            });
            
            if (baseMatches.length > 0) {
                // Base combination exists but different variation - can create variation
                const baseItem = baseMatches.find(code => !code.is_variation) || baseMatches[0];
                
                console.log('√É¬∞√Ö¬∏√¢‚Ç¨¬ù√Ç¬ç Base combination exists, checking for ALL variations including pending...');
                
                // Get next variation number using the enhanced function that checks ALL statuses
                const nextVariationNumber = await getNextVariationNumber(currentProject.id, baseSignature);
                
                console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Base combination exists, can create variation');
                console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ö¬† Approved variations found:', baseMatches.length);
                console.log('√É¬∞√Ö¬∏√¢‚Ç¨¬ù√Ç¬¢ Next variation number will be:', nextVariationNumber);
                
                return { 
                    exists: false, 
                    canCreateVariation: true,
                    baseItemCode: baseItem.item_code,
                    existingVariations: baseMatches.length,
                    willBeVariation: true,
                    nextVariationNumber: nextVariationNumber
                };
            }
        }
        
        // Check existing requests for conflicts
        const { data: existingRequests, error: requestError } = await supabase
            .from('item_code_workflow')
            .select(`
                id, item_code, base_combination_signature, variation_fields_signature,
                uom, country_of_origin, model_number, manufacturer
            `)
            .eq('project_id', currentProject.id)
            .in('status', ['pending', 'reviewer_approved']);
            
        if (!requestError && existingRequests && existingRequests.length > 0) {
            const exactRequestMatch = existingRequests.find(request => {
                if (request.base_combination_signature) {
                    return request.base_combination_signature === baseSignature && 
                           request.variation_fields_signature === variationSignature;
                } else {
                    // Legacy comparison
                    return request.uom === uom && 
                           request.country_of_origin === country && 
                           (request.model_number || '') === (modelNumber || '') &&
                           (request.manufacturer || '') === (manufacturer || '');
                }
            });
            
            if (exactRequestMatch) {
                console.log('EXACT DUPLICATE found in requests:', exactRequestMatch);
                return { 
                    exists: true, 
                    type: 'pending request', 
                    code: exactRequestMatch.item_code,
                    isDuplicate: true
                };
            }
        }
        
        // No conflicts found
        console.log(' No duplicates found - safe to proceed');
        return { 
            exists: false, 
            canCreateVariation: false, 
            willBeVariation: false 
        };
        
    } catch (error) {
        console.error('Error in enhanced duplicate checking:', error);
        return { exists: false, error: error.message };
    }
}

// MD5 hash function for client-side
async function generateMD5Hash(input) {
    // Use crypto-js or a simple MD5 implementation
    // For now, let's use a simple approach that should match
    const encoder = new TextEncoder();
    const data = encoder.encode(input);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32);
}
// Fallback function if hash generation fails
async function checkFallbackDuplicates(combination, uom, country, modelNumber) {
    // Simple fallback using combination signature
    const { data: requests, error } = await supabase
        .from('item_code_workflow')
        .select('id, item_code')
        .eq('project_id', currentProject.id)
        .eq('combination_signature', combination)
        .eq('uom', uom)
        .eq('country_of_origin', country)
        .eq('model_number', modelNumber || null)
        .in('status', ['pending', 'admin_approved']);
        
    if (!error && requests && requests.length > 0) {
        return { exists: true, type: 'pending request', code: requests[0].item_code };
    }
    
    return { exists: false };
}

// ===== VARIATION PREVIEW FUNCTIONS =====

// Show variation preview to user
function showVariationPreview(duplicateCheck) {
    const variationInfo = document.getElementById('variation-info');
    const baseItemCode = document.getElementById('base-item-code');
    const variationPreviewCode = document.getElementById('variation-preview-code');
    const existingVariationsCount = document.getElementById('existing-variations-count');
    
    if (duplicateCheck.willBeVariation && variationInfo) {
        variationInfo.classList.remove('hidden');
        
        if (baseItemCode) baseItemCode.textContent = duplicateCheck.baseItemCode;
        
        const nextVariationCode = `${duplicateCheck.baseItemCode}/${duplicateCheck.nextVariationNumber}`;
        if (variationPreviewCode) variationPreviewCode.textContent = nextVariationCode;
        
        if (existingVariationsCount) {
            existingVariationsCount.textContent = `${duplicateCheck.existingVariations} existing`;
        }
        
        console.log(' Showing variation preview:', {
            baseCode: duplicateCheck.baseItemCode,
            variationCode: nextVariationCode,
            existingCount: duplicateCheck.existingVariations
        });
    } else {
        variationInfo?.classList.add('hidden');
    }
}

// Hide variation preview
function hideVariationPreview() {
    const variationInfo = document.getElementById('variation-info');
    variationInfo?.classList.add('hidden');
}

// Check if this creates a variation and show preview
async function checkForVariationPreview() {
    if (!currentProject || !allRequiredFieldsFilled()) {
        hideVariationPreview();
        return;
    }
    
    try {
        const uom = document.getElementById('uom-select')?.value;
        const country = document.getElementById('country-select')?.value;
        const modelNumber = document.getElementById('model-number')?.value;
        const unitPrice = document.getElementById('unit-price')?.value;
        const currency = document.getElementById('currency-select')?.value;
        const manufacturer = document.getElementById('manufacturer-select')?.value;
        
        if (!uom || !country || !unitPrice || !currency) {
            hideVariationPreview();
            return;
        }
        
        const combination = getCombinationSignature();
        if (!combination) {
            hideVariationPreview();
            return;
        }
        
        const duplicateCheck = await checkCombinationExists(
            combination, uom, country, modelNumber, unitPrice, currency, manufacturer
        );
        
        if (duplicateCheck.willBeVariation) {
            showVariationPreview(duplicateCheck);
        } else {
            hideVariationPreview();
        }
    } catch (error) {
        console.error('Error checking variation preview:', error);
        hideVariationPreview();
    }
}

// Check if all required fields are filled for preview
function allRequiredFieldsFilled() {
    if (!currentProject?.attributes) return false;
    
    const allMandatory = currentProject.attributes.every(attr => 
        !attr.is_mandatory || attributeSelections[attr.attribute_id]
    );
    
    const uom = document.getElementById('uom-select')?.value;
    const country = document.getElementById('country-select')?.value;
    const unitPrice = document.getElementById('unit-price')?.value;
    const currency = document.getElementById('currency-select')?.value;
    
    return allMandatory && uom && country && unitPrice && currency;
}

// Setup variation preview listeners
function setupVariationPreviewListeners() {
    const fieldsToWatch = ['uom-select', 'manufacturer-select', 'model-number', 'country-select', 'unit-price', 'currency-select'];
    
    fieldsToWatch.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', debounce(checkForVariationPreview, 300));
            field.addEventListener('input', debounce(checkForVariationPreview, 500));
        }
    });
}

let draggedItem = null;
        let canReorder = true;
        
        

        // Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded');
    
    // Check for required elements with more comprehensive validation
    const requiredElements = [
        'login-modal',
        'main-container', 
        'division-select',
        'section-select',
        'detailed-section-select',
        'item-code-select',
        'additional-level-select',
        'selected-project-display',
        'project-details'
    ];
    
    const missingElements = requiredElements.filter(id => {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`Missing required element: ${id}`);
            return true;
        }
        return false;
    });
    
    if (missingElements.length > 0) {
        console.error('Missing required elements:', missingElements);
        alert('Page not loaded correctly. Missing elements: ' + missingElements.join(', '));
        return;
    }
    
    console.log('All required elements found, setting up login form...');
    setupLoginForm();
});     

// Setup login form
        function setupLoginForm() {
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                try {
                    const { data, error } = await supabase.rpc('authenticate_user', {
                        email_param: email,
                        password_param: password
                    });

                    if (error) throw error;

                    if (data && data.success) {
                        currentUser = data.user;
                        document.getElementById('login-modal').classList.add('hidden');
                        document.getElementById('main-container').classList.remove('hidden');
                        initializeApp();
                    } else {
                        throw new Error(data?.message || 'Login failed');
                    }
                } catch (error) {
                    document.getElementById('login-error').textContent = error.message;
                    document.getElementById('login-error').classList.remove('hidden');
                }
            });
        }

        // Initialize app after login
        // Initialize app after login
async function initializeApp() {
    try {
        console.log('Initializing app for user:', currentUser);
        
        document.getElementById('user-info').textContent = `${currentUser.username} (${currentUser.role})`;
        
        // MIGRATION: Run migration for additional level ordering (only for admin)
        if (currentUser.role === 'admin') {
            console.log('Running additional level migration for admin user...');
            try {
                const { data: migrationResult, error: migrationError } = await supabase.rpc('migrate_existing_additional_levels');
                if (migrationError) {
                    console.warn('Migration warning:', migrationError);
                } else {
                    console.log('Migration completed successfully:', migrationResult);
                }
            } catch (migrationError) {
                console.warn('Migration failed (non-critical):', migrationError);
            }
        }
        
        // Show admin tab if admin
if (currentUser.role === 'admin') {
    console.log(' Admin user detected, showing admin tab');
    document.getElementById('admin-tab').classList.remove('hidden');
}

// Show ERP tab if ERP data entry or admin
if (currentUser.role === 'erp_data_entry' || currentUser.role === 'admin') {
    console.log(' ERP access granted for role:', currentUser.role, 'showing ERP tab');
    const erpTabBtn = document.getElementById('erp-tab-button');
    if (erpTabBtn) {
        erpTabBtn.classList.remove('hidden');
        console.log('ERP tab button is now visible');
    } else {
        console.error('ERP tab button element not found!');
    }
} else {
    console.log('ERP access denied for role:', currentUser.role);
}

        // Load initial data in sequence to avoid race conditions
        console.log('Loading UOMs...');
        await loadUOMs();
        
        console.log('Loading countries...');
        await loadCountries();
        
        console.log('Loading reviewers...');
        await loadReviewers();
        
        console.log('Loading currencies...');
        await loadCurrencies();
        
        console.log('Loaded approved projects...');
        await loadApprovedProjects();

        // Debug: Show some example projects with their CSI codes
        if (allProjects && allProjects.length > 0) {
            console.log('=== DEBUGGING CSI CODES ===');
            allProjects.slice(0, 5).forEach((project, index) => {
                console.log(`Project ${index + 1}:`, {
                    project_id: project.project_id,
                    project_name: project.project_name,
                    division_code: project.division_code,
                    section_code: project.section_code, 
                    detailed_section_code: project.detailed_section_code,
                    item_code: project.item_code,
                    additional_level_name: project.additional_level_name,
                    additional_level_value: project.additional_level_value
                });
            });
            console.log('=== END DEBUGGING ===');
        }

        console.log('Setting up event listeners...');
        setupEventListeners();
        
        console.log('App initialization completed successfully');
        
    } catch (error) {
        console.error('Error during app initialization:', error);
        alert('Failed to initialize application. Please refresh the page and try again.');
    }
}
        // Load approved projects and setup cascading dropdowns
async function loadApprovedProjects() {
    try {
        const { data, error } = await supabase.rpc('get_all_approved_projects');
        
        if (error) {
            console.error('Projects error:', error);
            throw error;
        }

        allProjects = data || [];
        console.log('RAW PROJECT DATA:', allProjects);

        // Check what's actually in the first project
        if (allProjects.length > 0) {
            console.log('First project structure:', allProjects[0]);
            console.log('First project attributes:', allProjects[0].attributes);
            console.log('=== ALL FIELD NAMES IN FIRST PROJECT ===');
            console.log('Available fields:', Object.keys(allProjects[0]));
            console.log('Division field value:', allProjects[0].division_code);
            console.log('Section field value:', allProjects[0].section_code);
            console.log('Detailed section field value:', allProjects[0].detailed_section_code);
            console.log('Item field value:', allProjects[0].item_code);
            console.log('=== END FIELD DEBUG ===');
        }
        
        // Fix missing item_description for each project
        allProjects = allProjects.map(project => {
            if (!project.item_description) {
                // Use project_name or a default description
                project.item_description = project.project_name || 'No description available';
            }
            
            // Ensure attributes is always an array
            if (!project.attributes || project.attributes === null) {
                project.attributes = [];
            }
            
            // Filter out null attributes that can come from LEFT JOIN
            if (Array.isArray(project.attributes)) {
                project.attributes = project.attributes.filter(attr => 
                    attr && attr.attribute_id && attr.attribute_name
                );
            }
            
            return project;
        });
        
        setupCascadingDropdowns();
        setupProjectSearch();
        setupSearchCodesTab();
    } catch (error) {
        console.error('Error loading projects:', error);
        alert('Failed to load projects. Please check console for details.');
    }
}
       // Setup cascading dropdowns
function setupCascadingDropdowns() {
    // Initialize dropdown elements
    const divisionSelect = document.getElementById('division-select');
    const sectionSelect = document.getElementById('section-select');
    const detailedSectionSelect = document.getElementById('detailed-section-select');
    const itemCodeSelect = document.getElementById('item-code-select');
    const additionalLevelSelect = document.getElementById('additional-level-select');
    
    if (!divisionSelect || !sectionSelect || !detailedSectionSelect || !itemCodeSelect || !additionalLevelSelect) {
        console.error('One or more cascading dropdown elements not found');
        return;
    }
    
    // Setup event listeners for cascading behavior
    divisionSelect.addEventListener('change', handleDivisionChange);
    sectionSelect.addEventListener('change', handleSectionChange);
    detailedSectionSelect.addEventListener('change', handleDetailedSectionChange);
    itemCodeSelect.addEventListener('change', handleItemCodeChange);
    additionalLevelSelect.addEventListener('change', handleAdditionalLevelChange);
    
    // Load initial divisions
    loadDivisions();
}

// Load divisions that have approved projects
async function loadDivisions() {
    try {
        const divisionSelect = document.getElementById('division-select');
        divisionSelect.innerHTML = '<option value="">Choose division...</option>';
        
        // Get divisions using the proper RPC function
        const { data: divisionsData, error } = await supabase.rpc('get_divisions');
        
        if (error) {
            console.error('Error loading divisions:', error);
            throw error;
        }
        
        // Get unique divisions from approved projects to filter
        const approvedDivisions = [...new Set(allProjects.map(p => p.division_code))];
        
        // Filter divisions to only show those with approved projects
        const availableDivisions = divisionsData.filter(division => 
            approvedDivisions.includes(division.division_code)
        ).sort((a, b) => a.division_code.localeCompare(b.division_code));
        
        availableDivisions.forEach(division => {
            const option = document.createElement('option');
            option.value = division.division_code;
            option.textContent = `${division.division_code} - ${division.division_description}`;
            divisionSelect.appendChild(option);
        });
        
        console.log('Loaded divisions:', availableDivisions.length);
    } catch (error) {
        console.error('Error loading divisions:', error);
    }
}

// Handle division selection
async function handleDivisionChange(e) {
    const selectedDivision = e.target.value;
    
    // Reset and disable subsequent dropdowns
    resetDropdown('section-select', 'Choose section...');
    resetDropdown('detailed-section-select', 'Choose detailed section...');
    resetDropdown('item-code-select', 'Choose item code...');
    resetDropdown('additional-level-select', 'Choose additional level...');
    
    disableDropdown('detailed-section-select');
    disableDropdown('item-code-select');
    disableDropdown('additional-level-select');
    
    if (selectedDivision) {
        await loadSections(selectedDivision);
        enableDropdown('section-select');
    } else {
        disableDropdown('section-select');
    }
}

// Load sections for selected division
async function loadSections(divisionCode) {
    try {
        const sectionSelect = document.getElementById('section-select');
        sectionSelect.innerHTML = '<option value="">Choose section...</option>';
        
        // Get sections using the proper RPC function
        const { data: sectionsData, error } = await supabase.rpc('get_sections', {
            division_code_param: divisionCode
        });
        
        if (error) {
            console.error('Error loading sections:', error);
            throw error;
        }
        
        // Get unique sections from approved projects to filter
        // Include sections that might be duplicated as detailed sections
        const approvedSections = [...new Set(
            allProjects
                .filter(p => p.division_code === divisionCode)
                .flatMap(p => [p.section_code, p.detailed_section_code]) // Include both section and detailed section codes
                .filter(code => code) // Remove null/undefined values
        )];
        
        // Filter sections to only show those with approved projects
        const availableSections = sectionsData.filter(section => 
            approvedSections.includes(section.section_code)
        ).sort((a, b) => a.section_code.localeCompare(b.section_code));
        
        availableSections.forEach(section => {
            const option = document.createElement('option');
            option.value = section.section_code;
            option.textContent = `${section.section_code} - ${section.section_description}`;
            sectionSelect.appendChild(option);
        });
        
        console.log('Loaded sections for', divisionCode, ':', availableSections.length);
    } catch (error) {
        console.error('Error loading sections:', error);
    }
}

// Handle section selection
async function handleSectionChange(e) {
    const selectedSection = e.target.value;
    const selectedDivision = document.getElementById('division-select').value;
    
    // Reset and disable subsequent dropdowns
    resetDropdown('detailed-section-select', 'Choose detailed section...');
    resetDropdown('item-code-select', 'Choose item code...');
    resetDropdown('additional-level-select', 'Choose additional level...');
    
    disableDropdown('item-code-select');
    disableDropdown('additional-level-select');
    
    if (selectedSection) {
        await loadDetailedSections(selectedDivision, selectedSection);
        enableDropdown('detailed-section-select');
    } else {
        disableDropdown('detailed-section-select');
    }
}

// Load detailed sections for selected division and section
async function loadDetailedSections(divisionCode, sectionCode) {
    try {
        const detailedSectionSelect = document.getElementById('detailed-section-select');
        detailedSectionSelect.innerHTML = '<option value="">Choose detailed section...</option>';
        
        // First, get unique detailed sections from approved projects for this division/section
        const matchingProjects = allProjects.filter(p => p.division_code === divisionCode && p.section_code === sectionCode);
        console.log('Matching projects for detailed sections:', matchingProjects.length, matchingProjects);
        
        const projectDetailedSections = [...new Set(
            matchingProjects
                .map(p => p.detailed_section_code)
                .filter(code => code) // Remove null/undefined values
        )];
        
        console.log('Project detailed sections found:', projectDetailedSections);
        console.log('Looking for division:', divisionCode, 'section:', sectionCode);
        
        // Try to get detailed sections using the RPC function
        let availableDetailedSections = [];
        
        try {
            const { data: detailedSectionsData, error } = await supabase.rpc('get_detailed_sections', {
                division_code_param: divisionCode,
                section_code_param: sectionCode
            });
            
            if (error) {
                console.warn('RPC call failed, using project data directly:', error);
                throw error;
            }
            
            console.log('RPC detailed sections data:', detailedSectionsData);
            
            // Filter detailed sections using RPC data
            availableDetailedSections = detailedSectionsData.filter(detailedSection => 
                projectDetailedSections.includes(detailedSection.detailed_section_code)
            );
            
            console.log('Filtered RPC detailed sections:', availableDetailedSections);
            
            // If RPC filtering returns empty but we have project detailed sections, use fallback
            if (availableDetailedSections.length === 0 && projectDetailedSections.length > 0) {
                console.log('RPC filtering returned empty, falling back to project data');
                throw new Error('RPC filtering returned empty results');
            }
            
        } catch (rpcError) {
            // If RPC fails (common with duplicate levels), create options directly from project data
            console.log('Using direct project data for detailed sections due to RPC error:', rpcError);
            
            availableDetailedSections = projectDetailedSections.map(detailedSectionCode => {
                // Find a project with this detailed section code to get description
                const project = matchingProjects.find(p => p.detailed_section_code === detailedSectionCode);
                
                console.log('Found project for detailed section', detailedSectionCode, ':', project);
                
                // For duplicate levels, try to get the proper description from the CSI hierarchy
                // If detailed_section_code equals section_code, use section description
                let description = 'No description available';
                
                if (project) {
                    if (project.detailed_section_description && project.detailed_section_description.trim() !== '') {
                        description = project.detailed_section_description;
                    } else if (project.section_description && project.section_description.trim() !== '') {
                        description = project.section_description;
                    } else if (project.project_name && project.project_name.trim() !== '') {
                        description = project.project_name;
                    }
                }
                
                return {
                    detailed_section_code: detailedSectionCode,
                    detailed_section_description: description
                };
            });
            
            console.log('Created detailed sections from project data:', availableDetailedSections);
        }
        
        // Sort available detailed sections
        availableDetailedSections.sort((a, b) => a.detailed_section_code.localeCompare(b.detailed_section_code));
        
        availableDetailedSections.forEach(detailedSection => {
            const option = document.createElement('option');
            option.value = detailedSection.detailed_section_code;
            option.textContent = `${detailedSection.detailed_section_code} - ${detailedSection.detailed_section_description}`;
            detailedSectionSelect.appendChild(option);
        });
        
        console.log('Loaded detailed sections:', availableDetailedSections.length, availableDetailedSections);
    } catch (error) {
        console.error('Error loading detailed sections:', error);
    }
}

// Handle detailed section selection
async function handleDetailedSectionChange(e) {
    const selectedDetailedSection = e.target.value;
    const selectedDivision = document.getElementById('division-select').value;
    const selectedSection = document.getElementById('section-select').value;
    
    // Reset and disable subsequent dropdowns
    resetDropdown('item-code-select', 'Choose item code...');
    resetDropdown('additional-level-select', 'Choose additional level...');
    
    disableDropdown('additional-level-select');
    
    if (selectedDetailedSection) {
        await loadItemCodes(selectedDivision, selectedSection, selectedDetailedSection);
        enableDropdown('item-code-select');
    } else {
        disableDropdown('item-code-select');
    }
}

// Load item codes for selected hierarchy
async function loadItemCodes(divisionCode, sectionCode, detailedSectionCode) {
    try {
        const itemCodeSelect = document.getElementById('item-code-select');
        itemCodeSelect.innerHTML = '<option value="">Choose item code...</option>';
        
        // First, get unique item codes from approved projects for this hierarchy
        const projectItemCodes = [...new Set(
            allProjects
                .filter(p => 
                    p.division_code === divisionCode && 
                    p.section_code === sectionCode && 
                    p.detailed_section_code === detailedSectionCode
                )
                .map(p => p.item_code)
                .filter(code => code) // Remove null/undefined values
        )];
        
        console.log('Project item codes found:', projectItemCodes);
        
        // Try to get item codes using the RPC function
        let availableItemCodes = [];
        
        try {
            const { data: itemCodesData, error } = await supabase.rpc('get_items', {
                division_code_param: divisionCode,
                section_code_param: sectionCode,
                detailed_section_code_param: detailedSectionCode
            });
            
            if (error) {
                console.warn('RPC call failed, using project data directly:', error);
                throw error;
            }
            
            // Filter item codes using RPC data
            availableItemCodes = itemCodesData.filter(itemCode => 
                projectItemCodes.includes(itemCode.item_code)
            );
            
            // If RPC filtering returns empty but we have project item codes, use fallback
            if (availableItemCodes.length === 0 && projectItemCodes.length > 0) {
                console.log('RPC filtering returned empty for item codes, falling back to project data');
                throw new Error('RPC filtering returned empty results');
            }
            
        } catch (rpcError) {
            // If RPC fails (common with duplicate levels), create options directly from project data
            console.log('Using direct project data for item codes due to RPC error');
            
            availableItemCodes = projectItemCodes.map(itemCode => {
                // Find a project with this item code to get description
                const project = allProjects.find(p => 
                    p.division_code === divisionCode && 
                    p.section_code === sectionCode && 
                    p.detailed_section_code === detailedSectionCode && 
                    p.item_code === itemCode
                );
                
                // For duplicate levels, try to get the proper description
                let description = 'No description available';
                
                if (project) {
                    if (project.item_description && project.item_description.trim() !== '') {
                        description = project.item_description;
                    } else if (project.detailed_section_description && project.detailed_section_description.trim() !== '') {
                        description = project.detailed_section_description;
                    } else if (project.section_description && project.section_description.trim() !== '') {
                        description = project.section_description;
                    } else if (project.project_name && project.project_name.trim() !== '') {
                        description = project.project_name;
                    }
                }
                
                return {
                    item_code: itemCode,
                    item_description: description
                };
            });
        }
        
        // Sort available item codes
        availableItemCodes.sort((a, b) => a.item_code.localeCompare(b.item_code));
        
        availableItemCodes.forEach(itemCode => {
            const option = document.createElement('option');
            option.value = itemCode.item_code;
            option.textContent = `${itemCode.item_code} - ${itemCode.item_description}`;
            itemCodeSelect.appendChild(option);
        });
        
        console.log('Loaded item codes:', availableItemCodes.length);
    } catch (error) {
        console.error('Error loading item codes:', error);
    }
}

// Handle item code selection
function handleItemCodeChange(e) {
    const selectedItemCode = e.target.value;
    const selectedDivision = document.getElementById('division-select').value;
    const selectedSection = document.getElementById('section-select').value;
    const selectedDetailedSection = document.getElementById('detailed-section-select').value;
    
    // Reset additional level dropdown
    resetDropdown('additional-level-select', 'Choose additional level...');
    
    if (selectedItemCode) {
        loadAdditionalLevels(selectedDivision, selectedSection, selectedDetailedSection, selectedItemCode);
        enableDropdown('additional-level-select');
    } else {
        disableDropdown('additional-level-select');
    }
}

// Load additional level values for selected item code
function loadAdditionalLevels(divisionCode, sectionCode, detailedSectionCode, itemCode) {
    const additionalLevelSelect = document.getElementById('additional-level-select');
    additionalLevelSelect.innerHTML = '<option value="">Choose additional level...</option>';
    
    // Get approved projects for this exact CSI path
    const matchingProjects = allProjects.filter(p => 
        p.division_code === divisionCode && 
        p.section_code === sectionCode && 
        p.detailed_section_code === detailedSectionCode && 
        p.item_code === itemCode
    );
    
    // Group by additional level name and value
    const additionalLevels = matchingProjects.map(project => ({
        project_id: project.project_id,
        level_name: project.additional_level_name || 'Base Level',
        level_value: project.additional_level_value || 'Base Item',
        display_name: project.display_name,
        project: project
    }));
    
    additionalLevels.forEach(level => {
        const option = document.createElement('option');
        option.value = level.project_id;
        option.textContent = level.level_name && level.level_value ? 
            `${level.level_name}: ${level.level_value}` : 
            level.level_value || 'Base Level';
        option.dataset.project = JSON.stringify(level.project);
        additionalLevelSelect.appendChild(option);
    });
    
    console.log('Loaded additional levels:', additionalLevels.length);
}

// Handle final project selection
function handleAdditionalLevelChange(e) {
    const selectedProjectId = e.target.value;
    
    if (selectedProjectId) {
        const selectedOption = e.target.options[e.target.selectedIndex];
        
        if (!selectedOption.dataset.project) {
            console.error('No project data found in option');
            return;
        }
        
        try {
            const project = JSON.parse(selectedOption.dataset.project);
            console.log('Selected project from cascading dropdown:', project);
            selectProjectFromData(project);
            
            // Clear advanced search inputs
            clearAdvancedSearchInputs();
        } catch (error) {
            console.error('Error parsing project data:', error);
            alert('Error loading project data. Please try again.');
        }
    } else {
        // Reset when no project selected
        currentProject = null;
        document.getElementById('selected-project-display').classList.add('hidden');
        document.getElementById('project-details').classList.add('hidden');
    }
}

// Utility functions for dropdown management
function resetDropdown(elementId, defaultText) {
    const dropdown = document.getElementById(elementId);
    if (dropdown) {
        dropdown.innerHTML = `<option value="">${defaultText}</option>`;
    }
}

function enableDropdown(elementId) {
    const dropdown = document.getElementById(elementId);
    if (dropdown) {
        dropdown.disabled = false;
    }
}

function disableDropdown(elementId) {
    const dropdown = document.getElementById(elementId);
    if (dropdown) {
        dropdown.disabled = true;
    }
}

function clearAdvancedSearchInputs() {
    const searchInputs = [
        'search-project-name',
        'search-creator', 
        'search-csi-code',
        'search-attribute-name',
        'search-standard-value'
    ];
    
    searchInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) input.value = '';
    });
    
    const searchResultsDropdown = document.getElementById('search-results-dropdown');
    if (searchResultsDropdown) {
        searchResultsDropdown.classList.add('hidden');
    }
}

// Update cascading dropdowns to reflect selected project (when selected via advanced search)
async function updateCascadingDropdownsForProject(project) {
    if (!project) return;
    
    try {
        console.log('Updating cascading dropdowns for project:', project);
        
        // Set division
        const divisionSelect = document.getElementById('division-select');
        if (divisionSelect) {
            divisionSelect.value = project.division_code;
            console.log('Set division to:', project.division_code);
            
            // Load sections and set section
            await handleDivisionChange({ target: { value: project.division_code } });
            
            // Wait for sections to load, then set section
            await new Promise(resolve => setTimeout(resolve, 200));
            
            const sectionSelect = document.getElementById('section-select');
            if (sectionSelect) {
                // Check if the section option exists
                const sectionOption = Array.from(sectionSelect.options).find(opt => opt.value === project.section_code);
                if (sectionOption) {
                    sectionSelect.value = project.section_code;
                    console.log('Set section to:', project.section_code);
                    
                    // Load detailed sections and set detailed section
                    await handleSectionChange({ target: { value: project.section_code } });
                    
                    // Wait for detailed sections to load, then set detailed section
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    const detailedSectionSelect = document.getElementById('detailed-section-select');
                    if (detailedSectionSelect) {
                        // Check if the detailed section option exists
                        const detailedSectionOption = Array.from(detailedSectionSelect.options).find(opt => opt.value === project.detailed_section_code);
                        if (detailedSectionOption) {
                            detailedSectionSelect.value = project.detailed_section_code;
                            console.log('Set detailed section to:', project.detailed_section_code);
                            
                            // Load item codes and set item code
                            await handleDetailedSectionChange({ target: { value: project.detailed_section_code } });
                            
                            // Wait for item codes to load, then set item code
                            await new Promise(resolve => setTimeout(resolve, 200));
                            
                            const itemCodeSelect = document.getElementById('item-code-select');
                            if (itemCodeSelect) {
                                // Check if the item code option exists
                                const itemCodeOption = Array.from(itemCodeSelect.options).find(opt => opt.value === project.item_code);
                                if (itemCodeOption) {
                                    itemCodeSelect.value = project.item_code;
                                    console.log('Set item code to:', project.item_code);
                                    
                                    // Load additional levels and set final project
                                    await handleItemCodeChange({ target: { value: project.item_code } });
                                    
                                    // Wait for additional levels to load, then set project
                                    await new Promise(resolve => setTimeout(resolve, 200));
                                    
                                    const additionalLevelSelect = document.getElementById('additional-level-select');
                                    if (additionalLevelSelect) {
                                        // Check if the project option exists
                                        const projectOption = Array.from(additionalLevelSelect.options).find(opt => opt.value === project.project_id);
                                        if (projectOption) {
                                            additionalLevelSelect.value = project.project_id;
                                            console.log('Set additional level to project:', project.project_id);
                                        } else {
                                            console.warn('Project option not found in additional level dropdown');
                                        }
                                    }
                                } else {
                                    console.warn('Item code option not found:', project.item_code);
                                }
                            }
                        } else {
                            console.warn('Detailed section option not found:', project.detailed_section_code);
                        }
                    }
                } else {
                    console.warn('Section option not found:', project.section_code);
                }
            }
        }
        
        // Clear advanced search
        clearAdvancedSearchInputs();
        
    } catch (error) {
        console.error('Error updating cascading dropdowns for project:', error);
        // If there's an error, at least try to clear the advanced search
        clearAdvancedSearchInputs();
    }
}

// Setup enhanced project search
function setupProjectSearch() {
    const searchInputs = {
        projectName: document.getElementById('search-project-name'),
        creator: document.getElementById('search-creator'),
        csiCode: document.getElementById('search-csi-code'),
        attributeName: document.getElementById('search-attribute-name'),
        standardValue: document.getElementById('search-standard-value')
    };
    
    const resultsDropdown = document.getElementById('search-results-dropdown');
    const clearBtn = document.getElementById('clear-search-btn');
    
    // Add event listeners to all search inputs
    Object.values(searchInputs).forEach(input => {
        input.addEventListener('input', debounce(performAdvancedSearch, 300));
        input.addEventListener('focus', performAdvancedSearch);
    });
    
    // Clear search functionality
    clearBtn.addEventListener('click', () => {
        Object.values(searchInputs).forEach(input => {
            input.value = '';
        });
        resultsDropdown.classList.add('hidden');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.bg-gray-50')) {
            resultsDropdown.classList.add('hidden');
        }
    });
    
    function performAdvancedSearch() {
    console.log('Performing advanced search...');
    console.log('Available projects:', allProjects.length);
    
    if (!allProjects || allProjects.length === 0) {
        console.warn('No projects available for search');
        resultsDropdown.innerHTML = '<div class="project-option text-red-500">No projects loaded. Please refresh the page.</div>';
        resultsDropdown.classList.remove('hidden');
        return;
    }
    
    const criteria = {
        projectName: searchInputs.projectName.value.toLowerCase().trim(),
        creator: searchInputs.creator.value.toLowerCase().trim(),
        csiCode: searchInputs.csiCode.value.toLowerCase().trim(),
        attributeName: searchInputs.attributeName.value.toLowerCase().trim(),
        standardValue: searchInputs.standardValue.value.toLowerCase().trim()
    };
    
    console.log('Search criteria:', criteria);
    
    // Check if any search criteria is provided
    const hasSearchCriteria = Object.values(criteria).some(value => value.length > 0);
    
    if (!hasSearchCriteria) {
        resultsDropdown.classList.add('hidden');
        return;
    }
    
    const filtered = allProjects.filter(project => {
        let matches = true;
        
        // Project name search
        if (criteria.projectName) {
            const projectName = (project.project_name || '').toLowerCase();
            if (!projectName.includes(criteria.projectName)) {
                matches = false;
            }
        }
        
        // Creator search (if available in project data)
        if (criteria.creator) {
            const creatorName = (project.creator_name || '').toLowerCase();
            if (!creatorName.includes(criteria.creator)) {
                matches = false;
            }
        }
        
        // CSI Code search (search across all CSI levels)
        if (criteria.csiCode) {
            const csiText = `${project.division_code || ''} ${project.section_code || ''} ${project.detailed_section_code || ''} ${project.item_code || ''}`.toLowerCase();
            if (!csiText.includes(criteria.csiCode)) {
                matches = false;
            }
        }
        
        // Attribute name search
        if (criteria.attributeName && project.attributes) {
            const hasMatchingAttribute = project.attributes.some(attr => 
                attr && attr.attribute_name && attr.attribute_name.toLowerCase().includes(criteria.attributeName)
            );
            if (!hasMatchingAttribute) {
                matches = false;
            }
        }
        
        // Standard value search
        if (criteria.standardValue && project.attributes) {
            const hasMatchingValue = project.attributes.some(attr => 
                attr && attr.standard_values && Array.isArray(attr.standard_values) && 
                attr.standard_values.some(val => 
                    val && val.name && val.name.toLowerCase().includes(criteria.standardValue)
                )
            );
            if (!hasMatchingValue) {
                matches = false;
            }
        }
        
        return matches;
    });
    
    console.log('Filtered results:', filtered.length);
    renderSearchResults(filtered);
}    
    function renderSearchResults(projects) {
        if (projects.length === 0) {
            resultsDropdown.innerHTML = '<div class="project-option text-gray-500">No projects found matching criteria</div>';
            resultsDropdown.classList.remove('hidden');
            return;
        }
        
        resultsDropdown.innerHTML = projects.map(project => {
          // Format: Only show additional level value if it exists, avoid duplication
let displayText = project.additional_level_value && project.additional_level_value.trim() !== '' 
    ? `${project.item_code} ---> ${project.additional_level_value}`
    : `${project.item_code} - ${project.item_description || 'No description'}`;

const additionalLevelText = ''; // Remove this since it's now included in displayText
                
            return `
                <div class="project-option" onclick="selectProject(${project.project_id})">
                    <div class="font-medium">${project.project_name}</div>
                    <div class="text-sm text-gray-600">
                        CSI: ${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}
                    </div>
                   <div class="text-xs text-gray-500">
    ${displayText}${additionalLevelText}
</div>
${project.creator_name ? `<div class="text-xs text-blue-600">Creator: ${project.creator_name}</div>` : ''}
${currentUser && currentUser.role === 'admin' ? `
    <div class="text-xs text-red-600">Admin View</div>
` : ''}
                </div>
            `;
        }).join('');
        
        resultsDropdown.classList.remove('hidden');
    }
    
    // Debounce function to limit search frequency
   }       // Render project dropdown
function renderProjectDropdown(projects) {
    const dropdown = document.getElementById('project-dropdown');
    
    if (projects.length === 0) {
        dropdown.innerHTML = '<div class="project-option text-gray-500">No projects found</div>';
        dropdown.classList.remove('hidden');
        return;
    }
    
    dropdown.innerHTML = projects.map(project => {
        // Format: CSI Item Code - CSI Item Description
        let displayText = `${project.item_code} - ${project.item_description || 'No description'}`;
        
        // Add additional level if exists
        const additionalLevelText = project.additional_level_value && project.additional_level_value.trim() !== ''
    ? ` ${project.additional_level_value}`
    : '';
            
        return `
            <div class="project-option" onclick="selectProject(${project.project_id})">
                <div class="font-medium">${project.project_name}</div>
                <div class="text-sm text-gray-600">
                    ${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.item_code}
                </div>
                <div class="text-xs text-gray-500">
                    ${displayText}${additionalLevelText}
                </div>
            </div>
        `;
    }).join('');
    
    dropdown.classList.remove('hidden');
}
        // Select project
        // Select project
// Select project by ID
function selectProject(projectId) {
    console.log('selectProject called with ID:', projectId);
    console.log('Available projects:', allProjects.length);
    
    if (!allProjects || allProjects.length === 0) {
        console.error('No projects available');
        alert('No projects loaded. Please refresh the page.');
        return;
    }
    
    const project = allProjects.find(p => p.project_id === projectId || p.id === projectId);
    if (!project) {
        console.error('Project not found:', projectId);
        console.log('Available project IDs:', allProjects.map(p => p.project_id || p.id));
        alert('Project not found. Please try selecting a different project.');
        return;
    }
    
    console.log('Found project:', project);
    selectProjectFromData(project);
    
    // Clear any search inputs
    const searchInputs = [
         'search-desc1', 'search-desc2', 'search-item-code', 
    'search-project-name-codes', 'search-csi-path', 'search-country',
    'search-model', 'search-uom', 'search-attributes', 'search-erp-status'
    ];
    
    searchInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) input.value = '';
    });
}
function selectProjectFromData(project) {
    console.log('Selecting project:', project);
    
    if (!project) {
        console.error('No project provided to selectProjectFromData');
        return;
    }
    
    currentProject = project;

// Load the correct next serial number for this project
getNextSerialNumber().then(serial => {
    nextSerial = serial;
    updatePreview(); // Update preview with correct serial
    console.log(`Loaded next serial for project ${project.id}: ${nextSerial}`);
}).catch(error => {
    console.error('Error loading serial:', error);
    nextSerial = 1; // Fallback
    updatePreview();
});
    
    // CRITICAL FIX: Ensure we have an 'id' field for database queries
// The RPC returns 'project_id', but we need 'id' for queries
if (!currentProject.id && currentProject.project_id) {
    currentProject.id = currentProject.project_id;
} else if (!currentProject.id) {
    console.error('Project missing both id and project_id:', currentProject);
    alert('Error: Project data is incomplete. Please refresh and try again.');
    return;
}
    
    // Ensure attributes is always an array
    if (!currentProject.attributes || currentProject.attributes === null) {
        currentProject.attributes = [];
    }
    
    // Reset attribute selections
    attributeSelections = {};
    
    // Initialize attribute order if attributes exist
    if (currentProject.attributes && currentProject.attributes.length > 0) {
        attributeOrder = [];
        // Initialize arrays and check if attributes exist
attributeOrder = [];
includeHeaders = {};

if (currentProject.attributes && Array.isArray(currentProject.attributes)) {
    currentProject.attributes.forEach((attr, index) => {
        attributeOrder[index] = index;
        includeHeaders[attr.attribute_id] = false;
    });
    console.log('Attributes initialized:', currentProject.attributes.length, 'attributes found');
} else {
    console.error('No attributes found in project:', currentProject);
}   
} else {
        attributeOrder = [];
    }

    // Update dropdown selection if it exists (for backwards compatibility)
    const projectSelect = document.getElementById('project-select');
    if (projectSelect) {
        projectSelect.value = project.project_id;
    }
    
    // Update cascading dropdowns to reflect the selected project
    updateCascadingDropdownsForProject(project);
    
    // Hide search dropdowns
    const projectDropdown = document.getElementById('project-dropdown');
    if (projectDropdown) {
        projectDropdown.classList.add('hidden');
    }
    
    const searchResultsDropdown = document.getElementById('search-results-dropdown');
    if (searchResultsDropdown) {
        searchResultsDropdown.classList.add('hidden');
    }

    // Show selected project display
    const selectedDisplay = document.getElementById('selected-project-display');
    const selectedInfo = document.getElementById('selected-project-info');
    
    if (!selectedDisplay || !selectedInfo) {
        console.error('Selected project display elements not found');
        return;
    }
    
    // Format display text correctly - avoid duplication
let displayText = project.additional_level_value && project.additional_level_value.trim() !== '' 
    ? `${project.item_code} ${project.additional_level_value}`
    : `${project.item_code} - ${project.item_description || 'No description'}`;
    
    selectedInfo.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-sm text-blue-600 font-medium">Project Name</p>
                <p class="text-gray-800">${project.project_name || 'Unnamed Project'}</p>
            </div>
            <div>
                <p class="text-sm text-blue-600 font-medium">CSI Level</p>
                <p class="text-gray-800 font-mono">${displayText}</p>
            </div>
            <div class="md:col-span-2">
                <p class="text-sm text-blue-600 font-medium mb-3">CSI Hierarchy with Descriptions</p>
                <div class="space-y-3 bg-gray-50 p-4 rounded-lg border">
                    <div class="border-l-4 border-blue-500 pl-3 py-2 bg-white rounded-md">
                        <div class="flex flex-col space-y-1">
                            <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Division</span>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-mono font-semibold text-blue-600">${project.division_code}</span>
                                <span class="text-sm text-gray-700">${project.division_description || 'No description'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-l-4 border-green-500 pl-3 py-2 bg-white rounded-md">
                        <div class="flex flex-col space-y-1">
                            <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Section</span>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-mono font-semibold text-green-600">${project.section_code}</span>
                                <span class="text-sm text-gray-700">${project.section_description || 'No description'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-l-4 border-yellow-500 pl-3 py-2 bg-white rounded-md">
                        <div class="flex flex-col space-y-1">
                            <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Detailed Section</span>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-mono font-semibold text-yellow-600">${project.detailed_section_code}</span>
                                <span class="text-sm text-gray-700">${project.detailed_section_description || 'No description'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-l-4 border-purple-500 pl-3 py-2 bg-white rounded-md">
                        <div class="flex flex-col space-y-1">
                            <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Item</span>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-mono font-semibold text-purple-600">${project.item_code}</span>
                                <span class="text-sm text-gray-700">${project.item_description || 'No description'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ${project.additional_level_value ? `
            <div class="md:col-span-2">
                <p class="text-sm text-blue-600 font-medium">Additional Level</p>
                <p class="text-gray-600 text-sm">${project.additional_level_value}</p>
            </div>
            ` : ''}
            <div class="md:col-span-2">
                <p class="text-sm text-blue-600 font-medium">Attributes</p>
                <p class="text-gray-600 text-sm">${currentProject.attributes.length} attribute(s) available</p>
            </div>
        </div>
    `;
    
    selectedDisplay.classList.remove('hidden');
    document.getElementById('project-details').classList.remove('hidden');
    
    // Hide reviewer selection for admins
    const reviewerSelect = document.getElementById('reviewer-select');
    if (reviewerSelect) {
        const reviewerDiv = reviewerSelect.closest('div');
        if (reviewerDiv && currentUser && currentUser.role === 'admin') {
            reviewerDiv.style.display = 'none';
        } else if (reviewerDiv) {
            reviewerDiv.style.display = 'block';
        }
    }
    
    console.log('About to call functions...');
    
    try {
        checkReorderability();
        renderAttributes();
        updateModalAttributes();
        loadProjectHistory();
        loadProjectManufacturers(project.project_id);
        updatePreview();
        console.log('Project selection completed successfully');
    } catch (error) {
        console.error('Error in project selection functions:', error);
    }
}        


async function loadUOMs() {
            try {
                const { data, error } = await supabase
                    .from('unit_of_measures')
                    .select('uom_name, uom_symbol')
                    .order('uom_name');
                
                if (error) {
                    console.error('UOM query error:', error);
                    throw error;
                }
                
                uomList = data || [];
                
                const uomSelect = document.getElementById('uom-select');
                const modalUnitSelect = document.getElementById('modal-unit-select');
                
                uomSelect.innerHTML = '<option value="">Select UoM...</option>';
                modalUnitSelect.innerHTML = '<option value="">Select unit (optional)...</option>';
                
                if (uomList.length === 0) {
                    const defaultUOMs = [
                        {uom_name: 'Each', uom_symbol: 'EA'},
                        {uom_name: 'Pieces', uom_symbol: 'PCS'},
                        {uom_name: 'Meter', uom_symbol: 'M'},
                        {uom_name: 'Kilogram', uom_symbol: 'KG'},
                        {uom_name: 'Liter', uom_symbol: 'L'},
                        {uom_name: 'Square Meter', uom_symbol: 'M2'},
                        {uom_name: 'Cubic Meter', uom_symbol: 'M3'}
                    ];
                    
                    defaultUOMs.forEach(uom => {
                        const option1 = document.createElement('option');
                        option1.value = uom.uom_symbol;
                        option1.textContent = `${uom.uom_name} (${uom.uom_symbol})`;
                        uomSelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = uom.uom_symbol;
                        option2.textContent = `${uom.uom_name} (${uom.uom_symbol})`;
                        modalUnitSelect.appendChild(option2);
                    });
                } else {
                    uomList.forEach(uom => {
                        const option1 = document.createElement('option');
                        option1.value = uom.uom_symbol || uom.uom_name;
                        option1.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
                        uomSelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = uom.uom_symbol || uom.uom_name;
                        option2.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
                        modalUnitSelect.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('Error loading UOMs:', error);
            }
        }

        // Load countries
        async function loadCountries() {
            try {
                const { data, error } = await supabase
                    .from('countries')
                    .select('id, country_name, country_code')
                    .eq('is_active', true)
                    .order('country_name');
                
                if (error) {
                    console.error('Countries error:', error);
                    throw error;
                }
                
                countriesList = data || [];
                
                const countrySelect = document.getElementById('country-select');
                countrySelect.innerHTML = '<option value="">Select country...</option>';
                
                if (countriesList.length === 0) {
                    const defaultCountries = ['Saudi Arabia', 'United States', 'China', 'Germany', 'Japan'];
                    defaultCountries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        countrySelect.appendChild(option);
                    });
                } else {
                    countriesList.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.country_name;
                        option.textContent = country.country_name;
                        countrySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // Load reviewers
        async function loadReviewers() {
            try {
                const { data, error } = await supabase.rpc('get_reviewers');
                
                if (error) {
                    console.error('Reviewers error:', error);
                    throw error;
                }
                
                const reviewerSelect = document.getElementById('reviewer-select');
                reviewerSelect.innerHTML = '<option value="">Select reviewer...</option>';
                
                if (data && data.length > 0) {
                    data.forEach(reviewer => {
                        const option = document.createElement('option');
                        option.value = reviewer.user_id;
                        option.textContent = `${reviewer.username} (${reviewer.email})`;
                        reviewerSelect.appendChild(option);
                    });
                } else {
                    console.warn('No reviewers found in database');
                }
            } catch (error) {
                console.error('Error loading reviewers:', error);
            }
        }
// Load currencies
        async function loadCurrencies() {
            try {
                const { data, error } = await supabase
                    .from('currencies')
                    .select('currency_code, currency_name, currency_symbol')
                    .eq('is_active', true)
                    .order('currency_name');
                
                if (error) throw error;
                
                const currencySelect = document.getElementById('currency-select');
                currencySelect.innerHTML = '<option value="">Select currency...</option>';
                
                (data || []).forEach(currency => {
                    const option = document.createElement('option');
                    option.value = currency.currency_code;
                    option.textContent = `${currency.currency_name} (${currency.currency_symbol})`;
                    currencySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading currencies:', error);
            }
        }

        // Load project manufacturers
        async function loadProjectManufacturers(projectId) {
            try {
                const { data, error } = await supabase
                    .from('project_manufacturers')
                    .select('manufacturer_name')
                    .eq('project_id', projectId)
                    .order('manufacturer_name');
                
                if (error) throw error;
                
                const manufacturerSelect = document.getElementById('manufacturer-select');
                manufacturerSelect.innerHTML = '<option value="">Select manufacturer...</option>';
                
                (data || []).forEach(manufacturer => {
                    const option = document.createElement('option');
                    option.value = manufacturer.manufacturer_name;
                    option.textContent = manufacturer.manufacturer_name;
                    manufacturerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading manufacturers:', error);
            }
        }
        // Check reorderability
        async function checkReorderability() {
    console.log('=== CHECKING REORDERABILITY ===');
    console.log('User role:', currentUser?.role);
    console.log('Current project:', currentProject);
    
    // Since duplicate detection no longer depends on order, always allow reordering
    canReorder = true;
    console.log('Reordering always allowed - duplicate detection is order-independent');
    
    updateReorderUI();
}        // Update reorder UI
        function updateReorderUI() {
            console.log('Updating reorder UI, canReorder:', canReorder);
            const lockIndicator = document.getElementById('reorder-lock-indicator');
            if (lockIndicator) {
                if (!canReorder) {
                    lockIndicator.classList.remove('hidden');
                    console.log('Showing lock indicator');
                } else {
                    lockIndicator.classList.add('hidden');
                    console.log('Hiding lock indicator');
                }
            }
            
            if (currentProject && currentProject.attributes) {
                renderAttributes();
            }
        }

     
// Render attributes
function renderAttributes() {
    console.log('=== RENDERING ATTRIBUTES ===');
    console.log('Can reorder:', canReorder);
    console.log('Current project:', currentProject);
    console.log('Current project attributes:', currentProject?.attributes);

    const container = document.getElementById('attributes-container');
    
    if (!container) {
        console.error('Attributes container not found');
        return;
    }
    
    container.innerHTML = '';

    // Check if currentProject and attributes exist
    if (!currentProject) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">No project selected</div>';
        return;
    }

    if (!currentProject.attributes || !Array.isArray(currentProject.attributes)) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">No attributes found for this project</div>';
        console.error('Project attributes is not an array:', currentProject.attributes);
        return;
    }

    if (currentProject.attributes.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">This project has no attributes configured</div>';
        return;
    }

    console.log('Rendering', currentProject.attributes.length, 'attributes');

    // Debug manual entry attributes
    currentProject.attributes.forEach((attr, index) => {
        if (attr.is_manual_entry) {
            console.log(`Manual entry attribute found: ${attr.attribute_name} (ID: ${attr.attribute_id})`);
        }
    });

    // Create ordered attributes array
    let orderedAttributes;
    if (attributeOrder && attributeOrder.length > 0) {
        orderedAttributes = [...currentProject.attributes].sort((a, b) => {
            const aIndex = attributeOrder.indexOf(currentProject.attributes.indexOf(a));
            const bIndex = attributeOrder.indexOf(currentProject.attributes.indexOf(b));
            return aIndex - bIndex;
        });
    } else {
        orderedAttributes = [...currentProject.attributes];
    }

    orderedAttributes.forEach((attr, index) => {
        if (!attr || !attr.attribute_id || !attr.attribute_name) {
            console.warn('Skipping invalid attribute:', attr);
            return;
        }
        
        const originalIndex = currentProject.attributes.indexOf(attr);
        const attrDiv = document.createElement('div');
        attrDiv.className = 'attribute-item';
        attrDiv.dataset.index = originalIndex;
        attrDiv.dataset.originalOrder = index;

        // Build HTML for this attribute
        let html = `
            <div class="drag-handle ${!canReorder ? 'disabled' : ''}" 
                 ${!canReorder ? 'title="Reordering is locked due to pending requests"' : 'title="Drag to reorder"'}>
                
            </div>
            <div class="flex-1">
                <div class="mb-2">
                    <span class="font-semibold">${attr.attribute_name}</span>
                    ${attr.is_mandatory ? '<span class="ml-2 text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Required</span>' : ''}
                    ${attr.is_manual_entry ? '<span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Manual Entry</span>' : ''}
                </div>
        `;

        // Add header checkbox for non-manual entry attributes
        if (!attr.is_manual_entry) {
            html += `
                <div class="mb-2">
                    <label class="flex items-center">
                        <input type="checkbox" class="header-checkbox mr-2" 
                               data-attr-id="${attr.attribute_id}"
                               ${includeHeaders[attr.attribute_id] ? 'checked' : ''}
                               <input type=\"checkbox\" class=\"header-checkbox mr-2\" 
       data-attr-id=\"${attr.attribute_id}\"
       ${includeHeaders[attr.attribute_id] ? 'checked' : ''}>
                        <span class="text-sm text-gray-600">Include "${attr.attribute_name}" in Description 2</span>
                    </label>
                </div>
            `;
        }

        html += '<div class="flex flex-wrap gap-3 mb-2">';;

        // Handle manual entry vs standard values
        if (attr.is_manual_entry === true) {
            // Manual entry attributes - text input + unit dropdown
            const manualInputId = `manual-attr-${attr.attribute_id}`;
            const unitSelectId = `unit-attr-${attr.attribute_id}`;
            
           html += `
                </div>
                <div class="w-full mt-3 p-4 bg-blue-50 border border-blue-300 rounded-lg">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-blue-800 mb-2">Enter Custom Value for ${attr.attribute_name}</label>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">Value</label>
                            <input type="text" 
                                   id="${manualInputId}" 
                                   placeholder="Enter value..." 
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   data-attr-id="${attr.attribute_id}"
                                   autocomplete="off">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">Unit (Optional)</label>
                            <select id="${unitSelectId}" 
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    data-attr-id="${attr.attribute_id}">
                                <option value="">Select unit...</option>
                            </select>
                        </div>
                        <p class="text-xs text-blue-600">This attribute requires manual entry with optional unit.</p>
                    </div>
                </div>
            `;
        } else {
            // Standard attributes with predefined values
            // Modified section around line 1895-1917
if (attr.standard_values && Array.isArray(attr.standard_values) && attr.standard_values.length > 0) {
    attr.standard_values.forEach((value, valueIndex) => {
        const radioId = `attr-${originalIndex}-val-${valueIndex}`;
        
        // Enhanced handling for units
        let valueName, valueUnit;
        if (typeof value === 'object' && value !== null) {
            valueName = value.name || value.value || value;
            valueUnit = value.unit || value.unit_code || '';
        } else {
            valueName = value;
            // Look for unit in separate attribute property
            valueUnit = attr.unit_of_measurement || attr.default_unit || '';
        }
        
        // If no unit found in standard value, check attribute level
        if (!valueUnit && attr.units && Array.isArray(attr.units) && attr.units.length > 0) {
            valueUnit = attr.units[0]; // Use first available unit as default
        }
        
        html += `
            <label class="flex items-center">
                <input type="radio" id="${radioId}" name="attr-${originalIndex}" 
                       value="${valueName}" class="mr-1"
                       data-unit="${valueUnit}"
                       onchange="selectAttribute(${attr.attribute_id}, '${valueName}', ${valueIndex + 1}, '${valueUnit}')"
                <span class="text-sm">${valueName} ${valueUnit ? `(${valueUnit})` : ''}</span>
            </label>
        `;
    });

            } else {
                // No standard values available - provide manual entry
                const manualInputId = `manual-attr-${attr.attribute_id}`;
                const unitSelectId = `unit-attr-${attr.attribute_id}`;
                
                html += `
    <div class="w-full">
        <div class="text-sm text-gray-500 italic mb-3">No standard values available - Enter custom value:</div>
    </div>
</div>
<div class="w-full mt-3 p-4 bg-gray-50 border border-gray-300 rounded-lg">
    <div class="space-y-3">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Value</label>
            <input type="text" 
                   id="${manualInputId}" 
                   placeholder="Enter custom value..." 
                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   data-attr-id="${attr.attribute_id}"
                   autocomplete="off">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Unit (Optional)</label>
            <select id="${unitSelectId}" 
                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    data-attr-id="${attr.attribute_id}">
                <option value="">Select unit...</option>
            </select>
        </div>
        <p class="text-xs text-gray-600">Enter a custom value for this attribute since no standard values are configured.</p>
    </div>
`;
            }

            html += '</div>';

            // Add clear selection option for non-mandatory attributes
            if (!attr.is_mandatory) {
                html += `
                    <div class="w-full mt-2">
                        <button type="button" class="text-xs text-red-600 hover:text-red-800" 
                                onclick="clearAttributeSelection(${attr.attribute_id}, 'attr-${originalIndex}')">
                            Clear Selection
                        </button>
                    </div>
                `;
            }
        }

        html += '</div>';
        
        attrDiv.innerHTML = html;
        
        // Setup drag events if reordering is allowed
        if (canReorder) {
            console.log('Setting up drag events for attribute:', attr.attribute_name);
            setupDragEvents(attrDiv);
        } else {
            console.log('Skipping drag events for attribute (reordering disabled):', attr.attribute_name);
            attrDiv.style.opacity = '0.8';
        }

        container.appendChild(attrDiv);
        
        // Setup manual entry functionality if this is a manual entry attribute
        // Setup manual entry functionality for manual entry attributes OR attributes with no standard values
        if (attr.is_manual_entry === true || (!attr.standard_values || !Array.isArray(attr.standard_values) || attr.standard_values.length === 0)) {
            setupManualEntryAttribute(attr.attribute_id, originalIndex);
        }
    });

    // Add event listeners for header checkboxes (non-manual entry attributes only)
    document.querySelectorAll('.header-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const attrId = e.target.dataset.attrId;
            includeHeaders[attrId] = e.target.checked;
            updatePreview();
        });
    });
    
    console.log('Attributes rendered successfully');
}

// Separate function to setup manual entry attributes
function setupManualEntryAttribute(attributeId, originalIndex) {
    const manualInputId = `manual-attr-${attributeId}`;
    const unitSelectId = `unit-attr-${attributeId}`;
    
    console.log('Setting up manual entry for attribute:', attributeId);
    
    // Populate unit dropdown
    const unitSelect = document.getElementById(unitSelectId);
    if (unitSelect && uomList && uomList.length > 0) {
        // Clear existing options except the first one
        unitSelect.innerHTML = '<option value="">Select unit...</option>';
        
        uomList.forEach(uom => {
            const option = document.createElement('option');
            option.value = uom.uom_symbol || uom.uom_name;
            option.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
            unitSelect.appendChild(option);
        });
        console.log('Populated unit dropdown with', uomList.length, 'options');
    }
    
    // Setup event listeners for manual entry
    const manualInput = document.getElementById(manualInputId);
    if (manualInput) {
        console.log('Setting up manual input event listeners for:', manualInputId);
        
        // Remove any existing event listeners
        manualInput.replaceWith(manualInput.cloneNode(true));
        const freshManualInput = document.getElementById(manualInputId);
        
        // Input event for real-time updates
        freshManualInput.addEventListener('input', function(e) {
            console.log('Manual input changed:', e.target.value, 'for attribute:', attributeId);
            updateManualAttributeValue(attributeId, e.target.value, unitSelectId);
        });
        
        // Focus event to initialize selection
        freshManualInput.addEventListener('focus', function(e) {
            console.log('Manual input focused for attribute:', attributeId);
            if (!attributeSelections[attributeId]) {
                attributeSelections[attributeId] = { value: '', index: 'manual' };
                updatePreview();
            }
        });
        
        // Ensure input is enabled
        freshManualInput.disabled = false;
        freshManualInput.readOnly = false;
        freshManualInput.style.backgroundColor = '#ffffff';
        freshManualInput.style.cursor = 'text';
        
        console.log('Manual input setup complete for:', manualInputId);
    } else {
        console.error('Could not find manual input:', manualInputId);
    }
    
    // Setup unit select event listener
    if (unitSelect) {
        // Remove any existing event listeners
        unitSelect.replaceWith(unitSelect.cloneNode(true));
        const freshUnitSelect = document.getElementById(unitSelectId);
        
        // Repopulate the fresh unit select
        if (freshUnitSelect && uomList && uomList.length > 0) {
            freshUnitSelect.innerHTML = '<option value="">Select unit...</option>';
            uomList.forEach(uom => {
                const option = document.createElement('option');
                option.value = uom.uom_symbol || uom.uom_name;
                option.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
                freshUnitSelect.appendChild(option);
            });
        }
        
        freshUnitSelect.addEventListener('change', function(e) {
            console.log('Unit changed:', e.target.value, 'for attribute:', attributeId);
            const currentInput = document.getElementById(manualInputId);
            const currentValue = currentInput ? currentInput.value : '';
            updateManualAttributeValue(attributeId, currentValue, unitSelectId);
        });
        
        console.log('Unit select setup complete for:', unitSelectId);
    }
}

// New function to handle manual attribute value updates
function updateManualAttributeValue(attrId, value, unitSelectId) {
    console.log('=== UPDATING MANUAL ATTRIBUTE VALUE ===');
    console.log('Attribute ID:', attrId);
    console.log('Value:', value);
    console.log('Unit Select ID:', unitSelectId);
    
    const unitSelect = document.getElementById(unitSelectId);
    const selectedUnit = unitSelect ? unitSelect.value : '';
    
    let formattedValue = value ? value.trim() : '';
    if (formattedValue && selectedUnit) {
        formattedValue = `${formattedValue} (${selectedUnit})`;
    }
    
    console.log('Formatted value:', formattedValue);
    
    // Always maintain manual selection
    attributeSelections[attrId] = { 
        value: formattedValue, 
        index: 'manual',
        rawValue: value ? value.trim() : '',
        unit: selectedUnit || ''
    };
    
    console.log('Updated attributeSelections:', attributeSelections[attrId]);
    
    updatePreview();
    checkForDuplicates();
    checkGenerateButton();
    checkForVariationPreview(); // NEW: Check for variation preview
}
// Setup drag events
        function setupDragEvents(element) {
            console.log('Setting up drag events for element:', element.dataset.index);
            
            element.draggable = true;
            
            element.addEventListener('dragstart', (e) => {
                console.log('Drag start:', element.dataset.index);
                draggedItem = element;
                element.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', element.outerHTML);
            });

            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const container = element.parentElement;
                const afterElement = getDragAfterElement(container, e.clientY);
                
                if (afterElement == null) {
                    container.appendChild(draggedItem);
                } else {
                    container.insertBefore(draggedItem, afterElement);
                }
            });

            element.addEventListener('dragend', (e) => {
                console.log('Drag end:', element.dataset.index);
                element.classList.remove('dragging');
                updateAttributeOrder();
                draggedItem = null;
            });
        }

        // Get drag after element
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.attribute-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Update attribute order
        function updateAttributeOrder() {
            console.log('=== UPDATING ATTRIBUTE ORDER ===');
            const items = document.querySelectorAll('.attribute-item');
            const newOrder = [];
            
            items.forEach((item, index) => {
                const originalIndex = parseInt(item.dataset.index);
                newOrder.push(originalIndex);
                console.log(`Position ${index}: Attribute ${originalIndex}`);
            });
            
            attributeOrder = newOrder;
            console.log('New attribute order:', attributeOrder);
            updatePreview();
        }

        // Select attribute
       function selectAttribute(attrId, value, index, unit = '') {
    console.log('Selecting attribute:', attrId, 'value:', value, 'index:', index, 'unit:', unit);
    
    // Clear any manual entry for this attribute when selecting a standard value
    const manualInputs = document.querySelectorAll(`input[type="text"][id*="manual-attr"]`);
    manualInputs.forEach(input => {
        if (input.id.includes('manual-attr')) {
            const radioButton = document.getElementById(input.id + '-radio');
            if (radioButton && radioButton.name.includes(attrId.toString())) {
                input.disabled = true;
                input.value = '';
                input.style.backgroundColor = '#f3f4f6';
            }
        }
    });
    
    // Format the value with unit if unit exists
    let formattedValue = value;
    if (unit && unit.trim() !== '') {
        formattedValue = `${value} (${unit})`;
    }
    
    attributeSelections[attrId] = { 
        value: formattedValue,  //  FIXED: Include unit in formatted value
        index: index,
        rawValue: value,
        unit: unit || ''
    };
    
    updatePreview();
    checkForDuplicates();
    checkGenerateButton();
}
// Check for blocked combinations
async function checkBlockedCombination(projectId, combinationSignature) {
    try {
        // Check if this combination is blocked
        const { data: blockedCombinations, error } = await supabase
            .from('combination_requests')
            .select('*')
            .eq('project_id', projectId)
            .eq('combination_signature', combinationSignature)
            .eq('request_type', 'block')
            .eq('status', 'admin_approved');
        
        if (error) throw error;
        
        return blockedCombinations && blockedCombinations.length > 0;
    } catch (error) {
        console.error('Error checking blocked combinations:', error);
        return false;
    }
}

// Generate item code
       async function generateItemCode() {
    if (!currentProject) return 'No project selected';
    
    try {
        // Get the next available serial number from the database
        const correctSerial = await getNextSerialNumber();
        console.log('Using serial number:', correctSerial);
        
        const csiCode = currentProject.item_code.replace(/\s+/g, '');
        let code = csiCode;
        
        const hasAdditionalLevel = currentProject.additional_level_value && 
                                  currentProject.additional_level_value.trim() !== '';
        const hasModelNumber = document.getElementById('model-number').value.trim();
        
        let additionalLevelOrder = null;
        
        // Get proper additional level order if exists
        if (hasAdditionalLevel) {
            additionalLevelOrder = await getAdditionalLevelOrder(
                currentProject.division_code,
                currentProject.section_code,
                currentProject.detailed_section_code,
                currentProject.item_code,
                currentProject.additional_level_value
            );
            console.log('Additional level order for', currentProject.additional_level_value, ':', additionalLevelOrder);
        }
        
        if (hasAdditionalLevel && hasModelNumber) {
            code += `-${additionalLevelOrder}-n-${String(correctSerial).padStart(5, '0')}`;
        } else if (hasAdditionalLevel) {
            code += `-${additionalLevelOrder}-${String(correctSerial).padStart(5, '0')}`;
        } else if (hasModelNumber) {
            code += `-n-${String(correctSerial).padStart(5, '0')}`;
        } else {
            code += `-${String(correctSerial).padStart(5, '0')}`;
        }
        
        return code;
    } catch (error) {
        console.error('Error generating item code:', error);
        return 'Error generating code';
    }
}

// NEW: Enhanced item code generation with variation support
async function generateItemCodeWithVariations() {
    if (!currentProject) return 'No project selected';
    
    try {
        const uom = document.getElementById('uom-select')?.value;
        const country = document.getElementById('country-select')?.value;
        const modelNumber = document.getElementById('model-number')?.value;
        const manufacturer = document.getElementById('manufacturer-select')?.value;
        
        // Check if this will be a variation
        const combination = getCombinationSignature();
        const duplicateCheck = await checkCombinationExists(
            combination, uom, country, modelNumber, null, null, manufacturer
        );
        
        if (duplicateCheck.willBeVariation) {
            // This will be a variation - use base item code + variation suffix
            const variationNumber = duplicateCheck.nextVariationNumber;
            console.log('Creating variation:', `${duplicateCheck.baseItemCode}/${variationNumber}`);
            return `${duplicateCheck.baseItemCode}/${variationNumber}`;
        } else {
            // This will be a new base item - generate normally
            console.log('Creating new base item');
            return await generateItemCode(); // Use existing logic for new items
        }
        
    } catch (error) {
        console.error('Error generating item code with variations:', error);
        return await generateItemCode(); // Fallback to original function
    }
}      
// Get additional level order for proper sequencing
async function getAdditionalLevelOrder(divisionCode, sectionCode, detailedSectionCode, itemCode, additionalLevelValue) {
    try {
        console.log('Getting additional level order for:', {
            divisionCode,
            sectionCode, 
            detailedSectionCode,
            itemCode,
            additionalLevelValue
        });
        
        const { data, error } = await supabase.rpc('get_additional_level_order', {
            division_code_param: divisionCode,
            section_code_param: sectionCode,
            detailed_section_code_param: detailedSectionCode,
            item_code_param: itemCode,
            additional_level_value_param: additionalLevelValue
        });
        
        if (error) throw error;
        
        console.log('Additional level order received:', data);
        return data;
    } catch (error) {
        console.error('Error getting additional level order:', error);
        // Fallback to 1 if error occurs
        return 1;
    }
}

// Update preview
async function updatePreview() {
    const code = await generateItemCodeWithVariations(); // Enhanced with variation support
    const desc1 = generateDescription1();
    const desc2 = generateDescription2();
    
    const preview = `${code}

Description 1: ${desc1}
Description 2: ${desc2}`;
    
    document.getElementById('code-preview').textContent = preview;
}
// Check for duplicates
        // Enhanced duplicate detection
// FIXED: Enhanced duplicate detection that actually works
async function checkForDuplicates() {
    console.log(' Starting ENHANCED duplicate detection...');
    
    const uom = document.getElementById('uom-select').value;
    const country = document.getElementById('country-select').value;
    const modelNumber = document.getElementById('model-number').value.trim();
    const unitPrice = document.getElementById('unit-price').value;
    const currency = document.getElementById('currency-select').value;
    const manufacturer = document.getElementById('manufacturer-select').value || null;
    
    if (!uom || !country || !unitPrice || !currency || !currentProject || !attributeSelections) {
        clearDuplicationStatus();
        return false;
    }
    
    try {
        console.log('Input data:', { 
            project_id: currentProject.id,
            uom, 
            country, 
            modelNumber, 
            manufacturer,
            unitPrice,
            currency,
            attributeSelections
        });
        
        // Generate signatures for comparison
        const baseSignature = generateBaseSignatureClient();
        const variationSignature = generateVariationSignatureClient(uom, country, modelNumber, manufacturer);
        
        console.log('Generated signatures:', { baseSignature, variationSignature });
        
        // STEP 1: Check approved codes with VARIATION-AWARE duplicate detection
        const { data: approvedCodes, error: approvedError } = await supabase
            .from('item_code_workflow')
            .select(`
                id, item_code, base_combination_signature, variation_fields_signature,
                attribute_selections, uom, country_of_origin, model_number, manufacturer, status
            `)
            .eq('project_id', currentProject.id)
            .eq('status', 'admin_approved')
            .eq('is_blocked', false);
        
        if (approvedError) {
            console.error('Error checking approved codes:', approvedError);
            throw approvedError;
        }
        
        if (approvedCodes?.length > 0) {
            console.log(`Checking ${approvedCodes.length} approved codes for duplicates...`);
            
            // FIXED: Check for EXACT signature match (base + variation must BOTH match)
            const exactDuplicate = approvedCodes.find(code => 
                code.base_combination_signature === baseSignature && 
                code.variation_fields_signature === variationSignature
            );
            
            if (exactDuplicate) {
                console.log('√É¬∞√Ö¬∏√Ö¬°√Ç¬´ EXACT DUPLICATE FOUND (same attributes + same UOM/manufacturer/model/country):', exactDuplicate.item_code);
                showDuplicateStatusEnhanced('approved_code', exactDuplicate.item_code, 'signature_based');
                return true;
            }
            
            // FIXED: Check for base attribute match with different variation (should allow as variation)
            const baseMatch = approvedCodes.find(code => 
                code.base_combination_signature === baseSignature && 
                code.variation_fields_signature !== variationSignature
            );
            
            if (baseMatch) {
                console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ VARIATION DETECTED: Same attributes but different UOM/manufacturer/model/country');
                console.log(`   Base item: ${baseMatch.item_code} (UOM: ${baseMatch.uom}, Manufacturer: ${baseMatch.manufacturer})`);
                console.log(`   Your item will be: NEW VARIATION (UOM: ${uom}, Manufacturer: ${manufacturer})`);
                // This is ALLOWED - it's a variation, not a duplicate
            }
            
            // FALLBACK: Check field-by-field for legacy data without signatures
            const fieldDuplicate = approvedCodes.find(code => {
                // Skip if we already have signatures (handled above)
                if (code.base_combination_signature && code.variation_fields_signature) {
                    return false;
                }
                
                // Generate current combination string
                let currentAttrString = '';
                Object.keys(attributeSelections).sort().forEach(key => {
                    const selection = attributeSelections[key];
                    if (selection && selection.value) {
                        currentAttrString += `${key}:${selection.value}|`;
                    }
                });
                
                // Generate existing combination string
                let existingAttrString = '';
                if (code.attribute_selections) {
                    Object.keys(code.attribute_selections).sort().forEach(key => {
                        const selection = code.attribute_selections[key];
                        if (selection && selection.value) {
                            existingAttrString += `${key}:${selection.value}|`;
                        }
                    });
                }
                
                // Compare ALL fields for exact match (legacy data)
                const attributesMatch = currentAttrString === existingAttrString;
                const uomMatch = (code.uom || '') === (uom || '');
                const countryMatch = (code.country_of_origin || '') === (country || '');
                const modelMatch = (code.model_number || '') === (modelNumber || '');
                const manufacturerMatch = (code.manufacturer || '') === (manufacturer || '');
                
                const isFieldDuplicate = attributesMatch && uomMatch && countryMatch && modelMatch && manufacturerMatch;
                
                if (isFieldDuplicate) {
                    console.log('√É¬∞√Ö¬∏√Ö¬°√Ç¬´ LEGACY FIELD DUPLICATE DETECTED:', {
                        code: code.item_code,
                        attributesMatch,
                        uomMatch,
                        countryMatch,
                        modelMatch,
                        manufacturerMatch
                    });
                }
                
                return isFieldDuplicate;
            });
            
            if (fieldDuplicate) {
                console.log('LEGACY FIELD DUPLICATE FOUND in approved codes:', fieldDuplicate.item_code);
                showDuplicateStatusEnhanced('approved_code', fieldDuplicate.item_code, 'field_based_fallback');
                return true;
            }
        }
        
        // STEP 2: Check pending requests with VARIATION-AWARE duplicate detection
        const { data: pendingRequests, error: requestError } = await supabase
            .from('item_code_workflow')
            .select(`
                id, item_code, base_combination_signature, variation_fields_signature,
                attribute_selections, uom, country_of_origin, model_number, manufacturer, status
            `)
            .eq('project_id', currentProject.id)
            .in('status', ['pending', 'reviewer_approved']);
        
        if (requestError) {
            console.error('Error checking pending requests:', requestError);
            throw requestError;
        }
        
        if (pendingRequests?.length > 0) {
            console.log(`Checking ${pendingRequests.length} pending requests for duplicates...`);
            
            // FIXED: Check for EXACT signature match (base + variation must BOTH match)
            const exactRequestDuplicate = pendingRequests.find(req => 
                req.base_combination_signature === baseSignature && 
                req.variation_fields_signature === variationSignature
            );
            
            if (exactRequestDuplicate) {
                console.log('√É¬∞√Ö¬∏√Ö¬°√Ç¬´ EXACT DUPLICATE FOUND in requests (same attributes + same UOM/manufacturer/model/country):', exactRequestDuplicate.item_code);
                showDuplicateStatusEnhanced('pending_request', exactRequestDuplicate.item_code, 'signature_based');
                return true;
            }
            
            // FIXED: Check for base attribute match with different variation (should allow as variation)
            const baseRequestMatch = pendingRequests.find(req => 
                req.base_combination_signature === baseSignature && 
                req.variation_fields_signature !== variationSignature
            );
            
            if (baseRequestMatch) {
                console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ PENDING VARIATION DETECTED: Same attributes but different UOM/manufacturer/model/country');
                console.log(`   Pending item: ${baseRequestMatch.item_code} (UOM: ${baseRequestMatch.uom}, Manufacturer: ${baseRequestMatch.manufacturer})`);
                console.log(`   Your item will be: NEW VARIATION (UOM: ${uom}, Manufacturer: ${manufacturer})`);
                // This is ALLOWED - it's a variation, not a duplicate
            }
            
            // FALLBACK: Check field-by-field for legacy data without signatures
            const requestFieldDuplicate = pendingRequests.find(req => {
                // Skip if we already have signatures (handled above)
                if (req.base_combination_signature && req.variation_fields_signature) {
                    return false;
                }
                
                // Generate current combination string
                let currentAttrString = '';
                Object.keys(attributeSelections).sort().forEach(key => {
                    const selection = attributeSelections[key];
                    if (selection && selection.value) {
                        currentAttrString += `${key}:${selection.value}|`;
                    }
                });
                
                // Generate existing combination string
                let existingAttrString = '';
                if (req.attribute_selections) {
                    Object.keys(req.attribute_selections).sort().forEach(key => {
                        const selection = req.attribute_selections[key];
                        if (selection && selection.value) {
                            existingAttrString += `${key}:${selection.value}|`;
                        }
                    });
                }
                
                // Compare ALL fields for exact match (legacy data)
                const attributesMatch = currentAttrString === existingAttrString;
                const uomMatch = (req.uom || '') === (uom || '');
                const countryMatch = (req.country_of_origin || '') === (country || '');
                const modelMatch = (req.model_number || '') === (modelNumber || '');
                const manufacturerMatch = (req.manufacturer || '') === (manufacturer || '');
                
                const isFieldDuplicate = attributesMatch && uomMatch && countryMatch && modelMatch && manufacturerMatch;
                
                if (isFieldDuplicate) {
                    console.log('√É¬∞√Ö¬∏√Ö¬°√Ç¬´ LEGACY FIELD DUPLICATE DETECTED in requests:', {
                        code: req.item_code,
                        attributesMatch,
                        uomMatch,
                        countryMatch,
                        modelMatch,
                        manufacturerMatch
                    });
                }
                
                return isFieldDuplicate;
            });
            
            if (requestFieldDuplicate) {
                console.log('LEGACY FIELD DUPLICATE FOUND in requests:', requestFieldDuplicate.item_code);
                showDuplicateStatusEnhanced('pending_request', requestFieldDuplicate.item_code, 'field_based_fallback');
                return true;
            }
        }
        
        // No duplicates found
        console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ NO DUPLICATES FOUND - UNIQUE COMBINATION');
        showUniqueStatusEnhanced(uom, country, modelNumber, manufacturer);
        return false;
        
    } catch (error) {
        console.error("√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Error in enhanced duplicate detection:", error);
        showErrorStatusEnhanced(error.message);
        return false; // Allow submission on error to avoid blocking due to technical issues
    }
}

// Helper function to generate base signature (matching database logic)
function generateBaseSignatureClient() {
    let attrString = '';
    if (attributeSelections) {
        Object.keys(attributeSelections).sort().forEach(key => {
            const selection = attributeSelections[key];
            if (selection && selection.value) {
                attrString += `${key}:${selection.value}|`;
            }
        });
    }
    return md5(attrString);
}

// Helper function to generate variation signature (matching database logic)
function generateVariationSignatureClient(uom, country, modelNumber, manufacturer) {
    const variationString = `${uom || ''}|${country || ''}|${modelNumber || ''}|${manufacturer || ''}`;
    return md5(variationString);
}

// New function that includes the new fields in hash generation

// OLD DUPLICATE CHECKING FUNCTIONS REMOVED - NOW USING ENHANCED RPC-BASED DETECTION


function clearDuplicationStatus() {
    const duplicationStatus = document.getElementById('duplication-status');
    if (duplicationStatus) {
        duplicationStatus.classList.add('hidden');
    }
}

function showDuplicateStatusEnhanced(type, itemCode, method) {
    const duplicationStatus = document.getElementById('duplication-status');
    const duplicationMessage = document.getElementById('duplication-message');
    
    duplicationStatus.className = 'mb-4 p-4 rounded-lg bg-red-100 border-2 border-red-300';
    duplicationMessage.innerHTML = `
        <div class="flex items-start">
            <svg class="w-6 h-6 text-red-600 mr-3 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.854-.833-2.5 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div class="text-red-800">
                <div class="font-bold text-lg mb-2">√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è DUPLICATE DETECTED</div>
                <div class="mb-2">
                    This combination already exists as <strong>${formatDuplicateTypeEnhanced(type)}</strong>:
                </div>
                <div class="bg-red-200 p-2 rounded font-mono text-sm mb-2">
                    <strong>${itemCode}</strong>
                </div>
                <div class="text-xs text-red-600 mb-2">
                    Detection method: ${formatDetectionMethodEnhanced(method)}
                </div>
                <div class="text-red-600 font-medium text-sm">
                    √É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Cannot submit identical combination. Please modify your selections.
                </div>
            </div>
        </div>
    `;
    duplicationStatus.classList.remove('hidden');
}

function showUniqueStatusEnhanced(uom, country, modelNumber, manufacturer) {
    const duplicationStatus = document.getElementById('duplication-status');
    const duplicationMessage = document.getElementById('duplication-message');
    
    duplicationStatus.className = 'mb-4 p-4 rounded-lg bg-green-100 border-2 border-green-300';
    duplicationMessage.innerHTML = `
        <div class="flex items-start">
            <svg class="w-6 h-6 text-green-600 mr-3 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-green-800">
                <div class="font-bold text-lg mb-2">UNIQUE COMBINATION</div>
                <div class="mb-2">No duplicates found. This combination is unique.</div>
                <div class="text-xs text-green-700 mb-2">
                    UOM: <strong>${uom}</strong> | Country: <strong>${country}</strong> | 
                    Model: <strong>${modelNumber || 'None'}</strong> | 
                    Manufacturer: <strong>${manufacturer || 'None'}</strong>
                </div>
                <div class="text-green-600 font-medium text-sm">
                    Ready to submit.
                </div>
            </div>
        </div>
    `;
    duplicationStatus.classList.remove('hidden');
}

function showErrorStatusEnhanced(errorMessage) {
    const duplicationStatus = document.getElementById('duplication-status');
    const duplicationMessage = document.getElementById('duplication-message');
    
    duplicationStatus.className = 'mb-4 p-4 rounded-lg bg-yellow-100 border-2 border-yellow-300';
    duplicationMessage.innerHTML = `
        <div class="flex items-start">
            <svg class="w-6 h-6 text-yellow-600 mr-3 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-yellow-800">
                <div class="font-bold text-lg mb-2">√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è DUPLICATE CHECK ERROR</div>
                <div class="mb-2">Error checking for duplicates:</div>
                <div class="bg-yellow-200 p-2 rounded font-mono text-sm mb-2">
                    ${errorMessage}
                </div>
                <div class="text-yellow-600 font-medium text-sm">
                    √É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Proceeding with caution. Manual verification recommended.
                </div>
            </div>
        </div>
    `;
    duplicationStatus.classList.remove('hidden');
}

function formatDuplicateTypeEnhanced(type) {
    switch(type) {
        case 'approved_code': return ' Approved Item Code';
        case 'pending_request': return ' Pending Request';
        case 'approved_code_legacy': return ' Approved Item Code (Legacy)';
        case 'pending_request_legacy': return ' Pending Request (Legacy)';
        default: return type;
    }
}

function formatDetectionMethodEnhanced(method) {
    switch(method) {
        case 'signature_based': return 'Modern Signature-based Detection';
        case 'field_based': return 'Legacy Field-based Detection';
        case 'field_based_fallback': return 'Legacy Field-based Detection';
        default: return method;
    }
}
function getCombinationSignature() {
    if (!currentProject || !currentProject.attributes) return '';
    
    return attributeOrder.map(i => {
        const attr = currentProject.attributes[i];
        const sel = attributeSelections[attr.attribute_id];
        if (sel) {
            if (sel.index === 'manual') {
                // For manual entries, use the actual value in the signature
                return `manual:${sel.value || 'empty'}`;
            } else {
                return sel.index;
            }
        }
        return '_';
    }).join('-');
}

// NEW: Generate base combination signature (attributes only) for variation system
function getBaseCombinationSignature() {
    if (!currentProject || !currentProject.attributes) return '';
    
    let attrString = '';
    Object.keys(attributeSelections).sort().forEach(key => {
        const selection = attributeSelections[key];
        if (selection && selection.value) {
            attrString += `${key}:${selection.value}|`;
        }
    });
    
    return md5(attrString);
}

// NEW: Generate variation fields signature (UOM, manufacturer, model, country)
function getVariationFieldsSignature() {
    const uom = document.getElementById('uom-select')?.value || '';
    const country = document.getElementById('country-select')?.value || '';
    const model = document.getElementById('model-number')?.value || '';
    const manufacturer = document.getElementById('manufacturer-select')?.value || '';
    
    const variationString = `${uom}|${country}|${model}|${manufacturer}`;
    return md5(variationString);
}
// Check generate button - Admin doesn't need reviewer
        // Enhanced check generate button with duplicate prevention
async function checkGenerateButton() {
    const allMandatory = currentProject.attributes.every(attr => 
        !attr.is_mandatory || attributeSelections[attr.attribute_id]
    );
    
    const uomSelected = document.getElementById('uom-select').value;
    const countrySelected = document.getElementById('country-select').value;
    const unitPrice = document.getElementById('unit-price').value;
    const currency = document.getElementById('currency-select').value;
    
    // Unit price and currency are now mandatory
    const hasRequiredFields = uomSelected && countrySelected && unitPrice && currency;
    
    // Admin doesn't need reviewer selection
    const reviewerSelected = currentUser.role === 'admin' ? true : document.getElementById('reviewer-select').value;
    
    // Check for duplicates
    const hasDuplicate = await checkForDuplicates();

    const generateBtn = document.getElementById('generate-btn');
    const blockBtn = document.getElementById('block-btn');
    
    if (allMandatory && hasRequiredFields && reviewerSelected && !hasDuplicate) {
        generateBtn.disabled = false;
        generateBtn.classList.remove('bg-gray-400');
        generateBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        
        blockBtn.disabled = false;
        blockBtn.classList.remove('bg-gray-400');
        blockBtn.classList.add('bg-red-600', 'hover:bg-red-700');
    } else {
        generateBtn.disabled = true;
        generateBtn.classList.add('bg-gray-400');
        generateBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        
        blockBtn.disabled = true;
        blockBtn.classList.add('bg-gray-400');
        blockBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
    }
}
// FIXED: Generate Description 1 - CSI Description + Additional Level
function generateDescription1() {
    if (!currentProject) return 'No project selected';
    
    console.log('generateDescription1 - currentProject:', {
        additional_level_name: currentProject.additional_level_name,
        additional_level_value: currentProject.additional_level_value,
        item_description: currentProject.item_description
    });
    
    // NEW LOGIC: 
    // 1. If there is an additional level VALUE -> use additional level VALUE only
    // 2. If no additional level VALUE -> use lowest CSI hierarchy level (item_description)
    
    // Check if additional level VALUE exists and is not empty
    const hasAdditionalLevelValue = currentProject.additional_level_value && 
                                   currentProject.additional_level_value.trim() !== '';
    
    if (hasAdditionalLevelValue) {
        // Case 1: Additional level VALUE exists - use additional level VALUE only
        let cleanAdditionalLevelValue = currentProject.additional_level_value.replace(/\s*Types\s*/gi, '').trim();
        console.log('Using additional level VALUE:', cleanAdditionalLevelValue);
        return cleanAdditionalLevelValue;
    } else {
        // Case 2: No additional level VALUE - use lowest CSI hierarchy level
        let description1 = currentProject.item_description || '';
        // Remove any "Types" word that might be auto-generated
        description1 = description1.replace(/\s*Types\s*/gi, '').trim();
        console.log('Using item description:', description1);
        return description1;
    }
}

// FIXED: Generate Description 2 - Formatted attribute selections with headers
function generateDescription2() {
    const parts = [];
    
    if (!currentProject || !currentProject.attributes) {
        return '';
    }
    
    attributeOrder.forEach(originalIndex => {
        const attr = currentProject.attributes[originalIndex];
        const selection = attributeSelections[attr.attribute_id];
        
        if (selection && selection.value) {
            if (includeHeaders[attr.attribute_id]) {
                // Format: "Attribute Name: Value"
                parts.push(`${attr.attribute_name}: ${selection.value}`);
            } else {
                // Format: just "Value"
                parts.push(selection.value);
            }
        }
    });

    const modelNumber = document.getElementById('model-number').value.trim();
    if (modelNumber) {
        parts.push(`Model: ${modelNumber}`);
    }

    return parts.join(', ');
}

// FIXED: Get formatted combination for display and comparison
function getFormattedCombination() {
    const parts = [];
    
    if (!currentProject || !currentProject.attributes) {
        return 'No attributes available';
    }
    
    attributeOrder.forEach(originalIndex => {
        const attr = currentProject.attributes[originalIndex];
        const selection = attributeSelections[attr.attribute_id];
        
        if (selection && selection.value) {
            parts.push(`${attr.attribute_name}: ${selection.value}`);
        } else {
            parts.push(`${attr.attribute_name}: Not Selected`);
        }
    });
    
    return parts.join(' | ');
}

// Get formatted combination for display
function getFormattedCombination() {
    const parts = [];
    
    attributeOrder.forEach(originalIndex => {
        const attr = currentProject.attributes[originalIndex];
        const selection = attributeSelections[attr.attribute_id];
        
        if (selection) {
            parts.push(`${attr.attribute_name}: ${selection.value}`);
        } else {
            parts.push(`${attr.attribute_name}: Not Selected`);
        }
    });
    
    return parts.join(' | ');
}
        // FIXED: Submit item code - Admin bypasses approval
     async function submitItemCode() {
    console.log('=== SUBMIT START ===');
    console.log('User role:', currentUser.role);
    console.log('Current project ID:', currentProject.id);

    // CRITICAL: Final comprehensive duplicate check before submission
    console.log(' FINAL DUPLICATE CHECK before submission...');
    
    try {
        const uom = document.getElementById('uom-select').value;
        const country = document.getElementById('country-select').value;
        const modelNumber = document.getElementById('model-number').value.trim();
        const manufacturer = document.getElementById('manufacturer-select').value || null;
        
        // Generate signatures for comprehensive comparison
        let currentAttrString = '';
        Object.keys(attributeSelections).sort().forEach(key => {
            const selection = attributeSelections[key];
            if (selection && selection.value) {
                currentAttrString += `${key}:${selection.value}|`;
            }
        });
        
        console.log('Final check - current combination:', {
            attributes: currentAttrString,
            uom,
            country,
            modelNumber,
            manufacturer
        });
        
        // Check approved codes
        const { data: finalApprovedCheck, error: finalApprovedError } = await supabase
            .from('item_code_workflow')
            .select('id, item_code, attribute_selections, uom, country_of_origin, model_number, manufacturer')
            .eq('project_id', currentProject.id)
            .eq('status', 'admin_approved')
            .eq('is_blocked', false);
        
        if (finalApprovedError) {
            console.error("√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Final approved codes check error:", finalApprovedError);
            alert('Final duplicate check failed: ' + finalApprovedError.message);
            return;
        }
        
        // Check for duplicates in approved codes using VARIATION-AWARE logic
        if (finalApprovedCheck?.length > 0) {
            const approvedDuplicate = finalApprovedCheck.find(code => {
                // Generate attribute strings for comparison
                let existingAttrString = '';
                if (code.attribute_selections) {
                    Object.keys(code.attribute_selections).sort().forEach(key => {
                        const selection = code.attribute_selections[key];
                        if (selection && selection.value) {
                            existingAttrString += `${key}:${selection.value}|`;
                        }
                    });
                }
                
                const attributesMatch = currentAttrString === existingAttrString;
                const uomMatch = (code.uom || '') === (uom || '');
                const countryMatch = (code.country_of_origin || '') === (country || '');
                const modelMatch = (code.model_number || '') === (modelNumber || '');
                const manufacturerMatch = (code.manufacturer || '') === (manufacturer || '');
                
                // FIXED: Only block if ALL fields match (true duplicate), not just attributes
                const isTrueDuplicate = attributesMatch && uomMatch && countryMatch && modelMatch && manufacturerMatch;
                
                if (attributesMatch && !isTrueDuplicate) {
                    console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ VARIATION ALLOWED: Same attributes but different variation fields');
                    console.log(`   Existing: UOM=${code.uom}, Manufacturer=${code.manufacturer}, Model=${code.model_number}`);
                    console.log(`   New: UOM=${uom}, Manufacturer=${manufacturer}, Model=${modelNumber}`);
                }
                
                return isTrueDuplicate;
            });
            
            if (approvedDuplicate) {
                console.log('√É¬∞√Ö¬∏√Ö¬°√Ç¬´ FINAL CHECK BLOCKED - TRUE DUPLICATE:', approvedDuplicate);
                alert(`SUBMISSION BLOCKED\n\nEXACT DUPLICATE DETECTED: This combination already exists as approved code: ${approvedDuplicate.item_code}\n\nAll fields (attributes + UOM + manufacturer + model + country) are identical.\n\nPlease modify your combination and try again.`);
                showDuplicateStatusEnhanced('approved_code', approvedDuplicate.item_code, 'field_based');
                return;
            }
        }
        
        // Check pending requests
        const { data: finalRequestCheck, error: finalRequestError } = await supabase
            .from('item_code_workflow')
            .select('id, item_code, attribute_selections, uom, country_of_origin, model_number, manufacturer')
            .eq('project_id', currentProject.id)
            .in('status', ['pending', 'reviewer_approved']);
        
        if (finalRequestError) {
            console.error("√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Final requests check error:", finalRequestError);
            alert('Final duplicate check failed: ' + finalRequestError.message);
            return;
        }
        
        // Check for duplicates in pending requests using VARIATION-AWARE logic
        if (finalRequestCheck?.length > 0) {
            const requestDuplicate = finalRequestCheck.find(req => {
                // Generate attribute strings for comparison
                let existingAttrString = '';
                if (req.attribute_selections) {
                    Object.keys(req.attribute_selections).sort().forEach(key => {
                        const selection = req.attribute_selections[key];
                        if (selection && selection.value) {
                            existingAttrString += `${key}:${selection.value}|`;
                        }
                    });
                }
                
                const attributesMatch = currentAttrString === existingAttrString;
                const uomMatch = (req.uom || '') === (uom || '');
                const countryMatch = (req.country_of_origin || '') === (country || '');
                const modelMatch = (req.model_number || '') === (modelNumber || '');
                const manufacturerMatch = (req.manufacturer || '') === (manufacturer || '');
                
                // FIXED: Only block if ALL fields match (true duplicate), not just attributes
                const isTrueDuplicate = attributesMatch && uomMatch && countryMatch && modelMatch && manufacturerMatch;
                
                if (attributesMatch && !isTrueDuplicate) {
                    console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ PENDING VARIATION ALLOWED: Same attributes but different variation fields');
                    console.log(`   Pending: UOM=${req.uom}, Manufacturer=${req.manufacturer}, Model=${req.model_number}`);
                    console.log(`   New: UOM=${uom}, Manufacturer=${manufacturer}, Model=${modelNumber}`);
                }
                
                return isTrueDuplicate;
            });
            
            if (requestDuplicate) {
                console.log('√É¬∞√Ö¬∏√Ö¬°√Ç¬´ FINAL CHECK BLOCKED - TRUE DUPLICATE IN REQUESTS:', requestDuplicate);
                alert(`SUBMISSION BLOCKED\n\nEXACT DUPLICATE DETECTED: This combination already exists as pending request: ${requestDuplicate.item_code}\n\nAll fields (attributes + UOM + manufacturer + model + country) are identical.\n\nPlease modify your combination and try again.`);
                showDuplicateStatusEnhanced('pending_request', requestDuplicate.item_code, 'field_based');
                return;
            }
        }
        
        console.log(' Final duplicate check passed - proceeding with submission');
        
    } catch (error) {
        console.error("√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Final duplicate check exception:", error);
        const proceed = confirm(`DUPLICATE CHECK FAILED\n\nError: ${error.message}\n\nDo you want to proceed anyway? (Not recommended)`);
        if (!proceed) {
            return;
        }
    }

    // Override supabase.from to log all database operations
    const originalFrom = supabase.from;
    supabase.from = function(table) {
        console.log('DATABASE ACCESS:', table);
        const result = originalFrom.call(this, table);
        const originalInsert = result.insert;
        result.insert = function(data) {
            console.log('INSERT INTO', table, ':', data);
            console.log('INSERT STACK TRACE');
            return originalInsert.call(this, data);
        };
        return result;
    };
    
    try {
        // Validate required fields
        const uom = document.getElementById('uom-select').value;
        const country = document.getElementById('country-select').value;
        const modelNumber = document.getElementById('model-number').value || null;
        const unitPrice = document.getElementById('unit-price').value;
        const currency = document.getElementById('currency-select').value;
        const manufacturer = document.getElementById('manufacturer-select').value || null;
        
        if (!uom || !country || !unitPrice || !currency) {
            alert('Please fill in all required fields (UOM, Country, Unit Price, and Currency)');
            return;
        }
        
        const combination = getCombinationSignature();
        if (!combination) {
            alert('Please make all required attribute selections');
            return;
        }

        // NEW: Check for blocked combinations BEFORE duplicate check
        const isBlocked = await checkBlockedCombination(currentProject.id, combination);
        if (isBlocked) {
            alert('This combination of attributes is blocked and cannot be used to generate item codes.');
            return;
        }

        // Enhanced comprehensive duplicate check instead of old method
        if (!window.modifyingRequestId) {
            console.log(' Comprehensive duplicate validation before submission...');
            
            // Generate current combination for comparison
            let currentAttrString = '';
            Object.keys(attributeSelections).sort().forEach(key => {
                const selection = attributeSelections[key];
                if (selection && selection.value) {
                    currentAttrString += `${key}:${selection.value}|`;
                }
            });
            
            // Check approved codes
            const { data: submitApprovedCheck, error: submitApprovedError } = await supabase
                .from('item_code_workflow')
                .select('id, item_code, attribute_selections, uom, country_of_origin, model_number, manufacturer')
                .eq('project_id', currentProject.id)
                .eq('status', 'admin_approved')
                .eq('is_blocked', false);
            
            if (submitApprovedError) {
                console.error("√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Submit approved check error:", submitApprovedError);
                alert('Duplicate validation failed: ' + submitApprovedError.message);
                return;
            }
            
            if (submitApprovedCheck?.length > 0) {
                const approvedDuplicate = submitApprovedCheck.find(code => {
                    // Generate attribute strings for comparison
                    let existingAttrString = '';
                    if (code.attribute_selections) {
                        Object.keys(code.attribute_selections).sort().forEach(key => {
                            const selection = code.attribute_selections[key];
                            if (selection && selection.value) {
                                existingAttrString += `${key}:${selection.value}|`;
                            }
                        });
                    }
                    
                    // FIXED: Only block if ALL fields match (true duplicate)
                    const attributesMatch = currentAttrString === existingAttrString;
                    const uomMatch = (code.uom || '') === (uom || '');
                    const countryMatch = (code.country_of_origin || '') === (country || '');
                    const modelMatch = (code.model_number || '') === (modelNumber || '');
                    const manufacturerMatch = (code.manufacturer || '') === (manufacturer || '');
                    
                    const isTrueDuplicate = attributesMatch && uomMatch && countryMatch && modelMatch && manufacturerMatch;
                    
                    if (attributesMatch && !isTrueDuplicate) {
                        console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ SUBMIT VARIATION ALLOWED: Same attributes but different variation fields');
                        console.log(`   Existing: UOM=${code.uom}, Manufacturer=${code.manufacturer}`);
                        console.log(`   New: UOM=${uom}, Manufacturer=${manufacturer}`);
                    }
                    
                    return isTrueDuplicate;
                });
                
                if (approvedDuplicate) {
                    console.log('√É¬∞√Ö¬∏√Ö¬°√Ç¬´ SUBMIT CHECK BLOCKED - TRUE DUPLICATE:', approvedDuplicate);
                    alert(`SUBMISSION BLOCKED\n\nEXACT DUPLICATE: This combination already exists as approved code: ${approvedDuplicate.item_code}\n\nAll fields are identical. Please modify your combination.`);
                    showDuplicateStatusEnhanced('approved_code', approvedDuplicate.item_code, 'field_based');
                    return;
                }
            }
            
            // Check pending requests
            const { data: submitRequestCheck, error: submitRequestError } = await supabase
                .from('item_code_workflow')
                .select('id, item_code, attribute_selections, uom, country_of_origin, model_number, manufacturer')
                .eq('project_id', currentProject.id)
                .in('status', ['pending', 'reviewer_approved']);
            
            if (submitRequestError) {
                console.error("√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è Submit request check error:", submitRequestError);
                alert('Duplicate validation failed: ' + submitRequestError.message);
                return;
            }
            
            if (submitRequestCheck?.length > 0) {
                const requestDuplicate = submitRequestCheck.find(req => {
                    // Generate attribute strings for comparison
                    let existingAttrString = '';
                    if (req.attribute_selections) {
                        Object.keys(req.attribute_selections).sort().forEach(key => {
                            const selection = req.attribute_selections[key];
                            if (selection && selection.value) {
                                existingAttrString += `${key}:${selection.value}|`;
                            }
                        });
                    }
                    
                    // FIXED: Only block if ALL fields match (true duplicate)
                    const attributesMatch = currentAttrString === existingAttrString;
                    const uomMatch = (req.uom || '') === (uom || '');
                    const countryMatch = (req.country_of_origin || '') === (country || '');
                    const modelMatch = (req.model_number || '') === (modelNumber || '');
                    const manufacturerMatch = (req.manufacturer || '') === (manufacturer || '');
                    
                    const isTrueDuplicate = attributesMatch && uomMatch && countryMatch && modelMatch && manufacturerMatch;
                    
                    if (attributesMatch && !isTrueDuplicate) {
                        console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ SUBMIT PENDING VARIATION ALLOWED: Same attributes but different variation fields');
                        console.log(`   Pending: UOM=${req.uom}, Manufacturer=${req.manufacturer}`);
                        console.log(`   New: UOM=${uom}, Manufacturer=${manufacturer}`);
                    }
                    
                    return isTrueDuplicate;
                });
                
                if (requestDuplicate) {
                    console.log('√É¬∞√Ö¬∏√Ö¬°√Ç¬´ SUBMIT DUPLICATE CHECK BLOCKED (REQUEST):', requestDuplicate);
                    alert(`SUBMISSION BLOCKED\n\nExact duplicate detected: ${requestDuplicate.item_code} already exists as pending request\n\nAll fields are identical.`);
                    showDuplicateStatusEnhanced('pending_request', requestDuplicate.item_code, 'field_based');
                    return;
                }
            }
        }

        // Get the next available serial number
        const correctSerial = await getNextSerialNumber();
        nextSerial = correctSerial;
        
        // Generate the item code with variation support
        const itemCode = await generateItemCodeWithVariations();
        const description1 = generateDescription1();
        const description2 = generateDescription2();
        
        console.log('Submitting with serial:', nextSerial, 'Code:', itemCode);

        // Generate MD5 hash for submission
        let attrString = '';
        Object.keys(attributeSelections).sort().forEach(key => {
            const selection = attributeSelections[key];
            if (selection && selection.value) {
                attrString += `${key}:${selection.value}|`;
            }
        });

        const submissionHash = md5(`${currentProject.id}|${attrString}${uom || ''}|${country || ''}|${modelNumber || ''}|${manufacturer || ''}`);

        // Check if we're modifying an existing rejected request
        if (window.modifyingRequestId) {
            console.log('Modifying existing request:', window.modifyingRequestId);
            
            try {
                // Update the existing rejected request instead of creating new one
                const { data, error } = await supabase
                    .from('item_code_workflow')
                    .update({
                        item_code: itemCode,
                        description1: description1,
                        description2: description2,
                        combination_signature: combination,
                        attribute_selections: attributeSelections,
                        duplicate_check_hash: submissionHash,
                        attribute_order: attributeOrder,
                        include_headers_config: includeHeaders,
                        uom: uom,
                        country_of_origin: country,
                        model_number: modelNumber,
                        unit_price: unitPrice ? parseFloat(unitPrice) : null,
                        currency_code: currency,
                        manufacturer: manufacturer,
                        status: 'pending', // Reset to pending for re-review
                        review_comments: null, // Clear old rejection comments
                        reviewed_at: null,
                        reviewed_by: parseInt(document.getElementById('reviewer-select').value)
                    })
                    .eq('id', window.modifyingRequestId)
                    .select();

                if (error) {
                    if (error.code === '23505') { // Unique constraint violation
                        alert('This exact combination already exists. Please modify your selection.');
                        return;
                    }
                    throw error;
                }

                if (data && data.length > 0) {
                    alert('Request updated and resubmitted successfully: ' + itemCode);
                    
                    // Clear the modification tracking
                    window.modifyingRequestId = null;
                    
                    // Remove the modification notice
                    const notice = document.getElementById('modification-notice');
                    if (notice) notice.remove();
                    
                    // Reload and reset
                    loadProjectHistory();
                    checkReorderability();
                    resetForm();
                    updatePreview();
                    return; // Exit early, don't create new request
                }
            } catch (modifyError) {
                console.error('Error updating request:', modifyError);
                if (modifyError.code === '23505') {
                    alert('This exact combination already exists. Please modify your selection.');
                } else {
                    alert('Error updating request: ' + modifyError.message);
                }
                return;
            }
        }

        if (currentUser.role === 'admin') {
            // Admins create codes directly
            try {
                const { data, error } = await supabase
                    .from('item_code_workflow')
                    .insert({
                        project_id: currentProject.id,
                        csi_base_code: currentProject.item_code.replace(/\s+/g, ''),
                        csi_description: currentProject.item_description || '',
                        additional_level: currentProject.additional_level_value || null,
                        entry_description: 'Generated item code',
                        item_code: itemCode,
                        description1: description1,
                        description2: description2,
                        combination_signature: combination,
                        attribute_selections: attributeSelections,
                        attribute_order: attributeOrder,
                        include_headers_config: includeHeaders,
                        duplicate_check_hash: submissionHash,
                        uom: uom,
                        country_of_origin: country,
                        model_number: modelNumber,
                        unit_price: unitPrice ? parseFloat(unitPrice) : null,
                        currency_code: currency,
                        manufacturer: manufacturer,
                        serial_number: nextSerial,
                        created_by: currentUser.id,
                        status: 'admin_approved',
                        admin_reviewed_by: currentUser.id,
                        admin_reviewed_at: new Date().toISOString(),
                        admin_comments: 'Admin direct creation',
                        approved_by: currentUser.id,
                        approved_at: new Date().toISOString(),
                        // NEW: Variation support fields
                        base_combination_signature: getBaseCombinationSignature(),
                        variation_fields_signature: getVariationFieldsSignature(),
                        variation_suffix: itemCode.includes('/') ? '/' + itemCode.split('/')[1] : '',
                        variation_number: itemCode.includes('/') ? parseInt(itemCode.split('/')[1]) : 0,
                        is_variation: itemCode.includes('/')
                    })
                    .select();

                if (error) {
                    if (error.code === '23505') { // Unique constraint violation
                        alert('This exact combination already exists. Please modify your selection.');
                        return;
                    }
                    throw error;
                }

                if (data && data.length > 0) {
                    alert('Item code created successfully: ' + itemCode);
                    
                    // Update the serial tracking in code_generation_series
                    await supabase
                        .from('code_generation_series')
                        .upsert({
                            project_id: currentProject.id,
                            next_serial: nextSerial + 1,
                            last_updated: new Date().toISOString()
                        });
                    
                    // Reload for next generation
                    const newSerial = await getNextSerialNumber();
                    nextSerial = newSerial;
                    
                    loadProjectHistory();
                    checkReorderability();
                    resetForm();
                    updatePreview();
                } else {
                    alert('Failed to create item code');
                }
            } catch (adminError) {
                console.error('Error creating admin code:', adminError);
                if (adminError.code === '23505') {
                    alert('This exact combination already exists. Please modify your selection.');
                } else {
                    alert('Error creating item code: ' + adminError.message);
                }
            }
        } else {
            // Regular users go through approval process
            const reviewerId = document.getElementById('reviewer-select').value;
            if (!reviewerId) {
                alert('Please select a reviewer');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('item_code_workflow')
                    .insert({
                        project_id: currentProject.id,
                        csi_base_code: currentProject.division_code,
                        csi_description: currentProject.item_description || '',
                        additional_level: currentProject.additional_level_value || null,
                        entry_description: 'Generated item code',
                        item_code: itemCode,
                        description1: description1,
                        description2: description2,
                        combination_signature: combination,
                        attribute_selections: attributeSelections,
                        duplicate_check_hash: submissionHash,
                        attribute_order: attributeOrder,
                        include_headers_config: includeHeaders,
                        uom: uom,
                        country_of_origin: country,
                        model_number: modelNumber,
                        unit_price: unitPrice ? parseFloat(unitPrice) : null,
                        currency_code: currency,
                        manufacturer: manufacturer,
                        serial_number: nextSerial,
                        created_by: currentUser.id,
                        reviewed_by: parseInt(reviewerId),
                        status: 'pending',
                        // NEW: Variation support fields
                        base_combination_signature: getBaseCombinationSignature(),
                        variation_fields_signature: getVariationFieldsSignature(),
                        variation_suffix: itemCode.includes('/') ? '/' + itemCode.split('/')[1] : '',
                        variation_number: itemCode.includes('/') ? parseInt(itemCode.split('/')[1]) : 0,
                        is_variation: itemCode.includes('/')
                    })
                    .select();

                if (error) {
                    if (error.code === '23505') { // Unique constraint violation
                        alert('This exact combination already exists. Please modify your selection.');
                        return;
                    }
                    throw error;
                }

                if (data && data.length > 0) {
                    alert('Item code request submitted successfully: ' + itemCode);
                    
                    // Reload for next generation
                    const newSerial = await getNextSerialNumber();
                    nextSerial = newSerial;
                    
                    loadProjectHistory();
                    checkReorderability();
                    resetForm();
                    updatePreview();
                } else {
                    alert('Failed to submit request');
                }
            } catch (requestError) {
                console.error('Error submitting request:', requestError);
                if (requestError.code === '23505') {
                    alert('This exact combination already exists. Please modify your selection.');
                } else {
                    alert('Error submitting request: ' + requestError.message);
                }
            }
        }
    } catch (error) {
        console.error('Error submitting code:', error);
        alert('Failed to submit code request: ' + (error.message || 'Unknown error'));
    }
}
async function submitBlockRequest() {
            const reason = prompt('Please provide a reason for blocking this combination:');
            if (!reason || !reason.trim()) return;

            try {
                const combination = getCombinationSignature();
                const reviewerId = document.getElementById('reviewer-select').value;
                
                if (!reviewerId) {
                    alert('Please select a reviewer before blocking a combination.');
                    return;
                }

                const { data, error } = await supabase
                    .from('combination_requests')
                    .insert({
                        project_id: currentProject.id,
                        request_type: 'block',
                        combination_signature: combination,
                        attribute_selections: attributeSelections,
                        uom: document.getElementById('uom-select').value,
                        country_of_origin: document.getElementById('country-select').value,
                        model_number: document.getElementById('model-number').value || null,
                        unit_price: parseFloat(document.getElementById('unit-price').value),
                        currency_code: document.getElementById('currency-select').value,
                        manufacturer: document.getElementById('manufacturer-select').value || null,
                        reason: reason.trim(),
                        created_by: currentUser.id,
                        reviewed_by: parseInt(reviewerId),
                        status: 'pending'
                    })
                    .select();

                if (error) throw error;

                if (data && data.length > 0) {
                    alert('Block request submitted successfully!');
                    resetForm();
                } else {
                    alert('Failed to submit block request');
                }
            } catch (error) {
                console.error('Error submitting block request:', error);
                alert('Failed to submit block request: ' + (error.message || 'Unknown error'));
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('uom-select').value = '';
            document.getElementById('country-select').value = '';
            document.getElementById('model-number').value = '';
            document.getElementById('unit-price').value = '';
            document.getElementById('currency-select').value = '';
            document.getElementById('manufacturer-select').value = '';
            document.getElementById('reviewer-select').value = '';
            attributeSelections = {};
            document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
            updatePreview();
            clearDuplicationStatus();
        }
// Show add manufacturer modal
        function showAddManufacturerModal() {
            if (!currentProject) {
                alert('Please select a project first');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Add New Manufacturer</h3>
                    <form id="add-manufacturer-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Manufacturer Name *
                            </label>
                            <input type="text" 
                                   id="new-manufacturer-name" 
                                   required
                                   placeholder="Enter manufacturer name"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Reason for Addition (Optional)
                            </label>
                            <textarea id="manufacturer-reason" 
                                      rows="3"
                                      placeholder="Optional: Why is this manufacturer being added?"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" 
                                    onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-md">
                                Add Manufacturer
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('add-manufacturer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitManufacturerRequest();
            });
        }

        // Submit manufacturer request
        async function submitManufacturerRequest() {
            const manufacturerName = document.getElementById('new-manufacturer-name').value.trim();
            const reason = document.getElementById('manufacturer-reason').value.trim();
            
            if (!manufacturerName) {
                alert('Please enter a manufacturer name');
                return;
            }
            
            try {
                // Add manufacturer directly for all users with duplicate check
                const { data, error } = await supabase.rpc('add_manufacturer_to_project', {
                    project_id_param: currentProject.project_id,
                    manufacturer_name_param: manufacturerName,
                    created_by_param: currentUser.id
                });
                
                if (error) throw error;
                
                if (data.success) {
                    alert('Manufacturer added successfully!');
                    document.querySelector('.fixed').remove();
                    loadProjectManufacturers(currentProject.project_id);
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error submitting manufacturer request:', error);
                alert('Failed to submit manufacturer request: ' + error.message);
            }
        }
        // Load project history
        async function loadProjectHistory() {
    try {
        console.log('Loading comprehensive project history for project:', currentProject.id);
        
        // Load ALL workflow items from unified table
        const { data: allWorkflowItems, error: workflowError } = await supabase
            .from('item_code_workflow')
            .select(`
                id,
                project_id,
                csi_base_code,
                additional_level,
                entry_description,
                item_code,
                description1,
                description2,
                combination_signature,
                attribute_selections,
                attribute_order,
                include_headers_config,
                uom,
                country_of_origin,
                model_number,
                unit_price,
                currency_code,
                manufacturer,
                created_by,
                reviewed_by,
                status,
                reviewer_comments,
                admin_reviewed_by,
                admin_reviewed_at,
                admin_comments,
                approved_by,
                approved_at,
                created_at,
                reviewed_at,
                duplicate_check_hash,
                erp_integrated,
                erp_integrated_at,
                serial_number,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .eq('project_id', currentProject.id)
            .order('created_at', { ascending: false });
            
        if (workflowError) {
            console.error('Error loading workflow items:', workflowError);
            throw workflowError;
        }

        console.log("√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ö¬† Data loaded from unified workflow table:", (allWorkflowItems || []).length);

        // Transform for display compatibility
        historyData = (allWorkflowItems || []).map(item => ({
            ...item,
            // Map fields for backward compatibility
            csi_division_code: item.csi_base_code,
            review_comments: item.reviewer_comments,
            // Determine display properties
            source: item.status === 'admin_approved' ? 'admin' : 'request',
            sourceIcon: item.status === 'admin_approved' ? '√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨¬π√É¬¢√Ö‚Äú√¢‚Ç¨¬¶' : '√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨¬π√É¬¢√Ç¬è√Ç¬≥',
            sourceDescription: item.status === 'admin_approved' ? 'Admin Generated' : 'User Request',
            isApproved: item.status === 'admin_approved',
            displayStatus: item.status,
            finalCode: item.item_code,
            // ERP status
            erpStatus: item.status === 'admin_approved' ? {
                erp_integrated: item.erp_integrated,
                erp_integrated_at: item.erp_integrated_at
            } : null
        }));
        
        console.log("√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Complete project history loaded:");
        console.log('  - Total records:', historyData.length);
        console.log('  - Pending items:', historyData.filter(h => h.status === 'pending').length);
        console.log('  - Reviewer approved:', historyData.filter(h => h.status === 'reviewer_approved').length);  
        console.log('  - Admin approved:', historyData.filter(h => h.status === 'admin_approved').length);
        console.log('  - Rejected items:', historyData.filter(h => h.status && h.status.includes('rejected')).length);
        
        renderHistoryTable();
        
    } catch (error) {
        console.error('Error loading comprehensive project history:', error);
        alert('Failed to load project history: ' + error.message);
    }
}
// Debug function to test data structure
async function debugDataStructure() {
    console.log('=== DEBUGGING DATA STRUCTURE ===');
    
    // Test request history data
    if (historyData && historyData.length > 0) {
        console.log('First history item:', historyData[0]);
        console.log('Unit price:', historyData[0].unit_price);
        console.log('Currency:', historyData[0].currency_code);
        console.log('Manufacturer:', historyData[0].manufacturer);
        console.log('Creator user:', historyData[0].created_by_user);
    }
    
    // Test search codes data
    if (allApprovedCodes && allApprovedCodes.length > 0) {
        console.log('First search code:', allApprovedCodes[0]);
        console.log('Unit price:', allApprovedCodes[0].unit_price);
        console.log('Currency:', allApprovedCodes[0].currency_code);
        console.log('Manufacturer:', allApprovedCodes[0].manufacturer);
        console.log('Creator user:', allApprovedCodes[0].created_by_user);
    }
    
    console.log('=== END DEBUG ===');
}
// Complete enhanced render history table function
function renderHistoryTable() {
    const cardsContainer = document.getElementById('history-cards-container');
    const tableContainer = document.getElementById('history-table-container');
    const tbody = document.getElementById('history-table');
    const toggleBtn = document.getElementById('toggle-view-btn');
    
    console.log('Rendering enhanced history table with', historyData.length, 'items');
    console.log('Card view mode:', isCardView);

    // Clear both containers
    if (cardsContainer) cardsContainer.innerHTML = '';
    if (tbody) tbody.innerHTML = '';

    if (!historyData || historyData.length === 0) {
        if (cardsContainer) {
            cardsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No request history found for this project</div>';
        }
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="16" class="py-4 text-center text-gray-500">No request history found for this project</td></tr>';
        }
        return;
    }

    // Render cards view with enhanced information
    if (cardsContainer && isCardView) {
        historyData.forEach((item, index) => {
            const statusClass = getStatusClass(item.displayStatus || item.status);
            const formattedCombination = formatCombinationDisplay(item.attribute_selections);
            
            const card = document.createElement('div');
            card.className = 'bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg">${item.sourceIcon}</span>
                            <span class="text-xs font-medium px-2 py-1 bg-blue-100 text-blue-800 rounded">${item.sourceDescription}</span>
                            ${item.erpStatus && item.erpStatus.erp_integrated ? 
                                `<span class="text-xs font-medium px-2 py-1 bg-green-100 text-green-800 rounded">√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ ERP Integrated</span>` : ""}
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900 font-mono">${item.item_code}</h4>
                        <div class="flex items-center mt-1">
                            <span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">${item.displayStatus || item.status}</span>
                            <span class="ml-2 text-sm text-gray-500">${new Date(item.created_at).toLocaleDateString()}</span>
                            ${item.serial_number ? `<span class="ml-2 text-xs bg-gray-100 px-2 py-1 rounded">Serial: ${item.serial_number}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 ml-4">
                        <button onclick="viewItemDetails(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            View
                        </button>
                        <button onclick="exportSingleItem(${index}, 'excel')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                            Excel
                        </button>
                        <button onclick="exportSingleItem(${index}, 'pdf')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                            PDF
                        </button>
                        ${(item.status === 'rejected' || item.status === 'reviewer_rejected' || item.status === 'admin_rejected') && currentUser && currentUser.id === item.created_by && item.source === 'request' ? `
                            <button onclick="regenerateFromRejected(${index})" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Regenerate
                            </button>
                        ` : ''}
                        ${currentUser && currentUser.role === 'admin' && item.source === 'request' ? `
                            <button onclick="editItemCode(${item.id})" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
                                Edit
                            </button>
                            <button onclick="deleteItemCode(${item.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <!-- ENHANCED INFORMATION GRID WITH NEW FIELDS -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-sm mb-4">
                    <div>
                        <span class="font-medium text-gray-600">Request ID:</span>
                        <p class="font-mono text-blue-600">#${item.id}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Created by:</span>
                        <p class="text-gray-900">${item.created_by_user?.username || 'Unknown'}</p>
                        ${item.created_by_user?.email ? `<p class="text-xs text-gray-500">${item.created_by_user.email}</p>` : ''}
                    </div>
                    ${item.approved_by_user ? `
                    <div>
                        <span class="font-medium text-gray-600">Approved by:</span>
                        <p class="text-green-700 font-medium">${item.approved_by_user.username}</p>
                    </div>` : ''}
                    <div>
                        <span class="font-medium text-gray-600">Unit Price:</span>
                        <p class="font-mono bg-green-50 px-2 py-1 rounded text-green-800">${item.unit_price ? `${item.unit_price} ${item.currency_code || ''}` : 'Not specified'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Manufacturer:</span>
                        <p class="text-gray-900">${item.manufacturer || 'Not specified'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">CSI Code:</span>
                        <p class="font-mono">${item.csi_division_code || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Additional Level:</span>
                        <p>${item.additional_level || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">UoM:</span>
                        <p>${item.uom || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Country:</span>
                        <p>${item.country_of_origin || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Model:</span>
                        <p>${item.model_number || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Entry Type:</span>
                        <p>${item.entry_description || 'Generated'}</p>
                    </div>
                </div>
                
                <div class="mt-4 space-y-3">
                    <div>
                        <span class="font-medium text-gray-600">Description 1:</span>
                        <p class="text-gray-800 bg-gray-50 p-2 rounded border">${item.description1 || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Description 2:</span>
                        <p class="text-gray-800 bg-gray-50 p-2 rounded border">${item.description2 || '-'}</p>
                    </div>
                    ${currentUser && currentUser.role === 'admin' ? `
                        <div>
                            <span class="font-medium text-gray-600">Attribute Combination:</span>
                            <p class="text-gray-800 font-mono text-xs bg-gray-50 p-2 rounded border">${formattedCombination}</p>
                        </div>
                    ` : ''}
                    ${item.review_comments ? `
                        <div>
                            <span class="font-medium text-gray-600">Review Comments:</span>
                            <p class="text-gray-800 bg-yellow-50 p-2 rounded border">${item.review_comments}</p>
                        </div>
                    ` : ''}
                    ${item.erpStatus && item.erpStatus.erp_integrated && item.erpStatus.erp_integrated_at ? `
                        <div>
                            <span class="font-medium text-gray-600">ERP Integration:</span>
                            <p class="text-green-800 bg-green-50 p-2 rounded border">√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Integrated on ${new Date(item.erpStatus.erp_integrated_at).toLocaleDateString()}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            cardsContainer.appendChild(card);
        });
    }

    // Render table view with enhanced columns including source information
    if (tbody && !isCardView) {
        historyData.forEach((item, index) => {
            const statusClass = getStatusClass(item.displayStatus || item.status);
            const formattedCombination = formatCombinationDisplay(item.attribute_selections);
            
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-4 py-3 border-b text-sm font-mono">${item.item_code}</td>
                <td class="px-4 py-3 border-b text-sm">
                    <div class="flex items-center gap-1">
                        <span class="text-sm">${item.sourceIcon}</span>
                        <span class="px-1 py-0.5 rounded text-xs font-medium ${statusClass}">${item.displayStatus || item.status}</span>
                    </div>
                </td>
                <td class="px-4 py-3 border-b text-sm">
                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">${item.sourceDescription}</span>
                    ${item.erpStatus && item.erpStatus.erp_integrated ? 
                        `<br><span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded mt-1 inline-block">√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ ERP</span>` : ""}
                </td>
                <td class="px-4 py-3 border-b text-sm font-mono text-blue-600">#${item.id}</td>
                <td class="px-4 py-3 border-b text-sm">
                    ${item.created_by_user?.username || 'Unknown'}
                    ${item.created_by_user?.email ? `<br><span class="text-xs text-gray-500">${item.created_by_user.email}</span>` : ''}
                </td>
                <td class="px-4 py-3 border-b text-sm">
                    ${item.approved_by_user ? `<span class="text-green-700 font-medium">${item.approved_by_user.username}</span>` : '-'}
                </td>
                <td class="px-4 py-3 border-b text-sm font-mono">
                    <span class="bg-green-50 px-2 py-1 rounded text-green-800">
                        ${item.unit_price ? `${item.unit_price} ${item.currency_code || ''}` : 'Not specified'}
                    </span>
                </td>
                <td class="px-4 py-3 border-b text-sm">${item.manufacturer || 'Not specified'}</td>
                <td class="px-4 py-3 border-b text-sm font-mono">${item.csi_division_code || '-'}</td>
                <td class="px-4 py-3 border-b text-sm">${item.additional_level || '-'}</td>
                <td class="px-4 py-3 border-b text-sm">${item.uom || '-'}</td>
                <td class="px-4 py-3 border-b text-sm">${item.country_of_origin || '-'}</td>
                <td class="px-4 py-3 border-b text-sm">${item.model_number || '-'}</td>
                <td class="px-4 py-3 border-b text-sm">${item.description1 || '-'}</td>
                <td class="px-4 py-3 border-b text-sm">${new Date(item.created_at).toLocaleDateString()}</td>
                <td class="px-4 py-3 border-b text-sm">
                    <div class="flex flex-wrap gap-1">
                        <button onclick="viewItemDetails(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                            View
                        </button>
                        <button onclick="exportSingleItem(${index}, 'excel')" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                            Excel
                        </button>
                        <button onclick="exportSingleItem(${index}, 'pdf')" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs">
                            PDF
                        </button>
                        ${(item.status === 'rejected' || item.status === 'reviewer_rejected' || item.status === 'admin_rejected') && currentUser && currentUser.id === item.created_by && item.source === 'request' ? `
                            <button onclick="regenerateFromRejected(${index})" class="bg-orange-600 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs">
                                Regenerate
                            </button>
                        ` : ''}
                        ${currentUser && currentUser.role === 'admin' && item.source === 'request' ? `
                            <button onclick="editItemCode(${item.id})" class="bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 rounded text-xs">
                                Edit
                            </button>
                            <button onclick="deleteItemCode(${item.id})" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                Delete
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    console.log('Enhanced history rendering completed');
}

// Helper function to get status styling
function getStatusClass(status) {
    switch(status) {
        case 'approved':
        case 'admin_approved':
            return 'bg-green-100 text-green-800';
        case 'reviewer_approved':
            return 'bg-blue-100 text-blue-800';
        case 'rejected':
        case 'reviewer_rejected':
        case 'admin_rejected':
            return 'bg-red-100 text-red-800';
        case 'pending':
            return 'bg-yellow-100 text-yellow-800';
        default:
            return 'bg-gray-100 text-gray-800';
    }
}



// View request details function
async function viewRequestDetails(type, requestId) {
    try {
        let data, error;
        
        if (type === 'code') {
            const result = await supabase
                .from('item_code_workflow')
                .select('*')
                .eq('id', requestId)
                .single();
            data = result.data;
            error = result.error;
        } else {
            const result = await supabase
                .from('standard_value_requests')
                .select('*')
                .eq('id', requestId)
                .single();
            data = result.data;
            error = result.error;
        }
        
        if (error) throw error;
        
        // Create a modal to show details
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center';
        modal.innerHTML = `
            <div class="bg-white p-6 rounded-lg max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                <h3 class="text-lg font-semibold mb-4">Request Details</h3>
                <pre class="bg-gray-100 p-4 rounded text-sm overflow-auto">${JSON.stringify(data, null, 2)}</pre>
                <div class="mt-4 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error loading request details:', error);
        alert('Failed to load request details: ' + error.message);
    }
}





// Missing export functions for requests
function exportAllRequests(format) {
    if (!requestsData || requestsData.length === 0) {
        alert('No requests to export');
        return;
    }
    
    const timestamp = new Date().toISOString().slice(0, 10);
    
    if (format === 'excel') {
        exportToExcel(requestsData, `my_requests_${timestamp}.xlsx`);
    } else if (format === 'pdf') {
        exportToPDF(requestsData, `my_requests_${timestamp}.pdf`, 'My Requests');
    }
}

function toggleRequestsView() {
    // Toggle between card and table view for requests
    const cardsContainer = document.getElementById('requests-cards-container');
    const tableContainer = document.getElementById('requests-table-container');
    const toggleBtn = document.getElementById('toggle-requests-view-btn');
    
    if (cardsContainer.classList.contains('hidden')) {
        cardsContainer.classList.remove('hidden');
        tableContainer.classList.add('hidden');
        toggleBtn.textContent = 'Switch to Table View';
    } else {
        cardsContainer.classList.add('hidden');
        tableContainer.classList.remove('hidden');
        toggleBtn.textContent = 'Switch to Card View';
        // Render table version if needed
        renderRequestsTable();
    }
}

function renderRequestsTable() {
    const cardsContainer = document.getElementById('requests-cards-container');
    const tableContainer = document.getElementById('requests-table-container');
    const tbody = document.getElementById('requests-table');
    const toggleBtn = document.getElementById('toggle-requests-view-btn');
    
    // Clear both containers
    if (cardsContainer) cardsContainer.innerHTML = '';
    if (tbody) tbody.innerHTML = '';
    
    if (!requestsData || requestsData.length === 0) {
        if (cardsContainer) {
            cardsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No requests found</div>';
        }
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="12" class="py-4 text-center text-gray-500">No requests found</td></tr>';
        }
        return;
    }

    // Render cards view
    if (cardsContainer && isRequestsCardView) {
        requestsData.forEach((item, index) => {
            const statusClass = getStatusClass(item.status);
            const formattedCombination = formatCombinationDisplay(item.attribute_selections);
            
            const card = document.createElement('div');
            card.className = 'bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold text-gray-900 font-mono">${item.item_code}</h4>
                        <div class="flex items-center mt-1">
                            <span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">${item.status}</span>
                            <span class="ml-2 text-sm text-gray-500">${new Date(item.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="viewRequestDetails(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            View
                        </button>
                        ${item.status === 'rejected' ? `
                            <button onclick="modifyRejectedRequest(${item.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                                Modify & Resubmit
                            </button>
                        ` : ''}
                        <button onclick="exportSingleRequest(${index}, 'excel')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                            Excel
                        </button>
                        <button onclick="exportSingleRequest(${index}, 'pdf')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                            PDF
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-600">CSI Code:</span>
                        <p class="font-mono">${item.csi_division_code || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Additional Level:</span>
                        <p>${item.additional_level || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Entry Type:</span>
                        <p>${item.entry_description || 'Generated'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">UoM:</span>
                        <p>${item.uom || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Country of Origin:</span>
                        <p>${item.country_of_origin || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Model:</span>
                        <p>${item.model_number || '-'}</p>
                    </div>
                </div>
                
                <div class="mt-4 space-y-2">
                    <div>
                        <span class="font-medium text-gray-600">Description 1:</span>
                        <p class="text-gray-800">${item.description1 || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Description 2:</span>
                        <p class="text-gray-800">${item.description2 || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Attribute Combination:</span>
                        <p class="text-gray-800 font-mono text-xs">${formattedCombination}</p>
                    </div>
                    ${item.review_comments ? `
                        <div class="bg-red-50 border border-red-200 rounded p-3 mt-3">
                            <span class="font-medium text-red-700">Review Comments:</span>
                            <p class="text-red-800 mt-1">${item.review_comments}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            cardsContainer.appendChild(card);
        });
        
        cardsContainer.classList.remove('hidden');
        if (tableContainer) tableContainer.classList.add('hidden');
        if (toggleBtn) toggleBtn.textContent = 'Switch to Table View';
    }
    
    // Render table view
    if (tbody && !isRequestsCardView) {
        requestsData.forEach((item, index) => {
            const row = tbody.insertRow();
            const statusClass = getStatusClass(item.status);
            
            row.innerHTML = `
                <td class="py-1 px-2 border text-xs font-mono">${item.csi_division_code || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.additional_level || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.entry_description || 'Generated'}</td>
                <td class="py-1 px-2 border text-xs font-mono">${item.item_code}</td>
                <td class="py-1 px-2 border text-xs" title="${item.description1 || ''}">${(item.description1 || '-').substring(0, 20)}...</td>
                <td class="py-1 px-2 border text-xs" title="${item.description2 || ''}">${(item.description2 || '-').substring(0, 30)}...</td>
                <td class="py-1 px-2 border text-xs font-mono">${item.combination_signature || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.uom || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.country_of_origin || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.model_number || '-'}</td>
                <td class="py-1 px-2 border text-xs">
                    <div class="flex items-center space-x-1">
                        <span class="px-1 py-0.5 rounded text-xs ${statusClass}">${item.status}</span>
                        ${item.status === 'rejected' ? `
                            <button onclick="modifyRejectedRequest(${item.id})" class="px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white text-xs rounded">
                                Modify
                            </button>
                        ` : ''}
                    </div>
                </td>
                <td class="py-1 px-2 border text-xs">${new Date(item.created_at).toLocaleDateString()}</td>
            `;
        });
        
        if (cardsContainer) cardsContainer.classList.add('hidden');
        tableContainer.classList.remove('hidden');
        if (toggleBtn) toggleBtn.textContent = 'Switch to Card View';
    }
}
let isRequestsCardView = true;

// Enhanced render requests table
function renderRequestsTable() {
    const cardsContainer = document.getElementById('requests-cards-container');
    const tableContainer = document.getElementById('requests-table-container');
    const tbody = document.getElementById('requests-table');
    const toggleBtn = document.getElementById('toggle-requests-view-btn');
    
    // Clear both containers
    if (cardsContainer) cardsContainer.innerHTML = '';
    if (tbody) tbody.innerHTML = '';
    
    if (!requestsData || requestsData.length === 0) {
        if (cardsContainer) {
            cardsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No requests found</div>';
        }
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="12" class="py-4 text-center text-gray-500">No requests found</td></tr>';
        }
        return;
    }

    // Render cards view
    if (cardsContainer && isRequestsCardView) {
        requestsData.forEach((item, index) => {
            const statusClass = getStatusClass(item.status);
            const formattedCombination = formatCombinationDisplay(item.attribute_selections);
            
            const card = document.createElement('div');
            card.className = 'bg-white border rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold text-gray-900 font-mono">${item.item_code}</h4>
                        <div class="flex items-center mt-1">
                            <span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">${item.status}</span>
                            <span class="ml-2 text-sm text-gray-500">${new Date(item.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="viewRequestDetails(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            View
                        </button>
                        <button onclick="exportSingleRequest(${index}, 'excel')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                            Excel
                        </button>
                        <button onclick="exportSingleRequest(${index}, 'pdf')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                            PDF
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-600">CSI Code:</span>
                        <p class="font-mono">${item.csi_division_code || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Additional Level:</span>
                        <p>${item.additional_level || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Entry Type:</span>
                        <p>${item.entry_description || 'Generated'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">UoM:</span>
                        <p>${item.uom || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Country of Origin:</span>
                        <p>${item.country_of_origin || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Model:</span>
                        <p>${item.model_number || '-'}</p>
                    </div>
                </div>
                
                <div class="mt-4 space-y-2">
                    <div>
                        <span class="font-medium text-gray-600">Description 1:</span>
                        <p class="text-gray-800">${item.description1 || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Description 2:</span>
                        <p class="text-gray-800">${item.description2 || '-'}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Attribute Combination:</span>
                        <p class="text-gray-800 font-mono text-xs">${formattedCombination}</p>
                    </div>
                    ${item.review_comments ? `
                        <div>
                            <span class="font-medium text-gray-600">Review Comments:</span>
                            <p class="text-gray-800">${item.review_comments}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            cardsContainer.appendChild(card);
        });
        
        cardsContainer.classList.remove('hidden');
        if (tableContainer) tableContainer.classList.add('hidden');
        if (toggleBtn) toggleBtn.textContent = 'Switch to Table View';
    }
    
    // Render table view
    if (tbody && !isRequestsCardView) {
        requestsData.forEach(item => {
            const row = tbody.insertRow();
            const statusClass = getStatusClass(item.status);
            
            row.innerHTML = `
                <td class="py-1 px-2 border text-xs font-mono">${item.csi_division_code || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.additional_level || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.entry_description || 'Generated'}</td>
                <td class="py-1 px-2 border text-xs font-mono">${item.item_code}</td>
                <td class="py-1 px-2 border text-xs" title="${item.description1 || ''}">${(item.description1 || '-').substring(0, 20)}...</td>
                <td class="py-1 px-2 border text-xs" title="${item.description2 || ''}">${(item.description2 || '-').substring(0, 30)}...</td>
                <td class="py-1 px-2 border text-xs font-mono">${item.combination_signature || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.uom || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.country_of_origin || '-'}</td>
                <td class="py-1 px-2 border text-xs">${item.model_number || '-'}</td>
                <td class="py-1 px-2 border text-xs">
                    <span class="px-1 py-0.5 rounded text-xs ${statusClass}">${item.status}</span>
                </td>
                <td class="py-1 px-2 border text-xs">${new Date(item.created_at).toLocaleDateString()}</td>
            `;
        });
        
        if (cardsContainer) cardsContainer.classList.add('hidden');
        tableContainer.classList.remove('hidden');
        if (toggleBtn) toggleBtn.textContent = 'Switch to Card View';
    }
}

// View request details function
function viewRequestDetails(index) {
    const item = requestsData[index];
    if (!item) return;
    
    viewItemDetails.call(this, index, true); // Reuse the existing modal with request flag
}

// Export single request
function exportSingleRequest(index, format) {
    const item = requestsData[index];
    if (!item) return;
    
    if (format === 'excel') {
        exportToExcel([item], `request-${item.item_code}.xlsx`);
    } else if (format === 'pdf') {
        exportToPDF([item], `request-${item.item_code}.pdf`, `Request: ${item.item_code}`);
    }
}

// Toggle requests view
function toggleRequestsView() {
    isRequestsCardView = !isRequestsCardView;
    renderRequestsTable();
}

// Export all requests
function exportAllRequests(format) {
    if (!requestsData || requestsData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const timestamp = new Date().toISOString().slice(0, 10);
    
    if (format === 'excel') {
        exportToExcel(requestsData, `my_requests_${timestamp}.xlsx`);
    } else if (format === 'pdf') {
        exportToPDF(requestsData, `my_requests_${timestamp}.pdf`, 'My Item Code Requests');
    }
}

// Make request functions globally available
window.viewRequestDetails = viewRequestDetails;
window.exportSingleRequest = exportSingleRequest;
window.toggleRequestsView = toggleRequestsView;
window.exportAllRequests = exportAllRequests;        // PDF Export
        function exportToPDF(data, filename, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(title, 14, 20);
            
            if (currentProject) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Project: ${currentProject.project_name}`, 14, 30);
                doc.text(`CSI Path: ${currentProject.division_code}-${currentProject.section_code}-${currentProject.detailed_section_code}-${currentProject.item_code}`, 14, 36);
            }
            
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 42);
            doc.text(`Generated by: ${currentUser.username}`, 14, 48);
            
            const headers = [
                'CSI Code', 'Additional Level', 'Entry Type', 'Item Code', 
                'Description 1', 'Description 2', 'Combination', 'UoM', 
                'Origin', 'Model', 'Status', 'Created'
            ];
            
            const tableData = data.map(item => [
                item.csi_division_code || '-',
                item.additional_level || '-',
                item.entry_description || 'Generated',
                item.item_code,
                (item.description1 || '-').substring(0, 30) + '...',
                (item.description2 || '-').substring(0, 40) + '...',
                item.combination_signature || '-',
                item.uom || '-',
                item.country_of_origin || '-',
                item.model_number || '-',
                item.status,
                new Date(item.created_at).toLocaleDateString()
            ]);
            
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 55,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [66, 139, 202] },
                margin: { top: 55 }
            });
            
            doc.save(filename);
        }

        // Update modal attributes
        function updateModalAttributes() {
            const select = document.getElementById('modal-attribute-select');
            select.innerHTML = '<option value="">Select attribute...</option>';
            
            currentProject.attributes.forEach(attr => {
                const option = document.createElement('option');
                option.value = attr.attribute_id;
                option.textContent = attr.attribute_name;
                select.appendChild(option);
            });
        }

        // Update modal reviewers
        function updateModalReviewers() {
            const modalReviewerSelect = document.getElementById('modal-reviewer-select');
            const mainReviewerSelect = document.getElementById('reviewer-select');
            
            modalReviewerSelect.innerHTML = '<option value="">Select reviewer...</option>';
            
            for (let i = 1; i < mainReviewerSelect.options.length; i++) {
                const option = mainReviewerSelect.options[i];
                const newOption = document.createElement('option');
                newOption.value = option.value;
                newOption.textContent = option.textContent;
                modalReviewerSelect.appendChild(newOption);
            }
        }

        // Submit standard value request - Admin bypasses approval
        async function submitStandardValueRequest(e) {
            e.preventDefault();
            
            const attributeSelect = document.getElementById('modal-attribute-select');
            const attributeId = parseInt(attributeSelect.value);
            const attributeName = attributeSelect.options[attributeSelect.selectedIndex].text;
            const newValue = document.getElementById('modal-new-value').value;
            const unit = document.getElementById('modal-unit-select').value;
            const reason = document.getElementById('modal-reason').value;

            if (!attributeId || !newValue.trim()) {
                alert('Please select an attribute and enter a new value.');
                return;
            }

            const valueWithUnit = unit ? `${newValue.trim()} (${unit})` : newValue.trim();

            try {
                // ADMIN BYPASS: Admins add values directly without approval
                if (currentUser.role === 'admin') {
                    // Get current attribute
                    const { data: attrData, error: attrError } = await supabase
                        .from('project_attributes')
                        .select('standard_values')
                        .eq('id', attributeId)
                        .single();

                    if (attrError) throw attrError;

                    // Add new value to standard_values array
                    const currentValues = attrData.standard_values || [];
                    const newValueObj = {
                        name: newValue.trim(),
                        unit: unit || null
                    };
                    currentValues.push(newValueObj);

                    // Update the attribute with new value
                    const { error: updateError } = await supabase
                        .from('project_attributes')
                        .update({ standard_values: currentValues })
                        .eq('id', attributeId);

                    if (updateError) throw updateError;

                    alert('Standard value added successfully (Admin - No approval required)\n\nPlease refresh the project to see the new value.');
                    document.getElementById('add-value-modal').classList.add('hidden');
                    document.getElementById('add-value-form').reset();
                    
                    // Reload the project to show new value
                    selectProjectFromData(currentProject);
                } else {
                    // Regular users go through approval process
                    const reviewerId = document.getElementById('modal-reviewer-select').value;
                    if (!reviewerId) {
                        alert('Please assign a reviewer.');
                        return;
                    }

                    const { data, error } = await supabase
                        .from('standard_value_requests')
                        .insert({
                            project_id: currentProject.id,
                            attribute_id: attributeId,
                            attribute_name: attributeName,
                            new_value: valueWithUnit,
                            reason: reason.trim() || null,
                            created_by: currentUser.id,
                            reviewed_by: parseInt(reviewerId),
                            status: 'pending'
                        })
                        .select();

                    if (error) throw error;

                    if (data && data.length > 0) {
                        alert('Standard value request submitted successfully and assigned to reviewer!');
                        document.getElementById('add-value-modal').classList.add('hidden');
                        document.getElementById('add-value-form').reset();
                    } else {
                        alert('Failed to submit standard value request');
                    }
                }
            } catch (error) {
                console.error('Error submitting standard value request:', error);
                alert('Failed to submit request: ' + error.message);
            }
        }

        function setupEventListeners() {
    // Check if required elements exist before adding listeners
    const elementChecks = [
        'logout-btn', 'generate-btn', 'block-btn', 'uom-select', 
        'country-select', 'reviewer-select', 'model-number',
        'unit-price', 'currency-select', 'manufacturer-select', 'add-manufacturer-btn',
        'add-standard-value-btn', 'add-value-form', 'modal-cancel'
    ];
    
    const missingElements = elementChecks.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
        console.warn('Missing elements for event listeners:', missingElements);
    }

    // Logout
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            location.reload();
        });
    }

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            console.log('Tab clicked:', tabName);
            
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-600');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            btn.classList.remove('border-transparent', 'text-gray-500');
            btn.classList.add('border-blue-500', 'text-blue-600');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Load specific tab data
            if (tabName === 'user-history') {
                loadUserHistory();
            } else if (tabName === 'admin') {
                loadAdminPanel();
            } else if (tabName === 'search') {
                console.log('Search tab clicked, allApprovedCodes.length:', allApprovedCodes.length);
                // Always refresh search data when switching to search tab to ensure latest data
                console.log('Refreshing search codes data for latest changes...');
                refreshSearchCodesData();
            } else if (tabName === 'erp') {
                console.log(' ERP tab clicked, loading dashboard...');
                loadERPDashboard();
            }
        });
    });

    // History Sub-tab switching
    document.querySelectorAll('.history-subtab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const subtabName = btn.dataset.subtab;
            console.log('History sub-tab clicked:', subtabName);
            
            // Update button styles
            document.querySelectorAll('.history-subtab-btn').forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-600', 'font-medium');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            btn.classList.remove('border-transparent', 'text-gray-500');
            btn.classList.add('border-blue-500', 'text-blue-600', 'font-medium');
            
            // Show/hide content
            document.querySelectorAll('.history-subtab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${subtabName}-subtab`).classList.remove('hidden');
            
            // Load specific subtab data
            if (subtabName === 'item-codes') {
                loadUserHistory();
            } else if (subtabName === 'standard-values') {
                loadStandardValueRequests();
            } else if (subtabName === 'combination-requests') {
                loadCombinationRequests();
            }
        });
    });

    // Buttons
    const generateBtn = document.getElementById('generate-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', submitItemCode);
    }
    
    const blockBtn = document.getElementById('block-btn');
    if (blockBtn) {
        blockBtn.addEventListener('click', submitBlockRequest);
    }

    // Enhanced form changes with duplicate checking
    const uomSelect = document.getElementById('uom-select');
if (uomSelect) {
    uomSelect.addEventListener('change', async () => {
        updatePreview();
        await checkForDuplicates();
        await checkGenerateButton();
    });
}
    
    const countrySelect = document.getElementById('country-select');
if (countrySelect) {
    countrySelect.addEventListener('change', async () => {
        updatePreview();
        await checkForDuplicates();
        await checkGenerateButton();
    });
}
    
    const reviewerSelect = document.getElementById('reviewer-select');
    if (reviewerSelect) {
        reviewerSelect.addEventListener('change', checkGenerateButton);
    }
    
    const modelNumber = document.getElementById('model-number');
if (modelNumber) {
    modelNumber.addEventListener('input', async () => {
        updatePreview();
        await checkForDuplicates();
        await checkGenerateButton();
    });
}
// Unit price and currency event listeners
    const unitPrice = document.getElementById('unit-price');
    if (unitPrice) {
        unitPrice.addEventListener('input', async () => {
            updatePreview();
            await checkForDuplicates();
            await checkGenerateButton();
        });
    }

    const currencySelect = document.getElementById('currency-select');
    if (currencySelect) {
        currencySelect.addEventListener('change', async () => {
            updatePreview();
            await checkForDuplicates();
            await checkGenerateButton();
        });
    }

    // Manufacturer event listeners
    const manufacturerSelect = document.getElementById('manufacturer-select');
    if (manufacturerSelect) {
        manufacturerSelect.addEventListener('change', async () => {
            updatePreview();
            await checkForDuplicates();
            await checkGenerateButton();
        });
    }

    // Add manufacturer button
    const addManufacturerBtn = document.getElementById('add-manufacturer-btn');
    if (addManufacturerBtn) {
        addManufacturerBtn.addEventListener('click', showAddManufacturerModal);
    }
    // Export functionality with error checking
    const exportAllExcelBtn = document.getElementById('export-all-excel-btn');
    if (exportAllExcelBtn) {
        exportAllExcelBtn.addEventListener('click', () => {
            exportAllItems('excel');
        });
    }

    const exportPdfBtn = document.getElementById('export-pdf-btn');
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', () => {
            exportAllItems('pdf');
        });
    }

    const toggleViewBtn = document.getElementById('toggle-view-btn');
    if (toggleViewBtn) {
        toggleViewBtn.addEventListener('click', toggleView);
    }

    // Requests tab event listeners
    const exportRequestsExcelBtn = document.getElementById('export-requests-excel-btn');
    if (exportRequestsExcelBtn) {
        exportRequestsExcelBtn.addEventListener('click', () => {
            exportAllRequests('excel');
        });
    }

    const exportRequestsPdfBtn = document.getElementById('export-requests-pdf-btn');
    if (exportRequestsPdfBtn) {
        exportRequestsPdfBtn.addEventListener('click', () => {
            exportAllRequests('pdf');
        });
    }

    const toggleRequestsViewBtn = document.getElementById('toggle-requests-view-btn');
    if (toggleRequestsViewBtn) {
        toggleRequestsViewBtn.addEventListener('click', toggleRequestsView);
    }

    // Modal
    const addStandardValueBtn = document.getElementById('add-standard-value-btn');
    if (addStandardValueBtn) {
        addStandardValueBtn.addEventListener('click', () => {
            if (!currentProject) {
                alert('Please select a project first.');
                return;
            }
            
            // Hide reviewer selection for admins and remove required attribute
            const reviewerSelect = document.getElementById('modal-reviewer-select');
            const reviewerDiv = reviewerSelect ? reviewerSelect.closest('.mb-4') : null;
            if (reviewerDiv && currentUser && currentUser.role === 'admin') {
                reviewerDiv.style.display = 'none';
                reviewerSelect.removeAttribute('required');
            } else if (reviewerDiv) {
                reviewerDiv.style.display = 'block';
                reviewerSelect.setAttribute('required', 'required');
                updateModalReviewers();
            }
            
            document.getElementById('add-value-modal').classList.remove('hidden');
        });
    }

    const addValueForm = document.getElementById('add-value-form');
    if (addValueForm) {
        addValueForm.addEventListener('submit', submitStandardValueRequest);
    }

    const modalCancel = document.getElementById('modal-cancel');
    if (modalCancel) {
        modalCancel.addEventListener('click', () => {
            document.getElementById('add-value-modal').classList.add('hidden');
        });
    }
    
    // Setup variation preview listeners  
    setupVariationPreviewListeners();
}       



window.selectAttribute = selectAttribute;
// Manual entry functions
function selectManualEntry(attrId, inputId, isDirectEntry) {
    console.log('=== MANUAL ENTRY CLICKED ===');
    console.log('Attribute ID:', attrId);
    console.log('Input ID:', inputId);
    console.log('Is direct entry:', isDirectEntry);
    
    const input = document.getElementById(inputId);
    console.log('Input element found:', !!input);
    
    if (input) {
        console.log('Enabling manual input...');
        input.disabled = false;
        input.focus();
        input.style.backgroundColor = '#fff';
        
        // If this is a direct entry (no radio button), immediately set up the attribute
        if (isDirectEntry) {
            const currentValue = input.value.trim();
            if (currentValue) {
                attributeSelections[attrId] = { value: currentValue, index: 'manual' };
            } else {
                attributeSelections[attrId] = { value: '', index: 'manual' };
            }
        } else {
            // For radio button mode, initialize with empty manual entry
            attributeSelections[attrId] = { value: '', index: 'manual' };
        }
        
        console.log('Manual entry initialized for attribute:', attrId);
        
        updatePreview();
        checkForDuplicates();
        checkGenerateButton();
    } else {
        console.error('Manual entry input not found:', inputId);
    }
}
function updateManualValue(attrId, value, unitSelectId) {
    console.log('Manual value updated:', attrId, value, unitSelectId);
    
    const unitSelect = document.getElementById(unitSelectId);
    const selectedUnit = unitSelect ? unitSelect.value : '';
    
    let formattedValue = value ? value.trim() : '';
    if (formattedValue && selectedUnit) {
        formattedValue = `${formattedValue} (${selectedUnit})`;
    }
    
    if (formattedValue) {
        attributeSelections[attrId] = { value: formattedValue, index: 'manual' };
    } else {
        // Keep the manual selection but with empty value
        attributeSelections[attrId] = { value: '', index: 'manual' };
    }
    
    console.log('Updated attribute selection:', attributeSelections[attrId]);
    updatePreview();
    checkForDuplicates();
    checkGenerateButton();
}
function clearAttributeSelection(attrId, radioGroupName) {
    console.log('Clearing selection for attribute:', attrId);
    
    // Clear from attributeSelections
    delete attributeSelections[attrId];
    
    // Uncheck all radio buttons for this attribute
    const radioButtons = document.querySelectorAll(`input[name="${radioGroupName}"]`);
    radioButtons.forEach(radio => {
        radio.checked = false;
    });
    
    // Disable and clear any manual entry input
    const manualInput = document.querySelector(`input[type="text"][id*="manual-attr"]`);
    if (manualInput && manualInput.id.includes(radioGroupName.split('-')[1])) {
        manualInput.disabled = true;
        manualInput.value = '';
        manualInput.style.backgroundColor = '#f3f4f6';
    }
    
    updatePreview();
    checkForDuplicates();
    checkGenerateButton();
}

// Make manual entry functions globally available
window.selectManualEntry = selectManualEntry;
window.updateManualValue = updateManualValue;
window.clearAttributeSelection = clearAttributeSelection;
        window.selectProject = selectProject;
        window.editItemCode = editItemCode;
        window.deleteItemCode = deleteItemCode;
        window.toggleHierarchyNode = toggleHierarchyNode;
window.viewCodeDetails = viewCodeDetails;
window.copyToClipboard = copyToClipboard;
window.toggleERPStatus = toggleERPStatus;
 function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Invalid Date';
        
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        console.error('Error formatting date:', error);
        return 'Invalid Date';
    }
}

// ===== SEARCH CODES FUNCTIONALITY =====

// Function to refresh search codes data
// Function to refresh search codes data
function refreshSearchCodesData() {
    console.log('Refreshing search codes data...');
    allApprovedCodes = []; // Clear cached data
    
    // Clear any existing display
    const hierarchyView = document.getElementById('hierarchy-view');
    const listView = document.getElementById('list-view');
    const summary = document.getElementById('search-summary');
    
    if (hierarchyView) hierarchyView.innerHTML = '';
    if (listView) listView.innerHTML = '';
    if (summary) summary.classList.add('hidden');
    
    // Show loading state
    const loadingState = document.getElementById('search-loading');
    if (loadingState) loadingState.classList.remove('hidden');
    
    // Reload from database
    loadAllApprovedCodes();
}

let allApprovedCodes = [];
let searchHierarchyView = true;




// Load all approved item codes
async function loadAllApprovedCodes() {
    try {
        console.log('Starting to load ONLY approved codes...');
        
        // Show loading state
        const loadingState = document.getElementById('search-loading');
        const emptyState = document.getElementById('search-empty');
        const hierarchyView = document.getElementById('hierarchy-view');
        const listView = document.getElementById('list-view');
        
        if (loadingState) loadingState.classList.remove('hidden');
        if (emptyState) emptyState.classList.add('hidden');
        if (hierarchyView) hierarchyView.classList.add('hidden');
        if (listView) listView.classList.add('hidden');
        
        // CRITICAL FIX: Load ONLY items approved by ADMIN
        const { data: approvedCodes, error } = await supabase
            .from('item_code_workflow')
            .select(`
                id,
                item_code,
                description1,
                description2,
                uom,
                country_of_origin,
                model_number,
                unit_price,
                currency_code,
                manufacturer,
                created_at,
                project_id,
                status,
                approved_by,
                approved_at,
                erp_integrated,
                erp_integrated_at,
                erp_integrated_by,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                approved_by_user:users!item_code_workflow_approved_by_fkey(username, email),
                classification_projects!inner (
                    id,
                    project_name,
                    division_code,
                    division_description,
                    section_code,
                    section_description,
                    detailed_section_code,
                    detailed_section_description,
                    item_code,
                    item_description,
                    additional_level_name,
                    additional_level_value
                )
            `)
            .eq('status', 'admin_approved')  // Status must be approved
            .not('approved_by', 'is', null)  // CRITICAL: Must have admin approval
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allApprovedCodes = approvedCodes || [];
        console.log(' ONLY admin-approved codes loaded:', allApprovedCodes.length);
        console.log(' Approved by admins:', allApprovedCodes.filter(c => c.approved_by).length);
        if (allApprovedCodes.length > 0) {
            console.log(' First item approved by:', allApprovedCodes[0].approved_by_user?.username);
        }
        
        // Hide loading state
        if (loadingState) loadingState.classList.add('hidden');
        
        // Show appropriate state
        if (allApprovedCodes.length === 0) {
            showEmptyStateApproved();
        } else {
            displaySearchResults(allApprovedCodes);
        }
        
    } catch (error) {
        console.error('Error loading approved codes:', error);
        
        // Hide loading state on error
        const loadingState = document.getElementById('search-loading');
        if (loadingState) loadingState.classList.add('hidden');
        
        showEmptyStateApproved();
    }
}
// Show empty state with helpful message
function showEmptyState() {
    const hierarchyView = document.getElementById('hierarchy-view');
    const listView = document.getElementById('list-view');
    const summary = document.getElementById('search-summary');
    const emptyState = document.getElementById('search-empty');
    
    // Hide other views
    hierarchyView.classList.add('hidden');
    listView.classList.add('hidden');
    summary.classList.add('hidden');
    
    // Update empty state message
    emptyState.innerHTML = `
        <div class="text-center py-12 text-gray-500">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-lg font-medium mb-2">No approved item codes found</p>
            <p class="text-sm mb-4">There are currently no approved item codes in the system.</p>
            <div class="text-xs text-gray-400 space-y-1">
                <p> Item codes need to be generated and approved first</p>
                <p> Check the "Generate Codes" tab to create new item codes</p>
                <p> Admins can approve codes in the approval portal</p>
            </div>
        </div>
    `;
    
    emptyState.classList.remove('hidden');
}
// Show empty state specifically for approved codes
function showEmptyStateApproved() {
    const hierarchyView = document.getElementById('hierarchy-view');
    const listView = document.getElementById('list-view');
    const summary = document.getElementById('search-summary');
    const emptyState = document.getElementById('search-empty');
    
    // Hide other views
    if (hierarchyView) hierarchyView.classList.add('hidden');
    if (listView) listView.classList.add('hidden');
    if (summary) summary.classList.add('hidden');
    
    // Update empty state message
    if (emptyState) {
        emptyState.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-lg font-medium mb-2">No approved item codes found</p>
                <p class="text-sm mb-4">There are currently no approved item codes in the system.</p>
                <div class="text-xs text-gray-400 space-y-1">
                    <p> Item codes must be approved by an admin before appearing here</p>
                    <p> Only codes with status 'approved' are shown</p>
                    <p> Check with admin if codes are missing</p>
                </div>
            </div>
        `;
        emptyState.classList.remove('hidden');
    }
}
function setupSearchCodesTab() {
    const refreshBtn = document.getElementById('refresh-search-btn');
if (refreshBtn) {
    refreshBtn.addEventListener('click', refreshSearchCodesData);
}
    // Search input event listeners
    const searchInputs = [
        'search-desc1', 'search-desc2', 'search-item-code', 
        'search-project-name-codes', 'search-csi-path', 'search-country',
        'search-model', 'search-uom', 'search-attributes', 'search-erp-status'
    ];
    
    searchInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', debounce(performCodeSearch, 300));
        }
    });
    
    // Button event listeners
    const performSearchBtn = document.getElementById('perform-search-btn');
    if (performSearchBtn) {
        performSearchBtn.addEventListener('click', performCodeSearch);
    }
    
    const clearSearchBtn = document.getElementById('clear-search-codes-btn');
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', clearCodeSearch);
    }
    
    const toggleViewBtn = document.getElementById('toggle-view-btn');
    if (toggleViewBtn) {
        toggleViewBtn.addEventListener('click', toggleSearchView);
    }
    
    // Legacy export button (now triggers dropdown)
    const exportBtn = document.getElementById('export-search-results-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportSearchResults);
    }
    
    // Enhanced export functionality
    const exportDropdownBtn = document.getElementById('export-dropdown-btn');
    if (exportDropdownBtn) {
        exportDropdownBtn.addEventListener('click', toggleExportDropdown);
    }
    
    const exportExcelBtn = document.getElementById('export-excel-btn');
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', () => {
            const filterType = document.getElementById('export-filter-select').value;
            exportFilteredToExcel(filterType);
            // Close dropdown after export
            document.getElementById('export-dropdown-menu').classList.add('hidden');
        });
    }
    
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', () => {
            const filterType = document.getElementById('export-filter-select').value;
            exportFilteredToPDF(filterType);
            // Close dropdown after export
            document.getElementById('export-dropdown-menu').classList.add('hidden');
        });
    }
}

// Perform search across all criteria
function performCodeSearch() {
    const criteria = {
        desc1: document.getElementById('search-desc1').value.toLowerCase().trim(),
        desc2: document.getElementById('search-desc2').value.toLowerCase().trim(),
        itemCode: document.getElementById('search-item-code').value.toLowerCase().trim(),
        projectName: document.getElementById('search-project-name-codes').value.toLowerCase().trim(),
        csiPath: document.getElementById('search-csi-path').value.toLowerCase().trim(),
        country: document.getElementById('search-country').value.toLowerCase().trim(),
        model: document.getElementById('search-model').value.toLowerCase().trim(),
        uom: document.getElementById('search-uom').value.toLowerCase().trim(),
        attributes: document.getElementById('search-attributes').value.toLowerCase().trim(),
        erpStatus: document.getElementById('search-erp-status').value
    };
    
    const hasSearchCriteria = Object.values(criteria).some(value => value && value.length > 0);
    
    if (!hasSearchCriteria) {
        displaySearchResults(allApprovedCodes);
        return;
    }
    
    const filtered = allApprovedCodes.filter(code => {
        let matches = true;
        
        // Description 1 search
        if (criteria.desc1 && !code.description1?.toLowerCase().includes(criteria.desc1)) {
            matches = false;
        }
        
        // Description 2 search
        if (criteria.desc2 && !code.description2?.toLowerCase().includes(criteria.desc2)) {
            matches = false;
        }
        
        // Item code search
        if (criteria.itemCode && !code.item_code?.toLowerCase().includes(criteria.itemCode)) {
            matches = false;
        }
        
        // Project name search
        if (criteria.projectName && !code.classification_projects?.project_name?.toLowerCase().includes(criteria.projectName)) {
            matches = false;
        }
        
        // CSI path search
        if (criteria.csiPath) {
            const project = code.classification_projects;
            const csiPath = `${project?.division_code} ${project?.section_code} ${project?.detailed_section_code} ${project?.project_item_code}`.toLowerCase();
            if (!csiPath.includes(criteria.csiPath)) {
                matches = false;
            }
        }
        
        // Country search
        if (criteria.country && !code.country_of_origin?.toLowerCase().includes(criteria.country)) {
            matches = false;
        }
        
        // Model search
        if (criteria.model && !code.model_number?.toLowerCase().includes(criteria.model)) {
            matches = false;
        }
        
        // UOM search
        if (criteria.uom && !code.uom?.toLowerCase().includes(criteria.uom)) {
            matches = false;
        }
        
        // Attributes/Standard values search
        if (criteria.attributes && code.attribute_selections) {
            const attributeText = JSON.stringify(code.attribute_selections).toLowerCase();
            if (!attributeText.includes(criteria.attributes)) {
                matches = false;
            }
        }
        // Attributes/Standard values search
if (criteria.attributes && code.attribute_selections) {
    const attributeText = JSON.stringify(code.attribute_selections).toLowerCase();
    if (!attributeText.includes(criteria.attributes)) {
        matches = false;
    }
}

// ERP status filter
if (criteria.erpStatus) {
    if (criteria.erpStatus === 'integrated' && !code.erp_integrated) {
        matches = false;
    } else if (criteria.erpStatus === 'pending' && code.erp_integrated) {
        matches = false;
    }
}

return matches;
        return matches;
    });
    
    displaySearchResults(filtered);
}

// Display search results in hierarchy or list view
// Add this updated card generation for search results
// Display search results in hierarchy or list view
function displaySearchResults(codes) {
    console.log('=== displaySearchResults called ===');
    console.log('Codes received:', codes.length);
    
    const resultsContainer = document.getElementById('search-results-container');
    const emptyState = document.getElementById('empty-state');
    const hierarchyView = document.getElementById('hierarchy-view');
    const listView = document.getElementById('list-view');
    const resultsCount = document.getElementById('results-count');
    
    // Update results count
    if (resultsCount) {
        resultsCount.textContent = `${codes.length} item codes found`;
    }
    
    // Hide empty state if we have results
    if (emptyState) {
        emptyState.classList.toggle('hidden', codes.length > 0);
    }
    
    // Show/hide views based on results
    if (hierarchyView) hierarchyView.classList.toggle('hidden', codes.length === 0);
    if (listView) listView.classList.toggle('hidden', codes.length === 0);
    
    if (codes.length === 0) {
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No search results found</div>';
        }
        return;
    }
    
    // Check current view mode
    const isHierarchyView = hierarchyView && !hierarchyView.classList.contains('hidden');
    
    if (isHierarchyView) {
        // Render hierarchy view
        displayHierarchyView(codes);
    } else {
        // Render list view using our enhanced cards
        displayListView(codes);
    }
}

// Display codes in list view with enhanced cards
function displayListView(codes) {
    const listView = document.getElementById('list-view');
    if (!listView) return;
    
    listView.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${codes.map(code => createSearchCodeCard(code)).join('')}
        </div>
    `;
}

// Display codes in hierarchy view
function displayHierarchyView(codes) {
    const hierarchyView = document.getElementById('hierarchy-view');
    if (!hierarchyView) return;
    
    // Group codes by project
    const groupedCodes = codes.reduce((groups, code) => {
        const projectName = code.project_name || 'Unknown Project';
        if (!groups[projectName]) {
            groups[projectName] = [];
        }
        groups[projectName].push(code);
        return groups;
    }, {});
    
    // Render grouped codes
    hierarchyView.innerHTML = Object.entries(groupedCodes).map(([projectName, projectCodes]) => `
        <div class="border border-gray-200 rounded-lg">
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">${projectName}</h3>
                <p class="text-sm text-gray-600">${projectCodes.length} item codes</p>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${projectCodes.map(code => createSearchCodeCard(code)).join('')}
                </div>
            </div>
        </div>
    `).join('');
}
function createSearchCodeCard(item) {
    console.log(' Creating card for item:', item.id);
    console.log(' Current user:', currentUser);
    console.log(' User role:', currentUser?.role);
    const isAdmin = currentUser && currentUser.role === 'admin';
    console.log(' Is admin check result:', isAdmin);
    
    return `
        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 hover:shadow-lg transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        ${item.item_code || 'No Code'}
                        ${item.is_variation ? `<span class="text-sm text-blue-600 bg-blue-100 px-2 py-1 rounded">(Variation ${item.variation_number})</span>` : ''}
                    </h3>
                    <p class="text-sm text-gray-600">${item.classification_projects?.project_name || 'Unknown Project'}</p>
                    ${item.is_variation ? `<p class="text-xs text-blue-500">Base: ${item.item_code.split('/')[0]}</p>` : ''}
                    <p class="text-xs text-blue-600">Approved by: ${item.approved_by_user?.username || 'Admin'}</p>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="px-3 py-1 text-xs rounded-full ${getStatusColor(item.status)}">
                        ${item.status ? item.status.toUpperCase() : 'UNKNOWN'}
                    </span>
                    <span class="px-2 py-1 text-xs rounded-full ${item.erp_integrated ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                        ERP ${item.erp_integrated ? '' : ''}
                    </span>
                </div>
            </div>
            
            <!-- Enhanced Information Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 text-sm mb-4">
                <div class="bg-gray-50 p-3 rounded">
                    <div class="font-medium text-gray-700 mb-1">Created by:</div>
                    <div class="text-gray-900">${item.created_by_user?.username || 'Unknown'}</div>
                    ${item.created_by_user?.email ? `<div class="text-xs text-gray-500 mt-1">${item.created_by_user.email}</div>` : ''}
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="font-medium text-gray-700 mb-1">Unit Price:</div>
                    <div class="font-mono text-green-800">
                        ${item.unit_price ? `${item.unit_price} ${item.currency_code || ''}` : 'Not specified'}
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="font-medium text-gray-700 mb-1">Manufacturer:</div>
                    <div class="text-gray-900">${item.manufacturer || 'Not specified'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="font-medium text-gray-700 mb-1">UOM:</div>
                    <div class="text-gray-900">${item.uom || 'Not specified'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="font-medium text-gray-700 mb-1">Country:</div>
                    <div class="text-gray-900">${item.country_of_origin || 'Not specified'}</div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="font-medium text-gray-700 mb-1">Model:</div>
                    <div class="text-gray-900">${item.model_number || 'Not specified'}</div>
                </div>
            </div>
            
            <!-- Description Section -->
            <div class="mb-4 bg-blue-50 p-3 rounded">
                <div class="font-medium text-gray-700 mb-2">Description:</div>
                <div class="text-gray-900">${item.description1 || 'No description available'}</div>
                ${item.description2 ? `<div class="text-gray-700 text-sm mt-2">${item.description2}</div>` : ''}
            </div>
            
            <!-- ADMIN ERP INTEGRATION CONTROL -->
            ${isAdmin ? `
                <div class="border-2 border-yellow-400 bg-yellow-50 p-4 rounded-lg mb-4">
                    <div class="flex items-center mb-3">
                        <span class="text-lg"></span>
                        <h4 class="font-bold text-gray-800 ml-2">ADMIN: ERP Integration Control</h4>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="text-sm font-medium">
                                Current Status: 
                                <span class="px-2 py-1 rounded text-xs ${item.erp_integrated ? 'bg-green-200 text-green-800' : 'bg-orange-200 text-orange-800'}">
                                    ${item.erp_integrated ? ' INTEGRATED' : ' NOT INTEGRATED'}
                                </span>
                            </div>
                            ${item.erp_integrated && item.erp_integrated_at ? 
                                `<div class="text-xs text-gray-600 mt-1">Integrated on: ${formatDate(item.erp_integrated_at)}</div>` : 
                                ''
                            }
                        </div>
                        <div class="ml-4">
                            <label class="flex items-center cursor-pointer bg-white p-3 rounded-lg border-2 border-gray-300 hover:border-blue-400">
                                <input type="checkbox" 
                                       id="erp-toggle-${item.id}"
                                       ${item.erp_integrated ? 'checked' : ''} 
                                       onchange="toggleERPStatus(${item.id}, this.checked)"
                                       class="mr-3 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="text-sm font-bold text-gray-700">
                                    ${item.erp_integrated ? 'UNMARK FROM ERP' : 'MARK AS INTEGRATED'}
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="border border-gray-200 bg-gray-50 p-3 rounded mb-4">
                    <div class="text-sm text-gray-600">
                        <strong>ERP Status:</strong> 
                        <span class="font-medium ${item.erp_integrated ? 'text-green-700' : 'text-orange-700'}">
                            ${item.erp_integrated ? ' Integrated' : ' Not Integrated'}
                        </span>
                        ${item.erp_integrated && item.erp_integrated_at ? 
                            `<span class="text-xs text-gray-500 ml-2">(${formatDate(item.erp_integrated_at)})</span>` : 
                            ''
                        }
                    </div>
                </div>
            `}
            
            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-2 pt-3 border-t border-gray-200">
                <button onclick="viewCodeDetails(${item.id})" class="text-xs bg-blue-100 text-blue-800 px-3 py-2 rounded hover:bg-blue-200 transition-colors">
                     View Details
                </button>
                <button onclick="exportItemToPDF(${item.id}, 'approved')" class="text-xs bg-red-100 text-red-800 px-3 py-2 rounded hover:bg-red-200 transition-colors">
                    Export PDF
                </button>
                <button onclick="exportItemToExcel(${item.id}, 'approved')" class="text-xs bg-green-100 text-green-800 px-3 py-2 rounded hover:bg-green-200 transition-colors">
                     Export Excel
                </button>
            </div>
        </div>
    `;
}
// Export individual request to PDF
async function exportRequestToPDF(requestId) {
    try {
        const { data: request, error } = await supabase
            .from('item_code_workflow')
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .eq('id', requestId)
            .single();
            
        if (error) throw error;
        
        // Generate single item PDF (you'll need to implement this based on your existing PDF logic)
        generateSingleRequestPDF(request);
    } catch (error) {
        console.error('Error exporting request to PDF:', error);
        alert('Failed to export PDF: ' + error.message);
    }
}

// Export individual request to Excel
async function exportRequestToExcel(requestId) {
    try {
        const { data: request, error } = await supabase
            .from('item_code_workflow')
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .eq('id', requestId)
            .single();
            
        if (error) throw error;
        
        generateSingleItemExcel([request], `Request_${request.item_code}_${Date.now()}.xlsx`);
    } catch (error) {
        console.error('Error exporting request to Excel:', error);
        alert('Failed to export Excel: ' + error.message);
    }
}

// Export individual item from search to PDF/Excel
async function exportItemToPDF(itemId, source) {
    try {
        // Use unified workflow table for all items
        const { data: item, error } = await supabase
            .from('item_code_workflow')
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .eq('id', itemId)
            .single();
            
        if (error) throw error;
        
        generateSingleRequestPDF(item);
    } catch (error) {
        console.error('Error exporting item to PDF:', error);
        alert('Failed to export PDF: ' + error.message);
    }
}

async function exportItemToExcel(itemId, source) {
    try {
        // Use unified workflow table for all items
        const { data: item, error } = await supabase
            .from('item_code_workflow')
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .eq('id', itemId)
            .single();
            
        if (error) throw error;
        
        generateSingleItemExcel([item], `Item_${item.item_code}_${Date.now()}.xlsx`);
    } catch (error) {
        console.error('Error exporting item to Excel:', error);
        alert('Failed to export Excel: ' + error.message);
    }
}

// Helper function for single item Excel export with new fields
// Helper function for single item PDF export
// Helper function for single item PDF export
// Helper function for single item PDF export
function generateSingleRequestPDF(item) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('Item Code Details', 14, 20);
    
    // Project info
    if (item.project?.project_name) {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Project: ${item.project.project_name}`, 14, 30);
    }
    
    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 36);
    doc.text(`Generated by: ${currentUser?.username || 'Unknown'}`, 14, 42);
    
    // Item details
    let yPos = 55;
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Item Information:', 14, yPos);
    
    yPos += 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    const details = [
        ['Item Code:', item.item_code || 'N/A'],
        ['Description 1:', item.description1 || 'N/A'],
        ['Description 2:', item.description2 || 'N/A'],
        ['Unit Price:', item.unit_price ? `${item.unit_price} ${item.currency_code || ''}` : 'Not specified'],
        ['UOM:', item.uom || 'N/A'],
        ['Country of Origin:', item.country_of_origin || 'N/A'],
        ['Model Number:', item.model_number || 'N/A'],
        ['Manufacturer:', item.manufacturer || 'Not specified'],
        ['Request ID:', item.id ? `#${item.id}` : 'N/A'],
        ['Status:', item.status || 'N/A'],
        ['Created by:', item.created_by_user?.username || 'Unknown'],
        ['Creator Email:', item.created_by_user?.email || 'N/A'],      
        ['CSI Code:', item.csi_division_code || 'N/A'],
        ['Additional Level:', item.additional_level || 'N/A'],
        ['Created Date:', new Date(item.created_at).toLocaleDateString()]
    ];
    
    details.forEach(([label, value]) => {
        doc.setFont(undefined, 'bold');
        doc.text(label, 14, yPos);
        doc.setFont(undefined, 'normal');
        
        // Handle long text wrapping
        const textLines = doc.splitTextToSize(value, 120);
        doc.text(textLines, 70, yPos);
        yPos += textLines.length * 6;
        
        // Add new page if needed
        if (yPos > 220) {
            doc.addPage();
            yPos = 20;
        }
    });
    
    // Review comments if present
    if (item.review_comments) {
        yPos += 5;
        doc.setFont(undefined, 'bold');
        doc.text('Review Comments:', 14, yPos);
        yPos += 6;
        doc.setFont(undefined, 'normal');
        const commentLines = doc.splitTextToSize(item.review_comments, 180);
        doc.text(commentLines, 14, yPos);
        yPos += commentLines.length * 6;
    }
    
    // APPROVAL SIGNATURES SECTION - Only for approved item codes
    const isApproved = ['approved', 'reviewer_approved', 'admin_approved'].includes(item.status);
    
    if (isApproved) {
        // Add space before signatures
        yPos += 15;
        
        // Check if we need a new page for signatures
        if (yPos > 200) {
            doc.addPage();
            yPos = 20;
        }
        
        // Signatures header with timestamp trail
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('APPROVAL SIGNATURES', 14, yPos);
        
        // Create timestamp trail
        let timestampTrail = '';
        
        // Creator info
        const creatorName = item.created_by_user?.username || 'Unknown';
        const createdDate = new Date(item.created_at).toISOString();
        timestampTrail += `Creator-${creatorName}-${createdDate}`;
        
        // Reviewer info (if available)
        if (item.reviewed_by || item.reviewed_at) {
            const reviewerName = item.reviewed_by_user?.username || item.reviewed_by || 'System';
            const reviewDate = item.reviewed_at ? new Date(item.reviewed_at).toISOString() : new Date().toISOString();
            timestampTrail += `-Reviewer-${reviewerName}-${reviewDate}`;
        }
        
        // Admin info (if available)
        if (item.admin_approved_by || item.admin_approved_at || item.status === 'admin_approved') {
            const adminName = item.admin_approved_by_user?.username || item.admin_approved_by || 'Administrator';
            const adminDate = item.admin_approved_at ? new Date(item.admin_approved_at).toISOString() : new Date().toISOString();
            timestampTrail += `-Admin-${adminName}-${adminDate}`;
        }
        
        // Add timestamp trail next to approval signatures
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        const timestampLines = doc.splitTextToSize(timestampTrail, 180);
        doc.text(timestampLines, 14, yPos + 10);
        yPos += 5 + (timestampLines.length * 4);
        
        
        
        // Reviewer Approval (if available)
        if (item.reviewed_by || item.reviewed_at) {
            doc.setFont(undefined, 'bold');
            doc.text('REVIEWER APPROVAL:', 14, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'normal');
            doc.text('Reviewed by:', 20, yPos);
            doc.text(item.reviewed_by_user?.username || item.reviewed_by || 'System', 80, yPos);
            yPos += 6;
            
            if (item.reviewed_at) {
                doc.text('Review Date:', 20, yPos);
                doc.text(new Date(item.reviewed_at).toLocaleDateString(), 80, yPos);
                yPos += 6;
            }
            
            // Signature line
            doc.text('Reviewer Signature:', 20, yPos);
            doc.setLineWidth(0.2);
            doc.line(80, yPos, 150, yPos);
            yPos += 12;
        }
        
        // Admin Approval (if available)
        if (item.admin_approved_by || item.admin_approved_at || item.status === 'admin_approved') {
            doc.setFont(undefined, 'bold');
            doc.text('ADMIN APPROVAL:', 14, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'normal');
            doc.text('Approved by:', 20, yPos);
            doc.text(item.admin_approved_by_user?.username || item.admin_approved_by || 'Administrator', 80, yPos);
            yPos += 6;
            
            if (item.admin_approved_at) {
                doc.text('Approval Date:', 20, yPos);
                doc.text(new Date(item.admin_approved_at).toLocaleDateString(), 80, yPos);
                yPos += 6;
            }
            
            // Signature line
            doc.text('Admin Signature:', 20, yPos);
            doc.setLineWidth(0.2);
            doc.line(80, yPos, 150, yPos);
            yPos += 12;
        }
        
        // Final approval stamp with proper sizing and approver details
        if (item.status === 'approved' || item.status === 'admin_approved') {
            yPos += 5;
            
            // Create approval summary with names and dates
            let approvalText = 'STATUS: APPROVED ';
            let approvalDetails = [];
            
            // Always show reviewer info for approved items
            if (item.reviewed_by_user?.username || item.reviewed_by || item.status.includes('approved')) {
                const reviewerName = item.reviewed_by_user?.username || item.reviewed_by || 'System Reviewer';
                const reviewDate = item.reviewed_at ? new Date(item.reviewed_at).toLocaleDateString() : null;
                approvalDetails.push(`Reviewer: ${reviewerName}${reviewDate ? ` (${reviewDate})` : ''}`);
            }
            
            // Always show admin info for admin approved items
            if (item.admin_approved_by_user?.username || item.admin_approved_by || item.status === 'admin_approved' || item.status === 'approved') {
                const adminName = item.admin_approved_by_user?.username || item.admin_approved_by || 'System Admin';
                const adminDate = item.admin_approved_at ? new Date(item.admin_approved_at).toLocaleDateString() : null;
                approvalDetails.push(`Admin: ${adminName}${adminDate ? ` (${adminDate})` : ''}`);
            }
            
            // Calculate box dimensions based on content
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            const approvalTextWidth = doc.getTextWidth(approvalText);
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            let maxDetailWidth = 0;
            approvalDetails.forEach(detail => {
                const width = doc.getTextWidth(detail);
                if (width > maxDetailWidth) maxDetailWidth = width;
            });
            
            // Box dimensions
            const boxWidth = Math.max(approvalTextWidth + 10, maxDetailWidth + 10, 120);
            const boxHeight = 12 + (approvalDetails.length * 5);
            
            // Draw approval box
            doc.setLineWidth(1);
            doc.rect(14, yPos - 2, boxWidth, boxHeight);
            
            // Main approval text
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(approvalText, 18, yPos + 6);
            
            // Approval details
            let detailYPos = yPos + 12;
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            approvalDetails.forEach(detail => {
                doc.text(detail, 18, detailYPos);
                detailYPos += 5;
            });
            
            yPos += boxHeight + 5;
        }
        
        // Add approval workflow note
        yPos += 15;
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.text('This item code has been approved through the official review process and is', 14, yPos);
        yPos += 4;
        doc.text('authorized for use in project specifications and procurement.', 14, yPos);
    }
    
    // Save the PDF
    const filename = `ItemCode_${item.item_code || 'Unknown'}_${Date.now()}.pdf`;
    doc.save(filename);
}
// Display codes in hierarchical WBS structure
function displayHierarchyView(codes) {
    const hierarchyView = document.getElementById('hierarchy-view');
    
    // Group codes by CSI hierarchy
    const hierarchy = {};
    
    codes.forEach(code => {
        const project = code.classification_projects;
        if (!project) return;
        
        const divisionKey = project.division_code;
        const sectionKey = `${project.division_code}-${project.section_code}`;
        const detailedKey = `${project.division_code}-${project.section_code}-${project.detailed_section_code}`;
        const itemKey = `${project.division_code}-${project.section_code}-${project.detailed_section_code}-${project.project_item_code}`;
        
        if (!hierarchy[divisionKey]) {
            hierarchy[divisionKey] = {
                code: project.division_code,
                title: project.division_code,
                description: project.division_description || 'No description',
                type: 'division',
                sections: {}
            };
        }
        
        if (!hierarchy[divisionKey].sections[sectionKey]) {
            hierarchy[divisionKey].sections[sectionKey] = {
                code: project.section_code,
                title: project.section_code,
                description: project.section_description || 'No description',
                type: 'section',
                detailedSections: {}
            };
        }
        
        if (!hierarchy[divisionKey].sections[sectionKey].detailedSections[detailedKey]) {
            hierarchy[divisionKey].sections[sectionKey].detailedSections[detailedKey] = {
                code: project.detailed_section_code,
                title: project.detailed_section_code,
                description: project.detailed_section_description || 'No description',
                type: 'detailed_section',
                items: {}
            };
        }
        
        if (!hierarchy[divisionKey].sections[sectionKey].detailedSections[detailedKey].items[itemKey]) {
            hierarchy[divisionKey].sections[sectionKey].detailedSections[detailedKey].items[itemKey] = {
                code: project.project_item_code,
                title: project.project_item_code,
                description: project.item_description || project.project_name || 'No description',
                project_name: project.project_name,
                type: 'item',
                codes: []
            };
        }
        
        hierarchy[divisionKey].sections[sectionKey].detailedSections[detailedKey].items[itemKey].codes.push(code);
    });
    
    // Render hierarchy
    hierarchyView.innerHTML = Object.values(hierarchy).map(division => 
        createHierarchyCard(division, 'division')
    ).join('');
}

// Create hierarchy card
function createHierarchyCard(node, level) {
    const levelColors = {
        division: 'bg-blue-50 border-blue-200',
        section: 'bg-green-50 border-green-200',
        detailed_section: 'bg-yellow-50 border-yellow-200',
        item: 'bg-purple-50 border-purple-200'
    };
    
    const levelIcons = {
        division: '',
        section: '',
        detailed_section: '',
        item: ''
    };
    
    let content = `
        <div class="border rounded-lg ${levelColors[level]} p-4 mb-3">
            <div class="flex items-center justify-between mb-2">
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-800 mb-1">
                        ${levelIcons[level]} 
                        <span class="font-mono text-sm">${node.code || node.title}</span>
                        ${node.project_name ? `- ${node.project_name}` : ''}
                    </h3>
                    ${node.description && node.description !== 'No description' ? 
                        `<p class="text-sm text-gray-600 ml-6">${node.description}</p>` : 
                        ''
                    }
                </div>
                <button onclick="toggleHierarchyNode(this)" class="text-gray-500 hover:text-gray-700 ml-2">
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="hierarchy-content">
    `;
    
    if (node.sections) {
        content += Object.values(node.sections).map(section => 
            createHierarchyCard(section, 'section')
        ).join('');
    } else if (node.detailedSections) {
        content += Object.values(node.detailedSections).map(detailedSection => 
            createHierarchyCard(detailedSection, 'detailed_section')
        ).join('');
    } else if (node.items) {
        content += Object.values(node.items).map(item => 
            createHierarchyCard(item, 'item')
        ).join('');
    } else if (node.codes) {
        content += node.codes.map(code => createCodeCard(code)).join('');
    }
    
    content += `
            </div>
        </div>
    `;
    
    return content;
}

// Create individual code card
// Create individual code card
function createCodeCard(code) {
    const project = code.classification_projects;
    
    return `
        <div class="bg-white border border-gray-200 rounded p-4 mb-2 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                    <div class="font-mono text-sm font-semibold text-blue-600">${code.item_code}</div>
                    <div class="text-xs text-gray-500 mt-1">${project?.project_name || 'Unknown Project'}</div>
                </div>
                <div class="text-xs text-gray-500">${formatDate(code.created_at)}</div>
            </div>
            
            <!-- ENHANCED INFORMATION GRID WITH REQUIRED FIELDS -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm mb-3">
                <div>
                    <span class="font-medium text-gray-600">Created by:</span>
                    <div class="text-gray-900">${code.created_by_user?.username || 'Unknown'}</div>
                    ${code.created_by_user?.email ? `<div class="text-xs text-gray-500">${code.created_by_user.email}</div>` : ''}
                </div>
                <div>
                    <span class="font-medium text-gray-600">Unit Price:</span>
                    <div class="font-mono bg-green-50 px-2 py-1 rounded text-green-800 text-xs">
                        ${code.unit_price ? `${code.unit_price} ${code.currency_code || ''}` : 'Not specified'}
                    </div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">Manufacturer:</span>
                    <div class="text-gray-900">${code.manufacturer || 'Not specified'}</div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">UOM:</span>
                    <div class="text-gray-900">${code.uom || 'N/A'}</div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">Country:</span>
                    <div class="text-gray-900">${code.country_of_origin || 'N/A'}</div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">Model:</span>
                    <div class="text-gray-900">${code.model_number || 'N/A'}</div>
                </div>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
                <div><span class="font-medium text-gray-600">Description 1:</span> <span class="text-gray-900">${code.description1 || 'N/A'}</span></div>
                <div><span class="font-medium text-gray-600">Description 2:</span> <span class="text-gray-900">${code.description2 || 'N/A'}</span></div>
            </div>
            
            <div class="mt-3 flex space-x-2">
                <button onclick="viewCodeDetails(${code.id})" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200">
                    View Details
                </button>
                <button onclick="copyToClipboard('${code.item_code}')" class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded hover:bg-gray-200">
                    Copy Code
                </button>
                <button onclick="exportItemToPDF(${code.id}, 'approved')" class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200">
                    PDF
                </button>
                <button onclick="exportItemToExcel(${code.id}, 'approved')" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200">
                     Excel
                </button>
            </div>
        </div>
    `;
}
// Display codes in simple list view
function displayListView(codes) {
    const listView = document.getElementById('list-view');
    
    listView.innerHTML = codes.map(code => createCodeCard(code)).join('');
}

// Toggle between hierarchy and list view
function toggleSearchView() {
    // Don't toggle if we're in table view
    if (isSearchTableView) {
        alert('Please exit table view first by clicking "Switch to Card View"');
        return;
    }
    
    searchHierarchyView = !searchHierarchyView;
    const viewDescription = document.getElementById('view-description');
    const toggleBtn = document.getElementById('toggle-view-btn');
    
    if (viewDescription) {
        if (searchHierarchyView) {
            viewDescription.textContent = 'Showing hierarchical WBS view organized by CSI structure';
        } else {
            viewDescription.textContent = 'Showing flat list view of all item codes';
        }
    }
    
    if (toggleBtn) {
        if (searchHierarchyView) {
            toggleBtn.textContent = 'Switch to List View';
        } else {
            toggleBtn.textContent = 'Switch to Hierarchy View';
        }
    }
    
    // Re-display current results with new view
    const listView = document.getElementById('list-view');
    const hierarchyView = document.getElementById('hierarchy-view');
    
    let hasCurrentResults = false;
    if (searchHierarchyView && hierarchyView && hierarchyView.children.length > 0) {
        hasCurrentResults = true;
    } else if (!searchHierarchyView && listView && listView.children.length > 0) {
        hasCurrentResults = true;
    }
    
    // Only re-run search if we have data to display
    if (allApprovedCodes && allApprovedCodes.length > 0) {
        displaySearchResults(allApprovedCodes);
    }
}

// Clear all search inputs
function clearCodeSearch() {
    const searchInputs = [
        'search-desc1', 'search-desc2', 'search-item-code', 
        'search-project-name-codes', 'search-csi-path', 'search-country',
        'search-model', 'search-uom', 'search-attributes', 'search-erp-status'
    ];
    
    searchInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) input.value = '';
    });
    
    displaySearchResults(allApprovedCodes);
}
// Export individual request to PDF
async function exportRequestToPDF(requestId) {
    try {
        const { data: request, error } = await supabase
            .from('item_code_workflow')
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .eq('id', requestId)
            .single();
            
        if (error) throw error;
        
        // Use existing PDF generation logic
        alert('PDF export for individual request - to be implemented with your existing PDF logic');
        console.log('Request data for PDF:', request);
    } catch (error) {
        console.error('Error exporting request to PDF:', error);
        alert('Failed to export PDF: ' + error.message);
    }
}

// Export individual request to Excel
async function exportRequestToExcel(requestId) {
    try {
        const { data: request, error } = await supabase
            .from('item_code_workflow')
            .select(`
                *,
                created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                project:classification_projects(project_name)
            `)
            .eq('id', requestId)
            .single();
            
        if (error) throw error;
        
        // Generate Excel for single request
        const excelData = [{
            'Request ID': request.id,
            'Item Code': request.item_code || '',
            'Project': request.project?.project_name || '',
            'Description 1': request.description1 || '',
            'Description 2': request.description2 || '',
            'Unit of Measurement': request.uom || '',
            'Country of Origin': request.country_of_origin || '',
            'Model Number': request.model_number || '',
            'Unit Price': request.unit_price || '',
            'Currency': request.currency_code || '',
            'Manufacturer': request.manufacturer || '',
            'Status': request.status,
            'Created Date': new Date(request.created_at).toLocaleDateString(),
            'Created By': request.created_by_user?.username || '',
            'Creator Email': request.created_by_user?.email || '',
            'Review Comments': request.review_comments || ''
        }];
        
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Request Details');
        XLSX.writeFile(workbook, `Request_${request.item_code}_${Date.now()}.xlsx`);
    } catch (error) {
        console.error('Error exporting request to Excel:', error);
        alert('Failed to export Excel: ' + error.message);
    }
}

// Toggle hierarchy node visibility
function toggleHierarchyNode(button) {
    const content = button.closest('.border').querySelector('.hierarchy-content');
    const icon = button.querySelector('svg');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
    }
}

// View detailed information about a code
function viewCodeDetails(codeId) {
    const code = allApprovedCodes.find(c => c.id === codeId);
    if (!code) {
        alert('Code not found');
        return;
    }
    
    const details = `
Item Code: ${code.item_code}
Description 1: ${code.description1 || 'N/A'}
Description 2: ${code.description2 || 'N/A'}
UOM: ${code.uom || 'N/A'}
Country: ${code.country_of_origin || 'N/A'}
Model: ${code.model_number || 'N/A'}
Status: ${code.status || 'N/A'}
Created: ${formatDate(code.created_at)}
Project: ${code.classification_projects?.project_name || 'N/A'}
    `;
    
    alert(details);
}

// Toggle ERP integration status
// Toggle ERP integration status
async function toggleERPStatus(codeId, isIntegrated) {
    try {
        console.log(' Toggling ERP status for code:', codeId, 'to:', isIntegrated);
        console.log('Current user:', currentUser);
        
        if (!currentUser || currentUser.role !== 'admin' && currentUser.role !== 'erp_data_entry') {
            alert('Only administrators can change ERP integration status');
            // Revert checkbox
            const checkbox = document.getElementById(`erp-toggle-${codeId}`);
            if (checkbox) checkbox.checked = !isIntegrated;
            return;
        }
        
        const updateData = {
            erp_integrated: isIntegrated,
            erp_integrated_by: isIntegrated ? currentUser.id : null,
            erp_integrated_at: isIntegrated ? new Date().toISOString() : null
        };
        
        console.log('Updating with data:', updateData);
        
        const { error } = await supabase
            .from('item_code_workflow')
            .update(updateData)
            .eq('id', codeId);
        
        if (error) {
            console.error('Database error:', error);
            throw error;
        }
        
        console.log(' Database updated successfully');
        
        // Update local cache
        const codeIndex = allApprovedCodes.findIndex(c => c.id === codeId);
        if (codeIndex !== -1) {
            allApprovedCodes[codeIndex].erp_integrated = isIntegrated;
            allApprovedCodes[codeIndex].erp_integrated_at = updateData.erp_integrated_at;
            allApprovedCodes[codeIndex].erp_integrated_by = updateData.erp_integrated_by;
            console.log(' Local cache updated');
        }
        
        // Show success notification
        showNotification(
            ` Item code ${isIntegrated ? 'marked as integrated' : 'unmarked from integration'} successfully`,
            'success'
        );
        
        // Refresh the display
        console.log(' Refreshing display...');
        displaySearchResults(allApprovedCodes);
        
    } catch (error) {
        console.error(' Error updating ERP status:', error);
        showNotification(' Failed to update ERP status: ' + error.message, 'error');
        
        // Revert checkbox state
        const checkbox = document.getElementById(`erp-toggle-${codeId}`);
        if (checkbox) {
            checkbox.checked = !isIntegrated;
            console.log('Reverted checkbox state');
        }
    }
}
// Show notification to user
// Show notification to user
function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existingNotifications = document.querySelectorAll('.notification-toast');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 notification-toast ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <span class="mr-2">
                ${type === 'success' ? '' : type === 'error' ? '' : ''}
            </span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 4000);
}
// Show notification to user
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Copy code to clipboard
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        // Create a simple notification
        const notification = document.createElement('div');
        notification.textContent = `Copied: ${text}`;
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 2000);
    } catch (error) {
        console.error('Failed to copy:', error);
        alert(`Code: ${text}`);
    }
}

// ===== ENHANCED EXPORT FUNCTIONALITY =====

// Get filtered data based on export selection
function getFilteredExportData(filterType) {
    console.log(' Getting filtered data for export, filter type:', filterType);
    console.log(' allApprovedCodes is array:', Array.isArray(allApprovedCodes));
    console.log(' allApprovedCodes length:', allApprovedCodes.length);
    
    let filteredData = [];
    
    switch (filterType) {
        case 'all':
            // All approved item codes
            filteredData = [...allApprovedCodes];
            break;
            
        case 'erp_integrated':
            // Only ERP integrated codes
            filteredData = allApprovedCodes.filter(code => code.erp_integrated === true);
            break;
            
        case 'erp_pending':
            // Only pending ERP integration codes
            filteredData = allApprovedCodes.filter(code => code.erp_integrated !== true);
            break;
            
        default:
            filteredData = [...allApprovedCodes];
    }
    
    console.log(` Filtered data: ${filteredData.length} items for export type '${filterType}'`);
    console.log(' First filtered item:', filteredData[0]);
    return filteredData;
}

// Export to Excel with filtering
async function exportFilteredToExcel(filterType) {
    try {
        console.log('Starting filtered Excel export with filter:', filterType);
        
        const exportData = getFilteredExportData(filterType);
        
        if (exportData.length === 0) {
            alert('No data available for export with the selected filter.');
            return;
        }
        
        // Prepare data for Excel
        const excelData = exportData.map(item => ({
            'Item Code': item.item_code || '',
            'Base Item Code': item.is_variation ? item.item_code.split('/')[0] : item.item_code,
            'Is Variation': item.is_variation ? 'Yes' : 'No',
            'Variation Number': item.variation_number || '',
            'Variation Suffix': item.variation_suffix || '',
            'Project Name': item.classification_projects?.project_name || '',
            'Description 1': item.description1 || '',
            'Description 2': item.description2 || '',
            'CSI Division': item.classification_projects?.division_code || '',
            'CSI Section': item.classification_projects?.section_code || '',
            'CSI Detailed Section': item.classification_projects?.detailed_section_code || '',
            'CSI Item Code': item.classification_projects?.item_code || '',
            'Additional Level': item.classification_projects?.additional_level_name || '',
            'Additional Value': item.classification_projects?.additional_level_value || '',
            'UOM': item.uom || '',
            'Country of Origin': item.country_of_origin || '',
            'Model Number': item.model_number || '',
            'Unit Price': item.unit_price || '',
            'Currency': item.currency_code || '',
            'Manufacturer': item.manufacturer || '',
            'ERP Integrated': item.erp_integrated ? 'Yes' : 'No',
            'ERP Integration Date': item.erp_integrated_at ? new Date(item.erp_integrated_at).toLocaleDateString() : '',
            'Created By': item.created_by_user?.username || '',
            'Created Date': item.created_at ? new Date(item.created_at).toLocaleDateString() : '',
            'Status': item.status || '',
            'Approved By': item.approved_by || '',
            'Approved Date': item.approved_at ? new Date(item.approved_at).toLocaleDateString() : '',
            'Attribute Selections': JSON.stringify(item.attribute_selections || {})
        }));
        
        // Create workbook
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        
        // Auto-adjust column widths
        const colWidths = [];
        const headers = Object.keys(excelData[0] || {});
        headers.forEach((header, index) => {
            let maxLength = header.length;
            excelData.forEach(row => {
                const cellValue = String(row[header] || '');
                maxLength = Math.max(maxLength, cellValue.length);
            });
            colWidths[index] = { width: Math.min(maxLength + 5, 50) }; // Cap at 50 characters
        });
        worksheet['!cols'] = colWidths;
        
        // Add the worksheet to workbook
        const filterNames = {
            'all': 'All_Approved_Codes',
            'erp_integrated': 'ERP_Integrated_Codes',
            'erp_pending': 'Pending_ERP_Codes'
        };
        
        XLSX.utils.book_append_sheet(workbook, worksheet, filterNames[filterType] || 'Item_Codes');
        
        // Generate filename with timestamp and filter type
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:\-T]/g, '');
        const filename = `ItemCodes_${filterNames[filterType] || 'Export'}_${timestamp}.xlsx`;
        
        // Save the file
        XLSX.writeFile(workbook, filename);
        
        console.log(`Excel export completed: ${filename}, ${exportData.length} items`);
        alert(`Excel export completed successfully!\n\nFile: ${filename}\nItems exported: ${exportData.length}`);
        
    } catch (error) {
        console.error('Error in filtered Excel export:', error);
        alert('Failed to export to Excel: ' + error.message);
    }
}

// Export to PDF with automatic text wrapping
async function exportFilteredToPDF(filterType) {
    try {
        console.log('Starting PDF export with filter:', filterType);
        
        const exportData = getFilteredExportData(filterType);
        
        if (exportData.length === 0) {
            alert('No data available for export with the selected filter.');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        
        // Create new PDF with landscape orientation for better table fit
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'pt',
            format: 'a3' // Using A3 for more space
        });
        
        // Set fonts
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(16);
        
        // Filter names for title
        const filterTitles = {
            'all': 'All Approved Item Codes',
            'erp_integrated': 'ERP Integrated Item Codes',
            'erp_pending': 'Pending ERP Integration Item Codes'
        };
        
        const title = filterTitles[filterType] || 'Item Codes Export';
        
        // Add title
        doc.text(title, 40, 40);
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 60);
        doc.text(`Total Items: ${exportData.length}`, 40, 75);
        
        // Prepare table data with text wrapping consideration
        const tableHeaders = [
            'Item Code',
            'Project Name',
            'Description 1',
            'Description 2',
            'CSI Path',
            'UOM',
            'Country',
            'Model',
            'Price',
            'Manufacturer',
            'ERP Status',
            'Created By',
            'Created Date'
        ];
        
        const tableData = exportData.map(item => [
            item.item_code || '',
            item.classification_projects?.project_name || '',
            item.description1 || '',
            item.description2 || '',
            `${item.classification_projects?.division_code || ''}-${item.classification_projects?.section_code || ''}-${item.classification_projects?.detailed_section_code || ''}`,
            item.uom || '',
            item.country_of_origin || '',
            item.model_number || '',
            `${item.unit_price || ''} ${item.currency_code || ''}`.trim(),
            item.manufacturer || '',
            item.erp_integrated ? 'Integrated' : 'Pending',
            item.created_by_user?.username || '',
            item.created_at ? new Date(item.created_at).toLocaleDateString() : ''
        ]);
        
        // AutoTable configuration with text wrapping
        const autoTableConfig = {
            head: [tableHeaders],
            body: tableData,
            startY: 100,
            margin: { left: 20, right: 20 },
            styles: {
                fontSize: 7,
                cellPadding: 3,
                overflow: 'linebreak', // Enable text wrapping
                lineColor: [200, 200, 200],
                lineWidth: 0.5
            },
            headStyles: {
                fillColor: [66, 139, 202], // Blue header
                textColor: 255,
                fontSize: 8,
                fontStyle: 'bold',
                halign: 'center'
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            },
            columnStyles: {
                0: { cellWidth: 80 },  // Item Code
                1: { cellWidth: 100 }, // Project Name  
                2: { cellWidth: 120 }, // Description 1
                3: { cellWidth: 120 }, // Description 2
                4: { cellWidth: 80 },  // CSI Path
                5: { cellWidth: 40 },  // UOM
                6: { cellWidth: 60 },  // Country
                7: { cellWidth: 70 },  // Model
                8: { cellWidth: 60 },  // Price
                9: { cellWidth: 80 },  // Manufacturer
                10: { cellWidth: 60 }, // ERP Status
                11: { cellWidth: 60 }, // Created By
                12: { cellWidth: 70 }  // Created Date
            },
            // Enable automatic row height adjustment for text wrapping
            didDrawCell: function(data) {
                // Ensure minimum row height for readability
                if (data.row.height < 25) {
                    data.row.height = 25;
                }
            }
        };
        
        // Generate the table
        doc.autoTable(autoTableConfig);
        
        // Add page numbers
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.getWidth() - 60, doc.internal.pageSize.getHeight() - 20);
        }
        
        // Generate filename
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:\-T]/g, '');
        const filterNames = {
            'all': 'All_Approved_Codes',
            'erp_integrated': 'ERP_Integrated_Codes',
            'erp_pending': 'Pending_ERP_Codes'
        };
        const filename = `ItemCodes_${filterNames[filterType] || 'Export'}_${timestamp}.pdf`;
        
        // Save the PDF
        doc.save(filename);
        
        console.log(`PDF export completed: ${filename}, ${exportData.length} items`);
        alert(`PDF export completed successfully!\n\nFile: ${filename}\nItems exported: ${exportData.length}\nPages: ${pageCount}`);
        
    } catch (error) {
        console.error('Error in PDF export:', error);
        alert('Failed to export to PDF: ' + error.message);
    }
}

// Toggle export dropdown
function toggleExportDropdown() {
    const dropdown = document.getElementById('export-dropdown-menu');
    const isHidden = dropdown.classList.contains('hidden');
    
    if (isHidden) {
        dropdown.classList.remove('hidden');
        // Close dropdown when clicking outside
        setTimeout(() => {
            document.addEventListener('click', closeExportDropdownOnOutsideClick);
        }, 100);
    } else {
        dropdown.classList.add('hidden');
        document.removeEventListener('click', closeExportDropdownOnOutsideClick);
    }
}

// Close dropdown when clicking outside
function closeExportDropdownOnOutsideClick(event) {
    const dropdown = document.getElementById('export-dropdown-menu');
    const button = document.getElementById('export-dropdown-btn');
    
    if (!dropdown.contains(event.target) && !button.contains(event.target)) {
        dropdown.classList.add('hidden');
        document.removeEventListener('click', closeExportDropdownOnOutsideClick);
    }
}

// Legacy export function for compatibility
function exportSearchResults() {
    toggleExportDropdown();
}
// Function to modify and resubmit rejected requests
async function modifyRejectedRequest(requestId) {
    try {
        console.log('Modifying rejected request:', requestId);
        
        // Fetch the rejected request details
        const { data: request, error } = await supabase
            .from('item_code_workflow')
            .select('*')
            .eq('id', requestId)
            .single();

        if (error) throw error;

        console.log('Found rejected request:', request);

        // Load all approved projects to find the matching one
        const { data: projects, error: projectError } = await supabase
            .rpc('get_all_approved_projects');

        if (projectError) {
            console.error('Error loading projects:', projectError);
            throw projectError;
        }

        const requestProject = projects.find(p => p.project_id === request.project_id);
        if (!requestProject) {
            alert('Project not found or no longer accessible');
            return;
        }

        console.log('Found project for request:', requestProject);

        // Switch to generate tab
        showTab('generate');

        // Load the project
        currentProject = requestProject;
        
        // Load project attributes
        // Load project attributes manually
currentProject.attributes = requestProject.attributes || [];

        // Populate the project selector
        const projectSelect = document.getElementById('project-select');
        if (projectSelect) {
            projectSelect.value = requestProject.project_id;
        }

        // Set UOM
        const uomSelect = document.getElementById('uom-select');
        if (request.uom && uomSelect) {
            uomSelect.value = request.uom;
        }

        // Set country
        const countrySelect = document.getElementById('country-select');
        if (request.country_of_origin && countrySelect) {
            countrySelect.value = request.country_of_origin;
        }

        // Set model number
        const modelInput = document.getElementById('model-number');
        if (request.model_number && modelInput) {
            modelInput.value = request.model_number;
        }

        // Parse and set attribute selections
        if (request.attribute_selections) {
            try {
                const selections = JSON.parse(request.attribute_selections);
                console.log('Parsed attribute selections:', selections);
                
                // Wait for attributes to load and form to be ready
                setTimeout(async () => {
                    // Clear existing selections
                    attributeSelections = {};
                    
                    // Set the parsed selections
                    Object.keys(selections).forEach(attributeName => {
                        const value = selections[attributeName];
                        console.log('Setting attribute:', attributeName, 'to value:', value);
                        
                        // Find matching attribute in currentProject
                        const matchingAttr = currentProject.attributes.find(attr => 
                            attr.attribute_name === attributeName
                        );
                        
                        if (matchingAttr) {
                            // Check if value exists in standard values
                            const standardValue = matchingAttr.standard_values.find(sv => sv.name === value);
                            
                            if (standardValue) {
                                // Use standard value
                                attributeSelections[matchingAttr.attribute_id] = {
                                    value: value,
                                    index: matchingAttr.standard_values.indexOf(standardValue)
                                };
                            } else {
                                // Use as manual entry
                                attributeSelections[matchingAttr.attribute_id] = {
                                    value: value,
                                    index: 'manual'
                                };
                            }
                        }
                    });
                    
                    console.log('Set attributeSelections:', attributeSelections);
                    
                    // Rebuild the attributes display
                    renderAttributes();
                    
                    // Update preview
                    await updatePreview();
                    
                    // Check for duplicates
                    await checkForDuplicates();
                    
                    // Update generate button
                    await checkGenerateButton();
                    
                }, 1000);
                
            } catch (parseError) {
                console.error('Error parsing attribute selections:', parseError);
            }
        }

        // Show modification notice
        const notice = document.createElement('div');
        notice.id = 'modification-notice';
        notice.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4';
        notice.innerHTML = `
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-medium text-yellow-800">Modifying Rejected Request</h3>
                    <p class="mt-1 text-sm text-yellow-700">
                        You are modifying a previously rejected request. Make your changes and submit again for review.
                        <br><strong>Original Item Code:</strong> ${request.item_code}
                        <br><strong>Rejection reason:</strong> ${request.review_comments || 'No specific reason provided'}
                    </p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            class="text-yellow-400 hover:text-yellow-600">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;

        // Insert notice at the top of the generate tab
        const generateTab = document.getElementById('generate-tab');
        const existingNotice = document.getElementById('modification-notice');
        if (existingNotice) {
            existingNotice.remove();
        }
        generateTab.insertBefore(notice, generateTab.firstChild);

        // Store the original request ID for tracking
        window.modifyingRequestId = requestId;

        alert('Request loaded for modification. Please make your changes and resubmit.');

    } catch (error) {
        console.error('Error loading rejected request:', error);
        alert('Failed to load rejected request: ' + error.message);
    }
}

// Helper function to show a specific tab
function showTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (targetBtn) {
        targetBtn.classList.remove('border-transparent', 'text-gray-500');
        targetBtn.classList.add('border-blue-500', 'text-blue-600');
    }
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
    
    // Load specific tab data
    if (tabName === 'erp') {
        console.log(' ERP tab activated, loading dashboard...');
        loadERPDashboard();
    }
}
// Make functions globally available
window.selectAttribute = selectAttribute;
window.selectProject = selectProject;
window.selectProjectFromData = selectProjectFromData;
// Admin functions
window.editItemCode = editItemCode;

// Enhanced load user requests for comprehensive tracking
async function loadUserRequests() {
    try {
        console.log('Loading comprehensive user requests for user:', currentUser.id);
        
        // Load all types of requests for the current user
        const [
            { data: codeRequests, error: codeError },
            { data: blockRequests, error: blockError },
            { data: valueRequests, error: valueError },
            { data: manufacturerRequests, error: manufacturerError }
        ] = await Promise.all([
            // Item code requests
            supabase
                .from('item_code_workflow')
                .select(`
                    *,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    reviewed_by_user:users!item_code_workflow_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name, division_code)
                `)
                .eq('created_by', currentUser.id)
                .order('created_at', { ascending: false }),
                
            // Combination/block requests
            supabase
                .from('combination_requests')
                .select(`
                    *,
                    created_by_user:users!combination_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!combination_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name, division_code)
                `)
                .eq('created_by', currentUser.id)
                .order('created_at', { ascending: false }),
                
            // Standard value requests
            supabase
                .from('standard_value_requests')
                .select(`
                    *,
                    created_by_user:users!standard_value_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name, division_code)
                `)
                .eq('created_by', currentUser.id)
                .order('created_at', { ascending: false }),
                
            // Manufacturer requests
            supabase
                .from('manufacturer_requests')
                .select(`
                    *,
                    created_by_user:users!manufacturer_requests_created_by_fkey(username, email),
                    reviewed_by_user:users!manufacturer_requests_reviewed_by_fkey(username, email),
                    project:classification_projects(project_name, division_code)
                `)
                .eq('created_by', currentUser.id)
                .order('created_at', { ascending: false })
        ]);

        // Check for errors
        if (codeError) throw codeError;
        if (blockError) throw blockError;
        if (valueError) throw valueError;
        if (manufacturerError) throw manufacturerError;

        // Load approved item codes to check ERP integration status
        const { data: approvedCodes, error: approvedError } = await supabase
            .from('item_code_workflow')
            .select('id, item_code, erp_integrated, erp_integrated_at, erp_integrated_by')
            .eq('created_by', currentUser.id)
            .eq('status', 'admin_approved');
            
        if (approvedError) {
            console.warn('Error loading approved codes for ERP status:', approvedError);
        }

        // Create ERP lookup map
        const erpStatusMap = {};
        if (approvedCodes) {
            approvedCodes.forEach(code => {
                erpStatusMap[code.item_code] = {
                    erp_integrated: code.erp_integrated,
                    erp_integrated_at: code.erp_integrated_at,
                    erp_integrated_by: code.erp_integrated_by
                };
            });
        }

        // Organize requests by category with type identification
        const organizedRequests = {
            itemCodes: (codeRequests || []).map(req => ({
                ...req,
                type: 'Item Code',
                typeIcon: '√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨¬π',
                title: req.item_code || 'Pending Code Generation',
                subtitle: `${req.project?.division_code || ''} - ${req.project?.project_name || 'Unknown Project'}`,
                erpStatus: erpStatusMap[req.item_code] || null
            })),
            blockCombinations: (blockRequests || []).map(req => ({
                ...req,
                type: req.request_type === 'block' ? 'Block Combination' : 'Generate Combination',
                typeIcon: req.request_type === 'block' ? '' : '',
                title: `${req.request_type === 'block' ? 'Block' : 'Generate'} Request #${req.id}`,
                subtitle: `${req.project?.project_name || 'Unknown Project'}`,
                erpStatus: null // Block requests don't have direct ERP integration
            })),
            standardValues: (valueRequests || []).map(req => ({
                ...req,
                type: 'Standard Value',
                typeIcon: '',
                title: `${req.attribute_name}: ${req.new_value}`,
                subtitle: `${req.project?.project_name || 'Unknown Project'}`,
                erpStatus: null // Value requests don't have direct ERP integration
            })),
            manufacturers: (manufacturerRequests || []).map(req => ({
                ...req,
                type: 'Manufacturer',
                typeIcon: '√É¬∞√Ö¬∏√Ö¬°√Ç¬´',
                title: req.manufacturer_name,
                subtitle: `${req.project?.project_name || 'Unknown Project'}`,
                erpStatus: null // Manufacturer requests don't have direct ERP integration
            }))
        };

        // Store organized data globally
        window.organizedRequestsData = organizedRequests;
        
        // Calculate totals for display
        const totalRequests = 
            organizedRequests.itemCodes.length +
            organizedRequests.blockCombinations.length +
            organizedRequests.standardValues.length +
            organizedRequests.manufacturers.length;

        console.log("√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨¬π Loaded comprehensive requests:", {
            itemCodes: organizedRequests.itemCodes.length,
            blockCombinations: organizedRequests.blockCombinations.length,
            standardValues: organizedRequests.standardValues.length,
            manufacturers: organizedRequests.manufacturers.length,
            total: totalRequests
        });

        // Render enhanced requests cards
        renderEnhancedRequestsCards(organizedRequests);
        
    } catch (error) {
        console.error('Error loading comprehensive user requests:', error);
        document.getElementById('requests-cards-container').innerHTML = 
            '<div class="text-center py-8 text-red-500">Failed to load requests. Please try again.</div>';
    }
}


// Render requests in card format
function renderRequestsCards() {
    const container = document.getElementById('requests-cards-container');
    
    if (!requestsData || requestsData.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">No requests found</div>';
        return;
    }

    container.innerHTML = requestsData.map((request, index) => `
    <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 ${(request.status === 'rejected' || request.status === 'reviewer_rejected' || request.status === 'admin_rejected') ? 'opacity-75' : ''}">
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900">${request.item_code || 'No Code'}</h3>
                <p class="text-sm text-gray-600">${request.csi_division_code || 'No CSI Code'}</p>
                ${(request.status === 'rejected' || request.status === 'reviewer_rejected' || request.status === 'admin_rejected') ? `
                    <p class="text-xs text-red-600 font-medium mt-1">This item code is obsolete due to rejection</p>
                ` : ''}
            </div>
            <div class="flex items-center gap-2">
                <span class="px-3 py-1 text-xs rounded-full ${getStatusColor(request.status)}">
                    ${request.status}
                </span>
            </div>
        </div>
        
        <!-- ENHANCED INFORMATION GRID WITH NEW FIELDS -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm mb-4">
            <div>
                <p class="text-gray-600 font-medium">Request ID:</p>
                <p class="text-gray-900">#${request.id}</p>
            </div>
            <div>
                <p class="text-gray-600 font-medium">Created by:</p>
                <p class="text-gray-900">${request.created_by_user?.username || 'Unknown'}</p>
                ${request.created_by_user?.email ? `<p class="text-xs text-gray-500">${request.created_by_user.email}</p>` : ''}
            </div>
            <div>
                <p class="text-gray-600 font-medium">Unit Price:</p>
                <p class="text-gray-900 font-mono bg-green-50 px-2 py-1 rounded">${request.unit_price ? `${request.unit_price} ${request.currency_code || ''}` : 'Not specified'}</p>
            </div>
            <div>
                <p class="text-gray-600 font-medium">Manufacturer:</p>
                <p class="text-gray-900">${request.manufacturer || 'Not specified'}</p>
            </div>
            <div>
                <p class="text-gray-600 font-medium">UOM:</p>
                <p class="text-gray-900">${request.uom || '-'}</p>
            </div>
            <div>
                <p class="text-gray-600 font-medium">Country:</p>
                <p class="text-gray-900">${request.country_of_origin || '-'}</p>
            </div>
            <div>
                <p class="text-gray-600 font-medium">Model Number:</p>
                <p class="text-gray-900">${request.model_number || '-'}</p>
            </div>
            <div>
                <p class="text-gray-600 font-medium">Created:</p>
                <p class="text-gray-900">${new Date(request.created_at).toLocaleDateString()}</p>
            </div>
        </div>
        
        <div class="mt-4">
            <p class="text-gray-600 text-sm font-medium">Description 1:</p>
            <p class="text-gray-900">${request.description1 || '-'}</p>
        </div>
        
        ${request.review_comments ? `
            <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded">
                <p class="text-sm font-medium text-red-800">Rejection Reason:</p>
                <p class="text-sm text-red-700">${request.review_comments}</p>
            </div>
        ` : ''}
        
        <!-- Action Buttons -->
        <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
            <div class="flex gap-2">
                ${['reviewer_approved', 'admin_approved', 'approved'].includes(request.status) ? `
                    <button onclick="exportRequestToPDF(${request.id})" 
                            class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded">
                        PDF
                    </button>
                    <button onclick="exportRequestToExcel(${request.id})" 
                            class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded">
                        Excel
                    </button>
                ` : ''}
            </div>
            
            ${(request.status === 'rejected' || request.status === 'reviewer_rejected' || request.status === 'admin_rejected') ? `
                <button onclick="regenerateFromRejected(${index}, 'requests')" 
                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded text-sm font-medium">
                    Regenerate New Request
                </button>
            ` : ''}
        </div>
    </div>
`).join('');
}
// Helper function for status colors
function getStatusColor(status) {
    switch (status) {
        case 'pending': 
            return 'bg-yellow-100 text-yellow-800';
        case 'approved': 
            return 'bg-green-100 text-green-800';
        case 'rejected': 
        case 'reviewer_rejected': 
        case 'admin_rejected': 
            return 'bg-red-100 text-red-800';
        default: 
            return 'bg-gray-100 text-gray-800';
    }
}

// Enhanced render requests in categorized card format
function renderEnhancedRequestsCards(organizedRequests) {
    const container = document.getElementById('requests-cards-container');
    
    // Calculate totals
    const totalRequests = 
        organizedRequests.itemCodes.length +
        organizedRequests.blockCombinations.length +
        organizedRequests.standardValues.length +
        organizedRequests.manufacturers.length;
    
    if (totalRequests === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨¬π</div>
                <h3 class="text-xl font-medium text-gray-900 mb-2">No Requests Found</h3>
                <p class="text-gray-500">You haven't made any requests yet. Start by generating an item code!</p>
            </div>
        `;
        return;
    }

    // Generate summary header
    const summaryHtml = `
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-6 text-white mb-6">
            <h2 class="text-2xl font-bold mb-2">My Requests Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-3xl font-bold">${organizedRequests.itemCodes.length}</div>
                    <div class="text-sm opacity-90">Item Codes</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold">${organizedRequests.blockCombinations.length}</div>
                    <div class="text-sm opacity-90">Combinations</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold">${organizedRequests.standardValues.length}</div>
                    <div class="text-sm opacity-90">Standard Values</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold">${organizedRequests.manufacturers.length}</div>
                    <div class="text-sm opacity-90">Manufacturers</div>
                </div>
            </div>
        </div>
    `;

    // Generate sections for each request type
    const sectionsHtml = [
        renderRequestSection('Item Code Requests', 'itemCodes', organizedRequests.itemCodes, '', 'blue'),
        renderRequestSection('Combination Requests', 'blockCombinations', organizedRequests.blockCombinations, '', 'purple'),
        renderRequestSection('Standard Value Requests', 'standardValues', organizedRequests.standardValues, '', 'green'),
        renderRequestSection('Manufacturer Requests', 'manufacturers', organizedRequests.manufacturers, '√É¬∞√Ö¬∏√Ç¬è√Ç¬≠', 'orange')
    ].join('');

    container.innerHTML = summaryHtml + sectionsHtml;
}

// Render individual request section
function renderRequestSection(title, sectionId, requests, icon, color) {
    if (requests.length === 0) return '';

    const colorClasses = {
        blue: 'border-blue-200 bg-blue-50',
        purple: 'border-purple-200 bg-purple-50', 
        green: 'border-green-200 bg-green-50',
        orange: 'border-orange-200 bg-orange-50'
    };

    const headerColorClasses = {
        blue: 'text-blue-800 bg-blue-100',
        purple: 'text-purple-800 bg-purple-100',
        green: 'text-green-800 bg-green-100', 
        orange: 'text-orange-800 bg-orange-100'
    };

    return `
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-4">
                <span class="text-2xl">${icon}</span>
                <h3 class="text-xl font-semibold text-gray-900">${title}</h3>
                <span class="px-3 py-1 text-sm font-medium rounded-full ${headerColorClasses[color]}">${requests.length}</span>
            </div>
            
            <div class="grid gap-4">
                ${requests.map((request, index) => renderSingleRequestCard(request, sectionId, index, color)).join('')}
            </div>
        </div>
    `;
}

// Render individual request card with enhanced information
function renderSingleRequestCard(request, sectionType, index, color) {
    const isRejected = ['rejected', 'reviewer_rejected', 'admin_rejected'].includes(request.status);
    const isApproved = ['approved', 'reviewer_approved', 'admin_approved'].includes(request.status);
    
    // Enhanced status display with workflow tracking
    const statusInfo = getEnhancedStatusInfo(request.status);
    
    // ERP Integration Status (only for approved item codes)
    const erpStatusHtml = (sectionType === 'itemCodes' && isApproved && request.erpStatus) ? `
        <div class="mt-3 p-3 rounded-lg ${request.erpStatus.erp_integrated ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}">
            <div class="flex items-center gap-2">
                <span class="text-sm font-medium ${request.erpStatus.erp_integrated ? 'text-green-800' : 'text-yellow-800'}">
                    ${request.erpStatus.erp_integrated ? "√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ ERP INTEGRATED" : "PENDING ERP INTEGRATION"}
                </span>
            </div>
            ${request.erpStatus.erp_integrated && request.erpStatus.erp_integrated_at ? `
                <div class="text-xs text-gray-600 mt-1">
                    Integrated on: ${new Date(request.erpStatus.erp_integrated_at).toLocaleDateString()}
                </div>
            ` : ''}
        </div>
    ` : '';

    return `
        <div class="bg-white rounded-lg border-2 ${isRejected ? 'border-red-200 opacity-75' : 'border-gray-200'} shadow-sm hover:shadow-md transition-shadow p-5">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-lg">${request.typeIcon}</span>
                        <h4 class="font-semibold text-gray-900">${request.title}</h4>
                    </div>
                    <p class="text-sm text-gray-600">${request.subtitle}</p>
                    ${isRejected ? '<p class="text-xs text-red-600 font-medium mt-1"> This request has been rejected</p>' : ''}
                </div>
                <div class="flex flex-col items-end gap-2">
                    ${statusInfo.badge}
                    <span class="text-xs text-gray-500">#${request.id}</span>
                </div>
            </div>

            <!-- Request Details Based on Type -->
            ${renderRequestTypeDetails(request, sectionType)}

            <!-- Workflow Progress -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="text-xs font-medium text-gray-700 mb-2">Request Progress:</div>
                ${renderWorkflowProgress(request.status)}
            </div>

            <!-- Comments/Rejection Reasons -->
            ${(request.reviewer_comments || request.admin_comments || request.review_comments) ? `
                <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm font-medium text-red-800">Comments/Feedback:</p>
                    <p class="text-sm text-red-700 mt-1">
                        ${request.admin_comments || request.reviewer_comments || request.review_comments}
                    </p>
                </div>
            ` : ''}

            <!-- ERP Integration Status -->
            ${erpStatusHtml}

            <!-- Action Buttons -->
            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                <div class="text-xs text-gray-500">
                    Created: ${new Date(request.created_at).toLocaleDateString()}
                </div>
                <div class="flex gap-2">
                    ${isApproved ? `
                        <button onclick="exportRequestToPDF('${sectionType}', ${index})" 
                                class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors">
                            √É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨≈æ PDF
                        </button>
                        <button onclick="exportRequestToExcel('${sectionType}', ${index})" 
                                class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors">
                            √É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ö¬† Excel
                        </button>
                    ` : ''}
                    ${isRejected ? `
                        <button onclick="regenerateFromRejected('${sectionType}', ${index})" 
                                class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium rounded transition-colors">
                            √É¬∞√Ö¬∏√¢‚Ç¨¬ù√¢‚Ç¨≈æ Regenerate Request
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

// Render request-type-specific details
function renderRequestTypeDetails(request, sectionType) {
    switch (sectionType) {
        case 'itemCodes':
            return `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                    <div>
                        <p class="text-gray-600 font-medium">Item Code:</p>
                        <p class="text-gray-900 font-mono">${request.item_code || 'Pending Generation'}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 font-medium">Price:</p>
                        <p class="text-gray-900">${request.unit_price ? `${request.unit_price} ${request.currency_code || ''}` : 'Not specified'}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 font-medium">UOM:</p>
                        <p class="text-gray-900">${request.uom || '-'}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 font-medium">Manufacturer:</p>
                        <p class="text-gray-900">${request.manufacturer || 'Not specified'}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 font-medium">Country:</p>
                        <p class="text-gray-900">${request.country_of_origin || '-'}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 font-medium">Model:</p>
                        <p class="text-gray-900">${request.model_number || '-'}</p>
                    </div>
                </div>
                ${request.description1 ? `
                    <div class="mt-3">
                        <p class="text-gray-600 text-sm font-medium">Description:</p>
                        <p class="text-gray-900 text-sm">${request.description1}</p>
                    </div>
                ` : ''}
            `;
        case 'blockCombinations':
            return `
                <div class="text-sm">
                    <p class="text-gray-600 font-medium">Request Type:</p>
                    <p class="text-gray-900">${request.request_type === 'block' ? 'Block Combination' : 'Generate Combination'}</p>
                    ${request.reason ? `
                        <div class="mt-2">
                            <p class="text-gray-600 font-medium">Reason:</p>
                            <p class="text-gray-900">${request.reason}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        case 'standardValues':
            return `
                <div class="text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-gray-600 font-medium">Attribute:</p>
                            <p class="text-gray-900">${request.attribute_name}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 font-medium">New Value:</p>
                            <p class="text-gray-900 font-semibold">${request.new_value}</p>
                        </div>
                    </div>
                    ${request.reason ? `
                        <div class="mt-2">
                            <p class="text-gray-600 font-medium">Reason:</p>
                            <p class="text-gray-900">${request.reason}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        case 'manufacturers':
            return `
                <div class="text-sm">
                    <div>
                        <p class="text-gray-600 font-medium">Manufacturer Name:</p>
                        <p class="text-gray-900 font-semibold">${request.manufacturer_name}</p>
                    </div>
                    ${request.reason ? `
                        <div class="mt-2">
                            <p class="text-gray-600 font-medium">Reason:</p>
                            <p class="text-gray-900">${request.reason}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        default:
            return '';
    }
}

// Enhanced status information with better visual indicators
function getEnhancedStatusInfo(status) {
    const statusConfig = {
        'pending': {
            badge: '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800"> Pending Review</span>',
            description: 'Waiting for reviewer'
        },
        'reviewer_approved': {
            badge: '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Reviewer Approved</span>',
            description: 'Approved by reviewer, awaiting admin'
        },
        'admin_approved': {
            badge: '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Admin Approved</span>',
            description: 'Fully approved'
        },
        'approved': {
            badge: '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Approved</span>',
            description: 'Fully approved'
        },
        'reviewer_rejected': {
            badge: '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Reviewer Rejected</span>',
            description: 'Rejected by reviewer'
        },
        'admin_rejected': {
            badge: '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Admin Rejected</span>',
            description: 'Rejected by admin'
        },
        'rejected': {
            badge: '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Rejected</span>',
            description: 'Request rejected'
        }
    };
    
    return statusConfig[status] || {
        badge: '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Unknown</span>',
        description: 'Unknown status'
    };
}

// Render workflow progress visualization
function renderWorkflowProgress(status) {
    const steps = [
        { name: 'Submitted', key: 'submitted', completed: true },
        { name: 'Reviewer', key: 'reviewer', completed: ['reviewer_approved', 'admin_approved', 'approved'].includes(status) },
        { name: 'Admin', key: 'admin', completed: ['admin_approved', 'approved'].includes(status) },
        { name: 'Complete', key: 'complete', completed: ['approved'].includes(status) }
    ];

    const isRejected = ['rejected', 'reviewer_rejected', 'admin_rejected'].includes(status);

    if (isRejected) {
        return '<div class="text-xs text-red-600">Request workflow terminated due to rejection</div>';
    }

    return `
        <div class="flex items-center gap-2">
            ${steps.map((step, index) => {
                const isCompleted = step.completed;
                const isActive = !isCompleted && index === steps.findIndex(s => !s.completed);
                
                return `
                    <div class="flex items-center ${index < steps.length - 1 ? 'flex-1' : ''}">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium
                            ${isCompleted ? 'bg-green-500 text-white' : isActive ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-600'}">
                            ${isCompleted ? "√É¬¢√Ö‚Äú√¢‚Ç¨¬¶" : index + 1}
                        </div>
                        <div class="ml-1 text-xs ${isCompleted ? 'text-green-600 font-medium' : isActive ? 'text-blue-600 font-medium' : 'text-gray-500'}">
                            ${step.name}
                        </div>
                        ${index < steps.length - 1 ? `
                            <div class="flex-1 h-px mx-2 ${isCompleted ? 'bg-green-300' : 'bg-gray-300'}"></div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// Enhanced export functions for categorized requests
async function exportRequestToPDF(sectionType, index) {
    try {
        const organizedRequests = window.organizedRequestsData;
        if (!organizedRequests) {
            alert('No request data available for export');
            return;
        }

        let request;
        switch (sectionType) {
            case 'itemCodes':
                request = organizedRequests.itemCodes[index];
                break;
            case 'blockCombinations':
                request = organizedRequests.blockCombinations[index];
                break;
            case 'standardValues':
                request = organizedRequests.standardValues[index];
                break;
            case 'manufacturers':
                request = organizedRequests.manufacturers[index];
                break;
            default:
                alert('Invalid request type for export');
                return;
        }

        if (!request) {
            alert('Request not found for export');
            return;
        }

        generateEnhancedRequestPDF(request, sectionType);
        
    } catch (error) {
        console.error('Error exporting request to PDF:', error);
        alert('Failed to export PDF: ' + error.message);
    }
}

async function exportRequestToExcel(sectionType, index) {
    try {
        const organizedRequests = window.organizedRequestsData;
        if (!organizedRequests) {
            alert('No request data available for export');
            return;
        }

        let request;
        switch (sectionType) {
            case 'itemCodes':
                request = organizedRequests.itemCodes[index];
                break;
            case 'blockCombinations':
                request = organizedRequests.blockCombinations[index];
                break;
            case 'standardValues':
                request = organizedRequests.standardValues[index];
                break;
            case 'manufacturers':
                request = organizedRequests.manufacturers[index];
                break;
            default:
                alert('Invalid request type for export');
                return;
        }

        if (!request) {
            alert('Request not found for export');
            return;
        }

        generateEnhancedRequestExcel(request, sectionType);
        
    } catch (error) {
        console.error('Error exporting request to Excel:', error);
        alert('Failed to export Excel: ' + error.message);
    }
}

// Generate enhanced PDF for different request types
function generateEnhancedRequestPDF(request, sectionType) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(`${request.type} Request #${request.id}`, 14, 20);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 30);
    doc.text(`Created by: ${currentUser.username}`, 14, 36);
    doc.text(`Status: ${request.status}`, 14, 42);
    
    let yPosition = 55;
    
    // Request details based on type
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Request Details:', 14, yPosition);
    yPosition += 10;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    const details = getRequestDetailsForExport(request, sectionType);
    details.forEach(([label, value]) => {
        doc.text(`${label}: ${value}`, 14, yPosition);
        yPosition += 6;
    });
    
    // ERP Status (for approved item codes)
    if (sectionType === 'itemCodes' && request.erpStatus && ['approved', 'admin_approved', 'reviewer_approved'].includes(request.status)) {
        yPosition += 5;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('ERP Integration Status:', 14, yPosition);
        yPosition += 8;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Status: ${request.erpStatus.erp_integrated ? 'INTEGRATED' : 'PENDING'}`, 14, yPosition);
        yPosition += 6;
        
        if (request.erpStatus.erp_integrated && request.erpStatus.erp_integrated_at) {
            doc.text(`Integrated Date: ${new Date(request.erpStatus.erp_integrated_at).toLocaleDateString()}`, 14, yPosition);
            yPosition += 6;
        }
    }
    
    // Workflow progress
    yPosition += 10;
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Workflow Progress:', 14, yPosition);
    yPosition += 8;
    
    const workflowSteps = ['Submitted', 'Reviewer', 'Admin', 'Complete'];
    const completedSteps = getCompletedSteps(request.status);
    
    workflowSteps.forEach((step, index) => {
        const isCompleted = completedSteps[index];
        doc.setFont(undefined, isCompleted ? 'bold' : 'normal');
        doc.text(`${index + 1}. ${step} ${isCompleted ? "√É¬¢√Ö‚Äú√¢‚Ç¨¬¶" : ""}`, 20, yPosition);
        yPosition += 6;
    });
    
    // Comments if any
    if (request.reviewer_comments || request.admin_comments || request.review_comments) {
        yPosition += 10;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Comments/Feedback:', 14, yPosition);
        yPosition += 8;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const comments = request.admin_comments || request.reviewer_comments || request.review_comments;
        const lines = doc.splitTextToSize(comments, 180);
        lines.forEach(line => {
            doc.text(line, 14, yPosition);
            yPosition += 6;
        });
    }
    
    // Save file
    const filename = `${request.type.replace(' ', '_')}_Request_${request.id}_${new Date().toISOString().slice(0, 10)}.pdf`;
    doc.save(filename);
}

// Generate enhanced Excel for different request types
function generateEnhancedRequestExcel(request, sectionType) {
    const workbook = XLSX.utils.book_new();
    
    // Prepare data for Excel
    const details = getRequestDetailsForExport(request, sectionType);
    const excelData = details.map(([label, value]) => ({
        'Field': label,
        'Value': value
    }));
    
    // Add metadata rows
    const metadataRows = [
        { 'Field': 'Request Type', 'Value': request.type },
        { 'Field': 'Request ID', 'Value': request.id },
        { 'Field': 'Status', 'Value': request.status },
        { 'Field': 'Created Date', 'Value': new Date(request.created_at).toLocaleDateString() },
        { 'Field': 'Export Date', 'Value': new Date().toLocaleDateString() },
        { 'Field': '', 'Value': '' }, // Separator
        ...excelData
    ];
    
    // Add ERP status for item codes
    if (sectionType === 'itemCodes' && request.erpStatus && ['approved', 'admin_approved', 'reviewer_approved'].includes(request.status)) {
        metadataRows.push(
            { 'Field': '', 'Value': '' },
            { 'Field': 'ERP Integration Status', 'Value': request.erpStatus.erp_integrated ? 'INTEGRATED' : 'PENDING' }
        );
        
        if (request.erpStatus.erp_integrated && request.erpStatus.erp_integrated_at) {
            metadataRows.push({
                'Field': 'ERP Integration Date',
                'Value': new Date(request.erpStatus.erp_integrated_at).toLocaleDateString()
            });
        }
    }
    
    const worksheet = XLSX.utils.json_to_sheet(metadataRows);
    
    // Auto-size columns
    worksheet['!cols'] = [
        { wch: 25 }, // Field column
        { wch: 40 }  // Value column
    ];
    
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Request Details');
    
    // Save file
    const filename = `${request.type.replace(' ', '_')}_Request_${request.id}_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(workbook, filename);
}

// Get request details formatted for export
function getRequestDetailsForExport(request, sectionType) {
    const baseDetails = [
        ['Request Title', request.title],
        ['Project', request.subtitle],
        ['Created Date', new Date(request.created_at).toLocaleDateString()]
    ];
    
    switch (sectionType) {
        case 'itemCodes':
            return [
                ...baseDetails,
                ['Item Code', request.item_code || 'Pending Generation'],
                ['Description 1', request.description1 || 'N/A'],
                ['Description 2', request.description2 || 'N/A'],
                ['Unit Price', request.unit_price ? `${request.unit_price} ${request.currency_code || ''}` : 'Not specified'],
                ['Manufacturer', request.manufacturer || 'Not specified'],
                ['Model Number', request.model_number || 'N/A'],
                ['Country of Origin', request.country_of_origin || 'N/A'],
                ['Unit of Measure', request.uom || 'N/A']
            ];
        case 'blockCombinations':
            return [
                ...baseDetails,
                ['Request Type', request.request_type === 'block' ? 'Block Combination' : 'Generate Combination'],
                ['Reason', request.reason || 'N/A']
            ];
        case 'standardValues':
            return [
                ...baseDetails,
                ['Attribute Name', request.attribute_name],
                ['New Value', request.new_value],
                ['Reason', request.reason || 'N/A']
            ];
        case 'manufacturers':
            return [
                ...baseDetails,
                ['Manufacturer Name', request.manufacturer_name],
                ['Reason', request.reason || 'N/A']
            ];
        default:
            return baseDetails;
    }
}

// Get completed workflow steps for a given status
function getCompletedSteps(status) {
    const steps = [true, false, false, false]; // Default: only submitted
    
    if (['reviewer_approved', 'admin_approved', 'approved'].includes(status)) {
        steps[1] = true; // Reviewer completed
    }
    
    if (['admin_approved', 'approved'].includes(status)) {
        steps[2] = true; // Admin completed
    }
    
    if (status === 'approved') {
        steps[3] = true; // Complete
    }
    
    return steps;
}

// Enhanced regenerate function for categorized requests
async function regenerateFromRejected(sectionType, index) {
    try {
        const organizedRequests = window.organizedRequestsData;
        if (!organizedRequests) {
            alert('No request data available');
            return;
        }

        let rejectedRequest;
        switch (sectionType) {
            case 'itemCodes':
                rejectedRequest = organizedRequests.itemCodes[index];
                break;
            case 'blockCombinations':
                rejectedRequest = organizedRequests.blockCombinations[index];
                break;
            case 'standardValues':
                rejectedRequest = organizedRequests.standardValues[index];
                break;
            case 'manufacturers':
                rejectedRequest = organizedRequests.manufacturers[index];
                break;
            default:
                alert('Invalid request type for regeneration');
                return;
        }

        if (!rejectedRequest) {
            alert('Request not found for regeneration');
            return;
        }

        // Confirm regeneration
        const confirmMessage = `Are you sure you want to regenerate a new request based on this rejected ${rejectedRequest.type.toLowerCase()} request?`;
        if (!confirm(confirmMessage)) {
            return;
        }

        // For item code requests, redirect to generate tab with pre-filled data
        if (sectionType === 'itemCodes') {
            // Switch to generate tab
            document.querySelector('[data-tab="generate"]').click();
            
            // Pre-fill the form with rejected request data
            setTimeout(() => {
                if (rejectedRequest.description1) {
                    const desc1Input = document.getElementById('description1');
                    if (desc1Input) desc1Input.value = rejectedRequest.description1;
                }
                
                if (rejectedRequest.description2) {
                    const desc2Input = document.getElementById('description2');
                    if (desc2Input) desc2Input.value = rejectedRequest.description2;
                }
                
                if (rejectedRequest.unit_price) {
                    const priceInput = document.getElementById('unit-price');
                    if (priceInput) priceInput.value = rejectedRequest.unit_price;
                }
                
                if (rejectedRequest.currency_code) {
                    const currencySelect = document.getElementById('currency-select');
                    if (currencySelect) currencySelect.value = rejectedRequest.currency_code;
                }
                
                if (rejectedRequest.manufacturer) {
                    const manufacturerSelect = document.getElementById('manufacturer-select');
                    if (manufacturerSelect) manufacturerSelect.value = rejectedRequest.manufacturer;
                }
                
                if (rejectedRequest.uom) {
                    const uomSelect = document.getElementById('uom-select');
                    if (uomSelect) uomSelect.value = rejectedRequest.uom;
                }
                
                if (rejectedRequest.country_of_origin) {
                    const countrySelect = document.getElementById('country-select');
                    if (countrySelect) countrySelect.value = rejectedRequest.country_of_origin;
                }
                
                if (rejectedRequest.model_number) {
                    const modelInput = document.getElementById('model-number');
                    if (modelInput) modelInput.value = rejectedRequest.model_number;
                }
                
                // Show success message
                showNotification('Form pre-filled with rejected request data. Please review and modify as needed.', 'info');
            }, 1000);
        } else {
            // For other request types, show appropriate action
            alert(`Regeneration for ${rejectedRequest.type} requests will redirect you to the appropriate section. This feature will be enhanced in a future update.`);
        }
        
    } catch (error) {
        console.error('Error in regenerateFromRejected:', error);
        alert('Failed to regenerate request: ' + error.message);
    }
}
// Function to regenerate a new request from a rejected one
async function regenerateFromRejected(index, source = 'history') {
    try {
        let rejectedRequest;
        
        // Get the rejected request data
        if (source === 'history') {
            rejectedRequest = historyData[index];
        } else if (source === 'requests') {
            rejectedRequest = requestsData[index];
        }
        
        if (!rejectedRequest) {
            alert('Request not found');
            return;
        }
        
        // Verify the request is actually rejected
        if (!['rejected', 'reviewer_rejected', 'admin_rejected'].includes(rejectedRequest.status)) {
            alert('Only rejected requests can be regenerated');
            return;
        }
        
        // Verify ownership
        if (rejectedRequest.created_by !== currentUser.id) {
            alert('You can only regenerate your own rejected requests');
            return;
        }
        
        // Parse the attribute selections
        let attributeSelections = {};
        try {
            attributeSelections = typeof rejectedRequest.attribute_selections === 'string' 
                ? JSON.parse(rejectedRequest.attribute_selections) 
                : rejectedRequest.attribute_selections || {};
        } catch (e) {
            console.error('Error parsing attribute selections:', e);
        }
        
        // Create information modal showing what will be copied
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center overflow-y-auto';
        modal.innerHTML = `
            <div class="bg-white p-8 rounded-lg max-w-3xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-6 text-gray-900">Regenerate Item Code Request</h3>
                
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
                    <h4 class="font-semibold text-blue-900 mb-2"> What will happen:</h4>
                    <ul class="text-sm text-blue-800 space-y-2 list-disc list-inside">
                        <li>A <strong>new item code request</strong> will be created with a new serial number</li>
                        <li>All your previous selections and data will be pre-filled in the generator</li>
                        <li>You can make corrections before generating the new code</li>
                        <li>The old rejected request (${rejectedRequest.item_code}) will remain as a historical record</li>
                    </ul>
                </div>
                
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded">
                    <h4 class="font-semibold text-red-900 mb-2">Previous Rejection Reason:</h4>
                    <p class="text-sm text-red-700">${rejectedRequest.review_comments || 'No comments provided'}</p>
                </div>
                
                <div class="mb-6 p-4 bg-gray-50 border border-gray-300 rounded">
                    <h4 class="font-semibold text-gray-900 mb-3">Data to be copied:</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-gray-600">Project:</p>
                            <p class="font-medium">${currentProject?.project_name || 'Current Project'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">CSI Code:</p>
                            <p class="font-medium font-mono">${rejectedRequest.csi_division_code || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Additional Level:</p>
                            <p class="font-medium">${rejectedRequest.additional_level || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Entry Description:</p>
                            <p class="font-medium">${rejectedRequest.entry_description || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">UOM:</p>
                            <p class="font-medium">${rejectedRequest.uom || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Country:</p>
                            <p class="font-medium">${rejectedRequest.country_of_origin || '-'}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-gray-600">Model Number:</p>
                            <p class="font-medium">${rejectedRequest.model_number || '-'}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-gray-600">Attributes Selected:</p>
                            <p class="font-medium text-xs">${Object.keys(attributeSelections).length} attribute(s)</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-4 pt-6 border-t">
                    <button type="button" onclick="this.closest('.fixed').remove()" 
                            class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md font-medium">
                        Cancel
                    </button>
                    <button type="button" onclick="proceedWithRegeneration(${index}, '${source}')" 
                            class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-md font-medium">
                        Proceed to Generator
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error in regenerateFromRejected:', error);
        alert('An error occurred: ' + error.message);
    }
}

// Proceed with regeneration - pre-fill the generator form
function proceedWithRegeneration(index, source) {
    try {
        let rejectedRequest;
        
        // Get the rejected request data
        if (source === 'history') {
            rejectedRequest = historyData[index];
        } else if (source === 'requests') {
            rejectedRequest = requestsData[index];
        }
        
        // Close the modal
        document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.remove());
        
        // Switch to the Generate tab (make sure we're on the right tab)
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById('generate-tab')?.classList.remove('hidden');
        
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('border-blue-500', 'text-blue-600');
            btn.classList.add('border-transparent', 'text-gray-500');
        });
        document.querySelector('[data-tab="generate-tab"]')?.classList.add('border-blue-500', 'text-blue-600');
        
        // Scroll to top of generator
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Pre-fill the form fields
        setTimeout(() => {
            // UOM
            const uomSelect = document.getElementById('uom-select');
            if (uomSelect && rejectedRequest.uom) {
                uomSelect.value = rejectedRequest.uom;
            }
            
            // Country
            const countrySelect = document.getElementById('country-select');
            if (countrySelect && rejectedRequest.country_of_origin) {
                countrySelect.value = rejectedRequest.country_of_origin;
            }
            
            // Model Number
            const modelInput = document.getElementById('model-number');
            if (modelInput && rejectedRequest.model_number) {
                modelInput.value = rejectedRequest.model_number;
            }
            
            // Restore attribute selections
            if (rejectedRequest.attribute_selections) {
                let selections = {};
                try {
                    selections = typeof rejectedRequest.attribute_selections === 'string' 
                        ? JSON.parse(rejectedRequest.attribute_selections) 
                        : rejectedRequest.attribute_selections;
                    
                    // Set the global attributeSelections
                    attributeSelections = selections;
                    
                    // Check radio buttons
                    Object.entries(selections).forEach(([attrName, data]) => {
                        const radioButton = document.querySelector(`input[name="attr-${attrName}"][value="${data.value}"]`);
                        if (radioButton) {
                            radioButton.checked = true;
                        }
                    });
                    
                    // Update the preview
                    if (typeof updatePreview === 'function') {
                        updatePreview();
                    }
                } catch (e) {
                    console.error('Error restoring selections:', e);
                }
            }
            
            // Show a notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span>Form pre-filled from rejected request. Review and make corrections.</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
            
        }, 300);
        
    } catch (error) {
        console.error('Error in proceedWithRegeneration:', error);
        alert('Error pre-filling form: ' + error.message);
    }
}
// Function to edit and resubmit rejected requests
async function editAndResubmitRequest(source, index) {
    try {
        let request;
        
        // Get the request data from the appropriate source
        if (source === 'history') {
            request = historyData[index];
        } else if (source === 'requests') {
            request = requestsData[index];
        }
        
        if (!request) {
            alert('Request not found');
            return;
        }
        
        // Verify the request is rejected
        if (!['rejected', 'reviewer_rejected', 'admin_rejected'].includes(request.status)) {
            alert('Only rejected requests can be edited and resubmitted');
            return;
        }
        
        // Create modal for editing
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center overflow-y-auto';
        modal.innerHTML = `
            <div class="bg-white p-8 rounded-lg max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-6 text-gray-900">Edit & Resubmit Request</h3>
                
                <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                    <p class="text-sm font-medium text-yellow-800">Previous Rejection Reason:</p>
                    <p class="text-sm text-yellow-700">${request.review_comments || 'No comments provided'}</p>
                </div>
                
                <form id="edit-request-form" class="space-y-6">
                    <!-- Item Code (Read-only) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Item Code (Read-only)</label>
                        <input type="text" value="${request.item_code || ''}" disabled
                               class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
                    </div>
                    
                    <!-- CSI Division Code (Read-only) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CSI Division Code (Read-only)</label>
                        <input type="text" value="${request.csi_division_code || request.csi_base_code || ''}" disabled
                               class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
                    </div>
                    
                    <!-- Additional Level (Read-only) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Level (Read-only)</label>
                        <input type="text" value="${request.additional_level || ''}" disabled
                               class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
                    </div>
                    
                    <!-- Entry Description -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Entry Description</label>
                        <input type="text" id="edit-entry-description" value="${request.entry_description || ''}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <!-- Description 1 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description 1</label>
                        <textarea id="edit-description1" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">${request.description1 || ''}</textarea>
                    </div>
                    
                    <!-- Description 2 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description 2</label>
                        <textarea id="edit-description2" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">${request.description2 || ''}</textarea>
                    </div>
                    
                    <!-- UOM -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Unit of Measure</label>
                        <input type="text" id="edit-uom" value="${request.uom || ''}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <!-- Country of Origin -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country of Origin</label>
                        <input type="text" id="edit-country" value="${request.country_of_origin || ''}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <!-- Model Number -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Model Number</label>
                        <input type="text" id="edit-model" value="${request.model_number || ''}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <!-- Resubmission Note -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Resubmission Note (Optional)</label>
                        <textarea id="edit-resubmission-note" rows="3" placeholder="Explain what changes you made..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-4 pt-6 border-t">
                        <button type="button" onclick="this.closest('.fixed').remove()" 
                                class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md font-medium">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium">
                            Resubmit Request
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Handle form submission
        document.getElementById('edit-request-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const updatedData = {
                entry_description: document.getElementById('edit-entry-description').value,
                description1: document.getElementById('edit-description1').value,
                description2: document.getElementById('edit-description2').value,
                uom: document.getElementById('edit-uom').value,
                country_of_origin: document.getElementById('edit-country').value,
                model_number: document.getElementById('edit-model').value,
                status: 'pending', // Reset status to pending
                review_comments: null, // Clear previous review comments
                reviewed_by: null,
                reviewed_at: null
            };
            
            const resubmissionNote = document.getElementById('edit-resubmission-note').value;
            if (resubmissionNote) {
                updatedData.description2 = (updatedData.description2 ? updatedData.description2 + '\n\n' : '') 
                    + `[Resubmission Note: ${resubmissionNote}]`;
            }
            
            try {
                // Update the request in the database
                const { data, error } = await supabase
                    .from('item_code_workflow')
                    .update(updatedData)
                    .eq('id', request.id);
                
                if (error) throw error;
                
                alert('Request has been updated and resubmitted successfully!');
                modal.remove();
                
                // Refresh the appropriate view
                if (source === 'history') {
                    await loadItemCodesByProject();
                } else if (source === 'requests') {
                    await loadUserRequests();
                }
                
            } catch (error) {
                console.error('Error resubmitting request:', error);
                alert('Failed to resubmit request: ' + error.message);
            }
        });
        
    } catch (error) {
        console.error('Error in editAndResubmitRequest:', error);
        alert('An error occurred: ' + error.message);
    }
}

// Perform item code search
async function performItemCodeSearch() {
    const searchTerm = document.getElementById('search-input').value.trim();
    const resultsContainer = document.getElementById('search-results');
    
    if (!searchTerm) {
        resultsContainer.innerHTML = '<p class="text-gray-500">Please enter a search term</p>';
        return;
    }
    
    try {
        resultsContainer.innerHTML = '<p class="text-blue-500">Searching...</p>';
        
        // Query item_code_workflow table directly instead of using RPC
        const { data, error } = await supabase
            .from('item_code_workflow')
            .select(`
                *,
                classification_projects(project_name)
            `)
            .or(`item_code.ilike.%${searchTerm}%,description1.ilike.%${searchTerm}%,description2.ilike.%${searchTerm}%`)
            .order('created_at', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        renderSearchResults(data || []);
        
    } catch (error) {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<p class="text-red-500">Search failed. Please try again.</p>';
    }
}

// Render search results
function renderSearchResults(results) {
    const container = document.getElementById('search-results');
    
    if (results.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No item codes found matching your search.</p>';
        return;
    }
    
    container.innerHTML = `
        <h3 class="text-lg font-semibold mb-4">Search Results (${results.length} found)</h3>
        <div class="space-y-4">
            ${results.map(item => `
                <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${item.item_code}</h4>
                            <p class="text-sm text-gray-600">${item.classification_projects?.project_name || 'No Project'}</p>
                        </div>
                        <span class="px-3 py-1 text-xs rounded-full ${getStatusColor(item.status || 'pending')}">
                            ${item.status || 'pending'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">CSI Code:</p>
                            <p class="font-medium">${item.csi_base_code || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Additional Level:</p>
                            <p class="font-medium">${item.additional_level || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">UOM:</p>
                            <p class="font-medium">${item.uom || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Country:</p>
                            <p class="font-medium">${item.country_of_origin || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Model:</p>
                            <p class="font-medium">${item.model_number || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Serial:</p>
                            <p class="font-medium">${item.serial_number || '-'}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-gray-600 text-sm">Description 1:</p>
                        <p class="text-gray-900">${item.description1 || '-'}</p>
                    </div>
                    
                    <div class="mt-2">
                        <p class="text-gray-600 text-sm">Description 2:</p>
                        <p class="text-gray-900">${item.description2 || '-'}</p>
                    </div>
                    
                    <div class="mt-2">
                        <p class="text-gray-600 text-sm">Created:</p>
                        <p class="text-gray-900">${new Date(item.created_at).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-gray-600 text-sm">Combination:</p>
                        <p class="text-gray-900 text-xs">${formatCombinationDisplay(item.attribute_selections)}</p>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}
// Load admin panel data
async function loadAdminPanel() {
    if (currentUser.role !== 'admin' && currentUser.role !== 'erp_data_entry') {
        document.getElementById('pending-codes').innerHTML = '<p class="text-red-500">Access denied - Admin only</p>';
        document.getElementById('pending-values').innerHTML = '<p class="text-red-500">Access denied - Admin only</p>';
        return;
    }

    try {
        console.log('Loading admin panel data...');
        
        // Show loading state
        document.getElementById('pending-codes').innerHTML = '<p class="text-blue-500">Loading pending codes...</p>';
        document.getElementById('pending-values').innerHTML = '<p class="text-blue-500">Loading pending values...</p>';
        
        // Load pending code requests
        const { data: codeRequests, error: codeError } = await supabase
            .from('item_code_workflow')
            .select('*')
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        if (codeError) {
            console.error('Code requests error:', codeError);
            throw codeError;
        }

        // Load pending standard value requests
        const { data: valueRequests, error: valueError } = await supabase
            .from('standard_value_requests')
            .select('*')
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        if (valueError) {
            console.error('Value requests error:', valueError);
            throw valueError;
        }

        console.log('Loaded code requests:', codeRequests?.length || 0);
        console.log('Loaded value requests:', valueRequests?.length || 0);

        renderAdminPanel(codeRequests || [], valueRequests || []);
        
    } catch (error) {
        console.error('Error loading admin panel:', error);
        document.getElementById('pending-codes').innerHTML = '<p class="text-red-500">Failed to load code requests: ' + error.message + '</p>';
        document.getElementById('pending-values').innerHTML = '<p class="text-red-500">Failed to load value requests: ' + error.message + '</p>';
    }
}

// Render admin panel data
function renderAdminPanel(codeRequests, valueRequests) {
    const codesContainer = document.getElementById('pending-codes');
    const valuesContainer = document.getElementById('pending-values');

    // Render pending code requests
    if (codeRequests.length === 0) {
        codesContainer.innerHTML = '<p class="text-gray-500">No pending code requests</p>';
    } else {
        codesContainer.innerHTML = codeRequests.map(request => `
            <div class="bg-white p-4 rounded border shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium text-gray-900">${request.item_code || 'No Code'}</h4>
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Pending</span>
                </div>
                <p class="text-sm text-gray-600 mb-1">CSI: ${request.csi_division_code || 'N/A'}</p>
                <p class="text-sm text-gray-600 mb-1">UOM: ${request.uom || 'N/A'}</p>
                <p class="text-sm text-gray-600 mb-2">Country: ${request.country_of_origin || 'N/A'}</p>
                <p class="text-xs text-gray-500 mb-3">Created: ${new Date(request.created_at).toLocaleDateString()}</p>
                <div class="flex space-x-2">
                    <button onclick="approveRequest('code', ${request.id})" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded">
                        Approve
                    </button>
                    <button onclick="rejectRequest('code', ${request.id})" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded">
                        Reject
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Render pending value requests
    if (valueRequests.length === 0) {
        valuesContainer.innerHTML = '<p class="text-gray-500">No pending value requests</p>';
    } else {
        valuesContainer.innerHTML = valueRequests.map(request => `
            <div class="bg-white p-4 rounded border shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium text-gray-900">${request.attribute_name}</h4>
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Pending</span>
                </div>
                <p class="text-sm text-gray-600 mb-1">New Value: <strong>${request.new_value}</strong></p>
                ${request.reason ? `<p class="text-sm text-gray-600 mb-2">Reason: ${request.reason}</p>` : ''}
                <p class="text-xs text-gray-500 mb-3">Created: ${new Date(request.created_at).toLocaleDateString()}</p>
                <div class="flex space-x-2">
                    <button onclick="approveRequest('value', ${request.id})" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded">
                        Approve
                    </button>
                    <button onclick="rejectRequest('value', ${request.id})" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded">
                        Reject
                    </button>
                </div>
            </div>
        `).join('');
    }
}

// Format combination display for search results
function formatCombinationDisplay(attributeSelections) {
    if (!attributeSelections || typeof attributeSelections !== 'object') {
        return 'No selections';
    }
    
    try {
        const selections = [];
        for (const [attrId, selection] of Object.entries(attributeSelections)) {
            if (selection && selection.value) {
                selections.push(selection.value);
            }
        }
        return selections.length > 0 ? selections.join(' + ') : 'No selections';
    } catch (error) {
        console.error('Error formatting combination:', error);
        return 'Error displaying combination';
    }
}

// Approve/Reject admin functions
async function approveRequest(type, requestId) {
    try {
        if (type === 'code') {
            // Get the full request details
            const { data: request, error: fetchError } = await supabase
                .from('item_code_workflow')
                .select('*')
                .eq('id', requestId)
                .single();
            
            if (fetchError) throw fetchError;
            
            // Create entry in item_code_workflow table with all the data including hash
            const { error: insertError } = await supabase
                .from('item_code_workflow')
                .insert({
                    project_id: request.project_id,
                    csi_base_code: request.csi_division_code,
                    csi_description: '', // Add if available
                    additional_level: request.additional_level,
                    item_code: request.item_code,
                    description1: request.description1,
                    description2: request.description2,
                    combination_signature: request.combination_signature,
                    attribute_selections: request.attribute_selections,
                    duplicate_check_hash: request.duplicate_check_hash, // COPY THE HASH!
                    uom: request.uom,
                    country_of_origin: request.country_of_origin,
                    model_number: request.model_number,
                    serial_number: request.serial_number || 1,
                    created_by: request.created_by,
                    status: 'approved',
                    approved_by: currentUser.id,
                    approved_at: new Date().toISOString()
                });
            
            if (insertError) throw insertError;
            
            // Update the request status
            const { error: updateError } = await supabase
                .from('item_code_workflow')
                .update({ 
                    status: 'approved',
                    reviewed_by: currentUser.id,
                    reviewed_at: new Date().toISOString()
                })
                .eq('id', requestId);
            
            if (updateError) throw updateError;
            
        } else if (type === 'value') {
            const { error } = await supabase
                .from('standard_value_requests')
                .update({ status: 'approved' })
                .eq('id', requestId);
            
            if (error) throw error;
        }
        
        alert('Request approved successfully');
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error approving request:', error);
        alert('Failed to approve request: ' + error.message);
    }
}
async function rejectRequest(type, requestId) {
    const reason = prompt('Please provide a reason for rejection:');
    if (!reason) return;
    
    try {
        if (type === 'code') {
            const { error } = await supabase
                .from('item_code_workflow')
                .update({ 
                    status: 'rejected',
                    review_comments: reason
                })
                .eq('id', requestId);
            
            if (error) throw error;
        } else if (type === 'value') {
            const { error } = await supabase
                .from('standard_value_requests')
                .update({ 
                    status: 'rejected',
                    reviewer_comments: reason
                })
                .eq('id', requestId);
            
            if (error) throw error;
        }
        
        alert('Request rejected successfully');
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error rejecting request:', error);
        alert('Failed to reject request: ' + error.message);
    }
}

// Make admin functions globally available
window.approveRequest = approveRequest;
window.rejectRequest = rejectRequest;
// Missing export functions for requests
function exportAllRequests(format) {
    if (!requestsData || requestsData.length === 0) {
        alert('No requests to export');
        return;
    }
    
    const timestamp = new Date().toISOString().slice(0, 10);
    
    if (format === 'excel') {
        exportToExcel(requestsData, `my_requests_${timestamp}.xlsx`);
    } else if (format === 'pdf') {
        exportToPDF(requestsData, `my_requests_${timestamp}.pdf`, 'My Requests');
    }
}

function toggleRequestsView() {
    // Toggle between card and table view for requests
    const cardsContainer = document.getElementById('requests-cards-container');
    const tableContainer = document.getElementById('requests-table-container');
    const toggleBtn = document.getElementById('toggle-requests-view-btn');
    
    if (cardsContainer.classList.contains('hidden')) {
        cardsContainer.classList.remove('hidden');
        tableContainer.classList.add('hidden');
        toggleBtn.textContent = 'Switch to Table View';
    } else {
        cardsContainer.classList.add('hidden');
        tableContainer.classList.remove('hidden');
        toggleBtn.textContent = 'Switch to Card View';
        renderRequestsTable();
    }
}

function renderRequestsTable() {
    const tbody = document.getElementById('requests-table');
    if (!requestsData || requestsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-gray-500">No requests found</td></tr>';
        return;
    }
    
    tbody.innerHTML = requestsData.map(request => `
        <tr class="border-b">
            <td class="py-2 px-4 text-xs">${request.csi_division_code || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.additional_level || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.entry_description || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.item_code || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.description1 || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.description2 || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.combination_signature || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.uom || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.country_of_origin || '-'}</td>
            <td class="py-2 px-4 text-xs">${request.model_number || '-'}</td>
            <td class="py-2 px-4 text-xs"><span class="px-2 py-1 rounded ${getStatusColor(request.status)}">${request.status}</span></td>
            <td class="py-2 px-4 text-xs">${new Date(request.created_at).toLocaleDateString()}</td>
        </tr>
    `).join('');
}

// Make these functions globally available
window.exportAllRequests = exportAllRequests;
window.toggleRequestsView = toggleRequestsView;
// Manual entry functions
function selectManualEntry(attrId, inputId, isDirectEntry = false) {
    console.log('Manual entry selected for attribute:', attrId);
    // This function is kept for compatibility but manual entry is now always active
    // The actual work is done in updateManualValue
    const input = document.getElementById(inputId);
    if (input) {
        input.focus();
        // Initialize empty manual entry
        attributeSelections[attrId] = { value: '', index: 'manual' };
        updatePreview();
        checkForDuplicates();
        checkGenerateButton();
    }
}
function updateManualValue(attrId, value) {
    console.log('Manual value updated:', attrId, value);
    if (value && value.trim()) {
        attributeSelections[attrId] = { value: value.trim(), index: 'manual' };
    } else {
        // Keep the manual selection but with empty value
        attributeSelections[attrId] = { value: '', index: 'manual' };
    }
    updatePreview();
    checkForDuplicates();
    checkGenerateButton();
}

function clearAttributeSelection(attrId, radioGroupName) {
    console.log('Clearing selection for attribute:', attrId);
    
    // Clear from attributeSelections
    delete attributeSelections[attrId];
    
    // Uncheck all radio buttons for this attribute (standard values only)
    const radioButtons = document.querySelectorAll(`input[name="${radioGroupName}"]`);
    radioButtons.forEach(radio => {
        radio.checked = false;
    });
    
    // Clear any manual entry inputs and unit selectors
    const manualInput = document.querySelector(`input[type="text"][id*="manual-attr-${radioGroupName.split('-')[1]}"]`);
    const unitSelect = document.querySelector(`select[id*="unit-attr-${radioGroupName.split('-')[1]}"]`);
    
    if (manualInput) {
        manualInput.value = '';
    }
    if (unitSelect) {
        unitSelect.value = '';
    }
    
    updatePreview();
    checkForDuplicates();
    checkGenerateButton();
}
// Make manual entry functions globally available
window.selectManualEntry = selectManualEntry;
window.updateManualValue = updateManualValue;
window.clearAttributeSelection = clearAttributeSelection;

// Additional missing admin functions
async function editItemCode(requestId) {
    if (currentUser.role !== 'admin' && currentUser.role !== 'erp_data_entry') {
        alert('Only administrators can edit item codes.');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('item_code_workflow')
            .select('*')
            .eq('id', requestId)
            .single();
        
        if (error) throw error;
        
        const newDescription1 = prompt('Edit Description 1:', data.description1);
        const newDescription2 = prompt('Edit Description 2:', data.description2);
        
        if (newDescription1 !== null && newDescription2 !== null) {
            const { error: updateError } = await supabase
                .from('item_code_workflow')
                .update({
                    description1: newDescription1,
                    description2: newDescription2
                })
                .eq('id', requestId);
            
            if (updateError) throw updateError;
            
            alert('Item code updated successfully');
             // After successful save, add this line:
refreshSearchCodesData(); // Refresh search codes data
            loadProjectHistory();
           
        }
    } catch (error) {
        console.error('Error editing item code:', error);
        alert('Failed to edit item code: ' + error.message);
    }
}

async function deleteItemCode(requestId) {
    if (currentUser.role !== 'admin' && currentUser.role !== 'erp_data_entry') {
        alert('Only administrators can delete item codes.');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this item code request? This action cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('item_code_workflow')
            .delete()
            .eq('id', requestId);
        
        if (error) throw error;
        
        alert('Item code request deleted successfully');
        loadProjectHistory();
    } catch (error) {
        console.error('Error deleting item code:', error);
        alert('Failed to delete item code: ' + error.message);
    }
}

// View item details in modal
function viewItemDetails(index) {
    const item = historyData[index];
    if (!item) return;
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Item Code Details</h2>
                    <button onclick="closeModal(this)" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Header Info -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg text-blue-900 font-mono">${item.item_code}</h3>
                        <div class="flex items-center mt-2">
                            <span class="px-3 py-1 rounded text-sm font-medium ${getStatusClass(item.status)}">${item.status}</span>
                            <span class="ml-4 text-sm text-gray-600">Created: ${new Date(item.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-900 border-b pb-2">CSI Information</h4>
                            <div><span class="font-medium">CSI Code:</span> ${item.csi_division_code || '-'}</div>
                            <div><span class="font-medium">Additional Level:</span> ${item.additional_level || '-'}</div>
                            <div><span class="font-medium">Entry Type:</span> ${item.entry_description || 'Generated'}</div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-900 border-b pb-2">Product Information</h4>
                            <div><span class="font-medium">Unit of Measurement:</span> ${item.uom || '-'}</div>
                            <div><span class="font-medium">Country of Origin:</span> ${item.country_of_origin || '-'}</div>
                            <div><span class="font-medium">Model Number:</span> ${item.model_number || '-'}</div>
                        </div>
                    </div>
                    
                    <!-- Descriptions -->
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Description 1</h4>
                            <p class="bg-gray-50 p-3 rounded border">${item.description1 || 'No description available'}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Description 2</h4>
                            <p class="bg-gray-50 p-3 rounded border">${item.description2 || 'No description available'}</p>
                        </div>
                    </div>
                    
                    <!-- Attribute Combination -->
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">Attribute Combination</h4>
                        <div class="bg-gray-50 p-3 rounded border">
                            <p class="font-mono text-sm">${formatCombinationDisplay(item.attribute_selections)}</p>
                        </div>
                    </div>
                    
                    <!-- Review Information -->
                    ${item.review_comments ? `
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Review Comments</h4>
                            <p class="bg-yellow-50 p-3 rounded border">${item.review_comments}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="exportSingleItem(${index}, 'excel')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        Export as Excel
                    </button>
                    <button onclick="exportSingleItem(${index}, 'pdf')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                        Export as PDF
                    </button>
                    <button onclick="closeModal(this)" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Close modal function
function closeModal(button) {
    const modal = button.closest('.fixed');
    if (modal) {
        modal.remove();
    }
}

// Export single item
function exportSingleItem(index, format) {
    const item = historyData[index];
    if (!item) return;
    
    if (format === 'excel') {
        exportToExcel([item], `item-code-${item.item_code}.xlsx`);
    } else if (format === 'pdf') {
        exportToPDF([item], `item-code-${item.item_code}.pdf`, `Item Code: ${item.item_code}`);
    }
}

// Enhanced Excel export function
function exportToExcel(data, filename) {
    const workbook = XLSX.utils.book_new();
    
    // Prepare data for Excel
    const excelData = data.map(item => ({
        'Item Code': item.item_code,
        'CSI Code': item.csi_division_code || '',
        'Additional Level': item.additional_level || '',
        'Entry Type': item.entry_description || 'Generated',
        'Description 1': item.description1 || '',
        'Description 2': item.description2 || '',
        'Unit of Measurement': item.uom || '',
        'Country of Origin': item.country_of_origin || '',
        'Model Number': item.model_number || '',
        'Combination Signature': item.combination_signature || '',
        'Attribute Combination': formatCombinationDisplay(item.attribute_selections),
        'Status': item.status,
        'Created Date': new Date(item.created_at).toLocaleDateString(),
        'Review Comments': item.review_comments || ''
    }));
    
    const worksheet = XLSX.utils.json_to_sheet(excelData);
    
    // Auto-size columns
    const colWidths = [];
    Object.keys(excelData[0] || {}).forEach((key, i) => {
        const maxLength = Math.max(
            key.length,
            ...excelData.map(row => String(row[key] || '').length)
        );
        colWidths[i] = { wch: Math.min(maxLength + 2, 50) };
    });
    worksheet['!cols'] = colWidths;
    
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Item Codes');
    XLSX.writeFile(workbook, filename);
}

// Enhanced PDF export with better formatting
function exportToPDF(data, filename, title) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(title, 14, 20);
    
    if (currentProject) {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Project: ${currentProject.project_name}`, 14, 30);
        doc.text(`CSI Path: ${currentProject.division_code}-${currentProject.section_code}-${currentProject.detailed_section_code}-${currentProject.item_code}`, 14, 36);
    }
    
    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 42);
    doc.text(`Generated by: ${currentUser.username}`, 14, 48);
    
    let yPosition = 60;
    
    data.forEach((item, index) => {
        if (index > 0) {
            doc.addPage();
            yPosition = 20;
        }
        
        // Item Code Header
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text(`Item Code: ${item.item_code}`, 14, yPosition);
        yPosition += 10;
        
        // Status and Date
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Status: ${item.status} | Created: ${new Date(item.created_at).toLocaleDateString()}`, 14, yPosition);
        yPosition += 15;
        
        // Details table
        const tableData = [
            ['CSI Code', item.csi_division_code || '-'],
            ['Additional Level', item.additional_level || '-'],
            ['Entry Type', item.entry_description || 'Generated'],
            ['Unit of Measurement', item.uom || '-'],
            ['Country of Origin', item.country_of_origin || '-'],
            ['Model Number', item.model_number || '-'],
            ['Description 1', item.description1 || '-'],
            ['Description 2', item.description2 || '-'],
            ['Attribute Combination', formatCombinationDisplay(item.attribute_selections)]
        ];
        
        if (item.review_comments) {
            tableData.push(['Review Comments', item.review_comments]);
        }
        
        doc.autoTable({
            startY: yPosition,
            body: tableData,
            styles: { fontSize: 9 },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 50 },
                1: { cellWidth: 120 }
            },
            margin: { top: yPosition }
        });
    });
    
    doc.save(filename);
}

// Toggle between card and table view
function toggleView() {
    isCardView = !isCardView;
    renderHistoryTable();
}

// Export all items
function exportAllItems(format) {
    if (!historyData || historyData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const timestamp = new Date().toISOString().slice(0, 10);
    const projectName = currentProject?.project_name?.replace(/[^a-zA-Z0-9]/g, '_') || 'project';
    
    if (format === 'excel') {
        exportToExcel(historyData, `${projectName}_all_items_${timestamp}.xlsx`);
    } else if (format === 'pdf') {
        exportToPDF(historyData, `${projectName}_all_items_${timestamp}.pdf`, 'All Item Codes - Request History');
    }
}

// Make functions globally available
window.viewItemDetails = viewItemDetails;
window.closeModal = closeModal;
window.exportSingleItem = exportSingleItem;
window.toggleView = toggleView;
window.exportAllItems = exportAllItems;
window.modifyRejectedRequest = modifyRejectedRequest;       
// Admin functions
        async function editItemCode(requestId) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'erp_data_entry') {
                alert('Only administrators can edit item codes.');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('item_code_workflow')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (error) throw error;
                
                const newDescription1 = prompt('Edit Description 1:', data.description1);
                const newDescription2 = prompt('Edit Description 2:', data.description2);
                
                if (newDescription1 !== null && newDescription2 !== null) {
                    const { error: updateError } = await supabase
                        .from('item_code_workflow')
                        .update({
                            description1: newDescription1,
                            description2: newDescription2
                        })
                        .eq('id', requestId);
                    
                    if (updateError) throw updateError;
                    
                    alert('Item code updated successfully');
                    loadProjectHistory();
                }
            } catch (error) {
                console.error('Error editing item code:', error);
                alert('Failed to edit item code: ' + error.message);
            }
        }

        async function deleteItemCode(requestId) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'erp_data_entry') {
                alert('Only administrators can delete item codes.');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this item code request? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('item_code_workflow')
                    .delete()
                    .eq('id', requestId);
                
                if (error) throw error;
                
                alert('Item code request deleted successfully');
                loadProjectHistory();
            } catch (error) {
                console.error('Error deleting item code:', error);
                alert('Failed to delete item code: ' + error.message);
            }
        }

// ===== TABLE VIEW FUNCTIONALITY FOR SEARCH CODES =====

// Global variable to track search view mode
let isSearchTableView = false;

// Toggle between card/hierarchy view and table view
function toggleSearchTableView() {
    console.log(' Toggling search view mode...');
    
    const hierarchyView = document.getElementById('hierarchy-view');
    const listView = document.getElementById('list-view');
    const tableView = document.getElementById('table-view-container');
    const toggleBtn = document.getElementById('toggle-table-view-btn');
    const viewDescription = document.getElementById('view-description');
    
    if (!tableView) {
        console.error(' Table view container not found');
        return;
    }
    
    isSearchTableView = !isSearchTableView;
    
    if (isSearchTableView) {
        // Switch to table view
        if (hierarchyView) hierarchyView.classList.add('hidden');
        if (listView) listView.classList.add('hidden');
        tableView.classList.remove('hidden');
        
        if (toggleBtn) toggleBtn.textContent = 'Switch to Card View';
        if (viewDescription) viewDescription.textContent = 'Showing table view with ERP integration controls for admins';
        
        // Populate table with current data
        populateSearchTable();
    } else {
        // Switch back to card/hierarchy view
        tableView.classList.add('hidden');
        if (searchHierarchyView) {
            if (hierarchyView) hierarchyView.classList.remove('hidden');
            if (listView) listView.classList.add('hidden');
        } else {
            if (hierarchyView) hierarchyView.classList.add('hidden');
            if (listView) listView.classList.remove('hidden');
        }
        
        if (toggleBtn) toggleBtn.textContent = 'Switch to Table View';
        if (viewDescription) {
            viewDescription.textContent = searchHierarchyView ? 
                'Showing hierarchical WBS view organized by CSI structure' : 
                'Showing flat list view of all item codes';
        }
    }
    
    console.log(' Switched to', isSearchTableView ? 'table' : 'card', 'view');
}

// Populate the search table with approved codes
function populateSearchTable() {
    console.log(' Populating search table...');
    
    const tableBody = document.getElementById('search-codes-table-body');
    if (!tableBody) {
        console.error(' Table body not found');
        return;
    }
    
    if (!allApprovedCodes || allApprovedCodes.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-500">No admin-approved codes found</td></tr>';
        return;
    }
    
    console.log(' Populating table with', allApprovedCodes.length, 'admin-approved items');
    
    // Check if user is admin for showing checkboxes
    const isAdmin = currentUser && currentUser.role === 'admin';
    // Check if user is ERP data entry for showing ERP controls
    const isERPDataEntry = currentUser && currentUser.role === 'erp_data_entry';
    
    tableBody.innerHTML = allApprovedCodes.map((item, index) => `
        <tr class="hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
            <td class="px-4 py-3 whitespace-nowrap text-sm font-mono font-semibold text-blue-600 border-b">${item.item_code || 'N/A'}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">${(item.classification_projects?.project_name || 'Unknown').substring(0, 30)}${(item.classification_projects?.project_name || '').length > 30 ? '...' : ''}</td>
            <td class="px-4 py-3 text-sm text-gray-900 border-b max-w-xs" title="${item.description1 || ''}">${(item.description1 || 'N/A').substring(0, 40)}${(item.description1 || '').length > 40 ? '...' : ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-green-700 border-b">${item.unit_price ? `${item.unit_price} ${item.currency_code || ''}` : 'Not specified'}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">${(item.manufacturer || 'Not specified').substring(0, 20)}${(item.manufacturer || '').length > 20 ? '...' : ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">${item.uom || 'N/A'}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">${item.country_of_origin || 'N/A'}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">${item.model_number || 'N/A'}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">${item.approved_by_user?.username || 'Admin'}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b">${new Date(item.created_at).toLocaleDateString()}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center border-b">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.erp_integrated ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${item.erp_integrated ? ' INTEGRATED' : ' NOT INTEGRATED'}
                </span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-center border-b bg-yellow-50">
                ${isAdmin || isERPDataEntry ? `
                    <div class="flex items-center justify-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="erp-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500 focus:ring-2"
                                   ${item.erp_integrated ? 'checked' : ''} 
                                   data-item-id="${item.id}"
                                   data-item-code="${item.item_code}"
                                   onchange="handleERPToggleFromTable(this, ${item.id})">
                            <span class="ml-2 text-xs font-medium text-gray-700">
                                ${item.erp_integrated ? 'Unmark' : 'Mark'}
                            </span>
                        </label>
                    </div>
                ` : `
                    <span class="text-xs ${item.erp_integrated ? 'text-green-700 font-semibold' : 'text-orange-700 font-semibold'}">
                        ${item.erp_integrated ? 'Integrated' : 'Pending'}
                    </span>
                    ${item.erp_integrated && item.erp_integrated_at ? `<div class="text-xs text-gray-500 mt-1">${new Date(item.erp_integrated_at).toLocaleDateString()}</div>` : ''}
                `}
            </td>
            </td>
        </tr>
    `).join('');
    
    console.log(' Table populated with', allApprovedCodes.length, 'rows');
}

// Handle ERP toggle from table
async function handleERPToggleFromTable(checkbox, itemId) {
    console.log(' Table ERP toggle:', itemId, checkbox.checked);
    
    try {
        // Quick admin check
        if (!currentUser || currentUser.role !== 'admin' && currentUser.role !== 'erp_data_entry') {
            alert(' ERP Data Entry or Admin access required');
            checkbox.checked = !checkbox.checked; // Revert
            return;
        }
        
        const isIntegrated = checkbox.checked;
        const itemCode = checkbox.dataset.itemCode;
        
        // Show loading state
        checkbox.disabled = true;
        const row = checkbox.closest('tr');
        const originalHTML = row.cells[11].innerHTML; // Save original HTML
        row.cells[11].innerHTML = '<div class="flex items-center justify-center"><span class="text-xs text-blue-600 animate-pulse">Updating...</span></div>';
        
        // Update database
        const { error } = await supabase
            .from('item_code_workflow')
            .update({
                erp_integrated: isIntegrated,
                erp_integrated_by: isIntegrated ? currentUser.id : null,
                erp_integrated_at: isIntegrated ? new Date().toISOString() : null
            })
            .eq('id', itemId);
        
        if (error) {
            console.error(' Database error:', error);
            alert('Database update failed: ' + error.message);
            checkbox.checked = !isIntegrated; // Revert
            row.cells[11].innerHTML = originalHTML; // Restore
            return;
        }
        
        // Update local data
        const item = allApprovedCodes.find(c => c.id == itemId);
        if (item) {
            item.erp_integrated = isIntegrated;
            item.erp_integrated_at = isIntegrated ? new Date().toISOString() : null;
            item.erp_integrated_by = isIntegrated ? currentUser.id : null;
        }
        
        // Update status column
        const statusCell = row.cells[10]; // ERP Status column
        statusCell.innerHTML = `
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${isIntegrated ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${isIntegrated ? ' INTEGRATED' : ' NOT INTEGRATED'}
            </span>
        `;
        
        // Restore admin control column
        const adminCell = row.cells[11];
        adminCell.innerHTML = `
            <div class="flex items-center justify-center">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" 
                           class="erp-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500 focus:ring-2"
                           ${isIntegrated ? 'checked' : ''} 
                           data-item-id="${itemId}"
                           data-item-code="${itemCode}"
                           onchange="handleERPToggleFromTable(this, ${itemId})">
                    <span class="ml-2 text-xs font-medium text-gray-700">
                        ${isIntegrated ? 'Unmark' : 'Mark'}
                    </span>
                </label>
            </div>
        `;
        
        // Show success notification
        showNotification(
            ` ${itemCode} ${isIntegrated ? 'marked as integrated' : 'unmarked from integration'}`,
            'success'
        );
        
        console.log(' ERP status updated successfully');
        
    } catch (error) {
        console.error(' Error updating ERP status:', error);
        alert('Error: ' + error.message);
        checkbox.checked = !checkbox.checked; // Revert
        checkbox.disabled = false;
    }
}

// Setup table view event listeners
function setupTableView() {
    const toggleTableBtn = document.getElementById('toggle-table-view-btn');
    if (toggleTableBtn) {
        toggleTableBtn.addEventListener('click', toggleSearchTableView);
    }
}

// Initialize table view when app starts
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(setupTableView, 1000); // Wait for DOM to be ready
});

// ===== END TABLE VIEW FUNCTIONALITY =====

// ===== ERP INTEGRATION FUNCTIONALITY =====

// Load ERP dashboard data
async function loadERPDashboard() {
    console.log(' Loading ERP dashboard...');
    
    try {
        // Check user permissions
        if (!currentUser || (currentUser.role !== 'erp_data_entry' && currentUser.role !== 'admin')) {
            alert('Access denied. ERP Data Entry role required.');
            return;
        }

        let erpItems;
        
        // Try to reuse already loaded data if available
        if (window.allApprovedCodes && window.allApprovedCodes.length > 0) {
            console.log('Reusing already loaded approved codes for ERP dashboard:', window.allApprovedCodes.length);
            erpItems = window.allApprovedCodes;
        } else {
            console.log('Loading approved items for ERP dashboard...');
            
            // Load approved item codes - ONLY items with final admin approval from unified workflow table
            const { data: approvedCodes, error } = await supabase
                .from('item_code_workflow')
                .select(`
                    id,
                    item_code,
                    description1,
                    description2,
                    uom,
                    country_of_origin,
                    model_number,
                    unit_price,
                    currency_code,
                    manufacturer,
                    created_at,
                    project_id,
                    status,
                    approved_by,
                    approved_at,
                    erp_integrated,
                    erp_integrated_at,
                    erp_integrated_by,
                    created_by_user:users!item_code_workflow_created_by_fkey(username, email),
                    approved_by_user:users!item_code_workflow_approved_by_fkey(username, email),
                    classification_projects!inner (
                        id,
                        project_name,
                        division_code,
                        division_description,
                        section_code,
                        section_description,
                        detailed_section_code,
                        detailed_section_description,
                        item_code,
                        item_description,
                        additional_level_name,
                        additional_level_value
                    )
                `)
                .eq('status', 'admin_approved')  // CRITICAL: Only items with final admin approval in workflow
                .not('approved_by', 'is', null)  // CRITICAL: Must have admin who approved it
                .not('approved_at', 'is', null)  // CRITICAL: Must have approval timestamp
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading ERP items:', error);
                alert('Failed to load ERP data: ' + error.message);
                return;
            }
            
            erpItems = approvedCodes || [];
            console.log('Loaded approved items for ERP:', erpItems.length);
        }

        // Store data globally
        window.erpItems = erpItems;
        
        // Update stats
        updateERPStats(erpItems);
        
        // Populate table
        populateERPTable(erpItems);
        
        console.log('ERP dashboard loaded with', erpItems.length, 'items');
        
        // VISUAL TEST: Force show the ERP tab content
        console.log('VISUAL TEST: Checking ERP tab content visibility...');
        
        const erpTabContent = document.getElementById('erp-tab');  // This is the content div
        const tableBody = document.getElementById('erp-items-table-body');
        
        console.log('ERP tab content found:', !!erpTabContent);
        console.log('ERP tab content classes:', erpTabContent?.className);
        console.log('Table body found:', !!tableBody);
        console.log('Table body rows:', tableBody?.children?.length || 0);
        
        // Force remove hidden class from tab content
        if (erpTabContent) {
            const isHidden = erpTabContent.classList.contains('hidden');
            console.log('ERP tab content is hidden:', isHidden);
            if (isHidden) {
                console.log('FIXING: Removing hidden class from ERP tab content!');
                erpTabContent.classList.remove('hidden');
                console.log('Hidden class removed - content should now be visible!');
            } else {
                console.log('ERP tab content is already visible');
            }
            
            // Double-check final state
            console.log('Final tab content classes:', erpTabContent.className);
        } else {
            console.error('ERP tab content element not found!');
        }
        
    } catch (error) {
        console.error('Error in loadERPDashboard:', error);
        alert('Error loading ERP dashboard: ' + error.message);
    }
}

// Update ERP statistics
function updateERPStats(items) {
    console.log('updateERPStats called with items:', items?.length || 0);
    
    const total = items?.length || 0;
    const integrated = items?.filter(item => item.erp_integrated).length || 0;
    const pending = total - integrated;
    const rate = total > 0 ? Math.round((integrated / total) * 100) : 0;

    console.log('ERP Stats - Total:', total, 'Integrated:', integrated, 'Pending:', pending, 'Rate:', rate + '%');

    const totalElement = document.getElementById('erp-total-count');
    const integratedElement = document.getElementById('erp-integrated-count');
    const pendingElement = document.getElementById('erp-pending-count');
    const rateElement = document.getElementById('erp-rate-percentage');

    console.log('Statistics elements found:', {
        total: !!totalElement,
        integrated: !!integratedElement, 
        pending: !!pendingElement,
        rate: !!rateElement
    });

    if (totalElement) {
        totalElement.textContent = total;
        console.log(' Total count set to:', totalElement.textContent);
    }
    if (integratedElement) {
        integratedElement.textContent = integrated;
        console.log(' Integrated count set to:', integratedElement.textContent);
    }
    if (pendingElement) {
        pendingElement.textContent = pending;
        console.log(' Pending count set to:', pendingElement.textContent);
    }
    if (rateElement) {
        rateElement.textContent = rate + '%';
        console.log(' Rate set to:', rateElement.textContent);
    }
    
    console.log('ERP stats updated successfully');
}

// Populate ERP table
function populateERPTable(items) {
    console.log(' populateERPTable called with items:', items?.length || 0);
    
    const tableBody = document.getElementById('erp-items-table-body');
    if (!tableBody) {
        console.error('ERP table body not found');
        return;
    }

    if (!items || items.length === 0) {
        console.log('No items to display in ERP table');
        tableBody.innerHTML = '<tr><td colspan="11" class="px-4 py-8 text-center text-gray-500">No approved items found</td></tr>';
        return;
    }

    console.log(' First item structure:', items[0]);

    // Apply filters
    const statusFilter = document.getElementById('erp-status-filter')?.value || '';
    const searchText = document.getElementById('erp-search-input')?.value?.toLowerCase() || '';

    let filteredItems = items;

    // Filter by status
    if (statusFilter === 'integrated') {
        filteredItems = filteredItems.filter(item => item.erp_integrated);
    } else if (statusFilter === 'pending') {
        filteredItems = filteredItems.filter(item => !item.erp_integrated);
    }

    // Filter by search text
    if (searchText) {
        filteredItems = filteredItems.filter(item => 
            (item.item_code || '').toLowerCase().includes(searchText) ||
            (item.description1 || '').toLowerCase().includes(searchText) ||
            (item.description2 || '').toLowerCase().includes(searchText) ||
            (item.classification_projects?.division_code || '').toLowerCase().includes(searchText)
        );
    }

    console.log('Filtered items count:', filteredItems.length);

    if (filteredItems.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="11" class="px-4 py-8 text-center text-gray-500">No items found with current filters</td></tr>';
        return;
    }

    const canModify = currentUser && (currentUser.role === 'erp_data_entry' || currentUser.role === 'admin');
    console.log('User can modify ERP status:', canModify, 'Role:', currentUser?.role);

    console.log('About to render table with', filteredItems.length, 'items...');
    
    try {
        const tableHTML = filteredItems.map((item, index) => {
            console.log(`Rendering row ${index + 1}:`, item.item_code);
            return `
                <tr class="hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-mono font-semibold text-blue-600">
                        ${item.item_code || 'N/A'}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-purple-700 font-semibold">
                        ${item.classification_projects?.division_code || 'N/A'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 max-w-xs" title="${item.description1 || ''}">
                        ${(item.description1 || 'N/A').substring(0, 40)}${(item.description1 || '').length > 40 ? '...' : ''}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 max-w-xs" title="${item.description2 || ''}">
                        ${(item.description2 || 'N/A').substring(0, 40)}${(item.description2 || '').length > 40 ? '...' : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-green-700">
                        ${item.unit_price ? `${item.unit_price} ${item.currency_code || ''}` : 'Not specified'}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${(item.manufacturer || 'Not specified').substring(0, 20)}${(item.manufacturer || '').length > 20 ? '...' : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" title="${item.model_number || 'N/A'}">
                        ${(item.model_number || 'N/A').substring(0, 20)}${(item.model_number || '').length > 20 ? '...' : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" title="${item.country_of_origin || 'N/A'}">
                        ${(item.country_of_origin || 'N/A').substring(0, 15)}${(item.country_of_origin || '').length > 15 ? '...' : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${item.approved_at ? new Date(item.approved_at).toLocaleDateString() : 'N/A'}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.erp_integrated ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                            ${item.erp_integrated ? 'INTEGRATED' : 'PENDING'}
                        </span>
                        ${item.erp_integrated && item.erp_integrated_at ? `<div class="text-xs text-gray-500 mt-1">${new Date(item.erp_integrated_at).toLocaleDateString()}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        ${canModify ? `
                            <label class="flex items-center justify-center cursor-pointer">
                                <input type="checkbox" 
                                       class="erp-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                                       ${item.erp_integrated ? 'checked' : ''} 
                                       data-item-id="${item.id}"
                                       data-item-code="${item.item_code}"
                                       onchange="handleERPToggleFromERPTab(this, ${item.id})">
                                <span class="ml-2 text-xs font-medium text-gray-700">
                                    ${item.erp_integrated ? 'Unmark' : 'Mark'}
                                </span>
                            </label>
                        ` : `
                            <span class="text-xs text-gray-500">No Action</span>
                        `}
                    </td>
                </tr>
            `;
        }).join('');
        
        console.log('Generated table HTML length:', tableHTML.length);
        console.log('About to set innerHTML...');
        
        tableBody.innerHTML = tableHTML;
        
        console.log('Table HTML set successfully!');
        console.log(' Table body now has', tableBody.children.length, 'rows');
        
    } catch (error) {
        console.error('Error rendering table:', error);
        tableBody.innerHTML = '<tr><td colspan="11" class="px-4 py-8 text-center text-red-500">Error rendering table: ' + error.message + '</td></tr>';
    }
}

// Handle ERP toggle from ERP tab
async function handleERPToggleFromERPTab(checkbox, itemId) {
    console.log(' ERP tab toggle:', itemId, checkbox.checked);
    
    try {
        // Check permissions
        if (!currentUser || (currentUser.role !== 'erp_data_entry' && currentUser.role !== 'admin')) {
            alert('ERP Data Entry or ERP Data Entry or Admin access required');
            checkbox.checked = !checkbox.checked; // Revert
            return;
        }
        
        const isIntegrated = checkbox.checked;
        const itemCode = checkbox.dataset.itemCode;
        
        // Show loading state
        checkbox.disabled = true;
        
        // Update database
        const { error } = await supabase
            .from('item_code_workflow')
            .update({
                erp_integrated: isIntegrated,
                erp_integrated_by: isIntegrated ? currentUser.id : null,
                erp_integrated_at: isIntegrated ? new Date().toISOString() : null
            })
            .eq('id', itemId);
        
        if (error) {
            console.error('Database error:', error);
            alert('Database update failed: ' + error.message);
            checkbox.checked = !isIntegrated; // Revert
            checkbox.disabled = false;
            return;
        }
        
        // Update local data
        const item = window.erpItems.find(c => c.id == itemId);
        if (item) {
            item.erp_integrated = isIntegrated;
            item.erp_integrated_at = isIntegrated ? new Date().toISOString() : null;
            item.erp_integrated_by = isIntegrated ? currentUser.id : null;
        }
        
        // Show success notification
        showNotification(
            `${itemCode} ${isIntegrated ? 'marked as integrated' : 'unmarked from integration'}`,
            'success'
        );
        
        // Refresh dashboard
        updateERPStats(window.erpItems);
        populateERPTable(window.erpItems);
        
        console.log('ERP status updated successfully');
        
    } catch (error) {
        console.error('Error updating ERP status:', error);
        alert('Error: ' + error.message);
        checkbox.checked = !checkbox.checked; // Revert
        checkbox.disabled = false;
    }
}

// Refresh ERP data
async function refreshERPData() {
    await loadERPDashboard();
    showNotification('ERP data refreshed', 'success');
}

// Add event listeners for ERP filters
document.addEventListener('DOMContentLoaded', function() {
    // Wait for elements to be ready
    setTimeout(() => {
        const statusFilter = document.getElementById('erp-status-filter');
        const searchInput = document.getElementById('erp-search-input');
        
        if (statusFilter) {
            statusFilter.addEventListener('change', () => {
                if (window.erpItems) populateERPTable(window.erpItems);
            });
        }
        
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                if (window.erpItems) populateERPTable(window.erpItems);
            });
        }
    }, 2000);
});

// ===== ERP EXPORT FUNCTIONALITY =====

// Toggle export dropdown
function toggleERPExportDropdown() {
    const dropdown = document.getElementById('erp-export-dropdown');
    if (dropdown) {
        dropdown.classList.toggle('hidden');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const exportBtn = document.getElementById('erp-export-btn');
    const dropdown = document.getElementById('erp-export-dropdown');
    
    if (exportBtn && dropdown && !exportBtn.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.add('hidden');
    }
});

// Export ERP data to Excel
function exportERPData(type) {
    console.log(' Exporting ERP data:', type);
    
    if (!window.erpItems || window.erpItems.length === 0) {
        alert('No data available to export. Please load the ERP dashboard first.');
        return;
    }
    
    // Close dropdown
    document.getElementById('erp-export-dropdown').classList.add('hidden');
    
    let dataToExport;
    let filename;
    
    switch(type) {
        case 'all':
            dataToExport = window.erpItems;
            filename = 'All_Approved_Items_ERP';
            break;
        case 'integrated':
            dataToExport = window.erpItems.filter(item => item.erp_integrated);
            filename = 'ERP_Integrated_Items';
            break;
        case 'pending':
            dataToExport = window.erpItems.filter(item => !item.erp_integrated);
            filename = 'Pending_ERP_Integration';
            break;
        default:
            alert('Invalid export type');
            return;
    }
    
    if (dataToExport.length === 0) {
        alert(`No items found for export type: ${type}`);
        return;
    }
    
    console.log(` Exporting ${dataToExport.length} items for type: ${type}`);
    
    try {
        // Prepare data for Excel - updated to match new table structure
        const excelData = dataToExport.map(item => ({
            'Item Code': item.item_code || 'N/A',
            'Item Group': item.classification_projects?.division_code || 'N/A',
            'Description 1': item.description1 || 'N/A',
            'Description 2': item.description2 || 'N/A',
            'Price': item.unit_price ? `${item.unit_price} ${item.currency_code || ''}` : 'Not specified',
            'Manufacturer': item.manufacturer || 'Not specified',
            'Model': item.model_number || 'N/A',
            'Country of Origin': item.country_of_origin || 'N/A',
            'Approved Date': item.approved_at ? new Date(item.approved_at).toLocaleDateString() : 'N/A',
            'ERP Status': item.erp_integrated ? 'INTEGRATED' : 'PENDING',
            'Action': 'N/A' // This column represents the toggle controls in the table
        }));
        
        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Auto-size columns
        const cols = [];
        const maxWidths = {};
        
        // Calculate max width for each column
        excelData.forEach(row => {
            Object.keys(row).forEach(key => {
                const value = String(row[key] || '');
                maxWidths[key] = Math.max(maxWidths[key] || 0, value.length, key.length);
            });
        });
        
        // Set column widths with better sizing for table view columns
        Object.keys(maxWidths).forEach(key => {
            let width = Math.max(maxWidths[key] + 2, 12); // Minimum width of 12
            
            // Custom widths for specific columns
            switch(key) {
                case 'Item Code':
                    width = Math.max(width, 15);
                    break;
                case 'Item Group':
                    width = Math.max(width, 12);
                    break;
                case 'Description 1':
                    width = Math.max(width, 30);
                    break;
                case 'Description 2':
                    width = Math.max(width, 30);
                    break;
                case 'Model':
                    width = Math.max(width, 18);
                    break;
                case 'Country of Origin':
                    width = Math.max(width, 18);
                    break;
                case 'Price':
                    width = Math.max(width, 15);
                    break;
                case 'Manufacturer':
                    width = Math.max(width, 20);
                    break;
                case 'Approved Date':
                    width = Math.max(width, 15);
                    break;
                case 'ERP Status':
                    width = Math.max(width, 12);
                    break;
                case 'Action':
                    width = 10;
                    break;
            }
            
            cols.push({ wch: Math.min(width, 40) }); // Max width of 40
        });
        ws['!cols'] = cols;
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'ERP Data');
        
        // Generate filename with timestamp
        const timestamp = new Date().toISOString().slice(0, 10);
        const fullFilename = `${filename}_${timestamp}.xlsx`;
        
        // Save file
        XLSX.writeFile(wb, fullFilename);
        
        console.log(`Export completed: ${fullFilename}`);
        
        // Show success notification
        showNotification(`Export completed: ${dataToExport.length} items exported to ${fullFilename}`, 'success');
        
    } catch (error) {
        console.error('Export error:', error);
        alert('Export failed: ' + error.message);
    }
}

// ===== END ERP EXPORT FUNCTIONALITY =====

// ===== END ERP INTEGRATION FUNCTIONALITY =====


// ===== USER HISTORY TAB - BRAND NEW IMPLEMENTATION =====

// Add loading state management
window.isLoadingUserHistory = false;

async function loadUserHistory() {
    if (window.isLoadingUserHistory) {
        console.log('loadUserHistory already in progress, skipping...');
        return;
    }
    
    window.isLoadingUserHistory = true;
    console.log('=== loadUserHistory START ===');
    console.log('Loading User History - Enhanced Card View');
    
    const content = document.getElementById('user-history-content');
    if (!content) {
        console.error('user-history-content not found');
        window.isLoadingUserHistory = false;
        return;
    }
    
    // Show loading state
    content.innerHTML = 
        '<div class="text-center py-8">' +
            '<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>' +
            '<p class="text-gray-600">Loading your request history...</p>' +
        '</div>';
    
    try {
        console.log('Fetching enhanced user requests for:', currentUser.id);
        
        // Enhanced query with pagination and reviewer info
        let requests = null;
        let totalRequests = 0;
        let totalPages = 0;
        let currentPage = Math.max(1, parseInt(window.currentRequestsPage) || 1);
        
        console.log('=== PAGINATION DEBUG START ===');
        console.log('Initial currentPage from window.currentRequestsPage:', window.currentRequestsPage);
        console.log('Parsed currentPage:', currentPage);
        
        try {
            const { count: totalCount, error: countError } = await supabase
                .from('item_code_workflow')
                .select('*', { count: 'exact', head: true })
                .eq('created_by', currentUser.id);
            
            if (countError) {
                console.error('Error getting total count:', countError);
            }
                
            totalRequests = totalCount || 0;
            const itemsPerPage = 10;
            totalPages = Math.ceil(totalRequests / itemsPerPage);
            
            console.log('COUNT QUERY RESULT - totalCount:', totalCount, 'error:', countError);
            
            // Ensure currentPage is within valid bounds
            if (currentPage > totalPages && totalPages > 0) {
                console.log(`Current page ${currentPage} exceeds total pages ${totalPages}, adjusting to page ${totalPages}`);
                currentPage = totalPages;
                window.currentRequestsPage = currentPage;
            }
            
            const offset = (currentPage - 1) * itemsPerPage;
            
            console.log('=== PAGINATION DETAILS ===');
            console.log(`Total requests: ${totalRequests}`);
            console.log(`Items per page: ${itemsPerPage}`);
            console.log(`Total pages: ${totalPages}`);
            console.log(`Current page: ${currentPage}`);
            console.log(`Offset: ${offset}`);
            console.log(`Range: ${offset} to ${offset + itemsPerPage - 1}`);
            console.log('=== PAGINATION DEBUG END ===');
            
            // Try enhanced query first
            let { data: requestsData, error: requestsError } = await supabase
                .from('item_code_workflow')
                .select(`
                    *, 
                    reviewer_user:users!item_code_workflow_reviewed_by_fkey(id, username, email),
                    project_info:classification_projects(project_name, division_code)
                `)
                .eq('created_by', currentUser.id)
                .order('created_at', { ascending: false })
                .range(offset, offset + itemsPerPage - 1);
            
            // If enhanced query fails, fall back to simple query
            if (requestsError) {
                console.log('Enhanced query failed, using simple query:', requestsError);
                const fallbackResult = await supabase
                    .from('item_code_workflow')
                    .select('*')
                    .eq('created_by', currentUser.id)
                    .order('created_at', { ascending: false })
                    .range(offset, offset + itemsPerPage - 1);
                
                if (fallbackResult.error) {
                    throw fallbackResult.error;
                }
                requests = fallbackResult.data;
            } else {
                requests = requestsData;
            }
            
            // Store pagination info for the UI
            window.requestsPagination = {
                totalRequests,
                totalPages,
                currentPage,
                itemsPerPage: 10
            };
            
            console.log('=== QUERY RESULTS DEBUG ===');
            console.log('Query successful. Results:');
            console.log('- Requested offset:', offset);
            console.log('- Requested range:', offset, 'to', offset + 10 - 1);
            console.log('- Actual results returned:', requests?.length || 0);
            console.log('- First result ID:', requests?.[0]?.id);
            console.log('- Last result ID:', requests?.[requests.length - 1]?.id);
            console.log('=== QUERY RESULTS DEBUG END ===');
            
        } catch (queryError) {
            console.error('=== DATABASE ERROR DETAILS ===');
            console.error('Full error object:', queryError);
            console.error('Error message:', queryError.message);
            console.error('Error code:', queryError.code);
            console.error('Error details:', queryError.details);
            console.error('Error hint:', queryError.hint);
            console.error('===========================');
            throw queryError;
        }
        
        console.log('Found requests:', requests?.length || 0);
        
        // DEBUG: Show first request structure if any exist
        if (requests && requests.length > 0) {
            console.log('First request structure:', requests[0]);
            console.log('Available columns:', Object.keys(requests[0]));
            
            // Show all unique status values to understand the data
            const statusValues = [...new Set(requests.map(r => r.status))];
            console.log('Unique status values in data:', statusValues);
            
            // Show sample of each status
            statusValues.forEach(status => {
                const sample = requests.find(r => r.status === status);
                console.log(`Sample ${status} request:`, sample);
            });
        }
        
        if (!requests || requests.length === 0) {
            content.innerHTML = 
                '<div class="text-center py-12">' +
                    '<div class="text-gray-400 text-6xl mb-4">√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨¬π</div>' +
                    '<h3 class="text-xl font-medium text-gray-900 mb-2">No Request History</h3>' +
                    '<p class="text-gray-500">You have not submitted any item code requests yet.</p>' +
                    '<p class="text-gray-400 text-sm mt-2">Start by generating your first item code!</p>' +
                '</div>';
            return;
        }
        
        // Generate pagination controls with safe page calculations
        const prevPage = Math.max(1, currentPage - 1);
        const nextPage = Math.min(totalPages || 1, currentPage + 1);
        
        // Debug: Add test buttons to verify pagination works
        console.log('=== GENERATING PAGINATION BUTTONS ===');
        console.log('prevPage will be:', prevPage);
        console.log('nextPage will be:', nextPage);
        console.log('currentPage is:', currentPage);
        console.log('totalPages is:', totalPages);
        
        let cardsHtml = `
            <div class="mb-6 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Your Request History</h3>
                    <p class="text-gray-600 text-sm">
                        Showing ${requests.length} of ${totalRequests} requests 
                        (Page ${currentPage} of ${totalPages})
                    </p>
                    <!-- DEBUG: Add test buttons -->
                    <div class="mt-2 text-xs text-gray-500">
                        <button onclick="console.log('TEST: Setting page to 1'); window.currentRequestsPage = 1; loadUserHistory();" 
                                class="mr-2 px-2 py-1 bg-gray-200 rounded text-xs">TEST: Go to Page 1</button>
                        <button onclick="console.log('TEST: Setting page to 2'); window.currentRequestsPage = 2; loadUserHistory();" 
                                class="mr-2 px-2 py-1 bg-gray-200 rounded text-xs">TEST: Go to Page 2</button>
                        <span class="text-gray-400">Current: window.currentRequestsPage = ${window.currentRequestsPage}</span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="loadRequestsPage(${prevPage})" 
                            style="cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'};"
                            class="px-3 py-1 text-sm border rounded transition-colors ${currentPage <= 1 ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                        Previous
                    </button>
                    <span class="px-2 py-1 text-sm text-gray-600">${currentPage} / ${totalPages}</span>
                    <button onclick="loadRequestsPage(${nextPage})"
                            style="cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'};"
                            class="px-3 py-1 text-sm border rounded transition-colors ${currentPage >= totalPages ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                        Next 
                    </button>
                </div>
            </div>
            <div class="grid gap-6 lg:grid-cols-1">`;
        
        requests.forEach((request, index) => {
            cardsHtml += generateRequestCard(request, index);
        });
        
        cardsHtml += `
            </div>
            
            <!-- Bottom Pagination -->
            <div class="mt-8 flex items-center justify-center space-x-2">
                <button onclick="loadRequestsPage(1)" 
                        style="cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'};"
                        class="px-3 py-2 text-sm border rounded transition-colors ${currentPage <= 1 ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                    First
                </button>
                <button onclick="loadRequestsPage(${prevPage})" 
                        style="cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'};"
                        class="px-3 py-2 text-sm border rounded transition-colors ${currentPage <= 1 ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                     Previous
                </button>
                
                ${generatePageNumbers(currentPage, totalPages)}
                
                <button onclick="loadRequestsPage(${nextPage})"
                        style="cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'};"
                        class="px-3 py-2 text-sm border rounded transition-colors ${currentPage >= totalPages ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                    Next
                </button>
                <button onclick="loadRequestsPage(${totalPages || 1})"
                        style="cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'};"
                        class="px-3 py-2 text-sm border rounded transition-colors ${currentPage >= totalPages ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                    Last
                </button>
            </div>`;
        
        content.innerHTML = cardsHtml;
        
        console.log('Enhanced User History cards rendered successfully');
        console.log('=== loadUserHistory END ===');
        
    } catch (error) {
        console.error('Error loading enhanced user history:', error);
        content.innerHTML = 
            '<div class="text-center py-8 text-red-500">' +
                '<h3 class="text-lg font-semibold mb-2">Error Loading History</h3>' +
                '<p class="text-sm">' + error.message + '</p>' +
                '<button onclick="loadUserHistory()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">' +
                    'Try Again' +
                '</button>' +
            '</div>';
    } finally {
        window.isLoadingUserHistory = false;
    }
}

// ===== STANDARD VALUE REQUESTS HISTORY =====
async function loadStandardValueRequests() {
    console.log('Loading Standard Value Requests History');
    
    const content = document.getElementById('standard-values-content');
    if (!content) {
        console.error('standard-values-content not found');
        return;
    }
    
    // Show loading state
    content.innerHTML = 
        '<div class="text-center py-8">' +
            '<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>' +
            '<p class="text-gray-600">Loading your standard value requests...</p>' +
        '</div>';
    
    try {
        console.log('Fetching standard value requests for user:', currentUser.id);
        
        // Pagination setup
        let currentPage = window.currentStandardValuesPage || 1;
        const itemsPerPage = 10;
        
        // Get total count
        const { count: totalCount, error: countError } = await supabase
            .from('standard_value_requests')
            .select('*', { count: 'exact', head: true })
            .eq('created_by', currentUser.id);
        
        if (countError) {
            console.error('Error getting standard values count:', countError);
        }
            
        const totalRequests = totalCount || 0;
        const totalPages = Math.ceil(totalRequests / itemsPerPage);
        const offset = (currentPage - 1) * itemsPerPage;
        
        // Fetch requests with related data
        let { data: requests, error } = await supabase
            .from('standard_value_requests')
            .select(`
                *,
                project:classification_projects(project_name),
                reviewer_user:users!standard_value_requests_reviewed_by_fkey(username, email),
                admin_user:users!standard_value_requests_admin_reviewed_by_fkey(username, email),
                created_by_user:users!standard_value_requests_created_by_fkey(username, email)
            `)
            .eq('created_by', currentUser.id)
            .order('created_at', { ascending: false })
            .range(offset, offset + itemsPerPage - 1);
        
        if (error) {
            console.error('Error fetching standard value requests:', error);
            throw error;
        }
        
        console.log('Found standard value requests:', requests?.length || 0);
        
        if (!requests || requests.length === 0) {
            content.innerHTML = 
                '<div class="text-center py-12">' +
                    '<div class="text-gray-400 text-6xl mb-4">√É¬∞√Ö¬∏√¢‚Ç¨≈ì√¢‚Ç¨¬π</div>' +
                    '<h3 class="text-xl font-medium text-gray-900 mb-2">No Standard Value Requests</h3>' +
                    '<p class="text-gray-500">You have not submitted any standard value requests yet.</p>' +
                    '<p class="text-gray-400 text-sm mt-2">Standard value requests allow you to add new values to dropdown lists!</p>' +
                '</div>';
            return;
        }
        
        // Generate content with safe page calculations
        const prevPage = Math.max(1, currentPage - 1);
        const nextPage = Math.min(totalPages || 1, currentPage + 1);
        
        let cardsHtml = `
            <div class="mb-6 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Your Standard Value Requests</h3>
                    <p class="text-gray-600 text-sm">
                        Showing ${requests.length} of ${totalRequests} requests 
                        (Page ${currentPage} of ${totalPages})
                    </p>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="loadStandardValuesPage(${prevPage})" 
                            style="cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'};"
                            class="px-3 py-1 text-sm border rounded transition-colors ${currentPage <= 1 ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                        Previous
                    </button>
                    <span class="px-2 py-1 text-sm text-gray-600">${currentPage} / ${totalPages}</span>
                    <button onclick="loadStandardValuesPage(${nextPage})"
                            style="cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'};"
                            class="px-3 py-1 text-sm border rounded transition-colors ${currentPage >= totalPages ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                        Next 
                    </button>
                </div>
            </div>
            <div class="grid gap-6 lg:grid-cols-1">`;
        
        requests.forEach((request, index) => {
            cardsHtml += generateStandardValueRequestCard(request, index);
        });
        
        cardsHtml += `</div>`;
        
        content.innerHTML = cardsHtml;
        console.log('Standard Value Requests cards rendered successfully');
        
    } catch (error) {
        console.error('Error loading standard value requests:', error);
        content.innerHTML = 
            '<div class="text-center py-8 text-red-500">' +
                '<h3 class="text-lg font-semibold mb-2">Error Loading Standard Value Requests</h3>' +
                '<p class="text-sm">' + error.message + '</p>' +
                '<button onclick="loadStandardValueRequests()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">' +
                    'Try Again' +
                '</button>' +
            '</div>';
    }
}

// ===== COMBINATION REQUESTS HISTORY =====
async function loadCombinationRequests() {
    console.log('Loading Combination Requests History');
    
    const content = document.getElementById('combination-requests-content');
    if (!content) {
        console.error('combination-requests-content not found');
        return;
    }
    
    // Show loading state
    content.innerHTML = 
        '<div class="text-center py-8">' +
            '<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>' +
            '<p class="text-gray-600">Loading your combination requests...</p>' +
        '</div>';
    
    try {
        console.log('Fetching combination requests for user:', currentUser.id);
        
        // Pagination setup
        let currentPage = window.currentCombinationRequestsPage || 1;
        const itemsPerPage = 10;
        
        // Get total count
        const { count: totalCount, error: countError } = await supabase
            .from('combination_requests')
            .select('*', { count: 'exact', head: true })
            .eq('created_by', currentUser.id);
        
        if (countError) {
            console.error('Error getting combination requests count:', countError);
        }
            
        const totalRequests = totalCount || 0;
        const totalPages = Math.ceil(totalRequests / itemsPerPage);
        const offset = (currentPage - 1) * itemsPerPage;
        
        // Fetch requests with related data
        let { data: requests, error } = await supabase
            .from('combination_requests')
            .select(`
                *,
                project:classification_projects(project_name),
                reviewer_user:users!combination_requests_reviewed_by_fkey(username, email),
                admin_user:users!combination_requests_admin_reviewed_by_fkey(username, email),
                created_by_user:users!combination_requests_created_by_fkey(username, email)
            `)
            .eq('created_by', currentUser.id)
            .order('created_at', { ascending: false })
            .range(offset, offset + itemsPerPage - 1);
        
        if (error) {
            console.error('Error fetching combination requests:', error);
            throw error;
        }
        
        console.log('Found combination requests:', requests?.length || 0);
        
        if (!requests || requests.length === 0) {
            content.innerHTML = 
                '<div class="text-center py-12">' +
                    '<div class="text-gray-400 text-6xl mb-4">√É¬∞√Ö¬∏√¢‚Ç¨¬ù√¢‚Ç¨‚Äù</div>' +
                    '<h3 class="text-xl font-medium text-gray-900 mb-2">No Combination Requests</h3>' +
                    '<p class="text-gray-500">You have not submitted any combination requests yet.</p>' +
                    '<p class="text-gray-400 text-sm mt-2">Combination requests allow you to generate or block specific attribute combinations!</p>' +
                '</div>';
            return;
        }
        
        // Generate content with safe page calculations
        const prevPage = Math.max(1, currentPage - 1);
        const nextPage = Math.min(totalPages || 1, currentPage + 1);
        
        let cardsHtml = `
            <div class="mb-6 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Your Combination Requests</h3>
                    <p class="text-gray-600 text-sm">
                        Showing ${requests.length} of ${totalRequests} requests 
                        (Page ${currentPage} of ${totalPages})
                    </p>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="loadCombinationRequestsPage(${prevPage})" 
                            style="cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'};"
                            class="px-3 py-1 text-sm border rounded transition-colors ${currentPage <= 1 ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                        Previous
                    </button>
                    <span class="px-2 py-1 text-sm text-gray-600">${currentPage} / ${totalPages}</span>
                    <button onclick="loadCombinationRequestsPage(${nextPage})"
                            style="cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'};"
                            class="px-3 py-1 text-sm border rounded transition-colors ${currentPage >= totalPages ? 'bg-gray-100 text-gray-400 border-gray-300 opacity-50' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                        Next 
                    </button>
                </div>
            </div>
            <div class="grid gap-6 lg:grid-cols-1">`;
        
        requests.forEach((request, index) => {
            cardsHtml += generateCombinationRequestCard(request, index);
        });
        
        cardsHtml += `</div>`;
        
        content.innerHTML = cardsHtml;
        console.log('Combination Requests cards rendered successfully');
        
    } catch (error) {
        console.error('Error loading combination requests:', error);
        content.innerHTML = 
            '<div class="text-center py-8 text-red-500">' +
                '<h3 class="text-lg font-semibold mb-2">Error Loading Combination Requests</h3>' +
                '<p class="text-sm">' + error.message + '</p>' +
                '<button onclick="loadCombinationRequests()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">' +
                    'Try Again' +
                '</button>' +
            '</div>';
    }
}

// ===== PAGINATION FUNCTIONS FOR SUB-TABS =====
function loadStandardValuesPage(pageNumber) {
    console.log('loadStandardValuesPage called with pageNumber:', pageNumber);
    
    // Ensure we have a valid positive integer
    const validPageNumber = parseInt(pageNumber);
    if (!validPageNumber || validPageNumber < 1) {
        console.error('Invalid page number for standard values:', pageNumber, 'converted to:', validPageNumber);
        console.log('Defaulting to page 1');
        window.currentStandardValuesPage = 1;
        loadStandardValueRequests();
        return;
    }
    
    window.currentStandardValuesPage = validPageNumber;
    console.log('Set window.currentStandardValuesPage to:', window.currentStandardValuesPage);
    loadStandardValueRequests();
}

function loadCombinationRequestsPage(pageNumber) {
    console.log('loadCombinationRequestsPage called with pageNumber:', pageNumber);
    
    // Ensure we have a valid positive integer
    const validPageNumber = parseInt(pageNumber);
    if (!validPageNumber || validPageNumber < 1) {
        console.error('Invalid page number for combination requests:', pageNumber, 'converted to:', validPageNumber);
        console.log('Defaulting to page 1');
        window.currentCombinationRequestsPage = 1;
        loadCombinationRequests();
        return;
    }
    
    window.currentCombinationRequestsPage = validPageNumber;
    console.log('Set window.currentCombinationRequestsPage to:', window.currentCombinationRequestsPage);
    loadCombinationRequests();
}



function generateRequestCard(request, index) {
    const statusInfo = getRequestStatusInfo(request.status);
    const createdDate = new Date(request.created_at).toLocaleDateString();
    const updatedDate = request.updated_at ? new Date(request.updated_at).toLocaleDateString() : null;
    
    // Debug logging for ERP status
    if (request.status === 'admin_approved') {
        console.log(`√É∆í√Ü‚Äô√É‚Äö√Ç¬∞√É∆í√¢‚Ç¨¬¶√É‚Äö√Ç¬∏√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬ù√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬ç Debug - Request #${request.id}:`, {
            item_code: request.item_code,
            status: request.status,
            erp_integrated: request.erp_integrated,
            erp_integrated_at: request.erp_integrated_at,
            erp_integrated_by: request.erp_integrated_by
        });
    }
    
    return `
        <div class="bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <span class="text-blue-600 font-semibold text-sm">#${request.id}</span>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">
                                ${request.item_code || 'Code Pending'}
                            </h4>
                            <p class="text-sm text-gray-500">
                                Project ID: ${request.project_id || 'Unknown'}
                            </p>
                        </div>
                    </div>
                    <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusInfo.bgColor} ${statusInfo.textColor}">
                        ${statusInfo.label}
                    </span>
                </div>
            </div>
            
            <!-- 3-Milestone Approval Process: Submit  Reviewer  Admin -->
            <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100">
                <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
                    <span class="font-medium">Approval Process</span>
                    <span class="text-xs bg-white px-2 py-1 rounded-full">${getApprovalStage(request.status, request.erp_integrated)}</span>
                </div>
                
                <!-- 4-Stage Progress Line: Submit √É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬†√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É¬¢√¢‚Ç¨≈æ√Ç¬¢ Reviewer √É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬†√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É¬¢√¢‚Ç¨≈æ√Ç¬¢ Admin √É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬†√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É¬¢√¢‚Ç¨≈æ√Ç¬¢ ERP Integration -->
                <div class="relative">
                    <div class="flex items-center justify-between">
                        <!-- Stage 1: Submitted -->
                        <div class="flex flex-col items-center relative z-10">
                            <div class="w-5 h-5 rounded-full ${getMilestoneStyle('submit', request.status, request.erp_integrated).dot} flex items-center justify-center shadow-sm">
                                ${getMilestoneStyle('submit', request.status, request.erp_integrated).icon}
                            </div>
                            <span class="text-xs mt-2 ${getMilestoneStyle('submit', request.status, request.erp_integrated).text} font-medium">Submit</span>
                        </div>
                        
                        <!-- Stage 2: Reviewer -->
                        <div class="flex flex-col items-center relative z-10">
                            <div class="w-5 h-5 rounded-full ${getMilestoneStyle('reviewer', request.status, request.erp_integrated).dot} flex items-center justify-center shadow-sm">
                                ${getMilestoneStyle('reviewer', request.status, request.erp_integrated).icon}
                            </div>
                            <span class="text-xs mt-2 ${getMilestoneStyle('reviewer', request.status, request.erp_integrated).text} font-medium">Reviewer</span>
                            ${request.reviewer_user ? `<span class="text-xs text-gray-500 mt-1">${request.reviewer_user.username}</span>` : ''}
                        </div>
                        
                        <!-- Stage 3: Admin -->
                        <div class="flex flex-col items-center relative z-10">
                            <div class="w-5 h-5 rounded-full ${getMilestoneStyle('admin', request.status, request.erp_integrated).dot} flex items-center justify-center shadow-sm">
                                ${getMilestoneStyle('admin', request.status, request.erp_integrated).icon}
                            </div>
                            <span class="text-xs mt-2 ${getMilestoneStyle('admin', request.status, request.erp_integrated).text} font-medium">Admin</span>
                        </div>
                        
                        <!-- Stage 4: ERP Integration -->
                        <div class="flex flex-col items-center relative z-10">
                            <div class="w-5 h-5 rounded-full ${getMilestoneStyle('erp', request.status, request.erp_integrated).dot} flex items-center justify-center shadow-sm">
                                ${getMilestoneStyle('erp', request.status, request.erp_integrated).icon}
                            </div>
                            <span class="text-xs mt-2 ${getMilestoneStyle('erp', request.status, request.erp_integrated).text} font-medium">ERP</span>
                            ${request.erp_integrated_at ? `<span class="text-xs text-gray-500 mt-1">${new Date(request.erp_integrated_at).toLocaleDateString()}</span>` : ''}
                        </div>
                    </div>
                    
                    <!-- Connecting Lines Between Milestones -->
                    <div class="absolute top-2.5 left-0 right-0 h-1 bg-gray-300 -z-0 rounded-full">
                        <div class="h-full bg-gradient-to-r ${getApprovalLineColor(request.status)} rounded-full transition-all duration-700" 
                             style="width: ${getApprovalProgress(request.status, request.erp_integrated)}%"></div>
                    </div>
                </div>
                
                <!-- Milestone Status Message -->
                <div class="mt-4 text-center">
                    <span class="text-xs px-4 py-2 rounded-full ${getApprovalStatusBadge(request.status, request.erp_integrated).bg} ${getApprovalStatusBadge(request.status, request.erp_integrated).text}">
                        ${getApprovalStatusBadge(request.status, request.erp_integrated).label}
                    </span>
                </div>
            </div>
            
            <!-- Content -->
            <div class="px-6 py-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">Description:</span>
                        <p class="text-gray-900 mt-1">${request.description1 || 'Not specified'}</p>
                        ${request.description2 ? `<p class="text-gray-600 text-xs mt-1">${request.description2}</p>` : ''}
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Details:</span>
                        <div class="mt-1 space-y-1">
                            ${request.unit_price ? `<p class="text-gray-900">Price: ${request.unit_price} ${request.currency_code || ''}</p>` : ''}
                            ${request.manufacturer ? `<p class="text-gray-600">Mfg: ${request.manufacturer}</p>` : ''}
                            ${request.model ? `<p class="text-gray-600">Model: ${request.model}</p>` : ''}
                            ${request.uom ? `<p class="text-gray-600">UoM: ${request.uom}</p>` : ''}
                        </div>
                    </div>
                </div>
                
                ${request.country_of_origin ? `
                <div class="mt-3 pt-3 border-t border-gray-100">
                    <span class="text-xs font-medium text-gray-700">Country of Origin: </span>
                    <span class="text-xs text-gray-900">${request.country_of_origin}</span>
                </div>
                ` : ''}
            </div>
            
            <!-- Footer -->
            <div class="px-6 py-3 bg-gray-50 border-t border-gray-100">
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <div class="flex items-center space-x-4">
                        <span>Created: ${createdDate}</span>
                        ${updatedDate ? `<span>Updated: ${updatedDate}</span>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        ${request.reviewed_by ? `
                        <span class="flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Reviewed by User ID: ${request.reviewed_by}
                        </span>
                        ` : ''}
                        <button onclick="showRequestDetails(${request.id})" 
                                class="text-blue-600 hover:text-blue-800 font-medium">
                            View Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getRequestStatusInfo(status) {
    // Updated status mapping for actual database values
    const statusMap = {
        'admin_approved': {
            label: 'Approved',
            bgColor: 'bg-green-100', 
            textColor: 'text-green-800',
            progressColor: 'from-green-400 to-green-500'
        },
        'reviewer_rejected': {
            label: 'Rejected',
            bgColor: 'bg-red-100',
            textColor: 'text-red-800', 
            progressColor: 'from-red-400 to-red-500'
        },
        'pending': {
            label: 'Under Review',
            bgColor: 'bg-yellow-100',
            textColor: 'text-yellow-800',
            progressColor: 'from-yellow-400 to-yellow-500'
        },
        'submitted': {
            label: 'Submitted',
            bgColor: 'bg-blue-100',
            textColor: 'text-blue-800',
            progressColor: 'from-blue-400 to-blue-500'
        },
        'under_review': {
            label: 'Under Review',
            bgColor: 'bg-yellow-100',
            textColor: 'text-yellow-800',
            progressColor: 'from-yellow-400 to-yellow-500'
        }
    };
    
    return statusMap[status] || {
        label: status ? status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ') : 'Unknown',
        bgColor: 'bg-gray-100',
        textColor: 'text-gray-800',
        progressColor: 'from-gray-400 to-gray-500'
    };
}

// ===== 3-MILESTONE APPROVAL PROCESS FUNCTIONS =====

function getApprovalStage(status, erpIntegrated = false) {
    const stageMap = {
        'submitted': 'Stage 1 of 4',
        'pending': 'Stage 2 of 4', 
        'under_review': 'Stage 2 of 4',
        'reviewer_approved': 'Stage 3 of 4',
        'reviewer_rejected': 'Rejected at Stage 2',
        'admin_approved': erpIntegrated ? 'Completed (Stage 4)' : 'Stage 4 of 4',
        'admin_rejected': 'Rejected at Stage 3'
    };
    
    return stageMap[status] || 'In Process';
}

function getMilestoneStyle(milestone, currentStatus, erpIntegrated = false) {
    // Enhanced status checking with proper rejection handling
    const statusChecks = {
        isSubmitted: ['submitted', 'pending', 'under_review', 'reviewer_approved', 'reviewer_rejected', 'admin_approved', 'admin_rejected'].includes(currentStatus),
        isAtReviewer: ['pending', 'under_review'].includes(currentStatus),
        reviewerApproved: ['reviewer_approved', 'admin_approved', 'admin_rejected'].includes(currentStatus),
        reviewerRejected: currentStatus === 'reviewer_rejected',
        isAtAdmin: ['reviewer_approved'].includes(currentStatus),
        adminApproved: currentStatus === 'admin_approved',
        adminRejected: currentStatus === 'admin_rejected',
        erpIntegrated: erpIntegrated === true
    };
    
    const styles = {
        submit: {
            dot: statusChecks.isSubmitted ? 'bg-green-500 border-2 border-green-200' : 'bg-gray-300 border-2 border-gray-200',
            text: statusChecks.isSubmitted ? 'text-green-600' : 'text-gray-400',
            icon: statusChecks.isSubmitted ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg>' : '<div class="w-2 h-2 bg-gray-400 rounded-full"></div>'
        },
        reviewer: {
            dot: statusChecks.reviewerRejected ? 'bg-red-500 border-2 border-red-200' :
                 statusChecks.reviewerApproved ? 'bg-green-500 border-2 border-green-200' :
                 statusChecks.isAtReviewer ? 'bg-blue-500 border-2 border-blue-200 animate-pulse' :
                 'bg-gray-300 border-2 border-gray-200',
            text: statusChecks.reviewerRejected ? 'text-red-600' :
                  statusChecks.reviewerApproved ? 'text-green-600' :
                  statusChecks.isAtReviewer ? 'text-blue-600' :
                  'text-gray-400',
            icon: statusChecks.reviewerRejected ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"></path></svg>' :
                  statusChecks.reviewerApproved ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg>' :
                  statusChecks.isAtReviewer ? '<div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>' :
                  '<div class="w-2 h-2 bg-gray-400 rounded-full"></div>'
        },
        admin: {
            dot: statusChecks.adminRejected ? 'bg-red-500 border-2 border-red-200' :
                 statusChecks.adminApproved ? 'bg-green-500 border-2 border-green-200' :
                 statusChecks.isAtAdmin ? 'bg-blue-500 border-2 border-blue-200 animate-pulse' :
                 'bg-gray-300 border-2 border-gray-200',
            text: statusChecks.adminRejected ? 'text-red-600' :
                  statusChecks.adminApproved ? 'text-green-600' :
                  statusChecks.isAtAdmin ? 'text-blue-600' :
                  'text-gray-400',
            icon: statusChecks.adminRejected ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"></path></svg>' :
                  statusChecks.adminApproved ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg>' :
                  statusChecks.isAtAdmin ? '<div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>' :
                  '<div class="w-2 h-2 bg-gray-400 rounded-full"></div>'
        },
        erp: {
            dot: statusChecks.erpIntegrated ? 'bg-green-500 border-2 border-green-200' : 
                 (statusChecks.adminApproved && !statusChecks.erpIntegrated ? 'bg-blue-500 border-2 border-blue-200 animate-pulse' : 'bg-gray-300 border-2 border-gray-200'),
            text: statusChecks.erpIntegrated ? 'text-green-600' : 
                  (statusChecks.adminApproved && !statusChecks.erpIntegrated ? 'text-blue-600' : 'text-gray-400'),
            icon: statusChecks.erpIntegrated ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg>' :
                  (statusChecks.adminApproved && !statusChecks.erpIntegrated ? '<div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>' : '<div class="w-2 h-2 bg-gray-400 rounded-full"></div>')
        }
    };
    
    return styles[milestone];
}

function getApprovalProgress(status, erpIntegrated = false) {
    // Precise progress calculation based on 4 milestones: Submit(0%) -> Reviewer(33%) -> Admin(66%) -> ERP(100%)
    const progressMap = {
        'submitted': 15,              // Just submitted (15% - halfway to reviewer)
        'pending': 33,                // At reviewer stage (33% - at reviewer milestone)
        'under_review': 33,           // Being reviewed (33% - at reviewer milestone)
        'reviewer_approved': 50,      // Reviewer approved, halfway to admin (50%)
        'reviewer_rejected': 33,      // Rejected at reviewer (33% - stops at reviewer milestone)
        'admin_approved': erpIntegrated ? 100 : 66,  // Admin approved (66%), ERP integrated (100%)
        'admin_rejected': 66          // Rejected at admin (66% - stops at admin milestone)
    };
    
    return progressMap[status] || 0;
}

function getApprovalLineColor(status) {
    // Enhanced color mapping for rejection states
    const colorMap = {
        'submitted': 'from-blue-300 to-blue-400',
        'pending': 'from-blue-400 to-blue-500',
        'under_review': 'from-blue-400 to-blue-500',
        'reviewer_approved': 'from-green-400 to-green-500',
        'reviewer_rejected': 'from-red-400 to-red-500',
        'admin_approved': 'from-green-400 to-green-500',
        'admin_rejected': 'from-red-400 to-red-500'
    };
    
    return colorMap[status] || 'from-gray-300 to-gray-400';
}


function getApprovalStatusBadge(status, erpIntegrated = false) {
    const badgeMap = {
        'submitted': { 
            label: "√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ù Submitted - Awaiting Reviewer",
            bg: 'bg-blue-50', 
            text: 'text-blue-700' 
        },
        'pending': { 
            label: "√É¬∞√Ö¬∏√¢‚Ç¨Àú√¢‚Äö¬¨ Under Review by Reviewer",
            bg: 'bg-yellow-50', 
            text: 'text-yellow-700' 
        },
        'under_review': { 
            label: "√É¬¢√Ç¬è√Ç¬≥ Being Reviewed",
            bg: 'bg-orange-50', 
            text: 'text-orange-700' 
        },
        'reviewer_rejected': { 
            label: '√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬ù√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢ Rejected by Reviewer', 
            bg: 'bg-red-50', 
            text: 'text-red-700' 
        },
        'admin_approved': { 
            label: erpIntegrated ? '√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬¶ Fully Complete - ERP Integrated' : '√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬è√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬≥ Approved - Awaiting ERP Integration', 
            bg: erpIntegrated ? 'bg-green-50' : 'bg-blue-50', 
            text: erpIntegrated ? 'text-green-700' : 'text-blue-700' 
        },
        'reviewer_approved': { 
            label: 'Reviewer Approved - Awaiting Admin', 
            bg: 'bg-green-50', 
            text: 'text-green-700' 
        },
        'admin_rejected': { 
            label: 'Rejected by Admin', 
            bg: 'bg-red-50', 
            text: 'text-red-700' 
        }
    };
    
    return badgeMap[status] || { 
        label: `√É∆í√Ü‚Äô√É‚Äö√Ç¬∞√É∆í√¢‚Ç¨¬¶√É‚Äö√Ç¬∏√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√¢‚Ç¨≈ì√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬π Status: ${status ? status.replace('_', ' ') : 'Unknown'}`, 
        bg: 'bg-gray-50', 
        text: 'text-gray-700' 
    };
}
// ===== PAGINATION FUNCTIONS =====

function generatePageNumbers(currentPage, totalPages) {
    let pageNumbers = '';
    const maxVisible = 5;
    
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        pageNumbers += `
            <button onclick="loadRequestsPage(${i})" 
                    style="cursor: pointer;"
                    class="px-3 py-2 text-sm border rounded transition-colors ${isActive ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-blue-600 hover:bg-blue-50 border-blue-300 hover:border-blue-400'}">
                ${i}
            </button>`;
    }
    
    return pageNumbers;
}

function loadRequestsPage(pageNumber) {
    console.log('=== loadRequestsPage CALLED ===');
    console.log('Input pageNumber:', pageNumber, 'Type:', typeof pageNumber);
    console.log('Current window.currentRequestsPage before:', window.currentRequestsPage);
    
    // Ensure we have a valid positive integer
    const validPageNumber = parseInt(pageNumber);
    console.log('Parsed validPageNumber:', validPageNumber);
    
    if (!validPageNumber || validPageNumber < 1) {
        console.error('Invalid page number:', pageNumber, 'converted to:', validPageNumber);
        console.log('Defaulting to page 1');
        window.currentRequestsPage = 1;
    } else {
        window.currentRequestsPage = validPageNumber;
    }
    
    console.log('Final window.currentRequestsPage:', window.currentRequestsPage);
    console.log('About to call loadUserHistory()');
    console.log('=== loadRequestsPage END ===');
    
    loadUserHistory();
}

// ===== END PAGINATION FUNCTIONS =====

function showRequestDetails(requestId) {
    // TODO: Implement detailed view modal
    alert('Request details view - ID: ' + requestId + '\\n(This will open a detailed modal in the next enhancement)');
}

// ===== CARD GENERATION FUNCTIONS FOR SUB-TABS =====

function generateStandardValueRequestCard(request, index) {
    const statusInfo = getRequestStatusInfo(request.status);
    const createdDate = new Date(request.created_at).toLocaleDateString();
    const updatedDate = request.updated_at ? new Date(request.updated_at).toLocaleDateString() : null;
    
    return `
        <div class="bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <span class="text-purple-600 font-semibold text-sm">#${request.id}</span>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">
                                ${request.attribute_name}
                            </h4>
                            <p class="text-sm text-gray-500">
                                New Value: "${request.new_value}"
                            </p>
                            <p class="text-xs text-gray-400">
                                Project: ${request.project?.project_name || 'Unknown'}
                            </p>
                        </div>
                    </div>
                    <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusInfo.bgColor} ${statusInfo.textColor}">
                        ${statusInfo.label}
                    </span>
                </div>
            </div>
            
            <!-- Approval Process -->
            <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100">
                <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
                    <span class="font-medium">Approval Process</span>
                    <span class="text-xs text-gray-500">${getApprovalStage(request.status)}</span>
                </div>
                
                <!-- Enhanced Progress Timeline -->
                <div class="relative mb-4">
                    <!-- Background Progress Line -->
                    <div class="absolute top-6 left-6 right-6 h-0.5 bg-gray-200"></div>
                    
                    <!-- Active Progress Line -->
                    <div class="absolute top-6 left-6 h-0.5 bg-gradient-to-r ${getApprovalLineColor(request.status)}" 
                         style="width: calc(${getApprovalProgress(request.status)}% * (100% - 3rem) / 100);"></div>
                    
                    <!-- Milestone Container -->
                    <div class="relative flex items-center justify-between">
                        <!-- Submit Milestone -->
                        <div class="flex flex-col items-center z-10">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center ${getMilestoneStyle('submit', request.status).dot} bg-white">
                                ${getMilestoneStyle('submit', request.status).icon}
                            </div>
                            <span class="text-xs mt-1 ${getMilestoneStyle('submit', request.status).text}">Submit</span>
                        </div>
                        
                        <!-- Reviewer Milestone -->
                        <div class="flex flex-col items-center z-10">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center ${getMilestoneStyle('reviewer', request.status).dot} bg-white">
                                ${getMilestoneStyle('reviewer', request.status).icon}
                            </div>
                            <span class="text-xs mt-1 ${getMilestoneStyle('reviewer', request.status).text}">Reviewer</span>
                        </div>
                        
                        <!-- Admin Milestone -->
                        <div class="flex flex-col items-center z-10">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center ${getMilestoneStyle('admin', request.status).dot} bg-white">
                                ${getMilestoneStyle('admin', request.status).icon}
                            </div>
                            <span class="text-xs mt-1 ${getMilestoneStyle('admin', request.status).text}">Admin</span>
                        </div>
                    </div>
                </div>
                
                <!-- Status Badge -->
                <div class="mt-3">
                    <div class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${getApprovalStatusBadge(request.status).bg} ${getApprovalStatusBadge(request.status).text}">
                        ${getApprovalStatusBadge(request.status).label}
                    </div>
                </div>
            </div>
            
            <!-- Details -->
            <div class="px-6 py-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-600">Reason:</span>
                        <div class="text-gray-900 mt-1">${request.reason || 'No reason provided'}</div>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Submitted:</span>
                        <div class="text-gray-900">${createdDate}</div>
                    </div>
                </div>
                
                ${request.reviewer_comments ? `
                    <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                        <div class="font-medium text-yellow-800 text-sm">Reviewer Comments:</div>
                        <div class="text-yellow-700 text-sm mt-1">${request.reviewer_comments}</div>
                    </div>
                ` : ''}
                
                ${request.admin_comments ? `
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="font-medium text-blue-800 text-sm">Admin Comments:</div>
                        <div class="text-blue-700 text-sm mt-1">${request.admin_comments}</div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function generateCombinationRequestCard(request, index) {
    const statusInfo = getRequestStatusInfo(request.status);
    const createdDate = new Date(request.created_at).toLocaleDateString();
    const updatedDate = request.updated_at ? new Date(request.updated_at).toLocaleDateString() : null;
    
    return `
        <div class="bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                <span class="text-orange-600 font-semibold text-sm">#${request.id}</span>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">
                                ${request.request_type === 'block' ? 'Block Combination' : 'Generate Combination'}
                            </h4>
                            <p class="text-sm text-gray-500">
                                Signature: ${request.combination_signature.substring(0, 40)}${request.combination_signature.length > 40 ? '...' : ''}
                            </p>
                            <p class="text-xs text-gray-400">
                                Project: ${request.project?.project_name || 'Unknown'}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusInfo.bgColor} ${statusInfo.textColor}">
                            ${statusInfo.label}
                        </span>
                        <div class="mt-1">
                            <span class="px-2 py-1 text-xs font-semibold rounded ${request.request_type === 'block' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${request.request_type.toUpperCase()}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Approval Process -->
            <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100">
                <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
                    <span class="font-medium">Approval Process</span>
                    <span class="text-xs text-gray-500">${getApprovalStage(request.status)}</span>
                </div>
                
                <!-- Enhanced Progress Timeline -->
                <div class="relative mb-4">
                    <!-- Background Progress Line -->
                    <div class="absolute top-6 left-6 right-6 h-0.5 bg-gray-200"></div>
                    
                    <!-- Active Progress Line -->
                    <div class="absolute top-6 left-6 h-0.5 bg-gradient-to-r ${getApprovalLineColor(request.status)}" 
                         style="width: calc(${getApprovalProgress(request.status)}% * (100% - 3rem) / 100);"></div>
                    
                    <!-- Milestone Container -->
                    <div class="relative flex items-center justify-between">
                        <!-- Submit Milestone -->
                        <div class="flex flex-col items-center z-10">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center ${getMilestoneStyle('submit', request.status).dot} bg-white">
                                ${getMilestoneStyle('submit', request.status).icon}
                            </div>
                            <span class="text-xs mt-1 ${getMilestoneStyle('submit', request.status).text}">Submit</span>
                        </div>
                        
                        <!-- Reviewer Milestone -->
                        <div class="flex flex-col items-center z-10">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center ${getMilestoneStyle('reviewer', request.status).dot} bg-white">
                                ${getMilestoneStyle('reviewer', request.status).icon}
                            </div>
                            <span class="text-xs mt-1 ${getMilestoneStyle('reviewer', request.status).text}">Reviewer</span>
                        </div>
                        
                        <!-- Admin Milestone -->
                        <div class="flex flex-col items-center z-10">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center ${getMilestoneStyle('admin', request.status).dot} bg-white">
                                ${getMilestoneStyle('admin', request.status).icon}
                            </div>
                            <span class="text-xs mt-1 ${getMilestoneStyle('admin', request.status).text}">Admin</span>
                        </div>
                    </div>
                </div>
                
                <!-- Status Badge -->
                <div class="mt-3">
                    <div class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${getApprovalStatusBadge(request.status).bg} ${getApprovalStatusBadge(request.status).text}">
                        ${getApprovalStatusBadge(request.status).label}
                    </div>
                </div>
            </div>
            
            <!-- Details -->
            <div class="px-6 py-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-600">UoM:</span>
                        <div class="text-gray-900">${request.uom || 'Not specified'}</div>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Country:</span>
                        <div class="text-gray-900">${request.country_of_origin || 'Not specified'}</div>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Model:</span>
                        <div class="text-gray-900">${request.model_number || 'Not specified'}</div>
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Submitted:</span>
                        <div class="text-gray-900">${createdDate}</div>
                    </div>
                </div>
                
                ${request.reason ? `
                    <div class="mt-4">
                        <span class="font-medium text-gray-600">Reason:</span>
                        <div class="text-gray-900 mt-1">${request.reason}</div>
                    </div>
                ` : ''}
                
                ${request.reviewer_comments ? `
                    <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                        <div class="font-medium text-yellow-800 text-sm">Reviewer Comments:</div>
                        <div class="text-yellow-700 text-sm mt-1">${request.reviewer_comments}</div>
                    </div>
                ` : ''}
                
                ${request.admin_comments ? `
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="font-medium text-blue-800 text-sm">Admin Comments:</div>
                        <div class="text-blue-700 text-sm mt-1">${request.admin_comments}</div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// ===== END USER HISTORY TAB =====

// ===== AI CHATBOT INTEGRATION =====

class CodeGenerationAI {
    constructor() {
        this.isOpen = false;
        this.isProcessing = false;
        this.conversationHistory = [];
        this.currentUser = null;
        this.initializeEventListeners();
    }

    initializeEventListeners() {
        // Chat toggle
        document.getElementById('ai-chat-toggle').addEventListener('click', () => this.toggleChat());
        document.getElementById('ai-chat-close').addEventListener('click', () => this.closeChat());
        
        // Send message
        document.getElementById('ai-chat-send').addEventListener('click', () => this.sendMessage());
        document.getElementById('ai-chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        // Quick actions
        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                this.handleQuickAction(action);
            });
        });

        // Voice input (placeholder for future enhancement)
        document.getElementById('ai-voice-input').addEventListener('click', () => {
            this.showMessage('üé§ Voice input will be available in the next update!', 'info');
        });
    }

    toggleChat() {
        const chatWindow = document.getElementById('ai-chat-window');
        if (this.isOpen) {
            this.closeChat();
        } else {
            this.openChat();
        }
    }

    openChat() {
        const chatWindow = document.getElementById('ai-chat-window');
        const toggleBtn = document.getElementById('ai-chat-toggle');
        
        chatWindow.classList.remove('hidden');
        chatWindow.style.transform = 'scale(0.8) translateY(20px)';
        chatWindow.style.opacity = '0';
        
        // Animate in
        requestAnimationFrame(() => {
            chatWindow.style.transition = 'all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            chatWindow.style.transform = 'scale(1) translateY(0px)';
            chatWindow.style.opacity = '1';
        });
        
        this.isOpen = true;
        
        // Update quick actions based on current tab
        this.updateQuickActions();
        
        // Focus input
        setTimeout(() => {
            document.getElementById('ai-chat-input').focus();
        }, 300);
    }

    closeChat() {
        const chatWindow = document.getElementById('ai-chat-window');
        
        chatWindow.style.transition = 'all 0.2s ease-in-out';
        chatWindow.style.transform = 'scale(0.8) translateY(20px)';
        chatWindow.style.opacity = '0';
        
        setTimeout(() => {
            chatWindow.classList.add('hidden');
            chatWindow.style.transform = '';
            chatWindow.style.opacity = '';
            chatWindow.style.transition = '';
        }, 200);
        
        this.isOpen = false;
    }

    async sendMessage() {
        const input = document.getElementById('ai-chat-input');
        const message = input.value.trim();
        
        if (!message || this.isProcessing) return;
        
        // Clear input and show user message
        input.value = '';
        this.addUserMessage(message);
        this.showTypingIndicator();
        this.isProcessing = true;

        const startTime = Date.now();

        try {
            // Get or create session
            const session = await this.getOrCreateSession();
            
            // Process the message
            const response = await this.processUserMessage(message);
            const responseTime = Date.now() - startTime;
            
            this.hideTypingIndicator();
            this.addAIMessage(response.text, response.actions, response);
            
            // Log conversation to database
            await this.logConversation(session.session_id, message, response.text, response.intent, response.entities, response.actions, true, null, responseTime);
            
            // Execute any actions
            if (response.actions && response.actions.length > 0) {
                this.executeActions(response.actions);
            }
        } catch (error) {
            console.error('AI processing error:', error);
            this.hideTypingIndicator();
            const errorResponse = 'Sorry, I encountered an error while processing your request. Please try again.';
            this.addAIMessage(errorResponse, []);
            
            // Log error to database
            const session = await this.getOrCreateSession();
            await this.logConversation(session.session_id, message, errorResponse, 'error', {}, [], false, error.message, Date.now() - startTime);
        } finally {
            this.isProcessing = false;
        }
    }

    async getOrCreateSession() {
        try {
            const { data, error } = await supabase.rpc('ai_get_or_create_session', {
                user_id_param: this.currentUser.id,
                portal_name_param: 'code_generation'
            });

            if (error) {
                console.error('Session error:', error);
                return { session_id: null };
            }

            return data && data.length > 0 ? data[0] : { session_id: null };
        } catch (error) {
            console.error('Get or create session error:', error);
            return { session_id: null };
        }
    }

    async logConversation(sessionId, userMessage, aiResponse, intent, entities, actions, success, errorMessage, responseTime) {
        if (!sessionId) return;

        try {
            // Ensure all parameters are properly formatted
            const logData = {
                session_id_param: sessionId,
                user_message_param: userMessage?.substring(0, 1000) || '', // Limit message length
                ai_response_param: aiResponse?.substring(0, 2000) || '', // Limit response length
                intent_detected_param: intent || null,
                entities_extracted_param: entities || {},
                actions_performed_param: actions || [],
                execution_success_param: success,
                error_message_param: errorMessage?.substring(0, 500) || null, // Limit error message length
                response_time_ms_param: responseTime || 0
            };

            console.log('Logging conversation with data:', logData);

            const { error } = await supabase.rpc('ai_log_conversation', logData);

            if (error) {
                console.error('Log conversation RPC error:', error);
                
                // Check if it's a function not found error
                if (error.message && (error.message.includes('function') && error.message.includes('does not exist'))) {
                    console.warn('‚ö†Ô∏è AI conversation logging not available. RPC functions need to be installed.');
                    // Store this info to show user a one-time setup message
                    if (!window.aiSetupMessageShown) {
                        this.showMessage('üí° To enable conversation logging, run the AI database integration script.', 'info');
                        window.aiSetupMessageShown = true;
                    }
                } else {
                    console.error('Conversation logging failed:', error.message);
                }
                
                // Don't throw error to avoid breaking the chat flow
            } else {
                console.log('Conversation logged successfully');
            }
        } catch (error) {
            console.error('Log conversation error:', error);
            // Don't throw error to avoid breaking the chat flow
        }
    }

    async processUserMessage(message) {
        // Analyze the message and determine intent (keep for logging)
        const intent = this.analyzeIntent(message.toLowerCase());
        const entities = this.extractEntities(message);
        
        console.log('AI Processing:', { message, intent, entities });
        
        // Get current portal context
        const currentTab = this.getCurrentTab();
        const context = this.getPortalContext();
        
        // Perform actual database search and get real results
        const searchResults = await this.performDatabaseSearch(intent, entities, message);
        
        // Generate AI response using Claude API
        const response = await this.generateAIResponse(message, intent, entities, currentTab, context, searchResults);
        
        // Add metadata to response
        response.intent = intent;
        response.entities = entities;
        response.searchResults = searchResults;
        
        return response;
    }

    async generateAIResponse(userMessage, detectedIntent, entities, currentTab, context, searchResults) {
        try {
            // Prepare context information for the AI
            const contextInfo = this.buildContextForAI(currentTab, context, searchResults, entities);
            
            // Create the AI prompt with database results
            const aiPrompt = this.buildAIPrompt(userMessage, contextInfo, detectedIntent, searchResults);
            
            console.log('ü§ñ Calling Claude AI with comprehensive prompt including database results...');
            
            // Call Claude API (only real AI - no fallbacks)
            const aiResponse = await this.callClaudeAPI(aiPrompt);
            
            console.log('‚úÖ Received Claude AI response with database-informed insights');
            
            // Parse AI response and extract actions
            const parsedResponse = this.parseAIResponse(aiResponse, detectedIntent, searchResults);
            
            // Mark as real AI response
            parsedResponse.source = 'claude_ai';
            parsedResponse.isAI = true;
            
            return parsedResponse;
            
        } catch (error) {
            console.error('‚ùå Claude AI error:', error);
            
            // Provide detailed error information to user
            this.showAIErrorNotification(error);
            
            // Return error response instead of fallback
            return {
                text: `‚ùå **Claude AI Unavailable**\n\n${error.message}\n\nüîß **Database Functions Still Work:**\nYour database search and portal actions are fully functional. Only AI responses are temporarily unavailable.\n\nüìö **Setup Required:** Deploy the Claude AI serverless function to enable intelligent responses.`,
                actions: [],
                source: 'error',
                isAI: false,
                aiError: error.message,
                setupRequired: true
            };
        }
    }

    showAIErrorNotification(error) {
        // Show clear error information about AI setup requirements
        let message = 'üö® Claude AI Setup Required';
        let type = 'error';
        let setupInstructions = '';
        
        if (error.message.includes('SETUP_REQUIRED')) {
            setupInstructions = `
üîß **Required Steps:**
1. Deploy the serverless function to /.netlify/functions/claude-ai
2. Set ANTHROPIC_API_KEY environment variable
3. Redeploy your site
4. Refresh this page

üìö **See the setup guide for detailed instructions**
            `;
        } else if (error.message.includes('NETWORK_ERROR')) {
            setupInstructions = `
üåê **Network Issue:**
‚Ä¢ Ensure you're accessing via HTTPS (not file://)
‚Ä¢ Check serverless function deployment
‚Ä¢ Verify network connectivity
‚Ä¢ Try refreshing the page
            `;
        } else {
            setupInstructions = `
‚ùå **AI Configuration Error:**
${error.message}

üîß **Next Steps:**
‚Ä¢ Check serverless function logs
‚Ä¢ Verify ANTHROPIC_API_KEY is set
‚Ä¢ Ensure function is properly deployed
            `;
        }
        
        // Show detailed setup instructions
        this.addAIMessage(`${message}\n\n${setupInstructions}`, [], {
            source: 'system',
            isAI: false,
            setupRequired: true
        });
        
        this.showMessage(message + ' - Check chat for setup instructions', type);
    }

    buildContextForAI(currentTab, context, searchResults, entities) {
        const contextInfo = {
            currentTab: currentTab,
            user: {
                id: context.currentUser?.id,
                role: context.currentUser?.role,
                username: context.currentUser?.username
            },
            portal: 'Code Generation Portal',
            timestamp: new Date().toISOString()
        };

        // Add search results summary if available
        if (searchResults && searchResults.results) {
            contextInfo.searchResults = {
                type: searchResults.type || 'unknown',
                count: searchResults.total || searchResults.results.length,
                hasResults: searchResults.results.length > 0,
                sampleData: searchResults.results.slice(0, 3) // First 3 results for context
            };
        }

        // Add detected entities for context
        if (entities && Object.keys(entities).length > 0) {
            contextInfo.detectedEntities = entities;
        }

        return contextInfo;
    }

    buildAIPrompt(userMessage, contextInfo, detectedIntent, searchResults) {
        let prompt = `You are an AI assistant for a Code Generation Portal. You help users with item code generation, searching, and management tasks.

CONTEXT:
- User is currently on: ${contextInfo.currentTab} tab
- User role: ${contextInfo.user.role}
- Portal: ${contextInfo.portal}
- Detected intent: ${detectedIntent}

USER MESSAGE: "${userMessage}"`;

        // Add search results context if available with detailed logging
        if (searchResults && searchResults.results) {
            if (searchResults.results.length > 0) {
                prompt += `\n\n=== ACTUAL DATABASE SEARCH RESULTS ===`;
                prompt += `\nSearch Query: "${searchResults.searchQuery}"`;
                prompt += `\nTotal Results Found: ${searchResults.total}`;
                prompt += `\nResult Type: ${searchResults.type || 'items'}`;
                prompt += `\nDatabase Source: ${searchResults.source || 'rpc_function'}`;
                prompt += `\n\nDETAILED RESULTS:`;
                
                // Show ALL results with complete data
                searchResults.results.forEach((result, index) => {
                    prompt += `\n\n--- Result ${index + 1} ---`;
                    if (result.item_code) {
                        // Item code results
                        prompt += `\nItem Code: ${result.item_code}`;
                        prompt += `\nDescription: ${result.description1 || 'No description'}`;
                        prompt += `\nPrice: ${result.unit_price ? result.unit_price + ' ' + (result.currency_code || 'USD') : 'Not set'}`;
                        prompt += `\nManufacturer: ${result.manufacturer || 'Not specified'}`;
                        prompt += `\nUOM: ${result.uom || 'Not specified'}`;
                        prompt += `\nCountry: ${result.country_of_origin || 'Not specified'}`;
                        prompt += `\nModel: ${result.model_number || 'Not specified'}`;
                        prompt += `\nStatus: ${result.status || 'Unknown'}`;
                        prompt += `\nERP Integrated: ${result.erp_integrated ? 'Yes' : 'No'}`;
                        prompt += `\nCreated: ${result.created_at || 'Unknown'}`;
                        if (result.project && result.project.project_name) {
                            prompt += `\nProject: ${result.project.project_name}`;
                        }
                    } else if (result.project_name) {
                        // Project results
                        prompt += `\nProject ID: ${result.id}`;
                        prompt += `\nProject Name: ${result.project_name}`;
                        prompt += `\nDivision: ${result.division_code} - ${result.division_description || 'No description'}`;
                        prompt += `\nSection: ${result.section_code} - ${result.section_description || 'No description'}`;
                        prompt += `\nDetailed Section: ${result.detailed_section_code} - ${result.detailed_section_description || 'No description'}`;
                        prompt += `\nItem Code: ${result.item_code || 'Not specified'}`;
                        prompt += `\nItem Description: ${result.item_description || 'Not specified'}`;
                        prompt += `\nStatus: ${result.status}`;
                        prompt += `\nCreated: ${result.created_at || 'Unknown'}`;
                        if (result.attributes_count !== undefined) {
                            prompt += `\nAttributes Count: ${result.attributes_count}`;
                        }
                        if (result.item_codes_generated !== undefined) {
                            prompt += `\nGenerated Codes: ${result.item_codes_generated}`;
                        }
                        if (result.created_by_username) {
                            prompt += `\nCreated By: ${result.created_by_username}`;
                        }
                    } else {
                        // Unknown result type - show all fields
                        prompt += `\nRAW DATA: ${JSON.stringify(result)}`;
                    }
                });
                
                prompt += `\n\n=== END DATABASE RESULTS ===`;
            } else {
                prompt += `\n\n=== DATABASE SEARCH RESULTS ===`;
                prompt += `\nSearch Query: "${searchResults.searchQuery}"`;
                prompt += `\nResult: NO RESULTS FOUND`;
                prompt += `\nDatabase searched but returned 0 results`;
                prompt += `\n=== END DATABASE RESULTS ===`;
            }
        } else if (searchResults && searchResults.error) {
            prompt += `\n\n=== DATABASE ERROR ===`;
            prompt += `\nError: ${searchResults.error}`;
            if (searchResults.suggestion) {
                prompt += `\nSuggestion: ${searchResults.suggestion}`;
            }
            prompt += `\n=== END ERROR ===`;
        } else {
            prompt += `\n\n=== NO DATABASE SEARCH PERFORMED ===`;
            prompt += `\nReason: No search results object provided`;
            prompt += `\n=== END ===`;
        }

        // Add statistics if available
        if (searchResults && searchResults.stats) {
            prompt += `\n\nUSER STATISTICS:`;
            prompt += `\n- Total item codes: ${searchResults.stats.total_item_codes || 0}`;
            prompt += `\n- Pending codes: ${searchResults.stats.pending_item_codes || 0}`;
            prompt += `\n- Approved codes: ${searchResults.stats.approved_item_codes || 0}`;
            prompt += `\n- ERP integrated: ${searchResults.stats.erp_integrated_codes || 0}`;
        }

        prompt += `\n\nüö® ABSOLUTE REQUIREMENTS üö®
1. **USE ONLY THE DATA ABOVE** - Never invent project IDs, item codes, or any information
2. **EXACT DATA ONLY** - Copy project names, IDs, and details EXACTLY as shown above
3. **NO GUESSING** - If information isn't in the database results above, don't mention it
4. **NO PROJECT ID INVENTION** - Only use the exact "Project ID" numbers from the results above
5. **STRUCTURED RESPONSE** - Format results as clean, organized cards/sections

RESPONSE FORMAT:
- Use clear card-like sections with headers
- Show results in organized paragraphs/blocks
- Include all relevant fields from the actual database results
- Use emojis for visual organization
- Create a professional, structured layout

If NO RESULTS found above: Say "No results found in the database" and suggest alternatives.
If ERROR shown above: Acknowledge the error and suggest solutions.

At the end, include actions in this format:
RESPONSE_ACTIONS: {"actions": [{"type": "action_type", "description": "what this does", "data": {}}]}

RESPOND ONLY WITH FACTUAL DATA FROM THE DATABASE RESULTS SHOWN ABOVE!`;

        // Log the complete prompt for debugging
        console.log('üîç Complete AI Prompt:', prompt);
        console.log('üìä Search Results Object:', JSON.stringify(searchResults, null, 2));

        return prompt;
    }

    async callClaudeAPI(prompt) {
        // Use the comprehensive database-integrated serverless function
        const functionUrl = '/.netlify/functions/claude-ai-comprehensive-database';
        
        console.log('üß† Calling Claude AI with comprehensive database access...');
        
        try {
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: prompt,
                    maxTokens: 2000
                })
            });

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('FUNCTION_NOT_DEPLOYED: Comprehensive database function not found at /.netlify/functions/claude-ai-comprehensive-database');
                }
                
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Function error: ${response.status} - ${errorData.error || response.statusText}`);
            }

            const data = await response.json();
            
            if (data.success && data.response) {
                console.log('‚úÖ Claude AI response with comprehensive database access received');
                console.log('üìä Database search summary:', {
                    tablesSearched: data.searchResults?.tablesSearched || [],
                    totalResults: data.searchResults?.totalResults || 0
                });
                return data.response;
            } else if (data.fallback) {
                throw new Error(`AI_SERVICE_ERROR: ${data.error || 'AI temporarily unavailable'}`);
            } else {
                throw new Error('Invalid response format from Claude AI function');
            }
        } catch (error) {
            console.error('‚ùå Claude AI call failed:', error);
            
            // Provide specific error guidance
            if (error.message.includes('FUNCTION_NOT_DEPLOYED')) {
                throw new Error('SETUP_REQUIRED: Please deploy the comprehensive database Claude AI serverless function. See setup guide for instructions.');
            } else if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                throw new Error('NETWORK_ERROR: Cannot reach Claude AI function. Ensure proper deployment and try refreshing the page.');
            } else {
                throw error;
            }
        }
    }

    updateAIPromptForComplexQueries(prompt, userMessage) {
        // Enhance prompt for complex queries that require AI reasoning
        const complexQueryPrompt = prompt + `

ADVANCED AI CAPABILITIES:
You have access to real database search results above. Use this data to provide intelligent, specific responses.

For complex queries, you should:
1. Analyze the user's actual request beyond simple keyword matching
2. Use the database results to provide specific insights and recommendations  
3. Suggest related actions based on the data patterns you see
4. Provide contextual advice based on ERP status, pricing trends, or manufacturer patterns
5. Guide users through multi-step workflows when needed

RESPONSE GUIDELINES:
- Reference specific item codes, prices, and manufacturers from the database results
- Provide data-driven insights and recommendations
- Suggest next steps that make sense given the actual data
- Be conversational but informative
- Include relevant emojis and formatting for readability

Your responses should demonstrate understanding of the user's intent and provide value beyond simple data retrieval.`;

        return complexQueryPrompt;
    }

    // Alternative method for development/testing without serverless functions
    async callClaudeAPIDirect(prompt) {
        console.warn('‚ö†Ô∏è Attempting direct Claude API call - this will fail in browsers due to CORS');
        
        try {
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    // Note: API key should NEVER be in client-side code in production
                    // This is only for development testing
                },
                body: JSON.stringify({
                    model: "claude-3-sonnet-20240229",
                    max_tokens: 1000,
                    messages: [
                        { role: "user", content: prompt }
                    ],
                })
            });

            if (!response.ok) {
                throw new Error(`Claude API error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            if (data.content && data.content[0] && data.content[0].text) {
                return data.content[0].text;
            } else {
                throw new Error('Invalid response format from Claude API');
            }
        } catch (error) {
            if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                throw new Error('CORS_ERROR: Direct API calls blocked by browser. Please use serverless function.');
            }
            throw error;
        }
    }

    parseAIResponse(aiResponse, detectedIntent, searchResults) {
        try {
            // Extract actions from the AI response
            let actions = [];
            let responseText = aiResponse;

            // Look for RESPONSE_ACTIONS JSON at the end
            const actionsMatch = aiResponse.match(/RESPONSE_ACTIONS:\s*(\{.*\})\s*$/s);
            if (actionsMatch) {
                try {
                    const actionsData = JSON.parse(actionsMatch[1]);
                    if (actionsData.actions && Array.isArray(actionsData.actions)) {
                        actions = actionsData.actions;
                    }
                    // Remove the actions JSON from the display text
                    responseText = aiResponse.replace(/RESPONSE_ACTIONS:\s*\{.*\}\s*$/s, '').trim();
                } catch (parseError) {
                    console.warn('Could not parse AI actions:', parseError);
                }
            }

            // If no actions were provided, infer some based on intent and results
            if (actions.length === 0) {
                actions = this.inferActionsFromIntent(detectedIntent, searchResults);
            }

            return {
                text: responseText,
                actions: actions,
                source: 'claude_ai'
            };

        } catch (error) {
            console.error('Error parsing AI response:', error);
            return {
                text: aiResponse,
                actions: [],
                source: 'claude_ai_raw'
            };
        }
    }

    inferActionsFromIntent(intent, searchResults) {
        const actions = [];

        switch (intent) {
            case 'search_codes':
                if (searchResults && searchResults.results && searchResults.results.length > 0) {
                    actions.push({
                        type: 'search_codes',
                        description: 'View detailed search results',
                        data: { 
                            query: searchResults.searchQuery,
                            field: searchResults.searchField,
                            count: searchResults.total
                        }
                    });
                } else {
                    actions.push({
                        type: 'show_search_tips',
                        description: 'Get help with searching',
                        data: {}
                    });
                }
                break;

            case 'create_code':
                actions.push({
                    type: 'navigate_to_tab',
                    description: 'Go to Generate Codes tab',
                    data: { tab: 'generate' }
                });
                break;

            case 'export_data':
                actions.push({
                    type: 'show_export_options',
                    description: 'Show export options',
                    data: {}
                });
                break;

            case 'check_status':
                actions.push({
                    type: 'load_user_history',
                    description: 'Load user history',
                    data: {}
                });
                break;

            case 'search_project':
                actions.push({
                    type: 'show_project_search',
                    description: 'Show project search options',
                    data: {}
                });
                break;
        }

        return actions;
    }

    generateFallbackResponse(intent, entities, originalMessage, currentTab, context, searchResults) {
        // This is our backup rule-based system if AI fails
        console.log('Using fallback response generation...');
        
        if (searchResults && searchResults.error) {
            return {
                text: `‚ùå Search Error: ${searchResults.error}${searchResults.suggestion ? `\n\nüí° ${searchResults.suggestion}` : ''}`,
                actions: [{
                    type: 'show_search_tips',
                    description: 'Get search help',
                    data: {}
                }],
                source: 'fallback'
            };
        }

        // Basic fallback responses
        const fallbackResponses = {
            'search_codes': `üîç I searched for item codes but I'm having trouble processing the results right now. Please try using the Search Codes tab directly.`,
            'create_code': `‚ö° I can help you create item codes! Let me take you to the Generate Codes tab where you can select a project and configure attributes.`,
            'export_data': `üì§ For exporting data, please use the Export options available on the Search Codes tab. You can export to Excel or PDF format.`,
            'check_status': `üìã To check your request status, please visit the User History tab where you can see all your submissions and their approval progress.`,
            'help': `‚ùì I'm here to help! Try asking me to search for codes, create new codes, check your status, or export data.`
        };

        const responseText = fallbackResponses[intent] || 
            `I understand you're asking about: "${originalMessage}". Please try using the portal tabs directly or ask me for help with specific tasks like searching codes or checking status.`;

        return {
            text: responseText,
            actions: this.inferActionsFromIntent(intent, searchResults),
            source: 'fallback'
        };
    }

    async performDatabaseSearch(intent, entities, message) {
        try {
            switch (intent) {
                case 'search_codes':
                    return await this.searchItemCodes(entities, message);
                case 'check_status':
                    return await this.getUserRequestStatus();
                case 'search_project':
                    return await this.searchProjects(entities, message);
                case 'export_data':
                    return await this.getExportData(entities);
                case 'filter_requests':
                    return await this.getFilteredRequests(entities);
                default:
                    return null;
            }
        } catch (error) {
            console.error('Database search error:', error);
            
            // Check if it's an RPC function not found error
            if (error.message && (error.message.includes('function') && error.message.includes('does not exist'))) {
                return { 
                    error: 'AI database functions not yet installed. Please run the database integration script first.',
                    suggestion: 'Contact your administrator to install the AI chatbot database integration.'
                };
            }
            
            return { error: error.message };
        }
    }

    async searchItemCodes(entities, message) {
        try {
            let searchQuery = '';
            let searchField = 'all';

            // Determine search parameters from entities
            if (entities.materials && entities.materials.length > 0) {
                searchQuery = entities.materials[0];
                searchField = 'attributes';
            } else if (entities.item_codes && entities.item_codes.length > 0) {
                searchQuery = entities.item_codes[0];
                searchField = 'item_code';
            } else {
                // Extract keywords from the message
                const keywords = message.toLowerCase().match(/\b(steel|aluminum|copper|pvc|electrical|mechanical|pipe|valve|conduit|cable|fitting)\b/g);
                if (keywords && keywords.length > 0) {
                    searchQuery = keywords[0];
                    searchField = 'attributes';
                }
            }

            if (!searchQuery) {
                return { error: 'No search terms found', suggestion: 'Try specifying a material like "steel", "electrical", or an item code' };
            }

            // Check if RPC function exists by trying to call it
            const { data, error } = await supabase.rpc('ai_search_item_codes', {
                user_id_param: this.currentUser.id,
                search_query_param: searchQuery,
                search_field_param: searchField,
                limit_param: 10
            });

            if (error) {
                console.error('Search RPC error:', error);
                
                // If RPC function doesn't exist, fall back to direct table query
                if (error.message && error.message.includes('does not exist')) {
                    return await this.fallbackSearchItemCodes(searchQuery, searchField);
                }
                
                return { error: error.message };
            }

            return {
                results: data || [],
                searchQuery: searchQuery,
                searchField: searchField,
                total: data ? data.length : 0
            };
        } catch (error) {
            console.error('Search item codes error:', error);
            return { error: error.message };
        }
    }

    async fallbackSearchItemCodes(searchQuery, searchField) {
        try {
            console.log('Using fallback search for item codes...');
            
            let query = supabase
                .from('item_code_workflow')
                .select(`
                    item_code, description1, description2, unit_price,
                    currency_code, manufacturer, uom, country_of_origin,
                    model_number, status, erp_integrated, created_at,
                    project:classification_projects(project_name)
                `)
                .eq('status', 'admin_approved')
                .limit(10)
                .order('created_at', { ascending: false });

            // Apply search filter
            if (searchField === 'item_code') {
                query = query.ilike('item_code', `%${searchQuery}%`);
            } else if (searchField === 'description') {
                query = query.or(`description1.ilike.%${searchQuery}%,description2.ilike.%${searchQuery}%`);
            } else if (searchField === 'manufacturer') {
                query = query.ilike('manufacturer', `%${searchQuery}%`);
            } else {
                // Search all fields
                query = query.or(`item_code.ilike.%${searchQuery}%,description1.ilike.%${searchQuery}%,description2.ilike.%${searchQuery}%,manufacturer.ilike.%${searchQuery}%`);
            }

            const { data, error } = await query;

            if (error) {
                return { error: error.message };
            }

            return {
                results: data || [],
                searchQuery: searchQuery,
                searchField: searchField,
                total: data ? data.length : 0
            };
        } catch (error) {
            console.error('Fallback search error:', error);
            return { error: error.message };
        }
    }

    async getUserRequestStatus() {
        try {
            const { data, error } = await supabase.rpc('ai_get_user_request_stats', {
                user_id_param: this.currentUser.id
            });

            if (error) {
                console.error('Get user stats RPC error:', error);
                return { error: error.message };
            }

            return {
                stats: data && data.length > 0 ? data[0] : {},
                type: 'user_stats'
            };
        } catch (error) {
            console.error('Get user request status error:', error);
            return { error: error.message };
        }
    }

    async searchProjects(entities, message) {
        try {
            let searchQuery = '';
            
            if (entities.materials && entities.materials.length > 0) {
                searchQuery = entities.materials[0];
            } else {
                // Extract project-related keywords
                const keywords = message.toLowerCase().match(/\b(steel|electrical|mechanical|plumbing|hvac|concrete|aluminum|copper|pvc|pipe|valve|conduit|cable|fitting|pump|motor|switch|panel|duct|03|26|33|22|23)\b/g);
                if (keywords) {
                    searchQuery = keywords[0];
                }
            }

            console.log(`Searching projects for: "${searchQuery}"`);

            // Try RPC function first
            const { data, error } = await supabase.rpc('ai_search_projects', {
                user_id_param: this.currentUser.id,
                search_query_param: searchQuery,
                status_filter_param: 'admin_approved',
                limit_param: 10
            });

            if (data && !error) {
                console.log(`Found ${data.length} projects via RPC`);
                return {
                    results: data,
                    searchQuery: searchQuery,
                    total: data.length,
                    type: 'projects'
                };
            }

            // If RPC fails, use direct table query as fallback
            console.log('RPC failed, using direct table query for projects...');
            
            let query = supabase
                .from('classification_projects')
                .select(`
                    id,
                    project_name,
                    division_code,
                    division_description,
                    section_code, 
                    section_description,
                    detailed_section_code,
                    detailed_section_description,
                    item_code,
                    item_description,
                    status,
                    created_at
                `)
                .eq('status', 'admin_approved')
                .limit(15)
                .order('created_at', { ascending: false });

            // Apply search filter if we have a query
            if (searchQuery) {
                query = query.or(`project_name.ilike.%${searchQuery}%,division_description.ilike.%${searchQuery}%,section_description.ilike.%${searchQuery}%,detailed_section_description.ilike.%${searchQuery}%,item_description.ilike.%${searchQuery}%`);
            }

            const { data: directData, error: directError } = await query;

            if (directError) {
                console.error('Direct project search error:', directError);
                return { 
                    error: directError.message,
                    searchQuery: searchQuery,
                    results: [],
                    total: 0,
                    type: 'projects'
                };
            }

            console.log(`Found ${directData ? directData.length : 0} projects via direct query`);

            return {
                results: directData || [],
                searchQuery: searchQuery, 
                total: directData ? directData.length : 0,
                type: 'projects',
                source: 'direct_query'
            };

        } catch (error) {
            console.error('Search projects error:', error);
            return { 
                error: error.message,
                searchQuery: searchQuery || 'unknown',
                results: [],
                total: 0,
                type: 'projects'
            };
        }
    }

    async getExportData(entities) {
        try {
            // Use the enhanced export data function
            const { data, error } = await supabase.rpc('ai_get_export_data', {
                user_id_param: this.currentUser.id,
                status_filter: 'admin_approved',
                erp_filter: 'all',
                limit_param: 100
            });

            if (error) {
                console.error('Get export data error:', error);
                return { error: error.message };
            }

            return {
                results: data || [],
                total: data ? data.length : 0,
                type: 'export_data'
            };
        } catch (error) {
            console.error('Get export data error:', error);
            return { error: error.message };
        }
    }

    async getFilteredRequests(entities) {
        try {
            const status = entities.statuses && entities.statuses.length > 0 ? entities.statuses[0] : 'pending';
            
            // Get user's requests with the specified status
            const { data, error } = await supabase
                .from('item_code_workflow')
                .select(`
                    id, item_code, description1, status, created_at,
                    project:classification_projects(project_name),
                    reviewer_user:users!item_code_workflow_reviewed_by_fkey(username),
                    admin_user:users!item_code_workflow_admin_reviewed_by_fkey(username)
                `)
                .eq('created_by', this.currentUser.id)
                .ilike('status', `%${status}%`)
                .limit(20)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Get filtered requests error:', error);
                return { error: error.message };
            }

            return {
                results: data || [],
                total: data ? data.length : 0,
                status: status,
                type: 'filtered_requests'
            };
        } catch (error) {
            console.error('Get filtered requests error:', error);
            return { error: error.message };
        }
    }

    analyzeIntent(message) {
        const intentPatterns = {
            'search_codes': [
                /\b(find|search|show|list|get)\b.*\b(code|item|product)\b/,
                /\b(electrical|mechanical|plumbing|hvac|concrete|steel|pipe|valve|cable)\b/
            ],
            'create_code': [
                /\b(create|generate|make|add|new)\b.*\b(code|item)\b/,
                /\bgenerate\b.*\bfor\b/
            ],
            'export_data': [
                /\b(export|download|save|extract)\b/,
                /\b(excel|xlsx|pdf|csv)\b/
            ],
            'check_status': [
                /\b(status|pending|approved|rejected)\b/,
                /\b(my|mine)\b.*\b(request|submission)\b/
            ],
            'search_project': [
                /\b(project|classification)\b/,
                /\bshow\b.*\bproject\b/
            ],
            'help': [
                /\b(help|how|what|explain|guide)\b/,
                /\bwhat can you do\b/,
                /\bhow do i\b/
            ],
            'filter_requests': [
                /\b(filter|where|pending|approved|rejected)\b/,
                /\b(show me all|list all)\b.*\b(pending|approved|rejected)\b/
            ]
        };

        for (const [intent, patterns] of Object.entries(intentPatterns)) {
            if (patterns.some(pattern => pattern.test(message))) {
                return intent;
            }
        }
        
        return 'general_query';
    }

    extractEntities(message) {
        const entities = {};
        
        // Extract item codes
        const codePattern = /\b([A-Z]{2,3}-\d{4}-\d{3})\b/g;
        const codes = message.match(codePattern);
        if (codes) entities.item_codes = codes;
        
        // Extract materials/products
        const materials = ['electrical', 'mechanical', 'plumbing', 'hvac', 'concrete', 'steel', 'aluminum', 'copper', 'pvc', 'pipe', 'valve', 'cable', 'conduit', 'fitting'];
        const foundMaterials = materials.filter(material => 
            message.toLowerCase().includes(material)
        );
        if (foundMaterials.length > 0) entities.materials = foundMaterials;
        
        // Extract status keywords
        const statuses = ['pending', 'approved', 'rejected', 'draft', 'submitted'];
        const foundStatuses = statuses.filter(status => 
            message.toLowerCase().includes(status)
        );
        if (foundStatuses.length > 0) entities.statuses = foundStatuses;
        
        // Extract numbers/sizes
        const sizePattern = /\b(\d+[\.\d]*)\s*(inch|mm|cm|meter|ft|psi|bar|gauge)\b/gi;
        const sizes = message.match(sizePattern);
        if (sizes) entities.sizes = sizes;
        
        return entities;
    }

    async generateResponse(intent, entities, originalMessage, currentTab, context, searchResults) {
        const responses = {
            'search_codes': this.handleSearchCodes(entities, originalMessage, searchResults),
            'create_code': this.handleCreateCode(entities, originalMessage),
            'export_data': this.handleExportData(entities, originalMessage, searchResults),
            'check_status': this.handleCheckStatus(entities, originalMessage, searchResults),
            'search_project': this.handleSearchProject(entities, originalMessage, searchResults),
            'filter_requests': this.handleFilterRequests(entities, originalMessage, searchResults),
            'help': this.handleHelp(currentTab),
            'general_query': this.handleGeneralQuery(originalMessage, currentTab, context)
        };
        
        return responses[intent] || responses['general_query'];
    }

    handleSearchCodes(entities, message, searchResults) {
        if (searchResults && searchResults.error) {
            return {
                text: `‚ùå Search Error: ${searchResults.error}${searchResults.suggestion ? `\n\nüí° ${searchResults.suggestion}` : ''}`,
                actions: []
            };
        }

        if (!searchResults || !searchResults.results || searchResults.results.length === 0) {
            const searchTerm = searchResults ? searchResults.searchQuery : 'your criteria';
            return {
                text: `üîç No item codes found for "${searchTerm}".\n\nTry searching for:\n‚Ä¢ Material types (steel, electrical, pvc)\n‚Ä¢ Sizes (4 inch, 150 PSI)\n‚Ä¢ Specific item codes (ABC-2024-001)\n‚Ä¢ Manufacturers or countries`,
                actions: [{
                    type: 'show_search_tips'
                }]
            };
        }

        const { results, searchQuery, total } = searchResults;
        
        let responseText = `üéØ Found ${total} item code${total > 1 ? 's' : ''} for "${searchQuery}":\n\n`;
        
        results.slice(0, 5).forEach((item, index) => {
            responseText += `**${index + 1}. ${item.item_code}**\n`;
            responseText += `üìÑ ${item.description1 || 'No description'}\n`;
            responseText += `üí∞ ${item.unit_price ? `${item.unit_price} ${item.currency_code || ''}` : 'Price not set'}\n`;
            responseText += `üè≠ ${item.manufacturer || 'No manufacturer'}\n`;
            responseText += `üì¶ ${item.uom || 'No UOM'} | üåç ${item.country_of_origin || 'No country'}\n`;
            responseText += `${item.erp_integrated ? '‚úÖ ERP Integrated' : '‚è≥ Pending ERP'}\n\n`;
        });

        if (total > 5) {
            responseText += `üìã *Showing 5 of ${total} results. Use the Search tab to see all results.*\n\n`;
        }

        responseText += `üí° **Quick Actions:**\n‚Ä¢ Export these results to Excel\n‚Ä¢ View detailed specifications\n‚Ä¢ Search for similar codes`;

        return {
            text: responseText,
            actions: [{
                type: 'search_codes',
                query: searchQuery,
                field: searchResults.searchField,
                total: total
            }]
        };
    }

    handleCheckStatus(entities, message, searchResults) {
        if (searchResults && searchResults.error) {
            return {
                text: `‚ùå Error loading status: ${searchResults.error}`,
                actions: []
            };
        }

        if (!searchResults || !searchResults.stats) {
            return {
                text: `üìã Unable to load your request statistics. Please try again.`,
                actions: []
            };
        }

        const stats = searchResults.stats;
        
        let responseText = `üìä **Your Request Summary:**\n\n`;
        responseText += `**üîß Item Codes:** ${stats.total_item_codes || 0} total\n`;
        responseText += `   ‚Ä¢ ‚è≥ Pending: ${stats.pending_item_codes || 0}\n`;
        responseText += `   ‚Ä¢ ‚úÖ Approved: ${stats.approved_item_codes || 0}\n\n`;
        
        responseText += `**üìù Standard Values:** ${stats.total_standard_values || 0} total\n`;
        responseText += `   ‚Ä¢ ‚è≥ Pending: ${stats.pending_standard_values || 0}\n\n`;
        
        responseText += `**üîÑ Combination Requests:** ${stats.total_combination_requests || 0} total\n`;
        responseText += `   ‚Ä¢ ‚è≥ Pending: ${stats.pending_combination_requests || 0}\n\n`;
        
        responseText += `**üè≠ Manufacturer Requests:** ${stats.total_manufacturer_requests || 0} total\n`;
        responseText += `   ‚Ä¢ ‚è≥ Pending: ${stats.pending_manufacturer_requests || 0}\n\n`;

        // Add insights
        const totalPending = (stats.pending_item_codes || 0) + (stats.pending_standard_values || 0) + 
                           (stats.pending_combination_requests || 0) + (stats.pending_manufacturer_requests || 0);

        if (totalPending > 0) {
            responseText += `üîî **You have ${totalPending} pending requests that need attention!**\n`;
            responseText += `üí° Check your User History tab to track progress.`;
        } else {
            responseText += `üéâ **Great! No pending requests. You're all caught up!**`;
        }

        return {
            text: responseText,
            actions: [{
                type: 'load_user_requests',
                stats: stats
            }]
        };
    }

    handleSearchProject(entities, message, searchResults) {
        if (searchResults && searchResults.error) {
            return {
                text: `‚ùå Project search error: ${searchResults.error}`,
                actions: []
            };
        }

        if (!searchResults || !searchResults.results || searchResults.results.length === 0) {
            const searchTerm = searchResults ? searchResults.searchQuery : 'your criteria';
            return {
                text: `üéØ No approved projects found for "${searchTerm}".\n\n**Try searching for:**\n‚Ä¢ Project names\n‚Ä¢ Division codes (like "03", "26", "33")\n‚Ä¢ Materials (steel, electrical, concrete)\n‚Ä¢ Components (pipe, valve, conduit, cable)\n\nüí° **Popular Divisions:**\n‚Ä¢ 03 - Concrete\n‚Ä¢ 26 - Electrical\n‚Ä¢ 33 - Utilities\n‚Ä¢ 22 - Plumbing`,
                actions: []
            };
        }

        const { results, searchQuery, total } = searchResults;
        
        let responseText = `üéØ Found ${total} approved project${total > 1 ? 's' : ''} for "${searchQuery}":\n\n`;
        
        results.slice(0, 3).forEach((project, index) => {
            responseText += `**${index + 1}. ${project.project_name}**\n`;
            responseText += `üìã CSI Path: ${project.division_code}`;
            if (project.division_description) {
                responseText += ` (${project.division_description})`;
            }
            responseText += ` > ${project.section_code}`;
            if (project.section_description) {
                responseText += ` (${project.section_description})`;
            }
            responseText += `\n   ‚îî ${project.detailed_section_code}`;
            if (project.detailed_section_description) {
                responseText += ` (${project.detailed_section_description})`;
            }
            responseText += ` > ${project.item_code}`;
            if (project.item_description) {
                responseText += ` (${project.item_description})`;
            }
            responseText += `\n`;
            
            if (project.additional_level_name && project.additional_level_value) {
                responseText += `üè∑Ô∏è ${project.additional_level_name}: ${project.additional_level_value}\n`;
            }
            responseText += `üë§ Created by: ${project.created_by_username || 'Unknown'}\n`;
            responseText += `üìä Attributes: ${project.attributes_count || 0} | Generated Codes: ${project.item_codes_generated || 0}\n`;
            responseText += `üìÖ Created: ${new Date(project.created_at).toLocaleDateString()}\n\n`;
        });

        if (total > 3) {
            responseText += `üìã *Showing 3 of ${total} projects.*\n\n`;
        }

        // Add usage statistics
        const totalAttributes = results.reduce((sum, p) => sum + (p.attributes_count || 0), 0);
        const totalCodes = results.reduce((sum, p) => sum + (p.item_codes_generated || 0), 0);

        responseText += `üìä **Summary Statistics:**\n`;
        responseText += `‚Ä¢ Total Attributes: ${totalAttributes}\n`;
        responseText += `‚Ä¢ Total Generated Codes: ${totalCodes}\n`;
        responseText += `‚Ä¢ Average Codes per Project: ${totalCodes > 0 ? Math.round(totalCodes / results.length) : 0}\n\n`;

        responseText += `üí° **What you can do:**\n‚Ä¢ Generate new codes using these projects\n‚Ä¢ View detailed project specifications\n‚Ä¢ Check attribute configurations\n‚Ä¢ Analyze code generation patterns`;

        return {
            text: responseText,
            actions: [{
                type: 'show_project_search',
                results: results.slice(0, 3),
                stats: { totalAttributes, totalCodes }
            }]
        };
    }

    handleExportData(entities, message, searchResults) {
        if (searchResults && searchResults.error) {
            return {
                text: `‚ùå Export data error: ${searchResults.error}`,
                actions: []
            };
        }

        if (!searchResults || !searchResults.results || searchResults.results.length === 0) {
            return {
                text: `üì§ No approved item codes available for export.\n\n**Possible reasons:**\n‚Ä¢ No codes have been generated yet\n‚Ä¢ All codes are still pending approval\n‚Ä¢ Database connection issue\n\nüí° Try generating some item codes first!`,
                actions: []
            };
        }

        const { results, total } = searchResults;
        
        let responseText = `üìä **Export Data Summary:**\n\n`;
        responseText += `‚úÖ **${total} approved item codes** ready for export\n\n`;
        
        // Show breakdown by ERP status
        const erpIntegrated = results.filter(item => item.erp_integrated).length;
        const erpPending = total - erpIntegrated;
        
        responseText += `**ERP Integration Status:**\n`;
        responseText += `‚Ä¢ ‚úÖ Integrated: ${erpIntegrated}\n`;
        responseText += `‚Ä¢ ‚è≥ Pending: ${erpPending}\n\n`;
        
        // Show sample of recent codes
        responseText += `**Sample Recent Codes:**\n`;
        results.slice(0, 3).forEach((item, index) => {
            responseText += `${index + 1}. **${item.item_code}** - ${item.description1 || 'No description'}\n`;
            responseText += `   üí∞ ${item.unit_price ? `${item.unit_price} ${item.currency_code}` : 'No price'} | `;
            responseText += `üè≠ ${item.manufacturer || 'No mfg'}\n`;
        });
        
        responseText += `\nüí° **Export Options Available:**\n`;
        responseText += `‚Ä¢ üìä Excel with full details\n`;
        responseText += `‚Ä¢ üìÑ PDF report\n`;
        responseText += `‚Ä¢ üîÑ ERP integration data\n\n`;
        responseText += `Click the Export button on Search tab or ask me to "show export options".`;

        return {
            text: responseText,
            actions: [{
                type: 'show_export_options',
                data_summary: {
                    total: total,
                    erp_integrated: erpIntegrated,
                    erp_pending: erpPending
                }
            }]
        };
    }

    handleCreateCode(entities, message) {
        let itemDescription = '';
        if (entities.materials && entities.materials.length > 0) {
            itemDescription = entities.materials.join(' ');
        }
        
        if (entities.sizes && entities.sizes.length > 0) {
            itemDescription += ` ${entities.sizes.join(' ')}`;
        }
        
        const actions = [{
            type: 'navigate_to_generate',
            description: itemDescription
        }];
        
        return {
            text: `‚ö° I'll help you create an item code${itemDescription ? ` for "${itemDescription}"` : ''}. Let me take you to the generation tab and prepare the form.`,
            actions: actions
        };
    }

    handleExportData(entities, message, searchResults) {
        if (searchResults && searchResults.error) {
            return {
                text: `‚ùå Export data error: ${searchResults.error}`,
                actions: []
            };
        }

        if (!searchResults || !searchResults.results || searchResults.results.length === 0) {
            return {
                text: `üì§ No approved item codes available for export.\n\n**Possible reasons:**\n‚Ä¢ No codes have been generated yet\n‚Ä¢ All codes are still pending approval\n‚Ä¢ Database connection issue\n\nüí° Try generating some item codes first!`,
                actions: []
            };
        }

        const { results, total } = searchResults;
        
        let responseText = `üìä **Export Data Summary:**\n\n`;
        responseText += `‚úÖ **${total} approved item codes** ready for export\n\n`;
        
        // Show breakdown by ERP status
        const erpIntegrated = results.filter(item => item.erp_integrated).length;
        const erpPending = total - erpIntegrated;
        
        responseText += `**ERP Integration Status:**\n`;
        responseText += `‚Ä¢ ‚úÖ Integrated: ${erpIntegrated}\n`;
        responseText += `‚Ä¢ ‚è≥ Pending: ${erpPending}\n\n`;
        
        // Show sample of recent codes
        responseText += `**Sample Recent Codes:**\n`;
        results.slice(0, 3).forEach((item, index) => {
            responseText += `${index + 1}. **${item.item_code}** - ${item.description1 || 'No description'}\n`;
            responseText += `   üí∞ ${item.unit_price ? `${item.unit_price} ${item.currency_code}` : 'No price'} | `;
            responseText += `üè≠ ${item.manufacturer || 'No mfg'}\n`;
        });
        
        responseText += `\nüí° **Export Options Available:**\n`;
        responseText += `‚Ä¢ üìä Excel with full details\n`;
        responseText += `‚Ä¢ üìÑ PDF report\n`;
        responseText += `‚Ä¢ üîÑ ERP integration data\n\n`;
        responseText += `Click the Export button on Search tab or ask me to "show export options".`;

        return {
            text: responseText,
            actions: [{
                type: 'show_export_options',
                data_summary: {
                    total: total,
                    erp_integrated: erpIntegrated,
                    erp_pending: erpPending
                }
            }]
        };
    }

    handleFilterRequests(entities, message, searchResults) {
        if (searchResults && searchResults.error) {
            return {
                text: `‚ùå Filter error: ${searchResults.error}`,
                actions: []
            };
        }

        if (!searchResults || !searchResults.results || searchResults.results.length === 0) {
            const status = searchResults ? searchResults.status : 'specified';
            return {
                text: `üîΩ No ${status} requests found.\n\n**This could mean:**\n‚Ä¢ All your requests are in different status\n‚Ä¢ No requests have been submitted yet\n‚Ä¢ Filter criteria too restrictive\n\nüí° Try asking for "all my requests" or specific status like "pending" or "approved".`,
                actions: []
            };
        }

        const { results, total, status } = searchResults;
        
        let responseText = `üîΩ **${total} ${status} request${total > 1 ? 's' : ''} found:**\n\n`;
        
        results.slice(0, 5).forEach((request, index) => {
            responseText += `**${index + 1}. ${request.item_code || `Request #${request.id}`}**\n`;
            responseText += `üìÑ ${request.description1 || 'No description'}\n`;
            responseText += `üéØ Project: ${request.project?.project_name || 'Unknown'}\n`;
            responseText += `üìä Status: ${request.status}\n`;
            if (request.reviewer_user) {
                responseText += `üë§ Reviewer: ${request.reviewer_user.username}\n`;
            }
            if (request.admin_user) {
                responseText += `üëë Admin: ${request.admin_user.username}\n`;
            }
            responseText += `üìÖ Created: ${new Date(request.created_at).toLocaleDateString()}\n\n`;
        });

        if (total > 5) {
            responseText += `üìã *Showing 5 of ${total} ${status} requests.*\n\n`;
        }

        responseText += `üí° **Next Steps:**\n`;
        if (status === 'pending') {
            responseText += `‚Ä¢ Wait for reviewer approval\n‚Ä¢ Contact reviewer if urgent\n‚Ä¢ Check back tomorrow for updates`;
        } else if (status.includes('approved')) {
            responseText += `‚Ä¢ Codes ready for use\n‚Ä¢ Available for ERP integration\n‚Ä¢ Export to Excel if needed`;
        } else {
            responseText += `‚Ä¢ Review request details\n‚Ä¢ Check comments for feedback\n‚Ä¢ Consider resubmitting if needed`;
        }

        return {
            text: responseText,
            actions: [{
                type: 'filter_requests',
                status: status,
                total: total
            }]
        };
    }

    handleHelp(currentTab) {
        const helpContent = {
            'generate': `
                <div class="space-y-3">
                    <h4 class="font-semibold text-blue-700">üöÄ Generate Tab Help</h4>
                    <div class="text-sm space-y-2">
                        <div><strong>Select Project:</strong> Choose from approved classification projects</div>
                        <div><strong>Configure Attributes:</strong> Set values for each attribute</div>
                        <div><strong>Add Details:</strong> Unit price, currency, manufacturer</div>
                        <div><strong>Generate:</strong> Create unique item codes</div>
                    </div>
                    <div class="text-xs text-blue-600 bg-blue-50 p-2 rounded">
                        üí° Try: "Generate code for steel pipe 4 inch Schedule 40"
                    </div>
                </div>
            `,
            'user-history': `
                <div class="space-y-3">
                    <h4 class="font-semibold text-green-700">üìã User History Help</h4>
                    <div class="text-sm space-y-2">
                        <div><strong>Item Codes:</strong> View all your generated codes</div>
                        <div><strong>Standard Values:</strong> Track requested values</div>
                        <div><strong>Combinations:</strong> See block/generate requests</div>
                        <div><strong>Manufacturers:</strong> Your manufacturer requests</div>
                    </div>
                    <div class="text-xs text-green-600 bg-green-50 p-2 rounded">
                        üí° Try: "Show my pending requests"
                    </div>
                </div>
            `,
            'search': `
                <div class="space-y-3">
                    <h4 class="font-semibold text-purple-700">üîç Search Tab Help</h4>
                    <div class="text-sm space-y-2">
                        <div><strong>Advanced Filters:</strong> Search by multiple criteria</div>
                        <div><strong>View Options:</strong> Hierarchy, list, or table view</div>
                        <div><strong>Export Data:</strong> Download Excel/PDF reports</div>
                        <div><strong>ERP Status:</strong> Track integration status</div>
                    </div>
                    <div class="text-xs text-purple-600 bg-purple-50 p-2 rounded">
                        üí° Try: "Find all electrical conduit codes" or "Export approved codes to Excel"
                    </div>
                </div>
            `,
            'default': `
                <div class="space-y-3">
                    <h4 class="font-semibold text-gray-700">‚ùì Portal Help</h4>
                    <div class="text-sm space-y-2">
                        <div><strong>Natural Language:</strong> Ask questions in plain English</div>
                        <div><strong>Quick Actions:</strong> Use buttons below for common tasks</div>
                        <div><strong>Smart Search:</strong> I can find codes, projects, and requests</div>
                        <div><strong>Automation:</strong> I can perform actions for you</div>
                    </div>
                    <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded space-y-1">
                        <div>üí° <strong>Examples:</strong></div>
                        <div>"Show my pending item codes"</div>
                        <div>"Find steel pipe codes 4 inch"</div>
                        <div>"Export all electrical codes"</div>
                        <div>"Create code for PVC fitting"</div>
                    </div>
                </div>
            `
        };
        
        return {
            text: helpContent[currentTab] || helpContent['default'],
            actions: []
        };
    }

    handleGeneralQuery(message, currentTab, context) {
        // Provide contextual suggestions based on current tab
        const suggestions = {
            'generate': [
                'Generate a new item code',
                'Check duplicate detection',
                'Add standard values',
                'Select manufacturer'
            ],
            'user-history': [
                'Show my pending requests',
                'Filter by status',
                'Export my history',
                'Check approval progress'
            ],
            'search': [
                'Search for specific codes',
                'Export search results',
                'Toggle view mode',
                'Filter by ERP status'
            ],
            'admin': [
                'Review pending codes',
                'Check system statistics',
                'Manage user requests',
                'Export admin reports'
            ]
        };
        
        const tabSuggestions = suggestions[currentTab] || suggestions['search'];
        
        return {
            text: `I understand you're asking about: "${message}"\n\nHere are some things I can help you with on this tab:\n\n${tabSuggestions.map(s => `‚Ä¢ ${s}`).join('\n')}`,
            actions: [{
                type: 'show_suggestions',
                suggestions: tabSuggestions
            }]
        };
    }

    handleHelp(currentTab) {
        const helpContent = {
            'generate': `
                <div class="space-y-3">
                    <h4 class="font-semibold text-blue-700">üöÄ Generate Tab Help</h4>
                    <div class="text-sm space-y-2">
                        <div><strong>Select Project:</strong> Choose from approved classification projects</div>
                        <div><strong>Configure Attributes:</strong> Set values for each attribute</div>
                        <div><strong>Add Details:</strong> Unit price, currency, manufacturer</div>
                        <div><strong>Generate:</strong> Create unique item codes</div>
                    </div>
                    <div class="text-xs text-blue-600 bg-blue-50 p-2 rounded">
                        üí° Try: "Generate code for steel pipe 4 inch Schedule 40"
                    </div>
                </div>
            `,
            'user-history': `
                <div class="space-y-3">
                    <h4 class="font-semibold text-green-700">üìã User History Help</h4>
                    <div class="text-sm space-y-2">
                        <div><strong>Item Codes:</strong> View all your generated codes</div>
                        <div><strong>Standard Values:</strong> Track requested values</div>
                        <div><strong>Combinations:</strong> See block/generate requests</div>
                        <div><strong>Manufacturers:</strong> Your manufacturer requests</div>
                    </div>
                    <div class="text-xs text-green-600 bg-green-50 p-2 rounded">
                        üí° Try: "Show my pending requests"
                    </div>
                </div>
            `,
            'search': `
                <div class="space-y-3">
                    <h4 class="font-semibold text-purple-700">üîç Search Tab Help</h4>
                    <div class="text-sm space-y-2">
                        <div><strong>Advanced Filters:</strong> Search by multiple criteria</div>
                        <div><strong>View Options:</strong> Hierarchy, list, or table view</div>
                        <div><strong>Export Data:</strong> Download Excel/PDF reports</div>
                        <div><strong>ERP Status:</strong> Track integration status</div>
                    </div>
                    <div class="text-xs text-purple-600 bg-purple-50 p-2 rounded">
                        üí° Try: "Find all electrical conduit codes" or "Export approved codes to Excel"
                    </div>
                </div>
            `,
            'default': `
                <div class="space-y-3">
                    <h4 class="font-semibold text-gray-700">‚ùì Portal Help</h4>
                    <div class="text-sm space-y-2">
                        <div><strong>Natural Language:</strong> Ask questions in plain English</div>
                        <div><strong>Quick Actions:</strong> Use buttons below for common tasks</div>
                        <div><strong>Smart Search:</strong> I can find codes, projects, and requests</div>
                        <div><strong>Automation:</strong> I can perform actions for you</div>
                    </div>
                    <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded space-y-1">
                        <div>üí° <strong>Examples:</strong></div>
                        <div>"Show my pending item codes"</div>
                        <div>"Find steel pipe codes 4 inch"</div>
                        <div>"Export all electrical codes"</div>
                        <div>"Create code for PVC fitting"</div>
                    </div>
                </div>
            `
        };
        
        return {
            text: helpContent[currentTab] || helpContent['default'],
            actions: []
        };
    }

    handleGeneralQuery(message, currentTab, context) {
        // Provide contextual suggestions based on current tab
        const suggestions = {
            'generate': [
                'Generate a new item code',
                'Check duplicate detection',
                'Add standard values',
                'Select manufacturer'
            ],
            'user-history': [
                'Show my pending requests',
                'Filter by status',
                'Export my history',
                'Check approval progress'
            ],
            'search': [
                'Search for specific codes',
                'Export search results',
                'Toggle view mode',
                'Filter by ERP status'
            ],
            'admin': [
                'Review pending codes',
                'Check system statistics',
                'Manage user requests',
                'Export admin reports'
            ]
        };
        
        const tabSuggestions = suggestions[currentTab] || suggestions['search'];
        
        return {
            text: `I understand you're asking about: "${message}"\n\nHere are some things I can help you with on this tab:\n\n${tabSuggestions.map(s => `‚Ä¢ ${s}`).join('\n')}`,
            actions: [{
                type: 'show_suggestions',
                suggestions: tabSuggestions
            }]
        };
    }

    executeActions(actions) {
        if (!actions || actions.length === 0) return;
        
        actions.forEach(action => {
            console.log('Executing action:', action);
            
            switch (action.type) {
                case 'search_codes':
                    if (action.data && action.data.query) {
                        this.performSearch(action.data.query, action.data.field || 'all');
                    }
                    break;
                case 'navigate_to_tab':
                    if (action.data && action.data.tab) {
                        this.switchToTab(action.data.tab);
                    } else {
                        this.navigateToGenerate(action.description);
                    }
                    break;
                case 'show_export_options':
                    this.showExportOptions();
                    break;
                case 'load_user_history':
                    this.loadUserHistory(action.data?.status_filter);
                    break;
                case 'show_search_tips':
                    this.showSearchTips();
                    break;
                case 'show_project_search':
                    this.showProjectSearch();
                    break;
                case 'perform_filter':
                    if (action.data && action.data.status) {
                        this.filterRequests(action.data.status);
                    }
                    break;
                case 'show_suggestions':
                    this.showActionSuggestions(action.data?.suggestions || []);
                    break;
                default:
                    console.log('Unknown action type:', action.type);
            }
        });
    }

    showSearchTips() {
        this.showMessage('üí° Search Tips: Try searching for materials (steel, electrical), sizes (4 inch, 150 PSI), or specific codes (ABC-2024-001). You can also search by manufacturer or country.', 'info');
    }

    performSearch(query, field) {
        // Switch to search tab
        this.switchToTab('search');
        
        setTimeout(() => {
            const searchInput = document.getElementById(`search-${field}`) || 
                              document.getElementById('search-attributes') ||
                              document.getElementById('search-item-code');
            
            if (searchInput) {
                searchInput.value = query;
                searchInput.focus();
                
                // Trigger search if search button exists
                const searchBtn = document.getElementById('perform-search-btn');
                if (searchBtn) {
                    setTimeout(() => searchBtn.click(), 300);
                }
            }
        }, 500);
    }

    navigateToGenerate(description) {
        this.switchToTab('generate');
        
        if (description) {
            setTimeout(() => {
                this.showMessage(`üí° I've switched to the Generate tab. Now select a project and I'll help you configure the attributes for "${description}".`, 'success');
            }, 500);
        }
    }

    showExportOptions() {
        const currentTab = this.getCurrentTab();
        
        if (currentTab === 'search') {
            // Show export dropdown on search tab
            const exportBtn = document.getElementById('export-dropdown-btn');
            if (exportBtn) {
                exportBtn.click();
            }
        } else {
            this.showMessage('üì§ Export options are available on the Search Codes tab. Would you like me to take you there?', 'info');
        }
    }

    loadUserHistory(statusFilter = ['pending']) {
        this.switchToTab('user-history');
        
        setTimeout(() => {
            // Filter to show specific status if needed
            this.showMessage(`üìã I've switched to User History. You can view your requests organized by type and status.`, 'success');
        }, 500);
    }

    showProjectSearch() {
        this.switchToTab('generate');
        
        setTimeout(() => {
            this.showMessage('üéØ I\'ve opened the project selection area. You can search by project name, creator, CSI code, or attributes using the advanced search section.', 'success');
        }, 500);
    }

    filterRequests(status) {
        const currentTab = this.getCurrentTab();
        this.showMessage(`üîΩ To filter by ${status} requests, please use the status filters available in the current tab.`, 'info');
    }

    showActionSuggestions(suggestions) {
        // Update quick action buttons with current suggestions
        const quickActionsContainer = document.getElementById('ai-quick-actions');
        const currentButtons = quickActionsContainer.querySelector('.flex');
        
        currentButtons.innerHTML = suggestions.map((suggestion, index) => 
            `<button class="quick-action-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full text-xs transition-colors" 
                     onclick="codeGenerationAI.handleSuggestionClick('${suggestion}')">
                ${suggestion}
             </button>`
        ).join('');
    }

    handleSuggestionClick(suggestion) {
        document.getElementById('ai-chat-input').value = suggestion;
        this.sendMessage();
    }

    addUserMessage(message) {
        const messagesContainer = document.getElementById('ai-messages');
        const messageEl = document.createElement('div');
        messageEl.className = 'user-message text-right';
        messageEl.innerHTML = `
            <div class="inline-block bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-3 rounded-2xl rounded-tr-md max-w-xs">
                <p class="text-sm">${this.escapeHtml(message)}</p>
                <span class="text-xs text-blue-100 block mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
        `;
        messagesContainer.appendChild(messageEl);
        this.scrollToBottom();
    }

    addAIMessage(message, actions = [], responseData = {}) {
        const messagesContainer = document.getElementById('ai-messages');
        const messageEl = document.createElement('div');
        messageEl.className = 'ai-message';
        
        // Determine source from responseData or fall back to parameter
        const source = responseData.source || responseData;
        
        // Different styling based on source
        let sourceIcon = 'ü§ñ';
        let sourceColor = 'text-blue-600';
        let sourceLabel = 'AI Assistant';
        let sourceBadge = '';
        
        if (source === 'claude_ai' || responseData.isAI === true) {
            sourceIcon = 'üß†';
            sourceColor = 'text-green-600';
            sourceLabel = 'Claude AI';
            sourceBadge = '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Live AI</span>';
        } else if (source === 'error' || responseData.setupRequired) {
            
        } else if (source === 'system') {
            sourceIcon = 'üîß';
            sourceColor = 'text-gray-600';
            sourceLabel = 'System';
            sourceBadge = '<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full">Info</span>';
        } else if (source === 'fallback' || responseData.isAI === false) {
            sourceIcon = '‚öôÔ∏è';
            sourceColor = 'text-orange-600';
            sourceLabel = 'Basic Response';
            sourceBadge = '<span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full">Limited</span>';
        }
        
        // Enhanced message formatting for structured data
        let formattedMessage = this.formatStructuredMessage(message);
        
        messageEl.innerHTML = `
            <div class="bg-white p-4 rounded-2xl rounded-tl-md shadow-sm border border-gray-100 max-w-2xl">
                <div class="flex items-center space-x-2 mb-3">
                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-sm">${sourceIcon}</span>
                    </div>
                    <span class="text-xs ${sourceColor} font-medium">${sourceLabel}</span>
                    ${sourceBadge}
                </div>
                <div class="text-sm text-gray-800 leading-relaxed structured-content">
                    ${formattedMessage}
                </div>
                <span class="text-xs text-gray-400 block mt-3">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                
                ${responseData.aiError ? `
                    <div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">
                        üö® Setup Required: ${responseData.aiError}
                    </div>
                ` : ''}
            </div>
        `;
        messagesContainer.appendChild(messageEl);
        this.scrollToBottom();
    }

    formatStructuredMessage(message) {
        // Enhanced formatting for structured content
        let formatted = message;
        
        // Convert markdown-style headers to HTML
        formatted = formatted.replace(/^### (.*$)/gm, '<h4 class="font-bold text-gray-900 mt-4 mb-2">$1</h4>');
        formatted = formatted.replace(/^## (.*$)/gm, '<h3 class="font-bold text-gray-900 text-lg mt-4 mb-2">$1</h3>');
        formatted = formatted.replace(/^# (.*$)/gm, '<h2 class="font-bold text-gray-900 text-xl mt-4 mb-2">$1</h2>');
        
        // Convert **bold** to HTML
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
        
        // Convert bullet points to proper lists
        formatted = formatted.replace(/^‚Ä¢ (.*$)/gm, '<li class="ml-4 mb-1">‚Ä¢ $1</li>');
        formatted = formatted.replace(/^- (.*$)/gm, '<li class="ml-4 mb-1">‚Ä¢ $1</li>');
        
        // Wrap consecutive list items in ul tags
        formatted = formatted.replace(/(<li class="ml-4 mb-1">.*<\/li>\s*)+/gs, '<ul class="my-2">$&</ul>');
        
        // Create card-like sections for structured data
        formatted = formatted.replace(/^--- (.*?) ---$/gm, '<div class="bg-gray-50 border border-gray-200 rounded-lg p-3 my-3"><h5 class="font-semibold text-gray-800 mb-2">$1</h5>');
        
        // Close card sections (look for next card or end of message)
        formatted = formatted.replace(/(<div class="bg-gray-50[^>]*><h5[^>]*>.*?<\/h5>)(.*?)(?=<div class="bg-gray-50|$)/gs, '$1$2</div>');
        
        // Format project/item details with better spacing
        formatted = formatted.replace(/^(Project ID|Item Code|Project Name|Description|Price|Status|Created): (.*)$/gm, 
            '<div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0"><span class="text-gray-600 text-xs">$1:</span><span class="font-medium text-gray-900 text-xs">$2</span></div>');
        
        // Convert line breaks to HTML
        formatted = formatted.replace(/\n/g, '<br>');
        
        // Clean up extra breaks
        formatted = formatted.replace(/(<br>\s*){3,}/g, '<br><br>');
        
        return formatted;
    }

    showTypingIndicator() {
        document.getElementById('ai-typing-indicator').classList.remove('hidden');
    }

    hideTypingIndicator() {
        document.getElementById('ai-typing-indicator').classList.add('hidden');
    }

    scrollToBottom() {
        const messagesContainer = document.getElementById('ai-messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    getCurrentTab() {
        const activeTab = document.querySelector('.tab-btn.border-blue-500');
        return activeTab ? activeTab.getAttribute('data-tab') : 'generate';
    }

    getPortalContext() {
        return {
            currentUser: this.currentUser || currentUser,
            selectedProject: window.selectedProject,
            activeTab: this.getCurrentTab(),
            timestamp: new Date().toISOString()
        };
    }

    switchToTab(tabName) {
        const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
        if (tabButton) {
            tabButton.click();
        }
    }

    updateQuickActions() {
        const currentTab = this.getCurrentTab();
        const quickActionsContainer = document.getElementById('ai-quick-actions');
        const currentButtons = quickActionsContainer.querySelector('.flex');
        
        const tabActions = {
            'generate': [
                { text: '‚ö° New Code', action: 'create_code' },
                { text: 'üîç Search Projects', action: 'search_project' },
                { text: 'üìã Check Status', action: 'check_status' },
                { text: '‚ùì Help', action: 'help' }
            ],
            'user-history': [
                { text: 'üìã My Pending', action: 'search_pending' },
                { text: '‚úÖ Approved', action: 'filter_approved' },
                { text: 'üì§ Export', action: 'export_data' },
                { text: '‚ùì Help', action: 'help' }
            ],
            'search': [
                { text: 'üîç Smart Search', action: 'quick_search' },
                { text: 'üì§ Export', action: 'export_data' },
                { text: 'üîΩ Filter', action: 'filter_requests' },
                { text: '‚ùì Help', action: 'help' }
            ]
        };
        
        const actions = tabActions[currentTab] || tabActions['generate'];
        
        currentButtons.innerHTML = actions.map(action => 
            `<button class="quick-action-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full text-xs transition-colors" data-action="${action.action}">
                ${action.text}
             </button>`
        ).join('');
        
        // Reattach event listeners
        currentButtons.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                this.handleQuickAction(action);
            });
        });
    }

    handleQuickAction(action) {
        const quickActions = {
            'search_pending': 'Show my pending requests',
            'quick_search': 'Search for codes',
            'export_data': 'Export data to Excel',
            'help': 'Show help for this tab',
            'create_code': 'Generate a new item code',
            'search_project': 'Search for projects',
            'check_status': 'Check my request status',
            'filter_approved': 'Show approved requests',
            'filter_requests': 'Filter requests',
            'test_ai': null, // Special handling
            'test_db': null  // Special handling
        };
        
        if (action === 'test_ai') {
            this.testAIConnectivity();
            return;
        }
        
        if (action === 'test_db') {
            this.testDatabaseConnection();
            return;
        }
        
        const message = quickActions[action] || action;
        document.getElementById('ai-chat-input').value = message;
        this.sendMessage();
    }

    async testDatabaseConnection() {
        this.addUserMessage('üîç Testing database connection...');
        console.log('üîç Testing database connection and search functions...');
        
        try {
            // Test 1: Check if we can access the database
            const { data: testData, error: testError } = await supabase
                .from('classification_projects')
                .select('id, project_name, status, division_description')
                .limit(5);
                
            if (testError) {
                console.error('‚ùå Database connection failed:', testError);
                this.addAIMessage(`‚ùå **Database Connection Failed**\n\n**Error:** ${testError.message}\n\n**üîß Check:**\n‚Ä¢ Supabase configuration\n‚Ä¢ Database permissions\n‚Ä¢ Table existence`, [], {
                    source: 'system',
                    isAI: false
                });
                return;
            }
            
            console.log('‚úÖ Database connection working, found projects:', testData);
            
            // Test 2: Try the search functions
            const searchResults = await this.searchProjects({ materials: ['concrete'] }, 'concrete projects test');
            console.log('üîç Project search test results:', searchResults);
            
            let resultSummary = '';
            if (testData && testData.length > 0) {
                resultSummary = `\n\n--- **Sample Projects Found** ---\n`;
                testData.forEach((project, index) => {
                    resultSummary += `\n**Project ${index + 1}:**\n`;
                    resultSummary += `Project Name: ${project.project_name}\n`;
                    resultSummary += `Project ID: ${project.id}\n`;
                    resultSummary += `Status: ${project.status}\n`;
                    if (project.division_description) {
                        resultSummary += `Division: ${project.division_description}\n`;
                    }
                });
                resultSummary += `\n--- **End Sample Data** ---`;
            }
            
            let searchSummary = '';
            if (searchResults && searchResults.results && searchResults.results.length > 0) {
                searchSummary = `\n\n--- **Search Function Test** ---\n`;
                searchSummary += `Search Query: "${searchResults.searchQuery}"\n`;
                searchSummary += `Results Found: ${searchResults.total}\n`;
                searchSummary += `Function Used: ${searchResults.source || 'rpc_function'}\n`;
                
                searchResults.results.slice(0, 2).forEach((result, index) => {
                    searchSummary += `\n**Search Result ${index + 1}:**\n`;
                    searchSummary += `Project Name: ${result.project_name}\n`;
                    searchSummary += `Project ID: ${result.id}\n`;
                    if (result.division_description) {
                        searchSummary += `Division: ${result.division_description}\n`;
                    }
                });
                searchSummary += `\n--- **End Search Results** ---`;
            } else {
                searchSummary = `\n\n--- **Search Function Test** ---\n`;
                searchSummary += `Search Query: "${searchResults?.searchQuery || 'concrete'}"\n`;
                searchSummary += `Results Found: ${searchResults?.total || 0}\n`;
                searchSummary += `Function Source: ${searchResults?.source || 'unknown'}\n`;
                if (searchResults?.error) {
                    searchSummary += `Error: ${searchResults.error}\n`;
                }
                searchSummary += `--- **End Search Test** ---`;
            }
            
            this.addAIMessage(`‚úÖ **Database Test Results**\n\n**üîó Database Connection:** Working ‚úÖ\n**üìÅ Projects Table:** Accessible ‚úÖ\n**üìä Total Projects Found:** ${testData ? testData.length : 0}${resultSummary}${searchSummary}\n\n**üéØ Next Steps:**\n‚Ä¢ Database is working properly\n‚Ä¢ Search functions are operational\n‚Ä¢ AI should receive real data from these searches`, [], {
                source: 'system',
                isAI: false
            });
            
        } catch (error) {
            console.error('üí• Database test error:', error);
            this.addAIMessage(`üí• **Database Test Error**\n\n**Error:** ${error.message}\n\n**üîß Possible Issues:**\n‚Ä¢ Supabase client not initialized\n‚Ä¢ Network connection problems\n‚Ä¢ Configuration missing`, [], {
                source: 'system',
                isAI: false
            });
        }
    }

    async testAIConnectivity() {
        try {
            this.addUserMessage('üß™ Testing Claude AI connectivity...');
            this.showTypingIndicator();
            
            // Test actual Claude AI connection
            const testPrompt = 'TEST CONNECTION: Please respond with "Claude AI is working correctly" to confirm connectivity and functionality.';
            const response = await this.callClaudeAPI(testPrompt);

            this.hideTypingIndicator();
            
            // If we get here, Claude AI is working
            this.addAIMessage(`‚úÖ **Claude AI Test Successful!**\n\nüß† **Status:** Claude AI is working properly through the serverless function.\n\n**Test Response:** ${response}\n\nüéâ **All Systems Operational:**\n‚Ä¢ Real AI responses with database integration\n‚Ä¢ Intelligent analysis and recommendations\n‚Ä¢ Natural conversation capabilities\n‚Ä¢ Complex query handling\n\nüí° **You're now using full Claude AI with your database!**`, [], {
                source: 'claude_ai',
                isAI: true
            });
            
            this.showMessage('üéâ Claude AI test successful! Full AI capabilities active.', 'success');
            
        } catch (error) {
            this.hideTypingIndicator();
            
            let errorType = 'Configuration Error';
            let instructions = '';
            
            if (error.message.includes('SETUP_REQUIRED')) {
                errorType = 'Setup Required';
                instructions = `üîß **Deploy Serverless Function:**
1. Create \`netlify/functions/claude-ai.js\`
2. Copy the provided function code
3. Set \`ANTHROPIC_API_KEY\` environment variable  
4. Deploy to Netlify
5. Refresh this page

üìö **See setup guide for detailed steps**`;
            } else if (error.message.includes('NETWORK_ERROR')) {
                errorType = 'Network/Deployment Issue';
                instructions = `üåê **Check Deployment:**
‚Ä¢ Ensure you're accessing via HTTPS (not file://)
‚Ä¢ Verify serverless function is deployed correctly
‚Ä¢ Check Netlify function logs for errors
‚Ä¢ Confirm \`ANTHROPIC_API_KEY\` is set

üîÑ **Try refreshing the page after fixing**`;
            } else {
                errorType = 'API Configuration Error';
                instructions = `‚öôÔ∏è **Check Configuration:**
‚Ä¢ Verify \`ANTHROPIC_API_KEY\` environment variable
‚Ä¢ Ensure API key is valid and has credits
‚Ä¢ Check serverless function logs in Netlify
‚Ä¢ Confirm function is properly deployed

üí° **Error Details:** ${error.message}`;
            }
            
            this.addAIMessage(`‚ùå **Claude AI Test Failed**\n\n**Error Type:** ${errorType}\n\n${instructions}\n\nüö® **Important:** This chatbot requires real Claude AI to function. Database features work, but no AI responses are available until proper setup is completed.\n\nüìñ **Next Steps:** Follow the setup guide to deploy the serverless function with your Anthropic API key.`, [], {
                source: 'error',
                isAI: false,
                aiError: error.message,
                setupRequired: true
            });
            
            this.showMessage(`‚ùå Claude AI test failed: ${errorType}`, 'error');
        }
    }

    showMessage(message, type = 'info') {
        // Show a temporary toast notification
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
        
        const bgColors = {
            'info': 'bg-blue-500 text-white',
            'success': 'bg-green-500 text-white',
            'warning': 'bg-yellow-500 text-black',
            'error': 'bg-red-500 text-white'
        };
        
        toast.className += ` ${bgColors[type] || bgColors['info']}`;
        toast.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="text-sm">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="text-lg">&times;</button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Animate in
        requestAnimationFrame(() => {
            toast.classList.remove('translate-x-full');
        });
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// Initialize AI Chatbot when page loads
let codeGenerationAI;

// Wait for current user to be available and then initialize
function initializeAIChatbot() {
    if (typeof currentUser !== 'undefined' && currentUser) {
        if (!codeGenerationAI) {
            codeGenerationAI = new CodeGenerationAI();
            codeGenerationAI.currentUser = currentUser;
            console.log('‚úÖ AI Chatbot initialized for Code Generation Portal');
        }
    } else {
        // Retry in 100ms if currentUser is not yet available
        setTimeout(initializeAIChatbot, 100);
    }
}

// Initialize when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAIChatbot);
} else {
    initializeAIChatbot();
}

// ===== END AI CHATBOT INTEGRATION =====

// ===== END USER HISTORY TAB =====

    </script>
</body>
</html>
